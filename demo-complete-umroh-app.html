<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Demo - Aplikasi Manajemen Umroh</title>
    
    <!-- Material UI Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- SheetJS for Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        html, body {
            height: 100%;
            overflow: hidden;
        }
        
        /* Toggle Switch Styles */
        .switch {
            position: relative;
            display: inline-block;
            width: 48px;
            height: 24px;
        }
        
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(203, 213, 225, 0.2);
            transition: .4s;
            border: 1px solid rgba(203, 213, 225, 0.3);
        }
        
        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 3px;
            bottom: 3px;
            background-color: #e2e8f0;
            transition: .4s;
        }
        
        input:checked + .slider {
            background-color: #25D366;
            border-color: #25D366;
        }
        
        input:focus + .slider {
            box-shadow: 0 0 1px #25D366;
        }
        
        input:checked + .slider:before {
            transform: translateX(24px);
        }
        
        .slider.round {
            border-radius: 24px;
        }
        
        .slider.round:before {
            border-radius: 50%;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 25%, #334155 50%, #475569 75%, #64748b 100%);
            min-height: 100vh;
            color: #f8fafc;
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 80%, rgba(59, 130, 246, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(16, 185, 129, 0.12) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(139, 92, 246, 0.1) 0%, transparent 50%);
            z-index: -1;
        }

        .app-container {
            display: flex;
            flex-direction: row;
            height: 100vh;
            width: 100%;
            overflow: hidden;
            position: relative;
        }

        /* Sidebar */
        .sidebar {
            width: 280px;
            background: linear-gradient(145deg, rgba(30, 41, 59, 0.95), rgba(15, 23, 42, 0.9));
            backdrop-filter: blur(20px);
            border-right: 1px solid rgba(71, 85, 105, 0.3);
            padding: 20px;
            overflow-y: auto;
            box-shadow: 
                inset 0 1px 0 rgba(71, 85, 105, 0.4),
                0 20px 40px rgba(0, 0, 0, 0.3),
                0 1px 3px rgba(0, 0, 0, 0.2);
            position: relative;
            z-index: 10;
            flex-shrink: 0;
        }

        .logo {
            text-align: center;
            background: linear-gradient(135deg, #3b82f6, #10b981, #8b5cf6);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 30px;
            padding: 20px 0;
            text-shadow: 0 2px 10px rgba(59, 130, 246, 0.3);
        }

        .nav-item {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            margin: 5px 0;
            border-radius: 12px;
            color: #e2e8f0;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            background: linear-gradient(135deg, rgba(71, 85, 105, 0.4), rgba(30, 41, 59, 0.3));
            border: 1px solid rgba(71, 85, 105, 0.3);
            position: relative;
            overflow: hidden;
            user-select: none;
            -webkit-user-select: none;
        }

        .nav-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(59, 130, 246, 0.2), transparent);
            transition: left 0.5s ease;
        }

        .nav-item:hover::before {
            left: 100%;
        }

        .nav-item:hover {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(16, 185, 129, 0.1));
            transform: translateX(8px) scale(1.02);
            color: #60a5fa;
            border-color: rgba(59, 130, 246, 0.4);
            box-shadow: 
                0 10px 30px rgba(59, 130, 246, 0.2),
                inset 0 1px 0 rgba(59, 130, 246, 0.3);
        }

        .nav-item.active {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.3), rgba(16, 185, 129, 0.2));
            color: #3b82f6;
            border-color: rgba(59, 130, 246, 0.5);
            box-shadow: 
                0 10px 30px rgba(59, 130, 246, 0.3),
                inset 0 1px 0 rgba(59, 130, 246, 0.4),
                inset 0 -1px 0 rgba(16, 185, 129, 0.2);
        }

        .nav-item .material-icons {
            margin-right: 15px;
            font-size: 24px;
            pointer-events: none;
        }
        
        .nav-item span {
            pointer-events: none;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
            overflow-x: hidden;
            height: 100vh;
            position: relative;
            z-index: 1;
            margin-left: 0;
            background: transparent;
        }

        .page {
            display: none;
            animation: fadeIn 0.5s ease;
            width: 100%;
            min-height: 100%;
        }

        .page.active {
            display: block !important;
            opacity: 1;
            visibility: visible;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Spinner Animation */
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(37, 211, 102, 0.3);
            border-top-color: #25D366;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Flight Card Styles */
        .flight-card {
            transition: all 0.3s ease;
        }
        
        .flight-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }
        
        details.glass-details[open] .expand-icon {
            transform: rotate(180deg);
        }

        /* Glass Card */
        .glass-card {
            background: linear-gradient(145deg, rgba(30, 41, 59, 0.8), rgba(15, 23, 42, 0.7));
            backdrop-filter: blur(20px);
            border: 1px solid rgba(71, 85, 105, 0.3);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 
                0 20px 60px rgba(0, 0, 0, 0.4),
                inset 0 1px 0 rgba(71, 85, 105, 0.4),
                0 1px 3px rgba(0, 0, 0, 0.3);
            position: relative;
            overflow: hidden;
            opacity: 1;
            visibility: visible;
        }

        .glass-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, transparent, rgba(59, 130, 246, 0.6), rgba(16, 185, 129, 0.8), rgba(139, 92, 246, 0.6), transparent);
        }

        .glass-card h2 {
            background: linear-gradient(135deg, #60a5fa, #34d399, #a78bfa);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 20px;
            font-size: 28px;
            font-weight: 600;
            text-shadow: 0 2px 10px rgba(59, 130, 246, 0.3);
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 15px;
        }

        @media (min-width: 1200px) {
            .cards-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (min-width: 1600px) {
            .cards-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }
        
        /* Force visibility for problem pages */
        #flights .glass-card,
        #flights .card,
        #reports .glass-card,
        #excel .glass-card {
            display: block !important;
            opacity: 1 !important;
            visibility: visible !important;
            background: rgba(30, 41, 59, 0.9) !important;
            color: white !important;
        }
        
        #flights .cards-grid,
        #reports .report-grid,
        #excel .section {
            display: grid !important;
            opacity: 1 !important;
            visibility: visible !important;
        }
        
        /* Ensure text is visible */
        #flights *,
        #reports *,
        #excel * {
            color: inherit;
        }
        
        /* Tab buttons */
        .tab-button {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            background: transparent;
            border: none;
            color: rgba(255, 255, 255, 0.6);
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 16px;
            position: relative;
        }
        
        .tab-button:hover {
            color: rgba(255, 255, 255, 0.9);
        }
        
        .tab-button.active {
            color: #F59E0B;
        }
        
        .tab-button.active::after {
            content: '';
            position: absolute;
            bottom: -16px;
            left: 0;
            right: 0;
            height: 3px;
            background: #F59E0B;
            border-radius: 2px;
        }
        
        .tab-content {
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .card {
            background: linear-gradient(145deg, rgba(30, 41, 59, 0.9), rgba(15, 23, 42, 0.8));
            backdrop-filter: blur(20px);
            border: 1px solid rgba(71, 85, 105, 0.4);
            border-radius: 16px;
            box-shadow: 
                0 10px 30px rgba(0, 0, 0, 0.3),
                inset 0 1px 0 rgba(71, 85, 105, 0.4),
                0 1px 3px rgba(0, 0, 0, 0.2);
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            position: relative;
            overflow: hidden;
        }
        
        .card:hover {
            transform: translateY(-3px);
            box-shadow: 
                0 15px 40px rgba(0, 0, 0, 0.4),
                inset 0 1px 0 rgba(71, 85, 105, 0.5),
                0 1px 3px rgba(0, 0, 0, 0.3);
            border-color: rgba(59, 130, 246, 0.5);
        }
        
        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent, rgba(59, 130, 246, 0.6), rgba(16, 185, 129, 0.6), rgba(139, 92, 246, 0.6), transparent);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .card:hover::before {
            opacity: 1;
        }

        .report-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .header-section {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            gap: 15px;
        }

        .header-section h2 {
            margin: 0;
        }

        @media (max-width: 768px) {
            .header-section {
                flex-direction: column;
                align-items: stretch;
            }
        }

        .stat-card {
            background: linear-gradient(145deg, rgba(51, 65, 85, 0.8), rgba(30, 41, 59, 0.7));
            backdrop-filter: blur(15px);
            border: 1px solid rgba(71, 85, 105, 0.4);
            border-radius: 16px;
            padding: 25px;
            text-align: center;
            transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #3b82f6, #10b981, #8b5cf6, #f59e0b);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .stat-card:hover::before {
            opacity: 1;
        }

        .stat-card:hover {
            transform: translateY(-8px) scale(1.02);
            background: linear-gradient(145deg, rgba(59, 130, 246, 0.15), rgba(16, 185, 129, 0.1));
            border-color: rgba(59, 130, 246, 0.5);
            box-shadow: 
                0 20px 40px rgba(59, 130, 246, 0.3),
                inset 0 1px 0 rgba(59, 130, 246, 0.4);
        }

        .stat-card .stat-icon {
            font-size: 48px;
            background: linear-gradient(135deg, #60a5fa, #34d399, #a78bfa);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 15px;
            transition: transform 0.3s ease;
        }

        .stat-card:hover .stat-icon {
            transform: scale(1.1) rotate(3deg);
        }

        .stat-card .stat-number {
            font-size: 32px;
            font-weight: 700;
            color: #f8fafc;
            margin-bottom: 10px;
        }

        .stat-card .stat-label {
            color: #cbd5e1;
            font-size: 14px;
            font-weight: 500;
        }

        /* Forms */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid rgba(71, 85, 105, 0.3);
        }

        .section {
            margin-bottom: 40px;
        }

        .section h3 {
            color: white;
            margin-bottom: 15px;
            font-size: 20px;
            font-weight: 600;
        }

        .chart-container {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 30px;
            margin-top: 30px;
        }

        @media (max-width: 1024px) {
            .chart-container {
                grid-template-columns: 1fr;
            }
        }

        /* Chart Sizing */
        .chart-wrapper {
            position: relative;
            height: 300px;
            width: 100%;
            background: rgba(30, 41, 59, 0.4);
            border-radius: 12px;
            padding: 15px;
            border: 1px solid rgba(71, 85, 105, 0.2);
        }

        .chart-wrapper h3 {
            color: white;
            margin-bottom: 15px;
            font-size: 16px;
            font-weight: 600;
            text-align: center;
        }

        .chart-wrapper canvas {
            width: 100% !important;
            height: calc(100% - 50px) !important;
            max-height: 250px;
        }

        .dashboard-charts {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 30px;
        }

        @media (max-width: 768px) {
            .dashboard-charts {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .chart-wrapper {
                height: 250px;
            }
        }

        /* Group Cards */
        .group-card {
            background: linear-gradient(145deg, rgba(30, 41, 59, 0.8), rgba(15, 23, 42, 0.7));
            backdrop-filter: blur(20px);
            border: 1px solid rgba(71, 85, 105, 0.3);
            border-radius: 16px;
            padding: 18px;
            margin-bottom: 15px;
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.3),
                inset 0 1px 0 rgba(71, 85, 105, 0.4),
                0 1px 3px rgba(0, 0, 0, 0.2);
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .group-card:hover {
            transform: translateY(-3px);
            box-shadow: 
                0 12px 40px rgba(0, 0, 0, 0.4),
                inset 0 1px 0 rgba(71, 85, 105, 0.4),
                0 1px 3px rgba(0, 0, 0, 0.3);
        }

        .group-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
            gap: 12px;
        }

        .group-title {
            flex: 1;
        }

        .group-title h3 {
            color: #f8fafc;
            margin: 0 0 3px 0;
            font-size: 17px;
            font-weight: 600;
            line-height: 1.3;
        }

        .group-package {
            color: rgba(79, 172, 254, 0.9);
            font-size: 13px;
            font-weight: 500;
        }

        .group-status-badge {
            flex-shrink: 0;
        }

        .group-info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin-bottom: 12px;
            padding: 12px;
            background: rgba(15, 23, 42, 0.3);
            border-radius: 10px;
            border: 1px solid rgba(71, 85, 105, 0.2);
        }

        .group-info-item {
            text-align: center;
        }

        .group-info-label {
            color: rgba(255, 255, 255, 0.6);
            font-size: 10px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            margin-bottom: 3px;
        }

        .group-info-value {
            color: #f8fafc;
            font-size: 13px;
            font-weight: 600;
            line-height: 1.2;
        }

        .group-info-value.highlight {
            color: #4facfe;
            font-size: 14px;
        }

        .group-logistics {
            background: rgba(30, 41, 59, 0.4);
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 12px;
            border: 1px solid rgba(71, 85, 105, 0.2);
        }

        .group-logistics-title {
            color: #e2e8f0;
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .group-logistics-item {
            display: flex;
            align-items: center;
            gap: 6px;
            color: rgba(255, 255, 255, 0.8);
            font-size: 12px;
            margin-bottom: 4px;
            line-height: 1.3;
        }

        .group-logistics-item:last-child {
            margin-bottom: 0;
        }

        .group-logistics-icon {
            width: 14px;
            text-align: center;
            font-size: 12px;
        }

        .group-actions {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 6px;
            margin-top: 15px;
        }

        .group-actions-row {
            display: flex;
            gap: 4px;
        }

        .group-actions .btn {
            font-size: 9px;
            padding: 4px 6px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            flex: 1;
            min-width: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            min-height: 28px;
        }

        .group-actions .btn .material-icons {
            font-size: 12px;
            margin-right: 2px;
        }

        .group-actions .btn-sm {
            font-size: 8px;
            padding: 3px 4px;
            min-height: 24px;
        }

        .group-actions .btn-sm .material-icons {
            font-size: 10px;
            margin-right: 1px;
        }

        @media (max-width: 768px) {
            .group-actions {
                grid-template-columns: 1fr 1fr;
                gap: 4px;
            }
        }

        @media (max-width: 480px) {
            .group-actions {
                grid-template-columns: 1fr 1fr;
                gap: 3px;
            }

            .group-actions .btn {
                font-size: 8px;
                padding: 4px 6px;
                min-height: 26px;
            }

            .group-actions .btn .material-icons {
                font-size: 10px;
                margin-right: 1px;
            }
        }

        /* Room Management Styles */
        .room-management {
            margin-top: 20px;
        }

        .room-allocation-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding: 15px;
            background: rgba(30, 41, 59, 0.4);
            border-radius: 12px;
            border: 1px solid rgba(71, 85, 105, 0.3);
        }

        .room-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .room-stat-item {
            text-align: center;
            padding: 12px;
            background: rgba(15, 23, 42, 0.4);
            border-radius: 10px;
            border: 1px solid rgba(71, 85, 105, 0.2);
        }

        .room-stat-number {
            font-size: 18px;
            font-weight: 600;
            color: #4facfe;
            margin-bottom: 4px;
        }

        .room-stat-label {
            font-size: 11px;
            color: rgba(255, 255, 255, 0.7);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .room-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .room-card {
            background: linear-gradient(145deg, rgba(30, 41, 59, 0.8), rgba(15, 23, 42, 0.7));
            border: 1px solid rgba(71, 85, 105, 0.3);
            border-radius: 12px;
            padding: 15px;
            transition: all 0.3s ease;
        }

        .room-card:hover {
            transform: translateY(-2px);
            border-color: rgba(79, 172, 254, 0.5);
            box-shadow: 0 8px 25px rgba(79, 172, 254, 0.2);
        }

        .room-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .room-number {
            font-size: 16px;
            font-weight: 600;
            color: #f8fafc;
        }

        .room-type {
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 500;
            text-transform: uppercase;
        }

        .room-type.quad {
            background: rgba(139, 92, 246, 0.2);
            color: #a78bfa;
            border: 1px solid rgba(139, 92, 246, 0.3);
        }

        .room-type.triple {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
            border: 1px solid rgba(34, 197, 94, 0.3);
        }

        .room-type.double {
            background: rgba(59, 130, 246, 0.2);
            color: #3b82f6;
            border: 1px solid rgba(59, 130, 246, 0.3);
        }

        .room-type.single {
            background: rgba(245, 158, 11, 0.2);
            color: #f59e0b;
            border: 1px solid rgba(245, 158, 11, 0.3);
        }

        .room-occupants {
            margin-bottom: 12px;
        }

        .occupant-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 10px;
            margin-bottom: 6px;
            background: rgba(15, 23, 42, 0.5);
            border-radius: 8px;
            border: 1px solid rgba(71, 85, 105, 0.2);
        }

        .occupant-info {
            flex: 1;
        }

        .occupant-name {
            font-size: 13px;
            font-weight: 500;
            color: #e2e8f0;
            margin-bottom: 2px;
        }

        .occupant-details {
            font-size: 11px;
            color: rgba(255, 255, 255, 0.6);
        }

        .bed-assignment {
            padding: 2px 6px;
            background: rgba(79, 172, 254, 0.2);
            color: #4facfe;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 500;
        }

        .empty-bed {
            padding: 8px 10px;
            background: rgba(71, 85, 105, 0.2);
            border: 1px dashed rgba(71, 85, 105, 0.4);
            border-radius: 8px;
            text-align: center;
            color: rgba(255, 255, 255, 0.5);
            font-size: 12px;
            margin-bottom: 6px;
        }

        .room-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            justify-content: space-between;
            margin-top: 12px;
        }

        .room-actions .btn {
            flex: 1;
            padding: 8px 12px;
            font-size: 11px;
            min-width: 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }

        .room-actions .btn .material-icons {
            font-size: 14px;
        }

        .allocation-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .allocation-option {
            padding: 15px;
            background: rgba(30, 41, 59, 0.6);
            border: 1px solid rgba(71, 85, 105, 0.3);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .allocation-option:hover {
            border-color: rgba(79, 172, 254, 0.5);
            background: rgba(79, 172, 254, 0.1);
        }

        .allocation-option.active {
            border-color: #4facfe;
            background: rgba(79, 172, 254, 0.2);
        }

        .allocation-icon {
            font-size: 24px;
            margin-bottom: 8px;
            color: #4facfe;
        }

        .allocation-title {
            font-size: 14px;
            font-weight: 600;
            color: #f8fafc;
            margin-bottom: 4px;
        }

        .allocation-desc {
            font-size: 11px;
            color: rgba(255, 255, 255, 0.7);
            line-height: 1.3;
        }

        .unassigned-jamaah {
            background: rgba(30, 41, 59, 0.4);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .unassigned-header {
            color: #f8fafc;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .unassigned-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 10px;
            max-height: 200px;
            overflow-y: auto;
        }

        .unassigned-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 12px;
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(71, 85, 105, 0.3);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .unassigned-item:hover {
            border-color: rgba(79, 172, 254, 0.5);
            background: rgba(79, 172, 254, 0.1);
        }

        .unassigned-item.selected {
            border-color: #4facfe;
            background: rgba(79, 172, 254, 0.2);
        }

        @media (max-width: 992px) {
            .room-grid {
                grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
                gap: 12px;
            }
        }

        @media (max-width: 768px) {
            .room-grid {
                grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
                gap: 10px;
            }
            
            .allocation-controls {
                grid-template-columns: 1fr;
            }
            
            .room-stats {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .room-actions {
                gap: 6px;
            }
            
            .room-actions .btn {
                padding: 6px 8px;
                font-size: 10px;
            }
            
            .room-actions .btn .material-icons {
                font-size: 12px;
            }
        }

        @media (max-width: 576px) {
            .room-grid {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .room-card {
                padding: 12px;
            }
            
            .room-actions {
                gap: 4px;
                margin-top: 8px;
            }
            
            .room-actions .btn {
                padding: 5px 6px;
                font-size: 9px;
                min-height: 28px;
            }
            
            .room-actions .btn .material-icons {
                font-size: 11px;
                margin-right: 2px;
            }
            
            .occupant-item {
                padding: 6px 8px;
                flex-direction: column;
                align-items: flex-start;
                gap: 4px;
            }
            
            .occupant-item .occupant-name {
                font-size: 11px;
            }
            
            .occupant-item .occupant-role {
                font-size: 10px;
            }
        }

        @media (max-width: 400px) {
            .room-grid {
                grid-template-columns: 1fr;
                gap: 8px;
            }
            
            .room-card {
                padding: 10px;
                margin: 0 5px;
            }
            
            .room-actions {
                flex-direction: column;
                gap: 6px;
                margin-top: 10px;
            }
            
            .room-actions .btn {
                flex: none;
                width: 100%;
                justify-content: center;
                padding: 8px 12px;
                font-size: 10px;
                white-space: normal;
                text-overflow: none;
                overflow: visible;
            }
            
            .room-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 4px;
            }
            
            .room-number {
                font-size: 14px;
            }
        }

        .group-progress {
            margin-bottom: 12px;
        }

        .group-progress-bar {
            width: 100%;
            height: 5px;
            background: rgba(71, 85, 105, 0.3);
            border-radius: 3px;
            overflow: hidden;
        }

        .group-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4facfe, #00f2fe);
            transition: width 0.3s ease;
        }

        .group-progress-text {
            font-size: 10px;
            color: rgba(255, 255, 255, 0.7);
            margin-top: 3px;
            text-align: center;
            line-height: 1.2;
        }

        .form-group label {
            display: block;
            color: #e2e8f0;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid rgba(71, 85, 105, 0.4);
            border-radius: 8px;
            background: rgba(30, 41, 59, 0.6);
            color: #f8fafc;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .form-group input::placeholder,
        .form-group textarea::placeholder {
            color: rgba(203, 213, 225, 0.6);
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #3b82f6;
            background: rgba(30, 41, 59, 0.8);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }

        /* Buttons */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            text-decoration: none;
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            min-width: 120px;
            white-space: nowrap;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
            min-width: 80px;
        }

        .btn-icon {
            padding: 8px;
            min-width: auto;
        }

        .btn-icon .material-icons {
            font-size: 18px;
        }

        .btn-flex {
            flex: 1;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn-group .btn {
            flex: 1;
            min-width: 100px;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.5s ease;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn-primary {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 50%, #1e40af 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4);
        }

        .btn-primary:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 15px 30px rgba(59, 130, 246, 0.5);
        }

        .btn-success {
            background: linear-gradient(135deg, #10b981 0%, #059669 50%, #047857 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
        }

        .btn-success:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 15px 30px rgba(16, 185, 129, 0.4);
        }

        .btn-warning {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 50%, #b45309 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(245, 158, 11, 0.3);
        }

        .btn-warning:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 15px 30px rgba(245, 158, 11, 0.4);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 50%, #b91c1c 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
        }

        .btn-danger:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 15px 30px rgba(239, 68, 68, 0.4);
        }
        
        .btn-info {
            background: linear-gradient(135deg, #06b6d4, #0891b2);
            color: white;
            border: 1px solid rgba(6, 182, 212, 0.3);
        }
        
        .btn-info:hover {
            background: linear-gradient(135deg, #0891b2, #0e7490);
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 15px 30px rgba(6, 182, 212, 0.4);
        }

        /* Table */
        .table-container {
            background: linear-gradient(145deg, rgba(30, 41, 59, 0.8), rgba(15, 23, 42, 0.7));
            backdrop-filter: blur(15px);
            border-radius: 12px;
            overflow: hidden;
            margin-top: 20px;
            border: 1px solid rgba(71, 85, 105, 0.4);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .table-actions {
            display: flex;
            gap: 5px;
            align-items: center;
            justify-content: center;
        }

        .table-actions .btn {
            padding: 5px 10px;
            min-width: auto;
        }

        .table-actions .btn .material-icons {
            font-size: 16px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid rgba(71, 85, 105, 0.3);
            color: #e2e8f0;
        }

        th {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.15), rgba(16, 185, 129, 0.1));
            font-weight: 600;
            background: linear-gradient(135deg, #60a5fa, #34d399, #a78bfa);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            position: relative;
        }

        th::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, #3b82f6, #10b981, #8b5cf6, #f59e0b);
        }

        tr:hover {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(16, 185, 129, 0.05));
            transform: scale(1.01);
            transition: all 0.3s ease;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            z-index: 9999;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: linear-gradient(145deg, rgba(255, 255, 255, 0.15), rgba(255, 255, 255, 0.05));
            backdrop-filter: blur(25px);
            border: 2px solid;
            border-image: linear-gradient(135deg, rgba(255, 255, 255, 0.4), rgba(255, 255, 255, 0.1)) 1;
            border-radius: 24px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
            z-index: 10000;
            box-shadow: 
                0 25px 80px rgba(0, 0, 0, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
        }

        .modal-content::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #3b82f6, #10b981, #8b5cf6, #f59e0b);
        }

        .modal-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h3 {
            background: linear-gradient(135deg, #60a5fa, #34d399, #a78bfa);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            font-size: 24px;
            font-weight: 600;
        }

        .close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            margin-left: auto;
        }

        /* Charts */
        .chart-container {
            background: linear-gradient(145deg, rgba(255, 255, 255, 0.15), rgba(255, 255, 255, 0.05));
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 
                0 10px 30px rgba(0, 0, 0, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
            position: relative;
        }

        .chart-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.6), transparent);
        }

        /* Filters */
        .filters {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
        }

        .filter-group label {
            color: white;
            margin-bottom: 5px;
            font-size: 12px;
        }

        .filter-group input,
        .filter-group select {
            padding: 8px 12px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 12px;
        }

        /* File upload */
        .file-upload {
            border: 2px dashed rgba(255, 255, 255, 0.3);
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .file-upload:hover {
            border-color: #4facfe;
            background: rgba(79, 172, 254, 0.1);
        }

        .file-upload.dragover {
            border-color: #4facfe;
            background: rgba(79, 172, 254, 0.2);
        }

        /* Status badges */
        .status-badge {
            padding: 6px 14px;
            border-radius: 25px;
            font-size: 12px;
            font-weight: 600;
            border: 1px solid rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        /* Glassmorphism form inputs */
        .glass-input {
            background: rgba(255, 255, 255, 0.05) !important;
            border: 1px solid rgba(255, 255, 255, 0.2) !important;
            backdrop-filter: blur(10px);
            color: white !important;
            padding: 12px 16px !important;
            border-radius: 12px !important;
            width: 100% !important;
            transition: all 0.3s ease !important;
        }
        
        .glass-input:focus {
            border-color: #3b82f6 !important;
            background: rgba(255, 255, 255, 0.08) !important;
            outline: none !important;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1) !important;
        }
        
        .glass-input::placeholder {
            color: rgba(255, 255, 255, 0.4) !important;
        }
        
        .glass-label {
            color: rgba(255, 255, 255, 0.9) !important;
            font-weight: 500 !important;
            margin-bottom: 8px !important;
            display: block !important;
            font-size: 14px !important;
        }
        
        .glass-textarea {
            background: rgba(255, 255, 255, 0.05) !important;
            border: 1px solid rgba(255, 255, 255, 0.2) !important;
            backdrop-filter: blur(10px);
            color: white !important;
            padding: 12px 16px !important;
            border-radius: 12px !important;
            width: 100% !important;
            transition: all 0.3s ease !important;
            resize: vertical !important;
        }
        
        .glass-textarea:focus {
            border-color: #3b82f6 !important;
            background: rgba(255, 255, 255, 0.08) !important;
            outline: none !important;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1) !important;
        }
        
        /* Custom file input */
        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
            width: 100%;
        }
        
        .file-input-label {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 16px 24px;
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(147, 51, 234, 0.1));
            border: 2px dashed rgba(59, 130, 246, 0.3);
            border-radius: 12px;
            color: #60a5fa;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }
        
        .file-input-label:hover {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(147, 51, 234, 0.2));
            border-color: rgba(59, 130, 246, 0.5);
            transform: translateY(-2px);
        }
        
        .file-input-wrapper input[type="file"] {
            position: absolute;
            left: -9999px;
        }
        
        .file-selected {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(34, 197, 94, 0.1)) !important;
            border-color: rgba(16, 185, 129, 0.3) !important;
            color: #34d399 !important;
        }
        
        /* Marketing Page Styles */
        .marketing-stat-card {
            background: linear-gradient(145deg, rgba(30, 41, 59, 0.8), rgba(15, 23, 42, 0.7));
            border: 1px solid rgba(71, 85, 105, 0.3);
            border-radius: 16px;
            padding: 20px;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .marketing-stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            border-color: rgba(255, 255, 255, 0.2);
        }
        
        .marketing-stat-card:hover .stat-value {
            transform: scale(1.05);
        }
        
        .marketing-stat-card .stat-value {
            transition: transform 0.3s ease;
        }
        
        .pipeline-stages {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }
        
        .pipeline-stage {
            padding: 20px;
            border-radius: 16px;
            border: 1px solid;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .pipeline-stage:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }
        
        .pipeline-icon {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            margin-bottom: 15px;
        }
        
        .pipeline-info {
            margin-bottom: 15px;
        }
        
        .pipeline-count {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 5px;
        }
        
        .pipeline-label {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 5px;
        }
        
        .pipeline-value {
            font-size: 16px;
            font-weight: 600;
        }
        
        .pipeline-progress {
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            overflow: hidden;
        }
        
        .progress-bar {
            height: 100%;
            border-radius: 3px;
            transition: width 0.3s ease;
        }
        
        /* Customer List */
        .customer-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .customer-item {
            display: flex;
            align-items: center;
            padding: 20px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }
        
        .customer-item:hover {
            background: rgba(255, 255, 255, 0.06);
            transform: translateX(8px);
        }
        
        .customer-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            margin-right: 15px;
            flex-shrink: 0;
        }
        
        .customer-info {
            flex: 1;
        }
        
        .customer-name {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .customer-stage {
            padding: 3px 10px;
            border-radius: 8px;
            font-size: 11px;
            font-weight: 600;
            border: 1px solid;
        }
        
        .customer-details {
            display: flex;
            gap: 20px;
            font-size: 13px;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 5px;
        }
        
        .customer-meta {
            display: flex;
            align-items: center;
            font-size: 12px;
            color: rgba(255, 255, 255, 0.5);
        }
        
        .btn-icon {
            width: 36px;
            height: 36px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.7);
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .btn-icon:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .status-verified { 
            background: linear-gradient(135deg, #10b981, #059669); 
            color: white; 
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
        }
        .status-pending { 
            background: linear-gradient(135deg, #f59e0b, #d97706); 
            color: white; 
            box-shadow: 0 4px 15px rgba(245, 158, 11, 0.3);
        }
        .status-rejected { 
            background: linear-gradient(135deg, #ef4444, #dc2626); 
            color: white; 
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
        }
        .status-active { 
            background: linear-gradient(135deg, #f97316, #ea580c); 
            color: white; 
            box-shadow: 0 4px 15px rgba(249, 115, 22, 0.3);
        }

        /* Loading spinner */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Notifications */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.95), rgba(5, 150, 105, 0.95));
            backdrop-filter: blur(15px);
            color: white;
            padding: 15px 20px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 
                0 8px 25px rgba(0, 0, 0, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
            z-index: 1001;
            animation: slideIn 0.3s ease;
            font-weight: 500;
        }

        .notification.error {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.95), rgba(220, 38, 38, 0.95));
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .app-container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                height: auto;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="logo">
                <span class="material-icons" style="font-size: 32px; vertical-align: middle; margin-right: 10px;">flight_takeoff</span>
                VT Manager
            </div>
            
            <div class="nav-item active" data-page="dashboard">
                <span class="material-icons">dashboard</span>
                Dashboard
            </div>
            
            <div class="nav-item" data-page="jamaah">
                <span class="material-icons">people</span>
                Manajemen Jamaah
            </div>
            
            <div class="nav-item" data-page="packages">
                <span class="material-icons">card_travel</span>
                Paket Umroh
            </div>
            
            <div class="nav-item" data-page="payments">
                <span class="material-icons">payment</span>
                Pembayaran
            </div>
            
            <div class="nav-item" data-page="documents">
                <span class="material-icons">description</span>
                Dokumen
            </div>
            
            <div class="nav-item" data-page="groups">
                <span class="material-icons">group</span>
                Grup Keberangkatan
            </div>
            
            <div class="nav-item" data-page="marketing">
                <span class="material-icons">campaign</span>
                <span>Marketing</span>
                <span class="badge" style="background: #EC4899; color: white; padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: 600; margin-left: auto;">AI</span>
            </div>
            
            <div class="nav-item" data-page="hotel">
                <span class="material-icons">hotel</span>
                <span>Hotel</span>
                <span class="badge" style="background: #059669; color: white; padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: 600; margin-left: auto;">New</span>
            </div>
            
            <div class="nav-item" data-page="inventory">
                <span class="material-icons">inventory</span>
                <span>Perlengkapan</span>
                <span class="badge" style="background: #7C3AED; color: white; padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: 600; margin-left: auto;">New</span>
            </div>
            
            <div class="nav-item" data-page="flights">
                <span class="material-icons">flight</span>
                <span>Tiket Penerbangan</span>
                <span class="badge" style="background: #F59E0B; color: white; padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: 600; margin-left: auto;">PNR</span>
            </div>
            
            <div class="nav-item" data-page="groundHandling">
                <span class="material-icons">flight_takeoff</span>
                <span>Ground Handling</span>
                <span class="badge" style="background: #3B82F6; color: white; padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: 600; margin-left: auto;">New</span>
            </div>
            
            <div class="nav-item" onclick="window.location.href='reports-system.html'">
                <span class="material-icons">assessment</span>
                Laporan
            </div>
            
            <div class="nav-item" onclick="window.location.href='excel-system.html'">
                <span class="material-icons">table_chart</span>
                Excel Import/Export
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Dashboard Page -->
            <div id="dashboard" class="page active">
                <div class="glass-card">
                    <h2><span class="material-icons" style="vertical-align: middle; margin-right: 10px;">dashboard</span>Dashboard Umroh</h2>
                    <p style="color: rgba(255, 255, 255, 0.8); margin-bottom: 30px;">Ringkasan data dan statistik sistem manajemen umroh</p>
                    
                    <!-- Stats Cards -->
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-icon material-icons">people</div>
                            <div class="stat-number" id="totalJamaah">1,247</div>
                            <div class="stat-label">Total Jamaah</div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-icon material-icons">verified</div>
                            <div class="stat-number" id="verifiedJamaah">1,089</div>
                            <div class="stat-label">Jamaah Terverifikasi</div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-icon material-icons">card_travel</div>
                            <div class="stat-number" id="activePackages">15</div>
                            <div class="stat-label">Paket Aktif</div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-icon material-icons">attach_money</div>
                            <div class="stat-number" id="totalRevenue">24.8B</div>
                            <div class="stat-label">Total Revenue (IDR)</div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-icon material-icons">flight_takeoff</div>
                            <div class="stat-number" id="totalDepartures">42</div>
                            <div class="stat-label">Total Keberangkatan</div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-icon material-icons">pending</div>
                            <div class="stat-number" id="pendingPayments">23</div>
                            <div class="stat-label">Pembayaran Pending</div>
                        </div>
                    </div>
                    
                    <!-- Charts -->
                    <div class="dashboard-charts">
                        <div class="chart-wrapper">
                            <h3>Registrasi Jamaah Bulanan</h3>
                            <canvas id="jamaahChart"></canvas>
                        </div>
                        
                        <div class="chart-wrapper">
                            <h3>Revenue per Paket</h3>
                            <canvas id="revenueChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Jamaah Management Page -->
            <div id="jamaah" class="page">
                <div class="glass-card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2><span class="material-icons" style="vertical-align: middle; margin-right: 10px;">people</span>Manajemen Jamaah</h2>
                        <button class="btn btn-primary" onclick="openModal('jamaahModal')">
                            <span class="material-icons">add</span>
                            Tambah Jamaah
                        </button>
                    </div>
                    
                    <!-- Filters -->
                    <div class="filters">
                        <div class="filter-group">
                            <label>Cari Jamaah</label>
                            <input type="text" id="searchJamaah" placeholder="Nama, NIK, atau No. Telepon">
                        </div>
                        <div class="filter-group">
                            <label>Paket</label>
                            <select id="filterPackage">
                                <option value="">Semua Paket</option>
                                <option value="1">Umroh Ramadhan 2024</option>
                                <option value="2">Umroh Plus Turki</option>
                                <option value="3">Umroh Keluarga</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>Status</label>
                            <select id="filterStatus">
                                <option value="">Semua Status</option>
                                <option value="verified">Terverifikasi</option>
                                <option value="pending">Pending</option>
                                <option value="rejected">Ditolak</option>
                            </select>
                        </div>
                        <div style="margin-top: 15px;">
                            <button class="btn btn-primary" onclick="filterJamaah()">
                                <span class="material-icons">search</span>
                                Filter
                            </button>
                        </div>
                    </div>
                    
                    <!-- Jamaah Table -->
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>No</th>
                                    <th>Nama Lengkap</th>
                                    <th>NIK</th>
                                    <th>No. Telepon</th>
                                    <th>Paspor</th>
                                    <th>Paket</th>
                                    <th>Status</th>
                                    <th>Total Bayar</th>
                                    <th>Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="jamaahTableBody">
                                <!-- Data will be populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Packages Page -->
            <div id="packages" class="page">
                <div class="glass-card" style="padding: 35px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 35px; padding-bottom: 20px; border-bottom: 1px solid rgba(255, 255, 255, 0.1);">
                        <div>
                            <h2 style="margin: 0;"><span class="material-icons" style="vertical-align: middle; margin-right: 10px; background: linear-gradient(135deg, #3b82f6, #10b981); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">card_travel</span>Paket Umroh</h2>
                            <p style="color: rgba(255, 255, 255, 0.7); margin: 5px 0 0 0;">Kelola semua paket umroh yang tersedia</p>
                        </div>
                        <button class="btn btn-primary" onclick="openModal('packageModal')" style="padding: 12px 24px;">
                            <span class="material-icons">add</span>
                            Tambah Paket
                        </button>
                    </div>
                    
                    <!-- Package Cards -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(450px, 1fr)); gap: 30px; padding: 10px 0;" id="packageGrid">
                        <!-- Package cards will be populated by JavaScript -->
                    </div>
                </div>
            </div>

            <!-- Payments Page -->
            <div id="payments" class="page">
                <div class="glass-card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2><span class="material-icons" style="vertical-align: middle; margin-right: 10px;">payment</span>Manajemen Pembayaran</h2>
                        <button class="btn btn-primary" onclick="openModal('paymentModal')">
                            <span class="material-icons">add</span>
                            Catat Pembayaran
                        </button>
                    </div>
                    
                    <!-- Payment Stats -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                        <div class="stat-card">
                            <div class="stat-number">Rp 24.8B</div>
                            <div class="stat-label">Total Pembayaran</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">Rp 22.1B</div>
                            <div class="stat-label">Terverifikasi</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">Rp 2.7B</div>
                            <div class="stat-label">Pending</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">23</div>
                            <div class="stat-label">Transaksi Pending</div>
                        </div>
                    </div>
                    
                    <!-- Payment Table -->
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Tanggal</th>
                                    <th>Jamaah</th>
                                    <th>Paket</th>
                                    <th>Jumlah</th>
                                    <th>Metode</th>
                                    <th>Status</th>
                                    <th>Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="paymentTableBody">
                                <!-- Data will be populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Documents Page -->
            <div id="documents" class="page">
                <div class="glass-card">
                    <h2><span class="material-icons" style="vertical-align: middle; margin-right: 10px;">description</span>Manajemen Dokumen</h2>
                    
                    <!-- Document Stats -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin: 20px 0;">
                        <div class="stat-card">
                            <div class="stat-number">1,247</div>
                            <div class="stat-label">Total Dokumen</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">1,089</div>
                            <div class="stat-label">Terverifikasi</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">158</div>
                            <div class="stat-label">Pending</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">23</div>
                            <div class="stat-label">Ditolak</div>
                        </div>
                    </div>
                    
                    <!-- Document Upload -->
                    <div class="file-upload" onclick="document.getElementById('docUpload').click()" ondrop="handleDrop(event)" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)">
                        <span class="material-icons" style="font-size: 48px; color: rgba(255, 255, 255, 0.6); margin-bottom: 10px;">cloud_upload</span>
                        <p style="color: white; margin-bottom: 10px;">Klik atau drag & drop untuk upload dokumen</p>
                        <p style="color: rgba(255, 255, 255, 0.6); font-size: 12px;">Mendukung: PDF, JPG, PNG, DOC, DOCX (Max: 10MB)</p>
                        <input type="file" id="docUpload" multiple accept=".pdf,.jpg,.jpeg,.png,.doc,.docx" style="display: none;" onchange="handleFileUpload(event)">
                    </div>
                    
                    <!-- Document Table -->
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Jamaah</th>
                                    <th>Jenis Dokumen</th>
                                    <th>File</th>
                                    <th>Upload Date</th>
                                    <th>Status</th>
                                    <th>Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="documentTableBody">
                                <!-- Data will be populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Groups Page -->
            <div id="groups" class="page">
                <div class="glass-card">
                    <div class="header-section">
                        <h2><span class="material-icons" style="vertical-align: middle; margin-right: 10px;">group</span>Grup Keberangkatan</h2>
                        <button class="btn btn-primary" onclick="openModal('groupModal')">
                            <span class="material-icons">add</span>
                            Buat Grup Baru
                        </button>
                    </div>
                    
                    <!-- Group Cards -->
                    <div class="cards-grid" id="groupGrid">
                        <!-- Group cards will be populated by JavaScript -->
                    </div>
                </div>
            </div>

            <!-- Marketing Page -->
            <div id="marketing" class="page">
                <div class="glass-card">
                    <h2><span class="material-icons" style="vertical-align: middle; margin-right: 10px; background: linear-gradient(135deg, #EC4899, #F472B6); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">campaign</span>Marketing Dashboard AI</h2>
                    <p style="color: rgba(255, 255, 255, 0.7); margin-bottom: 30px;">Kelola leads dengan AI auto-reply dan pipeline management</p>
                    
                    <!-- Statistics Grid -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 30px;">
                        <div class="stat-card" style="background: linear-gradient(145deg, rgba(59, 130, 246, 0.15), rgba(96, 165, 250, 0.1)); border: 1px solid rgba(59, 130, 246, 0.3);">
                            <div class="stat-icon material-icons" style="color: #3B82F6;">people</div>
                            <div class="stat-number" style="color: #60A5FA;">3,248</div>
                            <div class="stat-label">Leads Tahun Ini</div>
                        </div>
                        <div class="stat-card" style="background: linear-gradient(145deg, rgba(139, 92, 246, 0.15), rgba(167, 139, 250, 0.1)); border: 1px solid rgba(139, 92, 246, 0.3);">
                            <div class="stat-icon material-icons" style="color: #8B5CF6;">calendar_month</div>
                            <div class="stat-number" style="color: #A78BFA;">342</div>
                            <div class="stat-label">Leads Bulan Ini</div>
                        </div>
                        <div class="stat-card" style="background: linear-gradient(145deg, rgba(236, 72, 153, 0.15), rgba(244, 114, 182, 0.1)); border: 1px solid rgba(236, 72, 153, 0.3);">
                            <div class="stat-icon material-icons" style="color: #EC4899;">today</div>
                            <div class="stat-number" style="color: #F472B6;">18</div>
                            <div class="stat-label">Leads Hari Ini</div>
                        </div>
                        <div class="stat-card" style="background: linear-gradient(145deg, rgba(245, 158, 11, 0.15), rgba(252, 211, 77, 0.1)); border: 1px solid rgba(245, 158, 11, 0.3);">
                            <div class="stat-icon material-icons" style="color: #F59E0B;">schedule</div>
                            <div class="stat-number" style="color: #FCD34D;">12</div>
                            <div class="stat-label">Leads Kemarin</div>
                        </div>
                        <div class="stat-card" style="background: linear-gradient(145deg, rgba(16, 185, 129, 0.15), rgba(52, 211, 153, 0.1)); border: 1px solid rgba(16, 185, 129, 0.3);">
                            <div class="stat-icon material-icons" style="color: #10B981;">attach_money</div>
                            <div class="stat-number" style="color: #34D399;">45</div>
                            <div class="stat-label">Closing Bulan Ini</div>
                        </div>
                        <div class="stat-card" style="background: linear-gradient(145deg, rgba(16, 185, 129, 0.15), rgba(52, 211, 153, 0.1)); border: 1px solid rgba(16, 185, 129, 0.3);">
                            <div class="stat-icon material-icons" style="color: #10B981;">check_circle</div>
                            <div class="stat-number" style="color: #34D399;">3</div>
                            <div class="stat-label">Closing Hari Ini</div>
                        </div>
                    </div>
                    
                    <!-- WhatsApp Integration Section -->
                    <div class="glass-card" style="margin-bottom: 30px; background: linear-gradient(145deg, rgba(37, 211, 102, 0.1), rgba(18, 140, 126, 0.1)); border: 1px solid rgba(37, 211, 102, 0.3);">
                        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 20px;">
                            <div>
                                <h3 style="margin: 0 0 10px 0; color: #25D366;">
                                    <span class="material-icons" style="vertical-align: middle; margin-right: 10px;">chat</span>
                                    WhatsApp Integration
                                </h3>
                                <p style="margin: 0; color: rgba(255, 255, 255, 0.7);">Sambungkan WhatsApp Anda untuk auto-reply dan broadcast pesan ke leads</p>
                            </div>
                            <div style="display: flex; gap: 15px; align-items: center;">
                                <div id="waConnectionStatus" style="display: none;">
                                    <span class="badge" style="background: rgba(16, 185, 129, 0.2); color: #10B981; padding: 8px 16px;">
                                        <span class="material-icons" style="font-size: 16px; vertical-align: middle;">check_circle</span>
                                        Terhubung: <span id="waConnectedNumber"></span>
                                    </span>
                                </div>
                                
                                <!-- Leads Bot Toggle -->
                                <div style="display: flex; align-items: center; gap: 10px; background: rgba(255, 255, 255, 0.05); padding: 8px 16px; border-radius: 8px; border: 1px solid rgba(255, 255, 255, 0.1);">
                                    <label class="switch" style="margin: 0;">
                                        <input type="checkbox" id="leadsBotToggle" onchange="toggleLeadsBot(this)">
                                        <span class="slider round"></span>
                                    </label>
                                    <span style="font-size: 14px; font-weight: 500; color: #25D366;">Leads Bot</span>
                                </div>
                                
                                <button class="btn btn-primary" onclick="connectWhatsApp()" style="background: linear-gradient(135deg, #25D366, #128C7E);">
                                    <span class="material-icons">qr_code_scanner</span>
                                    Sambung ke WhatsApp
                                </button>
                                <button class="btn btn-warning" onclick="restartWhatsAppSession()" style="background: linear-gradient(135deg, #FFA726, #FB8C00);">
                                    <span class="material-icons">restart_alt</span>
                                    Restart Session
                                </button>
                                <button class="btn btn-danger" onclick="disconnectWhatsApp()" style="display: none;" id="waDisconnectBtn">
                                    <span class="material-icons">link_off</span>
                                    Putuskan
                                </button>
                                <button class="btn btn-success" onclick="openWhatsAppChat()" style="background: linear-gradient(135deg, #25D366, #128C7E);">
                                    <span class="material-icons">chat</span>
                                    Buka WA
                                </button>
                            </div>
                        </div>
                        
                        <!-- WhatsApp Monitoring Dashboard -->
                        <div class="glass-card" style="margin-top: 30px; margin-bottom: 30px;">
                            <h3 style="margin-bottom: 20px;">
                                <span class="material-icons" style="vertical-align: middle; margin-right: 10px;">monitoring</span>
                                WhatsApp Monitoring Dashboard
                            </h3>
                            
                            <!-- Connection Status -->
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px;">
                                <div style="padding: 20px; background: rgba(255, 255, 255, 0.05); border-radius: 12px; border: 1px solid rgba(255, 255, 255, 0.1);">
                                    <h4 style="margin-bottom: 15px; font-size: 16px;">Connection Status</h4>
                                    <div id="waMonitoringStatus" style="display: flex; align-items: center; gap: 10px;">
                                        <div id="waStatusIndicator" style="width: 12px; height: 12px; border-radius: 50%; background: #EF4444;"></div>
                                        <span id="waStatusText" style="font-weight: 500;">Disconnected</span>
                                    </div>
                                    <div style="margin-top: 15px; font-size: 13px; color: rgba(255, 255, 255, 0.6);">
                                        <div>Session: <span id="waSessionName">default</span></div>
                                        <div>Status: <span id="waSessionStatus">-</span></div>
                                        <div>Last Check: <span id="waLastCheck">-</span></div>
                                    </div>
                                </div>
                                
                                <div style="padding: 20px; background: rgba(255, 255, 255, 0.05); border-radius: 12px; border: 1px solid rgba(255, 255, 255, 0.1);">
                                    <h4 style="margin-bottom: 15px; font-size: 16px;">Session Info</h4>
                                    <div style="font-size: 13px; color: rgba(255, 255, 255, 0.8);">
                                        <div style="margin-bottom: 10px;">Phone: <strong id="waPhoneInfo">-</strong></div>
                                        <div style="margin-bottom: 10px;">Name: <strong id="waNameInfo">-</strong></div>
                                        <div>Engine: <strong id="waEngineInfo">-</strong></div>
                                    </div>
                                </div>
                                
                                <div style="padding: 20px; background: rgba(255, 255, 255, 0.05); border-radius: 12px; border: 1px solid rgba(255, 255, 255, 0.1);">
                                    <h4 style="margin-bottom: 15px; font-size: 16px;">Message Stats (Today)</h4>
                                    <div style="font-size: 13px; color: rgba(255, 255, 255, 0.8);">
                                        <div style="margin-bottom: 10px;">Messages Received: <strong id="waMsgReceived">0</strong></div>
                                        <div style="margin-bottom: 10px;">Messages Sent: <strong id="waMsgSent">0</strong></div>
                                        <div>Auto Replies: <strong id="waAutoReplies">0</strong></div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Auto Refresh Toggle -->
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 20px;">
                                <input type="checkbox" id="waAutoRefresh" checked style="width: 16px; height: 16px;">
                                <label for="waAutoRefresh" style="font-size: 14px;">Auto refresh every 10 seconds</label>
                                <button class="btn btn-sm" onclick="refreshWhatsAppStatus()" style="margin-left: auto;">
                                    <span class="material-icons" style="font-size: 16px;">refresh</span>
                                    Refresh Now
                                </button>
                            </div>
                        </div>
                        
                        <!-- WhatsApp Features -->
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-top: 25px;">
                            <div style="padding: 20px; background: rgba(255, 255, 255, 0.05); border-radius: 12px; border: 1px solid rgba(255, 255, 255, 0.1);">
                                <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
                                    <div style="width: 48px; height: 48px; background: rgba(37, 211, 102, 0.2); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                                        <span class="material-icons" style="color: #25D366;">reply</span>
                                    </div>
                                    <div>
                                        <h4 style="margin: 0; font-size: 16px;">Auto Reply</h4>
                                        <p style="margin: 0; font-size: 13px; color: rgba(255, 255, 255, 0.6);">Balas otomatis 24/7</p>
                                    </div>
                                </div>
                                <p style="font-size: 13px; line-height: 1.6; color: rgba(255, 255, 255, 0.8); margin: 0;">
                                    Sistem akan membalas pesan masuk secara otomatis dengan informasi paket umroh dan harga
                                </p>
                            </div>
                            
                            <div style="padding: 20px; background: rgba(255, 255, 255, 0.05); border-radius: 12px; border: 1px solid rgba(255, 255, 255, 0.1);">
                                <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
                                    <div style="width: 48px; height: 48px; background: rgba(37, 211, 102, 0.2); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                                        <span class="material-icons" style="color: #25D366;">send</span>
                                    </div>
                                    <div>
                                        <h4 style="margin: 0; font-size: 16px;">Broadcast Message</h4>
                                        <p style="margin: 0; font-size: 13px; color: rgba(255, 255, 255, 0.6);">Kirim ke banyak kontak</p>
                                    </div>
                                </div>
                                <p style="font-size: 13px; line-height: 1.6; color: rgba(255, 255, 255, 0.8); margin: 0;">
                                    Kirim promo, info keberangkatan, atau pengumuman ke semua leads sekaligus
                                </p>
                            </div>
                            
                            <div style="padding: 20px; background: rgba(255, 255, 255, 0.05); border-radius: 12px; border: 1px solid rgba(255, 255, 255, 0.1);">
                                <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
                                    <div style="width: 48px; height: 48px; background: rgba(37, 211, 102, 0.2); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                                        <span class="material-icons" style="color: #25D366;">analytics</span>
                                    </div>
                                    <div>
                                        <h4 style="margin: 0; font-size: 16px;">Lead Tracking</h4>
                                        <p style="margin: 0; font-size: 13px; color: rgba(255, 255, 255, 0.6);">Otomatis catat leads</p>
                                    </div>
                                </div>
                                <p style="font-size: 13px; line-height: 1.6; color: rgba(255, 255, 255, 0.8); margin: 0;">
                                    Setiap chat WhatsApp otomatis tercatat sebagai leads dengan riwayat lengkap
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Pipeline Overview -->
                    <div class="glass-card" style="margin-bottom: 30px;">
                        <h3 style="margin-bottom: 20px;">Pipeline Overview Tahun Ini</h3>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px;">
                            <div style="text-align: center; padding: 20px; background: rgba(59, 130, 246, 0.1); border-radius: 12px;">
                                <div style="font-size: 48px; font-weight: 700; color: #3B82F6;">1,847</div>
                                <div style="color: rgba(255, 255, 255, 0.8);">Leads</div>
                                <div class="progress-bar" style="background: rgba(59, 130, 246, 0.2); margin-top: 10px;">
                                    <div style="width: 100%; background: #3B82F6;"></div>
                                </div>
                            </div>
                            <div style="text-align: center; padding: 20px; background: rgba(245, 158, 11, 0.1); border-radius: 12px;">
                                <div style="font-size: 48px; font-weight: 700; color: #F59E0B;">892</div>
                                <div style="color: rgba(255, 255, 255, 0.8);">Interest</div>
                                <div class="progress-bar" style="background: rgba(245, 158, 11, 0.2); margin-top: 10px;">
                                    <div style="width: 48%; background: #F59E0B;"></div>
                                </div>
                            </div>
                            <div style="text-align: center; padding: 20px; background: rgba(16, 185, 129, 0.1); border-radius: 12px;">
                                <div style="font-size: 48px; font-weight: 700; color: #10B981;">345</div>
                                <div style="color: rgba(255, 255, 255, 0.8);">Booked</div>
                                <div class="progress-bar" style="background: rgba(16, 185, 129, 0.2); margin-top: 10px;">
                                    <div style="width: 19%; background: #10B981;"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Customer List -->
                    <div class="glass-card">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3>Customer Pipeline</h3>
                            <div style="display: flex; gap: 10px;">
                                <div class="search-box">
                                    <span class="material-icons">search</span>
                                    <input type="text" placeholder="Cari nama atau nomor...">
                                </div>
                                <button class="btn btn-outline" style="border-color: #3B82F6; color: #3B82F6;">Leads</button>
                                <button class="btn btn-outline" style="border-color: #F59E0B; color: #F59E0B;">Interest</button>
                                <button class="btn btn-outline" style="border-color: #10B981; color: #10B981;">Booked</button>
                                <button class="btn btn-success">
                                    <span class="material-icons">refresh</span>
                                    Refresh
                                </button>
                            </div>
                        </div>
                        
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Customer</th>
                                        <th>WhatsApp</th>
                                        <th>Stage</th>
                                        <th>Last Contact</th>
                                        <th>Summary</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>
                                            <div style="display: flex; align-items: center; gap: 10px;">
                                                <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #3B82F6, #60A5FA); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600;">AH</div>
                                                <div>
                                                    <div style="font-weight: 600;">Ahmad Hidayat</div>
                                                    <div style="font-size: 12px; color: rgba(255, 255, 255, 0.6);">3 messages</div>
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            <button class="btn btn-sm" style="background: linear-gradient(135deg, #25D366, #128C7E); color: white;">
                                                <span class="material-icons">chat</span>
                                                +62 812-3456-7890
                                            </button>
                                        </td>
                                        <td><span class="badge" style="background: rgba(59, 130, 246, 0.2); color: #3B82F6;">Leads</span></td>
                                        <td>
                                            <div style="font-size: 12px;">
                                                <div>2 jam yang lalu</div>
                                                <div style="color: rgba(255, 255, 255, 0.5);">Last: Customer</div>
                                            </div>
                                        </td>
                                        <td style="max-width: 200px;">
                                            <div style="font-size: 12px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">Tanya paket umroh bulan April, 15 hari</div>
                                        </td>
                                        <td>
                                            <div style="display: flex; gap: 5px;">
                                                <button class="btn btn-sm btn-icon" title="Change Stage">
                                                    <span class="material-icons">swap_horiz</span>
                                                </button>
                                                <button class="btn btn-sm btn-icon" title="View Details">
                                                    <span class="material-icons">visibility</span>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>
                                            <div style="display: flex; align-items: center; gap: 10px;">
                                                <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #F59E0B, #FCD34D); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600;">SR</div>
                                                <div>
                                                    <div style="font-weight: 600;">Siti Rahmawati</div>
                                                    <div style="font-size: 12px; color: rgba(255, 255, 255, 0.6);">15 messages</div>
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            <button class="btn btn-sm" style="background: linear-gradient(135deg, #25D366, #128C7E); color: white;">
                                                <span class="material-icons">chat</span>
                                                +62 819-8765-4321
                                            </button>
                                        </td>
                                        <td><span class="badge" style="background: rgba(245, 158, 11, 0.2); color: #F59E0B;">Interest</span></td>
                                        <td>
                                            <div style="font-size: 12px;">
                                                <div>1 hari yang lalu</div>
                                                <div style="color: rgba(255, 255, 255, 0.5);">Last: Agent</div>
                                            </div>
                                        </td>
                                        <td style="max-width: 200px;">
                                            <div style="font-size: 12px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">Diskusi hotel, minta quad room, 4 orang</div>
                                        </td>
                                        <td>
                                            <div style="display: flex; gap: 5px;">
                                                <button class="btn btn-sm btn-icon" title="Change Stage">
                                                    <span class="material-icons">swap_horiz</span>
                                                </button>
                                                <button class="btn btn-sm btn-icon" title="View Details">
                                                    <span class="material-icons">visibility</span>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>
                                            <div style="display: flex; align-items: center; gap: 10px;">
                                                <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #10B981, #34D399); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600;">MF</div>
                                                <div>
                                                    <div style="font-weight: 600;">Muhammad Fadli</div>
                                                    <div style="font-size: 12px; color: rgba(255, 255, 255, 0.6);">28 messages</div>
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            <button class="btn btn-sm" style="background: linear-gradient(135deg, #25D366, #128C7E); color: white;">
                                                <span class="material-icons">chat</span>
                                                +62 856-7890-1234
                                            </button>
                                        </td>
                                        <td><span class="badge" style="background: rgba(16, 185, 129, 0.2); color: #10B981;">Booked</span></td>
                                        <td>
                                            <div style="font-size: 12px;">
                                                <div>3 hari yang lalu</div>
                                                <div style="color: rgba(255, 255, 255, 0.5);">Last: Payment</div>
                                            </div>
                                        </td>
                                        <td style="max-width: 200px;">
                                            <div style="font-size: 12px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">Sudah DP 10jt, paket VIP Maret</div>
                                        </td>
                                        <td>
                                            <div style="display: flex; gap: 5px;">
                                                <button class="btn btn-sm btn-icon" title="Payment Reminder">
                                                    <span class="material-icons">notifications</span>
                                                </button>
                                                <button class="btn btn-sm btn-icon" title="View Details">
                                                    <span class="material-icons">visibility</span>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Hotel Page -->
            <div id="hotel" class="page">
                <div class="glass-card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2><span class="material-icons" style="vertical-align: middle; margin-right: 10px; color: #059669;">hotel</span>Manajemen Hotel</h2>
                        <button class="btn btn-primary" onclick="openHotelModal()">
                            <span class="material-icons">add</span>
                            Tambah Hotel
                        </button>
                    </div>
                    
                    <!-- Summary Cards -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 30px;">
                        <div class="stat-card" style="background: linear-gradient(145deg, rgba(5, 150, 105, 0.15), rgba(16, 185, 129, 0.1)); border: 1px solid rgba(5, 150, 105, 0.3);">
                            <div class="stat-icon material-icons" style="color: #059669;">hotel</div>
                            <div class="stat-number" style="color: #10B981;">12</div>
                            <div class="stat-label">Total Hotels</div>
                        </div>
                        <div class="stat-card" style="background: linear-gradient(145deg, rgba(16, 185, 129, 0.15), rgba(52, 211, 153, 0.1)); border: 1px solid rgba(16, 185, 129, 0.3);">
                            <div class="stat-icon material-icons" style="color: #10B981;">check_circle</div>
                            <div class="stat-number" style="color: #34D399;">8</div>
                            <div class="stat-label">Visa Approved</div>
                        </div>
                        <div class="stat-card" style="background: linear-gradient(145deg, rgba(245, 158, 11, 0.15), rgba(252, 211, 77, 0.1)); border: 1px solid rgba(245, 158, 11, 0.3);">
                            <div class="stat-icon material-icons" style="color: #F59E0B;">payment</div>
                            <div class="stat-number" style="color: #FCD34D;">5</div>
                            <div class="stat-label">Fully Paid</div>
                        </div>
                        <div class="stat-card" style="background: linear-gradient(145deg, rgba(59, 130, 246, 0.15), rgba(96, 165, 250, 0.1)); border: 1px solid rgba(59, 130, 246, 0.3);">
                            <div class="stat-icon material-icons" style="color: #3B82F6;">single_bed</div>
                            <div class="stat-number" style="color: #60A5FA;">245</div>
                            <div class="stat-label">Total Rooms</div>
                        </div>
                    </div>
                    
                    <!-- Hotels Table -->
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Hotel</th>
                                    <th>Package</th>
                                    <th>Check In/Out</th>
                                    <th>Rooms</th>
                                    <th>Visa Status</th>
                                    <th>Payment</th>
                                    <th>Provider</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>
                                        <div>
                                            <div style="font-weight: 600;">Hilton Suites Makkah</div>
                                            <div style="font-size: 12px; color: rgba(255, 255, 255, 0.6);">
                                                <span class="material-icons" style="font-size: 14px; vertical-align: middle;">location_city</span>
                                                Makkah
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <div style="font-size: 12px;">UMR2025 - Umroh Ramadhan</div>
                                    </td>
                                    <td>
                                        <div style="font-size: 12px;">
                                            <div>In: 15 Mar 2025</div>
                                            <div>Out: 20 Mar 2025</div>
                                            <span class="badge" style="background: rgba(59, 130, 246, 0.2); color: #3B82F6;">5 nights</span>
                                        </div>
                                    </td>
                                    <td>
                                        <div style="font-size: 12px; text-align: center;">
                                            <div>Quad: 20</div>
                                            <div>Double: 10</div>
                                            <div style="font-weight: 600;">Total: 30</div>
                                        </div>
                                    </td>
                                    <td>
                                        <span class="badge" style="background: rgba(16, 185, 129, 0.2); color: #10B981;">approved</span>
                                    </td>
                                    <td>
                                        <div>
                                            <span class="badge" style="background: rgba(16, 185, 129, 0.2); color: #10B981;">paid</span>
                                            <div style="font-size: 11px; margin-top: 4px;">Rp 450.000.000</div>
                                            <div class="progress-bar" style="margin-top: 4px; height: 4px;">
                                                <div style="width: 100%; background: #10B981;"></div>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <div style="font-size: 12px;">
                                            <div>Al-Haramain Tours</div>
                                            <div style="color: rgba(255, 255, 255, 0.6);">+966 55 123 4567</div>
                                        </div>
                                    </td>
                                    <td>
                                        <div style="display: flex; gap: 5px;">
                                            <button class="btn btn-sm btn-icon" title="View Details">
                                                <span class="material-icons">visibility</span>
                                            </button>
                                            <button class="btn btn-sm btn-icon" title="Edit">
                                                <span class="material-icons">edit</span>
                                            </button>
                                            <button class="btn btn-sm btn-icon" style="color: #EF4444;" title="Delete">
                                                <span class="material-icons">delete</span>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <div>
                                            <div style="font-weight: 600;">Swissotel Al Maqam</div>
                                            <div style="font-size: 12px; color: rgba(255, 255, 255, 0.6);">
                                                <span class="material-icons" style="font-size: 14px; vertical-align: middle;">location_city</span>
                                                Makkah
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <div style="font-size: 12px;">UMR2025V - Umroh VIP</div>
                                    </td>
                                    <td>
                                        <div style="font-size: 12px;">
                                            <div>In: 20 Apr 2025</div>
                                            <div>Out: 25 Apr 2025</div>
                                            <span class="badge" style="background: rgba(59, 130, 246, 0.2); color: #3B82F6;">5 nights</span>
                                        </div>
                                    </td>
                                    <td>
                                        <div style="font-size: 12px; text-align: center;">
                                            <div>Double: 15</div>
                                            <div>Triple: 5</div>
                                            <div style="font-weight: 600;">Total: 20</div>
                                        </div>
                                    </td>
                                    <td>
                                        <span class="badge" style="background: rgba(245, 158, 11, 0.2); color: #F59E0B;">pending</span>
                                    </td>
                                    <td>
                                        <div>
                                            <span class="badge" style="background: rgba(245, 158, 11, 0.2); color: #F59E0B;">partial</span>
                                            <div style="font-size: 11px; margin-top: 4px;">Rp 200M / 350M</div>
                                            <div class="progress-bar" style="margin-top: 4px; height: 4px;">
                                                <div style="width: 57%; background: #F59E0B;"></div>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <div style="font-size: 12px;">
                                            <div>Makkah Hospitality</div>
                                            <div style="color: rgba(255, 255, 255, 0.6);">+966 50 987 6543</div>
                                        </div>
                                    </td>
                                    <td>
                                        <div style="display: flex; gap: 5px;">
                                            <button class="btn btn-sm btn-icon" title="Upload Document">
                                                <span class="material-icons">upload</span>
                                            </button>
                                            <button class="btn btn-sm btn-icon" title="Add Payment">
                                                <span class="material-icons">payment</span>
                                            </button>
                                            <button class="btn btn-sm btn-icon" title="Edit">
                                                <span class="material-icons">edit</span>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <div>
                                            <div style="font-weight: 600;">Madinah Hilton</div>
                                            <div style="font-size: 12px; color: rgba(255, 255, 255, 0.6);">
                                                <span class="material-icons" style="font-size: 14px; vertical-align: middle;">location_city</span>
                                                Madinah
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <div style="font-size: 12px;">UMR2025 - Umroh Ramadhan</div>
                                    </td>
                                    <td>
                                        <div style="font-size: 12px;">
                                            <div>In: 20 Mar 2025</div>
                                            <div>Out: 25 Mar 2025</div>
                                            <span class="badge" style="background: rgba(59, 130, 246, 0.2); color: #3B82F6;">5 nights</span>
                                        </div>
                                    </td>
                                    <td>
                                        <div style="font-size: 12px; text-align: center;">
                                            <div>Quad: 20</div>
                                            <div>Double: 10</div>
                                            <div style="font-weight: 600;">Total: 30</div>
                                        </div>
                                    </td>
                                    <td>
                                        <span class="badge" style="background: rgba(16, 185, 129, 0.2); color: #10B981;">approved</span>
                                    </td>
                                    <td>
                                        <div>
                                            <span class="badge" style="background: rgba(239, 68, 68, 0.2); color: #EF4444;">pending</span>
                                            <div style="font-size: 11px; margin-top: 4px;">Rp 0 / 380M</div>
                                            <div class="progress-bar" style="margin-top: 4px; height: 4px;">
                                                <div style="width: 0%; background: #EF4444;"></div>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <div style="font-size: 12px;">
                                            <div>Al-Haramain Tours</div>
                                            <div style="color: rgba(255, 255, 255, 0.6);">+966 55 123 4567</div>
                                        </div>
                                    </td>
                                    <td>
                                        <div style="display: flex; gap: 5px;">
                                            <button class="btn btn-sm btn-icon" style="color: #F59E0B;" title="Payment Required">
                                                <span class="material-icons">warning</span>
                                            </button>
                                            <button class="btn btn-sm btn-icon" title="Add Payment">
                                                <span class="material-icons">payment</span>
                                            </button>
                                            <button class="btn btn-sm btn-icon" title="Edit">
                                                <span class="material-icons">edit</span>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Flight Management Page (New Clean Version) -->
            <div id="flights" class="page">
                <div class="glass-card">
                    <h2><span class="material-icons" style="vertical-align: middle; margin-right: 10px; color: #F59E0B;">flight</span>Manajemen Tiket Penerbangan</h2>
                    <p style="color: rgba(255, 255, 255, 0.7); margin-bottom: 30px;">Kelola data PNR untuk setiap paket umroh</p>
                    
                    <!-- Main Content Area -->
                    <div style="margin-top: 30px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3 style="margin: 0;">Daftar Paket Umroh</h3>
                            <button class="btn btn-primary" onclick="refreshFlightPackages()">
                                <span class="material-icons">refresh</span>
                                Refresh
                            </button>
                        </div>
                        
                        <!-- Package List -->
                        <div id="flight-package-list" style="display: grid; gap: 20px;">
                            <div style="text-align: center; padding: 60px; color: rgba(255, 255, 255, 0.6);">
                                <span class="material-icons" style="font-size: 72px; display: block; margin-bottom: 20px; opacity: 0.3;">flight_takeoff</span>
                                <p>Memuat data paket...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Ground Handling Page -->
            <div id="groundHandling" class="page">
                <div class="glass-card">
                    <h2><span class="material-icons" style="vertical-align: middle; margin-right: 10px; background: linear-gradient(135deg, #3B82F6, #60A5FA); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">flight_takeoff</span>Ground Handling Management</h2>
                    <p style="color: rgba(255, 255, 255, 0.7); margin-bottom: 30px;">Kelola operasional ground handling, reservasi, dan dokumentasi penerbangan</p>
                    
                    
                    <!-- Enhanced Filter and Actions Card -->
                    <div class="glass-card" style="margin-bottom: 30px; background: linear-gradient(145deg, rgba(30, 41, 59, 0.9), rgba(15, 23, 42, 0.8)); border: 1px solid rgba(255, 255, 255, 0.1); padding: 20px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 16px;">
                            <div style="display: flex; gap: 12px; flex-wrap: wrap; flex: 1;">
                                <div class="search-box" style="background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 10px; padding: 10px 16px; display: flex; align-items: center; gap: 10px; min-width: 300px; flex: 1;">
                                    <span class="material-icons" style="color: #60A5FA;">flight_takeoff</span>
                                    <input type="text" placeholder="Cari flight code, route, atau paket..." style="background: transparent; border: none; outline: none; color: #fff; width: 100%; font-size: 14px;">
                                </div>
                                <div style="position: relative;">
                                    <select class="form-select" style="background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 10px; padding: 10px 16px; min-width: 180px; color: #fff; font-size: 14px; appearance: none; cursor: pointer;">
                                        <option>Semua Status</option>
                                        <option>🔴 Urgent (H-3)</option>
                                        <option>🟡 Soon (H-7)</option>
                                        <option>🔵 Upcoming</option>
                                    </select>
                                    <span class="material-icons" style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); pointer-events: none; color: rgba(255, 255, 255, 0.6);">expand_more</span>
                                </div>
                            </div>
                            <div style="display: flex; gap: 10px;">
                                <button class="btn" style="background: linear-gradient(135deg, #8B5CF6, #A78BFA); border: none; padding: 10px 20px; border-radius: 10px; display: flex; align-items: center; gap: 8px; font-weight: 600; transition: all 0.3s; box-shadow: 0 4px 15px rgba(139, 92, 246, 0.3);">
                                    <span class="material-icons">calendar_month</span>
                                    Calendar View
                                </button>
                                <button class="btn" style="background: linear-gradient(135deg, #3B82F6, #60A5FA); border: none; padding: 10px 20px; border-radius: 10px; display: flex; align-items: center; gap: 8px; font-weight: 600; transition: all 0.3s; box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);">
                                    <span class="material-icons">add_circle</span>
                                    New Flight
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Ground Handling Cards -->
                    <!-- Ground Handling Cards -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px;">
                        <!-- Flight 1 - Urgent -->
                        <div class="glass-card flight-card" style="border-left: 5px solid #EF4444; padding: 16px; position: relative; min-height: 420px; display: flex; flex-direction: column;">
                            <!-- Status Badges -->
                            <div style="position: absolute; top: 16px; right: 16px; display: flex; gap: 6px;">
                                <span class="badge" style="background: rgba(239, 68, 68, 0.2); color: #EF4444; border: 1px solid rgba(239, 68, 68, 0.3); padding: 4px 12px; font-size: 11px; font-weight: 600;">H-2</span>
                                <span class="badge" style="background: rgba(59, 130, 246, 0.2); color: #3B82F6; border: 1px solid rgba(59, 130, 246, 0.3); padding: 4px 12px; font-size: 11px;">Preparing</span>
                            </div>
                            
                            <!-- Header -->
                            <div style="margin-bottom: 12px; padding-right: 150px;">
                                <h3 style="color: #EF4444; margin: 0 0 8px 0; font-size: 26px; font-weight: 700;">GA-897</h3>
                                <div style="display: flex; gap: 6px; flex-wrap: wrap;">
                                    <span class="badge" style="font-size: 11px; padding: 3px 10px;">CGK-JED</span>
                                    <span class="badge" style="font-size: 11px; padding: 3px 10px;">Garuda</span>
                                    <span class="badge" style="font-size: 11px; padding: 3px 10px;">T3</span>
                                </div>
                            </div>
                            
                            <!-- Package Info -->
                            <div style="margin-bottom: 14px; padding-bottom: 14px; border-bottom: 1px solid rgba(255, 255, 255, 0.1);">
                                <div style="color: rgba(255, 255, 255, 0.95); font-size: 14px; font-weight: 500;">Paket Umroh Eksekutif</div>
                                <div style="color: rgba(255, 255, 255, 0.6); font-size: 12px;">Grup Al-Barokah</div>
                            </div>
                            
                            <!-- Event Alert -->
                            <div style="background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 8px; padding: 12px; margin-bottom: 14px; display: flex; align-items: center; gap: 10px;">
                                <span class="material-icons" style="color: #EF4444; font-size: 24px;">warning</span>
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; font-size: 13px; color: #EF4444;">KEBERANGKATAN H-2</div>
                                    <div style="font-size: 12px; color: rgba(255, 255, 255, 0.7);">26 Jul 2025, 23:30</div>
                                </div>
                            </div>
                            
                            <!-- Key Metrics -->
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 14px; background: rgba(255, 255, 255, 0.03); padding: 14px; border-radius: 8px;">
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <span class="material-icons" style="font-size: 28px; color: #3B82F6;">people</span>
                                    <div>
                                        <div style="font-size: 10px; color: rgba(255, 255, 255, 0.6); text-transform: uppercase; letter-spacing: 0.5px;">PAX</div>
                                        <div style="font-weight: 700; font-size: 20px;">225</div>
                                    </div>
                                </div>
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <span class="material-icons" style="font-size: 28px; color: #F59E0B;">luggage</span>
                                    <div>
                                        <div style="font-size: 10px; color: rgba(255, 255, 255, 0.6); text-transform: uppercase; letter-spacing: 0.5px;">BAGASI</div>
                                        <div style="font-weight: 700; font-size: 20px;">450</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Service Grid -->
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 14px; flex: 1;">
                                <div style="background: rgba(239, 68, 68, 0.1); color: #EF4444; border: 1px solid rgba(239, 68, 68, 0.3); padding: 10px; border-radius: 8px; font-size: 12px; display: flex; align-items: center; gap: 6px; justify-content: center;">
                                    <span class="material-icons" style="font-size: 16px;">event_seat</span>
                                    <span>2 Lounge</span>
                                </div>
                                <div style="background: rgba(16, 185, 129, 0.1); color: #10B981; border: 1px solid rgba(16, 185, 129, 0.3); padding: 10px; border-radius: 8px; font-size: 12px; display: flex; align-items: center; gap: 6px; justify-content: center;">
                                    <span class="material-icons" style="font-size: 16px;">hotel</span>
                                    <span>1 Hotel ✓</span>
                                </div>
                                <div style="background: rgba(239, 68, 68, 0.1); color: #EF4444; border: 1px solid rgba(239, 68, 68, 0.3); padding: 10px; border-radius: 8px; font-size: 12px; display: flex; align-items: center; gap: 6px; justify-content: center;">
                                    <span class="material-icons" style="font-size: 16px;">restaurant</span>
                                    <span>3 Meal</span>
                                </div>
                                <div style="background: rgba(245, 158, 11, 0.2); color: #F59E0B; border: 1px solid rgba(245, 158, 11, 0.3); padding: 10px; border-radius: 8px; font-size: 12px; display: flex; align-items: center; gap: 6px; justify-content: center; cursor: pointer; transition: all 0.2s;" onclick="showSpecialRequests('GA-897')" onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.2)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                                    <span class="material-icons" style="font-size: 16px;">accessible</span>
                                    <span>5 Request</span>
                                </div>
                            </div>
                            
                            <!-- Action Button -->
                            <button onclick="showFlightDetails('GA-897')" style="width: 100%; padding: 12px; background: linear-gradient(135deg, #3B82F6, #60A5FA); color: white; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; margin-top: auto; transition: all 0.2s;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(59, 130, 246, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                                <span class="material-icons" style="font-size: 18px;">visibility</span>
                                View Details
                            </button>
                        </div>
                        
                        <!-- Flight 2 - Soon -->
                        <div class="glass-card flight-card" style="border-left: 5px solid #F59E0B; padding: 16px; position: relative; min-height: 420px; display: flex; flex-direction: column;">
                            <!-- Status Badges -->
                            <div style="position: absolute; top: 16px; right: 16px; display: flex; gap: 6px;">
                                <span class="badge" style="background: rgba(245, 158, 11, 0.2); color: #F59E0B; border: 1px solid rgba(245, 158, 11, 0.3); padding: 4px 12px; font-size: 11px; font-weight: 600;">H-5</span>
                                <span class="badge" style="background: rgba(59, 130, 246, 0.2); color: #3B82F6; border: 1px solid rgba(59, 130, 246, 0.3); padding: 4px 12px; font-size: 11px;">Scheduled</span>
                            </div>
                            
                            <!-- Header -->
                            <div style="margin-bottom: 12px; padding-right: 150px;">
                                <h3 style="color: #F59E0B; margin: 0 0 8px 0; font-size: 26px; font-weight: 700;">SV-815</h3>
                                <div style="display: flex; gap: 6px; flex-wrap: wrap;">
                                    <span class="badge" style="font-size: 11px; padding: 3px 10px;">JED-MED</span>
                                    <span class="badge" style="font-size: 11px; padding: 3px 10px;">Saudia</span>
                                    <span class="badge" style="font-size: 11px; padding: 3px 10px;">T1</span>
                                </div>
                            </div>
                            
                            <!-- Package Info -->
                            <div style="margin-bottom: 14px; padding-bottom: 14px; border-bottom: 1px solid rgba(255, 255, 255, 0.1);">
                                <div style="color: rgba(255, 255, 255, 0.95); font-size: 14px; font-weight: 500;">Paket Umroh Reguler</div>
                                <div style="color: rgba(255, 255, 255, 0.6); font-size: 12px;">Grup Al-Hikmah</div>
                            </div>
                            
                            <!-- Event Alert -->
                            <div style="background: rgba(245, 158, 11, 0.1); border: 1px solid rgba(245, 158, 11, 0.3); border-radius: 8px; padding: 12px; margin-bottom: 14px; display: flex; align-items: center; gap: 10px;">
                                <span class="material-icons" style="color: #F59E0B; font-size: 24px;">schedule</span>
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; font-size: 13px; color: #F59E0B;">KEDATANGAN H-5</div>
                                    <div style="font-size: 12px; color: rgba(255, 255, 255, 0.7);">31 Jul 2025, 14:15</div>
                                </div>
                            </div>
                            
                            <!-- Key Metrics -->
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 14px; background: rgba(255, 255, 255, 0.03); padding: 14px; border-radius: 8px;">
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <span class="material-icons" style="font-size: 28px; color: #3B82F6;">people</span>
                                    <div>
                                        <div style="font-size: 10px; color: rgba(255, 255, 255, 0.6); text-transform: uppercase; letter-spacing: 0.5px;">PAX</div>
                                        <div style="font-weight: 700; font-size: 20px;">180</div>
                                    </div>
                                </div>
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <span class="material-icons" style="font-size: 28px; color: #F59E0B;">luggage</span>
                                    <div>
                                        <div style="font-size: 10px; color: rgba(255, 255, 255, 0.6); text-transform: uppercase; letter-spacing: 0.5px;">BAGASI</div>
                                        <div style="font-weight: 700; font-size: 20px;">360</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Service Grid -->
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 14px; flex: 1;">
                                <div style="background: rgba(239, 68, 68, 0.1); color: #EF4444; border: 1px solid rgba(239, 68, 68, 0.3); padding: 10px; border-radius: 8px; font-size: 12px; display: flex; align-items: center; gap: 6px; justify-content: center;">
                                    <span class="material-icons" style="font-size: 16px;">hotel</span>
                                    <span>2 Hotel</span>
                                </div>
                                <div style="background: rgba(245, 158, 11, 0.2); color: #F59E0B; border: 1px solid rgba(245, 158, 11, 0.3); padding: 10px; border-radius: 8px; font-size: 12px; display: flex; align-items: center; gap: 6px; justify-content: center; cursor: pointer; transition: all 0.2s;" onclick="showSpecialRequests('SV-815')" onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.2)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                                    <span class="material-icons" style="font-size: 16px;">directions_bus</span>
                                    <span>1 Request</span>
                                </div>
                            </div>
                            
                            <!-- Action Button -->
                            <button onclick="showFlightDetails('SV-815')" style="width: 100%; padding: 12px; background: linear-gradient(135deg, #3B82F6, #60A5FA); color: white; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; margin-top: auto; transition: all 0.2s;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(59, 130, 246, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                                <span class="material-icons" style="font-size: 18px;">visibility</span>
                                View Details
                            </button>
                        </div>
                        
                        <!-- Flight 3 - Upcoming -->
                        <div class="glass-card flight-card" style="border-left: 5px solid #3B82F6; padding: 16px; position: relative; min-height: 420px; display: flex; flex-direction: column;">
                            <!-- Status Badges -->
                            <div style="position: absolute; top: 16px; right: 16px; display: flex; gap: 6px;">
                                <span class="badge" style="background: rgba(59, 130, 246, 0.2); color: #3B82F6; border: 1px solid rgba(59, 130, 246, 0.3); padding: 4px 12px; font-size: 11px; font-weight: 600;">H-14</span>
                                <span class="badge" style="background: rgba(59, 130, 246, 0.2); color: #3B82F6; border: 1px solid rgba(59, 130, 246, 0.3); padding: 4px 12px; font-size: 11px;">Scheduled</span>
                            </div>
                            
                            <!-- Header -->
                            <div style="margin-bottom: 12px; padding-right: 150px;">
                                <h3 style="color: #3B82F6; margin: 0 0 8px 0; font-size: 26px; font-weight: 700;">QR-955</h3>
                                <div style="display: flex; gap: 6px; flex-wrap: wrap;">
                                    <span class="badge" style="font-size: 11px; padding: 3px 10px;">CGK-DOH</span>
                                    <span class="badge" style="font-size: 11px; padding: 3px 10px;">Qatar</span>
                                    <span class="badge" style="font-size: 11px; padding: 3px 10px;">T2</span>
                                </div>
                            </div>
                            
                            <!-- Package Info -->
                            <div style="margin-bottom: 14px; padding-bottom: 14px; border-bottom: 1px solid rgba(255, 255, 255, 0.1);">
                                <div style="color: rgba(255, 255, 255, 0.95); font-size: 14px; font-weight: 500;">Paket Umroh VIP</div>
                                <div style="color: rgba(255, 255, 255, 0.6); font-size: 12px;">Grup Al-Amin</div>
                            </div>
                            
                            <!-- Event Alert -->
                            <div style="background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 8px; padding: 12px; margin-bottom: 14px; display: flex; align-items: center; gap: 10px;">
                                <span class="material-icons" style="color: #3B82F6; font-size: 24px;">flight_takeoff</span>
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; font-size: 13px; color: #3B82F6;">KEBERANGKATAN H-14</div>
                                    <div style="font-size: 12px; color: rgba(255, 255, 255, 0.7);">07 Aug 2025, 01:45</div>
                                </div>
                            </div>
                            
                            <!-- Key Metrics -->
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 14px; background: rgba(255, 255, 255, 0.03); padding: 14px; border-radius: 8px;">
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <span class="material-icons" style="font-size: 28px; color: #3B82F6;">people</span>
                                    <div>
                                        <div style="font-size: 10px; color: rgba(255, 255, 255, 0.6); text-transform: uppercase; letter-spacing: 0.5px;">PAX</div>
                                        <div style="font-weight: 700; font-size: 20px;">45</div>
                                    </div>
                                </div>
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <span class="material-icons" style="font-size: 28px; color: #F59E0B;">luggage</span>
                                    <div>
                                        <div style="font-size: 10px; color: rgba(255, 255, 255, 0.6); text-transform: uppercase; letter-spacing: 0.5px;">BAGASI</div>
                                        <div style="font-weight: 700; font-size: 20px;">90</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- No Services Message -->
                            <div style="padding: 16px; background: rgba(255, 255, 255, 0.05); border-radius: 8px; text-align: center; font-size: 13px; color: rgba(255, 255, 255, 0.6); margin-bottom: 14px; flex: 1;">
                                Tidak ada layanan tambahan yang diminta
                            </div>
                            
                            <!-- Action Button -->
                            <button onclick="showFlightDetails('QR-955')" style="width: 100%; padding: 12px; background: linear-gradient(135deg, #3B82F6, #60A5FA); color: white; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; margin-top: auto; transition: all 0.2s;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(59, 130, 246, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                                <span class="material-icons" style="font-size: 18px;">visibility</span>
                                View Details
                            </button>
                        </div>
                        
                        <!-- Flight 4 - Completed -->
                        <div class="glass-card flight-card" style="border-left: 5px solid #10B981; padding: 16px; position: relative; min-height: 420px; display: flex; flex-direction: column;">
                            <!-- Status Badges -->
                            <div style="position: absolute; top: 16px; right: 16px; display: flex; gap: 6px;">
                                <span class="badge" style="background: rgba(16, 185, 129, 0.2); color: #10B981; border: 1px solid rgba(16, 185, 129, 0.3); padding: 4px 12px; font-size: 11px; font-weight: 600;">H+3</span>
                                <span class="badge" style="background: rgba(16, 185, 129, 0.2); color: #10B981; border: 1px solid rgba(16, 185, 129, 0.3); padding: 4px 12px; font-size: 11px;">Completed</span>
                            </div>
                            
                            <!-- Header -->
                            <div style="margin-bottom: 12px; padding-right: 150px;">
                                <h3 style="color: #10B981; margin: 0 0 8px 0; font-size: 26px; font-weight: 700;">EK-385</h3>
                                <div style="display: flex; gap: 6px; flex-wrap: wrap;">
                                    <span class="badge" style="font-size: 11px; padding: 3px 10px;">CGK-DXB</span>
                                    <span class="badge" style="font-size: 11px; padding: 3px 10px;">Emirates</span>
                                    <span class="badge" style="font-size: 11px; padding: 3px 10px;">T3</span>
                                </div>
                            </div>
                            
                            <!-- Package Info -->
                            <div style="margin-bottom: 14px; padding-bottom: 14px; border-bottom: 1px solid rgba(255, 255, 255, 0.1);">
                                <div style="color: rgba(255, 255, 255, 0.95); font-size: 14px; font-weight: 500;">Paket Umroh Premium</div>
                                <div style="color: rgba(255, 255, 255, 0.6); font-size: 12px;">Grup Al-Falah</div>
                            </div>
                            
                            <!-- Event Alert -->
                            <div style="background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.3); border-radius: 8px; padding: 12px; margin-bottom: 14px; display: flex; align-items: center; gap: 10px;">
                                <span class="material-icons" style="color: #10B981; font-size: 24px;">check_circle</span>
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; font-size: 13px; color: #10B981;">SELESAI</div>
                                    <div style="font-size: 12px; color: rgba(255, 255, 255, 0.7);">21 Jul 2025, 14:30</div>
                                </div>
                            </div>
                            
                            <!-- Key Metrics -->
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 14px; background: rgba(255, 255, 255, 0.03); padding: 14px; border-radius: 8px;">
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <span class="material-icons" style="font-size: 28px; color: #3B82F6;">people</span>
                                    <div>
                                        <div style="font-size: 10px; color: rgba(255, 255, 255, 0.6); text-transform: uppercase; letter-spacing: 0.5px;">PAX</div>
                                        <div style="font-weight: 700; font-size: 20px;">180</div>
                                    </div>
                                </div>
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <span class="material-icons" style="font-size: 28px; color: #F59E0B;">luggage</span>
                                    <div>
                                        <div style="font-size: 10px; color: rgba(255, 255, 255, 0.6); text-transform: uppercase; letter-spacing: 0.5px;">BAGASI</div>
                                        <div style="font-weight: 700; font-size: 20px;">360</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Service Grid -->
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 14px; flex: 1;">
                                <div style="background: rgba(16, 185, 129, 0.1); color: #10B981; border: 1px solid rgba(16, 185, 129, 0.3); padding: 10px; border-radius: 8px; font-size: 12px; display: flex; align-items: center; gap: 6px; justify-content: center;">
                                    <span class="material-icons" style="font-size: 16px;">event_seat</span>
                                    <span>3 Lounge ✓</span>
                                </div>
                                <div style="background: rgba(16, 185, 129, 0.1); color: #10B981; border: 1px solid rgba(16, 185, 129, 0.3); padding: 10px; border-radius: 8px; font-size: 12px; display: flex; align-items: center; gap: 6px; justify-content: center;">
                                    <span class="material-icons" style="font-size: 16px;">restaurant</span>
                                    <span>2 Meal ✓</span>
                                </div>
                            </div>
                            
                            <!-- Action Button -->
                            <button onclick="showFlightDetails('EK-385')" style="width: 100%; padding: 12px; background: linear-gradient(135deg, #3B82F6, #60A5FA); color: white; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; margin-top: auto; transition: all 0.2s;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(59, 130, 246, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                                <span class="material-icons" style="font-size: 18px;">visibility</span>
                                View Details
                            </button>
                        </div>
                    </div>                    
                    <!-- Add New Handling Button -->
                    <div style="text-align: center; margin-top: 30px;">
                        <button class="btn btn-primary btn-lg">
                            <span class="material-icons">add_circle</span>
                            Add New Ground Handling
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Inventory Page -->
            <div id="inventory" class="page">
                <div class="glass-card">
                    <h2><span class="material-icons" style="vertical-align: middle; margin-right: 10px; color: #7C3AED;">inventory</span>Manajemen Perlengkapan</h2>
                    <button class="btn btn-primary" onclick="openInventoryModal()">
                        <span class="material-icons" style="vertical-align: middle; margin-right: 5px;">add</span>
                        Tambah Item
                    </button>
                    
                    <!-- Stats Cards -->
                    <div class="stats-grid" style="margin-top: 30px;">
                        <div class="stat-card">
                            <div class="stat-icon" style="background: linear-gradient(135deg, #7C3AED, #A78BFA);">
                                <span class="material-icons">inventory_2</span>
                            </div>
                            <div class="stat-value">127</div>
                            <div class="stat-label">Total Items</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon" style="background: linear-gradient(135deg, #EF4444, #F87171);">
                                <span class="material-icons">warning</span>
                            </div>
                            <div class="stat-value" style="color: #EF4444;">8</div>
                            <div class="stat-label">Stok Kritis</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon" style="background: linear-gradient(135deg, #10B981, #34D399);">
                                <span class="material-icons">local_shipping</span>
                            </div>
                            <div class="stat-value">23</div>
                            <div class="stat-label">Transaksi Hari Ini</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon" style="background: linear-gradient(135deg, #F59E0B, #FCD34D);">
                                <span class="material-icons">monetization_on</span>
                            </div>
                            <div class="stat-value">45.2M</div>
                            <div class="stat-label">Total Penjualan</div>
                        </div>
                    </div>
                    
                    <!-- Alert Section -->
                    <div class="alert alert-warning" style="margin-top: 20px; background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); color: #FCA5A5;">
                        <h4 style="display: flex; align-items: center; margin-bottom: 10px;">
                            <span class="material-icons" style="margin-right: 10px;">warning</span>
                            Peringatan Stok Rendah
                        </h4>
                        <div style="font-size: 14px;">
                            • Slayer Hijau - Stok: 15 pcs (Minimum: 50 pcs)<br>
                            • Tas Serut - Stok: 23 pcs (Minimum: 50 pcs)<br>
                            • Mukenah Putih - Stok: 8 pcs (Minimum: 50 pcs)
                        </div>
                    </div>
                    
                    <!-- Tabs -->
                    <div class="tabs" style="margin-top: 30px;">
                        <button class="tab-btn active" onclick="switchInventoryTab('items')">Inventory</button>
                        <button class="tab-btn" onclick="switchInventoryTab('transactions')">Transaksi</button>
                        <button class="tab-btn" onclick="switchInventoryTab('slayer')">Slayer</button>
                        <button class="tab-btn" onclick="switchInventoryTab('earphone')">Earphone</button>
                        <button class="tab-btn" onclick="switchInventoryTab('checklist')">Distribusi Jamaah</button>
                        <button class="tab-btn" onclick="switchInventoryTab('recap')">Recap Penjualan</button>
                    </div>
                    
                    <!-- Items Tab Content -->
                    <div id="inventoryItemsTab" class="tab-content active">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Nama Item</th>
                                    <th>Kategori</th>
                                    <th>Stok</th>
                                    <th>Min. Stok</th>
                                    <th>Status</th>
                                    <th>Harga Jual</th>
                                    <th>Aksi</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>Slayer Hijau</td>
                                    <td>Slayer</td>
                                    <td>15 pcs</td>
                                    <td>50 pcs</td>
                                    <td><span class="status-badge status-critical">Kritis</span></td>
                                    <td>Rp 150,000</td>
                                    <td>
                                        <button class="btn btn-small btn-secondary" onclick="recordTransaction(1)">
                                            <span class="material-icons" style="font-size: 16px;">swap_horiz</span>
                                            Transaksi
                                        </button>
                                    </td>
                                </tr>
                                <tr>
                                    <td>Tas Serut Premium</td>
                                    <td>Tas Serut</td>
                                    <td>125 pcs</td>
                                    <td>50 pcs</td>
                                    <td><span class="status-badge status-paid">Aman</span></td>
                                    <td>Rp 75,000</td>
                                    <td>
                                        <button class="btn btn-small btn-secondary" onclick="recordTransaction(2)">
                                            <span class="material-icons" style="font-size: 16px;">swap_horiz</span>
                                            Transaksi
                                        </button>
                                    </td>
                                </tr>
                                <tr>
                                    <td>Koper Cabin 20"</td>
                                    <td>Koper</td>
                                    <td>87 pcs</td>
                                    <td>50 pcs</td>
                                    <td><span class="status-badge status-paid">Aman</span></td>
                                    <td>Rp 450,000</td>
                                    <td>
                                        <button class="btn btn-small btn-secondary" onclick="recordTransaction(3)">
                                            <span class="material-icons" style="font-size: 16px;">swap_horiz</span>
                                            Transaksi
                                        </button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Transactions Tab Content -->
                    <div id="inventoryTransactionsTab" class="tab-content" style="display: none;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3>Riwayat Transaksi</h3>
                            <button class="btn btn-primary" onclick="openTransactionModal()">
                                <span class="material-icons" style="vertical-align: middle; margin-right: 5px;">add</span>
                                Catat Transaksi
                            </button>
                        </div>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Tanggal</th>
                                    <th>Item</th>
                                    <th>Tipe</th>
                                    <th>Jumlah</th>
                                    <th>Harga/Unit</th>
                                    <th>Total</th>
                                    <th>Keterangan</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>24/01/2025</td>
                                    <td>Slayer Hijau</td>
                                    <td><span class="status-badge status-critical">Keluar</span></td>
                                    <td>10 pcs</td>
                                    <td>Rp 150,000</td>
                                    <td>Rp 1,500,000</td>
                                    <td>Penjualan ke Grup UMR-2025-001</td>
                                </tr>
                                <tr>
                                    <td>23/01/2025</td>
                                    <td>Tas Serut Premium</td>
                                    <td><span class="status-badge status-paid">Masuk</span></td>
                                    <td>50 pcs</td>
                                    <td>Rp 50,000</td>
                                    <td>Rp 2,500,000</td>
                                    <td>Pembelian dari supplier</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                        </div>
                        
                    <!-- Slayer Tab Content -->
                    <div id="inventorySlayerTab" class="tab-content" style="display: none;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3>Manajemen Warna Slayer</h3>
                            <button class="btn btn-primary" onclick="openSlayerColorModal()">
                                <span class="material-icons" style="vertical-align: middle; margin-right: 5px;">add</span>
                                Tambah Warna
                            </button>
                        </div>
                        <div class="cards-grid">
                            <div class="card" style="padding: 20px;">
                                <div style="display: flex; align-items: center; margin-bottom: 15px;">
                                    <div style="width: 40px; height: 40px; background: #059669; border-radius: 8px; margin-right: 15px;"></div>
                                    <div>
                                        <h4 style="margin: 0;">Hijau Zamrud</h4>
                                        <p style="margin: 0; font-size: 14px; color: rgba(255,255,255,0.6);">Stok: 45 pcs</p>
                                    </div>
                                </div>
                                <button class="btn btn-small btn-secondary" style="width: 100%;">
                                    Assign ke Grup
                                </button>
                            </div>
                            <div class="card" style="padding: 20px;">
                                <div style="display: flex; align-items: center; margin-bottom: 15px;">
                                    <div style="width: 40px; height: 40px; background: #7C3AED; border-radius: 8px; margin-right: 15px;"></div>
                                    <div>
                                        <h4 style="margin: 0;">Ungu Royal</h4>
                                        <p style="margin: 0; font-size: 14px; color: rgba(255,255,255,0.6);">Stok: 67 pcs</p>
                                    </div>
                                </div>
                                <button class="btn btn-small btn-secondary" style="width: 100%;">
                                    Assign ke Grup
                                </button>
                            </div>
                            <div class="card" style="padding: 20px;">
                                <div style="display: flex; align-items: center; margin-bottom: 15px;">
                                    <div style="width: 40px; height: 40px; background: #EC4899; border-radius: 8px; margin-right: 15px;"></div>
                                    <div>
                                        <h4 style="margin: 0;">Pink Fuchsia</h4>
                                        <p style="margin: 0; font-size: 14px; color: rgba(255,255,255,0.6);">Stok: 23 pcs</p>
                                    </div>
                                </div>
                                <button class="btn btn-small btn-secondary" style="width: 100%;">
                                    Assign ke Grup
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Earphone Tab Content -->
                    <div id="inventoryEarphoneTab" class="tab-content" style="display: none;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3>Mapping Earphone ke Grup</h3>
                            <button class="btn btn-primary" onclick="openEarphoneMappingModal()">
                                <span class="material-icons" style="vertical-align: middle; margin-right: 5px;">add</span>
                                Mapping Earphone
                            </button>
                        </div>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Grup</th>
                                    <th>Tanggal Berangkat</th>
                                    <th>Jumlah</th>
                                    <th>Serial Numbers</th>
                                    <th>Status</th>
                                    <th>Aksi</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>UMR-2025-001</td>
                                    <td>15/02/2025</td>
                                    <td>45 pcs</td>
                                    <td>EP001-EP045</td>
                                    <td><span class="status-badge status-paid">Distributed</span></td>
                                    <td>
                                        <button class="btn btn-small btn-secondary">Detail</button>
                                    </td>
                                </tr>
                                <tr>
                                    <td>UMR-2025-002</td>
                                    <td>28/02/2025</td>
                                    <td>40 pcs</td>
                                    <td>EP046-EP085</td>
                                    <td><span class="status-badge status-paid">Distributed</span></td>
                                    <td>
                                        <button class="btn btn-small btn-secondary">Detail</button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Checklist Tab Content -->
                    <div id="inventoryChecklistTab" class="tab-content" style="display: none;">
                        <div class="info-box" style="background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.3); padding: 20px; border-radius: 12px;">
                            <h3 style="margin-bottom: 10px;">
                                <span class="material-icons" style="vertical-align: middle; margin-right: 10px;">info</span>
                                Checklist Perlengkapan
                            </h3>
                            <p style="margin: 0;">
                                Fitur checklist perlengkapan jamaah dan Tour Leader dapat diakses melalui halaman detail grup keberangkatan.
                                Silakan buka halaman Grup Keberangkatan dan pilih grup yang ingin Anda kelola checklistnya.
                            </p>
                        </div>
                    </div>
                    
                    <!-- Sales Recap Tab Content -->
                    <div id="inventoryRecapTab" class="tab-content" style="display: none;">
                        <h3 style="margin-bottom: 20px;">Recap Penjualan Perlengkapan</h3>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Bulan</th>
                                    <th>Item</th>
                                    <th>Kategori</th>
                                    <th>Transaksi</th>
                                    <th>Qty Terjual</th>
                                    <th>Total Revenue</th>
                                    <th>Rata-rata</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>Jan 2025</td>
                                    <td>Slayer Hijau</td>
                                    <td>Slayer</td>
                                    <td>15</td>
                                    <td>187 pcs</td>
                                    <td>Rp 28,050,000</td>
                                    <td>Rp 150,000</td>
                                </tr>
                                <tr>
                                    <td>Jan 2025</td>
                                    <td>Tas Serut Premium</td>
                                    <td>Tas Serut</td>
                                    <td>23</td>
                                    <td>156 pcs</td>
                                    <td>Rp 11,700,000</td>
                                    <td>Rp 75,000</td>
                                </tr>
                                <tr>
                                    <td>Jan 2025</td>
                                    <td>Koper Cabin 20"</td>
                                    <td>Koper</td>
                                    <td>8</td>
                                    <td>34 pcs</td>
                                    <td>Rp 15,300,000</td>
                                    <td>Rp 450,000</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    </div>
                </div>
            </div>
            
            
            <!-- Reports Page -->
            <div id="reports" class="page">
                <div class="glass-card">
                    <h2><span class="material-icons" style="vertical-align: middle; margin-right: 10px;">assessment</span>Laporan & Analytics</h2>
                    
                    <!-- Report Buttons -->
                    <div class="report-grid">
                        <button class="btn btn-primary" onclick="generateReport('jamaah')">
                            <span class="material-icons">people</span>
                            Laporan Jamaah
                        </button>
                        <button class="btn btn-success" onclick="generateReport('payment')">
                            <span class="material-icons">payment</span>
                            Laporan Keuangan
                        </button>
                        <button class="btn btn-warning" onclick="generateReport('package')">
                            <span class="material-icons">card_travel</span>
                            Laporan Paket
                        </button>
                        <button class="btn btn-primary" onclick="generateReport('departure')">
                            <span class="material-icons">flight_takeoff</span>
                            Laporan Keberangkatan
                        </button>
                    </div>
                    
                    <!-- Analytics Charts -->
                    <div class="chart-container">
                        <div class="glass-card">
                            <div class="chart-wrapper" style="background: transparent; border: none; padding: 0;">
                                <h3>Trend Registrasi 6 Bulan</h3>
                                <canvas id="trendChart"></canvas>
                            </div>
                        </div>
                        
                        <div class="glass-card">
                            <div class="chart-wrapper" style="background: transparent; border: none; padding: 0;">
                                <h3>Distribusi Status Jamaah</h3>
                                <canvas id="statusChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Excel Page -->
            <div id="excel" class="page">
                <div class="glass-card">
                    <h2><span class="material-icons" style="vertical-align: middle; margin-right: 10px;">table_chart</span>Excel Import & Export</h2>
                    
                    <!-- Import Section -->
                    <div class="section">
                        <h3>Import Data</h3>
                        
                        <div class="report-grid">
                            <button class="btn btn-primary" onclick="downloadTemplate('jamaah')">
                                <span class="material-icons">download</span>
                                Template Jamaah
                            </button>
                            <button class="btn btn-primary" onclick="downloadTemplate('package')">
                                <span class="material-icons">download</span>
                                Template Paket
                            </button>
                            <button class="btn btn-primary" onclick="downloadTemplate('payment')">
                                <span class="material-icons">download</span>
                                Template Pembayaran
                            </button>
                        </div>
                        
                        <div class="file-upload" onclick="document.getElementById('excelUpload').click()">
                            <span class="material-icons" style="font-size: 48px; color: rgba(255, 255, 255, 0.6); margin-bottom: 10px;">upload_file</span>
                            <p style="color: white; margin-bottom: 10px;">Upload file Excel untuk import data</p>
                            <p style="color: rgba(255, 255, 255, 0.6); font-size: 12px;">Format: .xlsx, .xls</p>
                            <input type="file" id="excelUpload" accept=".xlsx,.xls" style="display: none;" onchange="handleExcelImport(event)">
                        </div>
                    </div>
                    
                    <!-- Export Section -->
                    <div class="section">
                        <h3>Export Data</h3>
                        
                        <div class="report-grid">
                            <button class="btn btn-success" onclick="exportToExcel('jamaah')">
                                <span class="material-icons">file_download</span>
                                Export Jamaah
                            </button>
                            <button class="btn btn-success" onclick="exportToExcel('package')">
                                <span class="material-icons">file_download</span>
                                Export Paket
                            </button>
                            <button class="btn btn-success" onclick="exportToExcel('payment')">
                                <span class="material-icons">file_download</span>
                                Export Pembayaran
                            </button>
                            <button class="btn btn-success" onclick="exportToExcel('all')">
                                <span class="material-icons">file_download</span>
                                Export Semua Data
                            </button>
                            <button class="btn btn-primary" onclick="exportToExcel('manifest')">
                                <span class="material-icons">description</span>
                                Export Manifest
                            </button>
                        </div>
                    </div>
                    
                    <!-- Import Results -->
                    <div id="importResults" style="margin-top: 30px; display: none;">
                        <h3 style="color: white; margin-bottom: 15px;">Hasil Import</h3>
                        <div id="importResultsContent"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <!-- Jamaah Modal -->
    <div id="jamaahModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Tambah/Edit Jamaah</h3>
                <button class="close-btn">&times;</button>
            </div>
            
            <form id="jamaahForm" onsubmit="saveJamaah(event)">
                <div class="form-grid">
                    <div class="form-group">
                        <label>Nama Lengkap</label>
                        <input type="text" id="jamaahName" required>
                    </div>
                    <div class="form-group">
                        <label>NIK</label>
                        <input type="text" id="jamaahNik" maxlength="16" required>
                    </div>
                    <div class="form-group">
                        <label>Tanggal Lahir</label>
                        <input type="text" id="jamaahBirthDate" placeholder="ddmmyyyy (contoh: 15051985)" maxlength="8" pattern="[0-9]{8}" required>
                        <small style="color: rgba(255, 255, 255, 0.6); font-size: 11px;">Format: ddmmyyyy</small>
                    </div>
                    <div class="form-group">
                        <label>Tempat Lahir</label>
                        <input type="text" id="jamaahBirthPlace" required>
                    </div>
                    <div class="form-group">
                        <label>Jenis Kelamin</label>
                        <select id="jamaahGender" required>
                            <option value="">Pilih</option>
                            <option value="male">Laki-laki</option>
                            <option value="female">Perempuan</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>No. Telepon</label>
                        <input type="tel" id="jamaahPhone" required>
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="jamaahEmail">
                    </div>
                    <div class="form-group">
                        <label>Paket Umroh</label>
                        <select id="jamaahPackage" required>
                            <option value="">Pilih Paket</option>
                            <option value="1">Umroh Ramadhan 2024 - Rp 25.000.000</option>
                            <option value="2">Umroh Plus Turki - Rp 35.000.000</option>
                            <option value="3">Umroh Keluarga - Rp 22.000.000</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Alamat Lengkap</label>
                    <textarea id="jamaahAddress" rows="3" required></textarea>
                </div>

                <!-- Optional Regional Fields -->
                <div class="form-section">
                    <h4 style="color: #3b82f6; margin: 20px 0 15px 0; font-size: 16px;">Data Regional (Opsional)</h4>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Provinsi</label>
                            <select id="jamaahProvinsi">
                                <option value="">Pilih Provinsi</option>
                                <option value="Nanggroe Aceh Darussalam">Nanggroe Aceh Darussalam</option>
                                <option value="Sumatera Utara">Sumatera Utara</option>
                                <option value="Sumatera Selatan">Sumatera Selatan</option>
                                <option value="Sumatera Barat">Sumatera Barat</option>
                                <option value="Bengkulu">Bengkulu</option>
                                <option value="Riau">Riau</option>
                                <option value="Kepulauan Riau">Kepulauan Riau</option>
                                <option value="Jambi">Jambi</option>
                                <option value="Lampung">Lampung</option>
                                <option value="Bangka Belitung">Bangka Belitung</option>
                                <option value="Kalimantan Barat">Kalimantan Barat</option>
                                <option value="Kalimantan Timur">Kalimantan Timur</option>
                                <option value="Kalimantan Selatan">Kalimantan Selatan</option>
                                <option value="Kalimantan Tengah">Kalimantan Tengah</option>
                                <option value="Kalimantan Utara">Kalimantan Utara</option>
                                <option value="Banten">Banten</option>
                                <option value="DKI Jakarta">DKI Jakarta</option>
                                <option value="Jawa Barat">Jawa Barat</option>
                                <option value="Jawa Tengah">Jawa Tengah</option>
                                <option value="Daerah Istimewa Yogyakarta">Daerah Istimewa Yogyakarta</option>
                                <option value="Jawa Timur">Jawa Timur</option>
                                <option value="Bali">Bali</option>
                                <option value="Nusa Tenggara Timur">Nusa Tenggara Timur</option>
                                <option value="Nusa Tenggara Barat">Nusa Tenggara Barat</option>
                                <option value="Gorontalo">Gorontalo</option>
                                <option value="Sulawesi Barat">Sulawesi Barat</option>
                                <option value="Sulawesi Tengah">Sulawesi Tengah</option>
                                <option value="Sulawesi Utara">Sulawesi Utara</option>
                                <option value="Sulawesi Tenggara">Sulawesi Tenggara</option>
                                <option value="Sulawesi Selatan">Sulawesi Selatan</option>
                                <option value="Maluku Utara">Maluku Utara</option>
                                <option value="Maluku">Maluku</option>
                                <option value="Papua Barat">Papua Barat</option>
                                <option value="Papua">Papua</option>
                                <option value="Papua Tengah">Papua Tengah</option>
                                <option value="Papua Pegunungan">Papua Pegunungan</option>
                                <option value="Papua Selatan">Papua Selatan</option>
                                <option value="Papua Barat Daya">Papua Barat Daya</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Kabupaten/Kota</label>
                            <input type="text" id="jamaahKabupaten" placeholder="Contoh: Jakarta Pusat">
                        </div>
                        <div class="form-group">
                            <label>Kecamatan</label>
                            <input type="text" id="jamaahKecamatan" placeholder="Contoh: Gambir">
                        </div>
                        <div class="form-group">
                            <label>Kelurahan</label>
                            <input type="text" id="jamaahKelurahan" placeholder="Contoh: Petojo Utara">
                        </div>
                    </div>
                </div>

                <!-- Personal Status Fields -->
                <div class="form-section">
                    <h4 style="color: #3b82f6; margin: 20px 0 15px 0; font-size: 16px;">Data Personal (Opsional)</h4>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Status Pernikahan</label>
                            <select id="jamaahMaritalStatus">
                                <option value="">Pilih Status</option>
                                <option value="belum_kawin">Belum Kawin</option>
                                <option value="kawin">Kawin</option>
                                <option value="cerai_hidup">Cerai Hidup</option>
                                <option value="cerai_mati">Cerai Mati</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Pendidikan Terakhir</label>
                            <select id="jamaahEducation">
                                <option value="">Pilih Pendidikan</option>
                                <option value="sd">SD</option>
                                <option value="smp">SMP</option>
                                <option value="sma">SMA/SMK</option>
                                <option value="d3">Diploma 3</option>
                                <option value="s1">Sarjana (S1)</option>
                                <option value="s2">Magister (S2)</option>
                                <option value="s3">Doktor (S3)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Pekerjaan</label>
                            <input type="text" id="jamaahOccupation" placeholder="Contoh: Guru, Pegawai Swasta, Wiraswasta">
                        </div>
                    </div>
                </div>

                <!-- Family Information -->
                <div class="form-section">
                    <h4 style="color: #3b82f6; margin: 20px 0 15px 0; font-size: 16px;">Data Keluarga</h4>
                    
                    <div class="form-group">
                        <label>Status dalam Keluarga</label>
                        <select id="jamaahFamilyRole" onchange="toggleFamilyFields(this)" required>
                            <option value="">Pilih Status</option>
                            <option value="kepala_keluarga">Kepala Keluarga</option>
                            <option value="istri">Istri</option>
                            <option value="anak">Anak</option>
                            <option value="individu">Individu (Tidak Ada Keluarga)</option>
                        </select>
                    </div>

                    <div id="mainFamilySection" style="display: none;">
                        <div class="form-group">
                            <label>Pilih Main Family (Kepala Keluarga)</label>
                            <select id="jamaahMainFamily">
                                <option value="">Pilih Kepala Keluarga</option>
                                <!-- Will be populated dynamically -->
                            </select>
                        </div>
                    </div>

                    <div class="form-grid">
                        <div class="form-group">
                            <label>Preferensi Kamar</label>
                            <select id="jamaahRoomPreference" required>
                                <option value="">Pilih Tipe Kamar</option>
                                <option value="quad" selected>Quad (4 orang) - Default</option>
                                <option value="triple">Triple (3 orang)</option>
                                <option value="double">Double (2 orang)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label style="display: flex; align-items: center; gap: 10px;">
                                <input type="checkbox" id="jamaahFamilyRoomRequest">
                                <span>Request 1 Kamar untuk 1 Keluarga</span>
                            </label>
                            <small style="color: rgba(255, 255, 255, 0.6); font-size: 11px;">Centang jika ingin satu keluarga dalam satu kamar (berbeda gender diperbolehkan)</small>
                        </div>
                    </div>
                </div>

                <!-- Passport Information -->
                <div class="form-section">
                    <h4 style="color: #3b82f6; margin: 20px 0 15px 0; font-size: 16px;">Data Paspor</h4>
                    
                    <div class="form-group">
                        <label>Nama di Paspor</label>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <input type="text" id="jamaahPassportName" placeholder="Nama lengkap sesuai paspor" style="flex: 1;">
                            <label style="display: flex; align-items: center; gap: 5px; color: rgba(255, 255, 255, 0.8); font-size: 12px; white-space: nowrap;">
                                <input type="checkbox" id="sameAsKtpName" onchange="togglePassportName(this)">
                                Sama dengan nama KTP
                            </label>
                        </div>
                    </div>

                    <div class="form-grid">
                        <div class="form-group">
                            <label>No. Paspor</label>
                            <input type="text" id="jamaahPassportNumber" placeholder="Contoh: A1234567">
                        </div>
                        <div class="form-group">
                            <label>Kota Penerbitan Paspor</label>
                            <input type="text" id="jamaahPassportCity" placeholder="Contoh: Jakarta">
                        </div>
                        <div class="form-group">
                            <label>Tanggal Penerbitan</label>
                            <input type="text" id="jamaahPassportIssueDate" placeholder="ddmmyyyy (contoh: 15012020)" maxlength="8" pattern="[0-9]{8}">
                            <small style="color: rgba(255, 255, 255, 0.6); font-size: 11px;">Format: ddmmyyyy</small>
                        </div>
                        <div class="form-group">
                            <label>Tanggal Kadaluarsa</label>
                            <input type="text" id="jamaahPassportExpireDate" placeholder="ddmmyyyy (contoh: 15012030)" maxlength="8" pattern="[0-9]{8}">
                            <small style="color: rgba(255, 255, 255, 0.6); font-size: 11px;">Format: ddmmyyyy</small>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Upload Foto Paspor</label>
                        <input type="file" id="jamaahPassportImage" accept="image/*" onchange="previewPassportImage(event)">
                        <div id="passportPreview" style="margin-top: 10px; display: none;">
                            <img id="passportImg" style="width: 100px; height: 60px; border-radius: 8px; object-fit: cover; border: 1px solid rgba(71, 85, 105, 0.4);">
                        </div>
                    </div>
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" class="btn btn-primary">
                        <span class="material-icons">save</span>
                        Simpan
                    </button>
                    <button type="button" class="btn btn-danger" onclick="closeModal('jamaahModal')">
                        <span class="material-icons">cancel</span>
                        Batal
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Package Modal -->
    <div id="packageModal" class="modal">
        <div class="modal-content" style="
            max-width: 800px;
            background: rgba(15, 23, 42, 0.85);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.18);
            box-shadow: 
                0 8px 32px 0 rgba(31, 38, 135, 0.37),
                inset 0 0 0 1px rgba(255, 255, 255, 0.1);
        ">
            <div class="modal-header" style="
                background: linear-gradient(135deg, rgba(59, 130, 246, 0.15), rgba(147, 51, 234, 0.15));
                margin: -30px -30px 20px -30px;
                padding: 24px 30px;
                border-radius: 24px 24px 0 0;
                border-bottom: 1px solid rgba(255, 255, 255, 0.1);
                display: flex;
                justify-content: space-between;
                align-items: center;
            ">
                <div>
                    <h3 style="
                        margin: 0;
                        font-size: 24px;
                        font-weight: 700;
                        background: linear-gradient(135deg, #3b82f6, #9333ea);
                        -webkit-background-clip: text;
                        -webkit-text-fill-color: transparent;
                    ">Tambah/Edit Paket Umroh</h3>
                    <p style="
                        margin: 5px 0 0 0;
                        font-size: 14px;
                        color: rgba(255, 255, 255, 0.6);
                    ">Kelola informasi paket perjalanan umroh</p>
                </div>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <button type="button" onclick="clearPackageForm()" style="
                        background: rgba(239, 68, 68, 0.2);
                        border: 1px solid rgba(239, 68, 68, 0.3);
                        color: #ef4444;
                        padding: 8px 16px;
                        border-radius: 12px;
                        cursor: pointer;
                        display: flex;
                        align-items: center;
                        gap: 6px;
                        font-size: 14px;
                        transition: all 0.3s ease;
                    " onmouseover="this.style.background='rgba(239, 68, 68, 0.3)'" onmouseout="this.style.background='rgba(239, 68, 68, 0.2)'">
                        <span class="material-icons" style="font-size: 18px;">clear_all</span>
                        Hapus Semua
                    </button>
                    <button class="close-btn" style="
                        background: rgba(255, 255, 255, 0.1);
                        border: 1px solid rgba(255, 255, 255, 0.2);
                        width: 36px;
                        height: 36px;
                        border-radius: 12px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        cursor: pointer;
                        transition: all 0.3s ease;
                    " onmouseover="this.style.background='rgba(255, 255, 255, 0.2)'" onmouseout="this.style.background='rgba(255, 255, 255, 0.1)'">&times;</button>
                </div>
            </div>
            
            <form id="packageForm" onsubmit="savePackage(event)">
                <div class="form-grid" style="margin-top: 10px;">
                    <div class="form-group">
                        <label class="glass-label">Nama Paket</label>
                        <input type="text" id="packageName" class="glass-input" required>
                    </div>
                    <div class="form-group">
                        <label class="glass-label">Kode Paket</label>
                        <input type="text" id="packageCode" class="glass-input" placeholder="Contoh: PKG001" required>
                    </div>
                    <div class="form-group">
                        <label class="glass-label">Harga (IDR)</label>
                        <input type="number" id="packagePrice" class="glass-input" required>
                    </div>
                    <div class="form-group">
                        <label class="glass-label">Tanggal Keberangkatan</label>
                        <input type="date" id="packageDeparture" class="glass-input" required>
                    </div>
                    <div class="form-group">
                        <label class="glass-label">Tanggal Kembali</label>
                        <input type="date" id="packageReturn" class="glass-input" required>
                    </div>
                    <div class="form-group">
                        <label class="glass-label">Kuota</label>
                        <input type="number" id="packageQuota" class="glass-input" required>
                    </div>
                    <div class="form-group">
                        <label class="glass-label">Hotel Makkah</label>
                        <input type="text" id="packageMakkahHotel" class="glass-input" required>
                    </div>
                    <div class="form-group">
                        <label class="glass-label">Hotel Madinah</label>
                        <input type="text" id="packageMadinahHotel" class="glass-input" required>
                    </div>
                    <div class="form-group">
                        <label class="glass-label">Malam di Makkah</label>
                        <input type="number" id="packageMakkahNights" class="glass-input" required>
                    </div>
                    <div class="form-group">
                        <label class="glass-label">Malam di Madinah</label>
                        <input type="number" id="packageMadinahNights" class="glass-input" required>
                    </div>
                    <div class="form-group">
                        <label class="glass-label">Maskapai</label>
                        <input type="text" id="packageAirline" class="glass-input" required>
                    </div>
                </div>
                
                <!-- Flight Details Section -->
                <h4 style="
                    background: linear-gradient(135deg, #3b82f6, #10b981);
                    -webkit-background-clip: text;
                    -webkit-text-fill-color: transparent;
                    margin: 30px 0 20px 0;
                    padding-top: 30px;
                    border-top: 1px solid rgba(255, 255, 255, 0.1);
                    font-size: 18px;
                    font-weight: 600;
                ">Detail Penerbangan</h4>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label class="glass-label">Kota Keberangkatan</label>
                        <select id="packageDepartureCity" class="glass-input" onchange="handleCitySelectChange(this, 'departure')">
                            <option value="Jakarta">Jakarta</option>
                            <option value="Surabaya">Surabaya</option>
                            <option value="add_new" style="background: rgba(59, 130, 246, 0.1); color: #60a5fa; font-weight: 500;">+ Tambah Kota Baru</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="glass-label">Transit Berangkat</label>
                        <input type="text" id="packageTransitDeparture" class="glass-input" placeholder="Contoh: Istanbul (opsional)">
                    </div>
                    <div class="form-group">
                        <label class="glass-label">Kota Tiba</label>
                        <select id="packageArrivalCity" class="glass-input" onchange="handleCitySelectChange(this, 'arrival')">
                            <option value="Jeddah">Jeddah</option>
                            <option value="Madinah" selected>Madinah</option>
                            <option value="Taif">Taif</option>
                            <option value="add_new" style="background: rgba(59, 130, 246, 0.1); color: #60a5fa; font-weight: 500;">+ Tambah Kota Baru</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="glass-label">No. Penerbangan Berangkat</label>
                        <input type="text" id="packageDepartureFlightNumber" class="glass-input" placeholder="Contoh: TK057 (opsional)">
                    </div>
                </div>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label class="glass-label">Kota Pulang Dari</label>
                        <select id="packageReturnDepartureCity" class="glass-input" onchange="handleCitySelectChange(this, 'returnDeparture')">
                            <option value="Jeddah" selected>Jeddah</option>
                            <option value="Madinah">Madinah</option>
                            <option value="Taif">Taif</option>
                            <option value="add_new" style="background: rgba(59, 130, 246, 0.1); color: #60a5fa; font-weight: 500;">+ Tambah Kota Baru</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="glass-label">Transit Pulang</label>
                        <input type="text" id="packageTransitReturn" class="glass-input" placeholder="Contoh: Istanbul (opsional)">
                    </div>
                    <div class="form-group">
                        <label class="glass-label">Kota Tiba Pulang</label>
                        <select id="packageReturnArrivalCity" class="glass-input" onchange="handleCitySelectChange(this, 'returnArrival')">
                            <option value="Jakarta">Jakarta</option>
                            <option value="Surabaya">Surabaya</option>
                            <option value="add_new" style="background: rgba(59, 130, 246, 0.1); color: #60a5fa; font-weight: 500;">+ Tambah Kota Baru</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="glass-label">No. Penerbangan Pulang</label>
                        <input type="text" id="packageReturnFlightNumber" class="glass-input" placeholder="Contoh: TK058 (opsional)">
                    </div>
                </div>
                
                <div class="form-group" style="grid-column: 1 / -1;">
                    <label class="glass-label">Catatan Penerbangan</label>
                    <textarea id="packageFlightInfo" class="glass-textarea" rows="2" placeholder="Informasi tambahan tentang penerbangan (opsional)"></textarea>
                </div>
                
                <div class="form-group" style="grid-column: 1 / -1;">
                    <label class="glass-label">Gambar Brosur Utama</label>
                    <div class="file-input-wrapper">
                        <label for="packageBrochure" class="file-input-label" id="brochureLabel">
                            <span class="material-icons">cloud_upload</span>
                            <span id="brochureText">Pilih Gambar Brosur</span>
                        </label>
                        <input type="file" id="packageBrochure" accept="image/*" onchange="handleBrochureChange(event)">
                    </div>
                    <div id="brochurePreview" style="margin-top: 15px; display: none;">
                        <img id="brochureImg" style="width: 100%; max-width: 300px; height: auto; border-radius: 12px; object-fit: cover; border: 1px solid rgba(255, 255, 255, 0.2); box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);">
                    </div>
                </div>
                
                <div class="form-group" style="grid-column: 1 / -1;">
                    <label class="glass-label">Gambar Tambahan (Multiple)</label>
                    <div class="file-input-wrapper">
                        <label for="packageImages" class="file-input-label" id="imagesLabel">
                            <span class="material-icons">add_photo_alternate</span>
                            <span id="imagesText">Pilih Beberapa Gambar</span>
                        </label>
                        <input type="file" id="packageImages" accept="image/*" multiple onchange="handleImagesChange(event)">
                    </div>
                    <small style="color: rgba(255, 255, 255, 0.5); display: block; margin-top: 8px;">Anda dapat memilih beberapa gambar sekaligus (maks. 10 gambar)</small>
                    <div id="multipleImagesPreview" style="margin-top: 15px; display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px;">
                    </div>
                </div>
                
                <div class="form-group" style="grid-column: 1 / -1;">
                    <label class="glass-label">Deskripsi Singkat</label>
                    <textarea id="packageDescription" class="glass-textarea" rows="3" placeholder="Deskripsi singkat paket (maks. 200 karakter)"></textarea>
                </div>
                
                <div class="form-group" style="grid-column: 1 / -1;">
                    <label class="glass-label">Informasi Detail Paket</label>
                    <textarea id="packageInfo" class="glass-textarea" rows="5" placeholder="Informasi lengkap tentang paket ini, fasilitas, itinerary, dll."></textarea>
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 30px; padding-top: 20px; border-top: 1px solid rgba(255, 255, 255, 0.1);">
                    <button type="submit" class="btn btn-primary" style="
                        background: linear-gradient(135deg, #3b82f6, #2563eb);
                        border: 1px solid rgba(59, 130, 246, 0.3);
                        color: white;
                        padding: 12px 24px;
                        border-radius: 12px;
                        font-weight: 500;
                        display: flex;
                        align-items: center;
                        gap: 8px;
                        transition: all 0.3s ease;
                        box-shadow: 0 4px 15px rgba(59, 130, 246, 0.2);
                    " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(59, 130, 246, 0.3)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(59, 130, 246, 0.2)'">
                        <span class="material-icons">save</span>
                        Simpan
                    </button>
                    <button type="button" class="btn btn-danger" onclick="closeModal('packageModal')" style="
                        background: rgba(239, 68, 68, 0.2);
                        border: 1px solid rgba(239, 68, 68, 0.3);
                        color: #ef4444;
                        padding: 12px 24px;
                        border-radius: 12px;
                        font-weight: 500;
                        display: flex;
                        align-items: center;
                        gap: 8px;
                        transition: all 0.3s ease;
                    " onmouseover="this.style.background='rgba(239, 68, 68, 0.3)'" onmouseout="this.style.background='rgba(239, 68, 68, 0.2)'">
                        <span class="material-icons">cancel</span>
                        Batal
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Payment Modal -->
    <div id="paymentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Catat Pembayaran</h3>
                <button class="close-btn">&times;</button>
            </div>
            
            <form onsubmit="savePayment(event)">
                <div class="form-grid">
                    <div class="form-group">
                        <label>Jamaah</label>
                        <select id="paymentJamaah" required>
                            <option value="">Pilih Jamaah</option>
                            <option value="1">Ahmad Fauzi - 1234567890123456</option>
                            <option value="2">Siti Aisyah - 1234567890123457</option>
                            <option value="3">Muhammad Rizki - 1234567890123458</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Jumlah Pembayaran</label>
                        <input type="number" id="paymentAmount" required>
                    </div>
                    <div class="form-group">
                        <label>Tanggal Pembayaran</label>
                        <input type="date" id="paymentDate" required>
                    </div>
                    <div class="form-group">
                        <label>Metode Pembayaran</label>
                        <select id="paymentMethod" required>
                            <option value="">Pilih Metode</option>
                            <option value="transfer_bank">Transfer Bank</option>
                            <option value="cash">Cash</option>
                            <option value="credit_card">Kartu Kredit</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Bank</label>
                        <input type="text" id="paymentBank">
                    </div>
                    <div class="form-group">
                        <label>No. Referensi</label>
                        <input type="text" id="paymentReference">
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Catatan</label>
                    <textarea id="paymentNotes" rows="2"></textarea>
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" class="btn btn-primary">
                        <span class="material-icons">save</span>
                        Simpan
                    </button>
                    <button type="button" class="btn btn-danger" onclick="closeModal('paymentModal')">
                        <span class="material-icons">cancel</span>
                        Batal
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Group Modal -->
    <div id="groupModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Buat Grup Keberangkatan</h3>
                <button class="close-btn">&times;</button>
            </div>
            
            <form onsubmit="saveGroup(event)">
                <div class="form-grid">
                    <div class="form-group">
                        <label>Nama Grup</label>
                        <input type="text" id="groupName" required>
                    </div>
                    <div class="form-group">
                        <label>Paket</label>
                        <select id="groupPackage" required>
                            <option value="">Pilih Paket</option>
                            <option value="1">Umroh Ramadhan 2024</option>
                            <option value="2">Umroh Plus Turki</option>
                            <option value="3">Umroh Keluarga</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Tanggal Keberangkatan</label>
                        <input type="date" id="groupDeparture" required>
                    </div>
                    <div class="form-group">
                        <label>Maksimal Anggota</label>
                        <input type="number" id="groupMaxMembers" value="45" required>
                    </div>
                    <div class="form-group">
                        <label>No. Bus</label>
                        <input type="text" id="groupBusNumber">
                    </div>
                    <div class="form-group">
                        <label>Waktu Kumpul</label>
                        <input type="time" id="groupMeetingTime">
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Tempat Kumpul</label>
                    <textarea id="groupMeetingPoint" rows="2"></textarea>
                </div>
                
                <div class="form-group">
                    <label>Tour Leader</label>
                    <input type="text" id="groupTourLeader" placeholder="Nama Ustadz/Tour Leader">
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" class="btn btn-primary">
                        <span class="material-icons">save</span>
                        Buat Grup
                    </button>
                    <button type="button" class="btn btn-danger" onclick="closeModal('groupModal')">
                        <span class="material-icons">cancel</span>
                        Batal
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Package Details Modal -->
    <div id="packageDetailModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h3 id="packageDetailTitle">Detail Paket Umroh</h3>
                <button class="close-btn">&times;</button>
            </div>
            
            <div id="packageDetailContent" style="padding: 20px;">
                <!-- Content will be populated dynamically -->
            </div>
            
            <div style="display: flex; justify-content: flex-end; padding: 20px; border-top: 1px solid rgba(255, 255, 255, 0.1);">
                <button class="btn btn-primary" onclick="closeModal('packageDetailModal')">
                    <span class="material-icons">close</span>
                    Tutup
                </button>
            </div>
        </div>
    </div>
    
    <!-- Image Preview Modal -->
    <div id="imagePreviewModal" class="modal">
        <div class="modal-content" style="max-width: 90%; max-height: 90vh; padding: 0; background: rgba(15, 23, 42, 0.95);">
            <div class="modal-header" style="padding: 15px 20px;">
                <h3 id="imagePreviewTitle" style="margin: 0;">Preview Gambar</h3>
                <button class="close-btn" onclick="closeModal('imagePreviewModal')">&times;</button>
            </div>
            <div style="display: flex; align-items: center; justify-content: center; padding: 20px;">
                <img id="imagePreviewImg" src="" alt="" style="max-width: 100%; max-height: 70vh; border-radius: 8px;">
            </div>
        </div>
    </div>
    
    <!-- WhatsApp QR Code Modal -->
    <div id="whatsappQRModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3>Sambungkan WhatsApp</h3>
                <button class="close-btn" onclick="closeModal('whatsappQRModal')">&times;</button>
            </div>
            
            <div style="padding: 20px; text-align: center;">
                <div id="qrCodeContainer" style="margin: 20px auto; padding: 20px; background: white; border-radius: 12px; display: inline-block;">
                    <div id="qrCodeLoader" style="padding: 40px;">
                        <div class="spinner" style="margin: 0 auto 20px;"></div>
                        <p style="color: #1e293b;">Memuat QR Code...</p>
                    </div>
                    <canvas id="qrCodeCanvas" style="display: none;"></canvas>
                </div>
                
                <div style="margin-top: 20px;">
                    <h4 style="color: #25D366; margin-bottom: 15px;">Cara Menyambungkan:</h4>
                    <ol style="text-align: left; max-width: 400px; margin: 0 auto; color: rgba(255, 255, 255, 0.8); line-height: 1.8;">
                        <li>Buka WhatsApp di HP Anda</li>
                        <li>Tap titik tiga (⋮) atau Settings</li>
                        <li>Pilih "Linked Devices" atau "Perangkat Tertaut"</li>
                        <li>Tap "Link a Device" atau "Tautkan Perangkat"</li>
                        <li>Scan QR code di atas</li>
                    </ol>
                </div>
                
                <div id="waConnectionProgress" style="display: none; margin-top: 20px;">
                    <div class="progress-bar" style="background: rgba(37, 211, 102, 0.2);">
                        <div style="width: 0%; background: #25D366; transition: width 0.3s;"></div>
                    </div>
                    <p style="margin-top: 10px; color: #25D366;">Menghubungkan...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Room Management Modal -->
    <div id="roomModal" class="modal">
        <div class="modal-content" style="max-width: 1200px; width: 95%;">
            <div class="modal-header">
                <h3 id="roomModalTitle">Room List - Grup Ramadhan A</h3>
                <button class="close-btn">&times;</button>
            </div>
            
            <div class="room-management">
                <!-- Room Allocation Header -->
                <div class="room-allocation-header">
                    <div>
                        <h4 style="color: #f8fafc; margin: 0;">Pengaturan Kamar Otomatis</h4>
                        <p style="color: rgba(255, 255, 255, 0.7); margin: 4px 0 0 0; font-size: 12px;">Sistem akan mengalokasikan kamar berdasarkan preferensi jamaah</p>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-primary" onclick="autoAllocateRooms()">
                            <span class="material-icons">auto_awesome</span>
                            Auto Allocate
                        </button>
                        <button class="btn btn-warning" onclick="clearAllRooms()">
                            <span class="material-icons">clear_all</span>
                            Clear All
                        </button>
                    </div>
                </div>

                <!-- Room Statistics -->
                <div class="room-stats">
                    <div class="room-stat-item">
                        <div class="room-stat-number" id="totalRooms">0</div>
                        <div class="room-stat-label">Total Kamar</div>
                    </div>
                    <div class="room-stat-item">
                        <div class="room-stat-number" id="occupiedRooms">0</div>
                        <div class="room-stat-label">Kamar Terisi</div>
                    </div>
                    <div class="room-stat-item">
                        <div class="room-stat-number" id="assignedJamaah">0</div>
                        <div class="room-stat-label">Jamaah Ditempatkan</div>
                    </div>
                    <div class="room-stat-item">
                        <div class="room-stat-number" id="unassignedJamaah">0</div>
                        <div class="room-stat-label">Belum Ditempatkan</div>
                    </div>
                </div>

                <!-- Allocation Strategy -->
                <div class="allocation-controls">
                    <div class="allocation-option active" data-strategy="auto" onclick="selectAllocationStrategy('auto')">
                        <div class="allocation-icon material-icons">auto_awesome</div>
                        <div class="allocation-title">Auto Smart</div>
                        <div class="allocation-desc">Sistem otomatis mengalokasikan berdasarkan preferensi dan gender</div>
                    </div>
                    <div class="allocation-option" data-strategy="preference" onclick="selectAllocationStrategy('preference')">
                        <div class="allocation-icon material-icons">tune</div>
                        <div class="allocation-title">By Preference</div>
                        <div class="allocation-desc">Prioritaskan preferensi kamar yang dipilih jamaah</div>
                    </div>
                    <div class="allocation-option" data-strategy="family" onclick="selectAllocationStrategy('family')">
                        <div class="allocation-icon material-icons">family_restroom</div>
                        <div class="allocation-title">Family First</div>
                        <div class="allocation-desc">Kelompokkan anggota keluarga dalam kamar yang sama</div>
                    </div>
                    <div class="allocation-option" data-strategy="manual" onclick="selectAllocationStrategy('manual')">
                        <div class="allocation-icon material-icons">pan_tool</div>
                        <div class="allocation-title">Manual</div>
                        <div class="allocation-desc">Atur penempatan kamar secara manual</div>
                    </div>
                </div>

                <!-- Unassigned Jamaah -->
                <div class="unassigned-jamaah" id="unassignedSection">
                    <div class="unassigned-header">
                        <span class="material-icons">person_off</span>
                        Jamaah Belum Ditempatkan (<span id="unassignedCount">0</span>)
                    </div>
                    <div class="unassigned-list" id="unassignedList">
                        <!-- Unassigned jamaah will be populated here -->
                    </div>
                </div>

                <!-- Room Grid -->
                <div class="room-grid" id="roomGrid">
                    <!-- Room cards will be populated here -->
                </div>

                <!-- Room Actions -->
                <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(71, 85, 105, 0.3);">
                    <button class="btn btn-success" onclick="exportRoomList()">
                        <span class="material-icons">download</span>
                        Export Room List
                    </button>
                    <button class="btn btn-primary" onclick="saveRoomAssignments()">
                        <span class="material-icons">save</span>
                        Simpan Pengaturan
                    </button>
                    <button class="btn btn-danger" onclick="closeModal('roomModal')">
                        <span class="material-icons">close</span>
                        Tutup
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Flight Management Modals -->
    
    <!-- Create PNR Modal -->
    <div id="pnrModal" class="modal">
        <div class="modal-content" style="
            max-width: 900px;
            background: rgba(15, 23, 42, 0.85);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.18);
            box-shadow: 
                0 8px 32px 0 rgba(31, 38, 135, 0.37),
                inset 0 0 0 1px rgba(255, 255, 255, 0.1);
        ">
            <div class="modal-header" style="
                background: linear-gradient(135deg, rgba(245, 158, 11, 0.15), rgba(251, 191, 36, 0.15));
                margin: -30px -30px 20px -30px;
                padding: 24px 30px;
                border-radius: 24px 24px 0 0;
                border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            ">
                <h3 id="pnrModalTitle">Tambah PNR Baru</h3>
                <button class="close-btn" onclick="closeModal('pnrModal')">&times;</button>
            </div>
            
            <form id="pnrForm" style="padding: 10px;">
                <div class="form-grid">
                    <div class="form-group">
                        <label>Kode PNR *</label>
                        <input type="text" id="pnr_code" required placeholder="Contoh: ABC123">
                    </div>
                    <div class="form-group">
                        <label>Maskapai *</label>
                        <input type="text" id="airline" required placeholder="Contoh: Garuda Indonesia">
                    </div>
                    <div class="form-group">
                        <label>Kode Maskapai</label>
                        <input type="text" id="airline_code" placeholder="Contoh: GA">
                    </div>
                    <div class="form-group">
                        <label>Total Kursi *</label>
                        <input type="number" id="total_seats" required min="1">
                    </div>
                </div>
                
                <h4 style="margin: 30px 0 20px; color: #F59E0B;">Detail Penerbangan</h4>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label>Kota Keberangkatan *</label>
                        <select id="departure_city" required>
                            <option value="">Pilih Kota</option>
                            <option value="Jakarta">Jakarta</option>
                            <option value="Surabaya">Surabaya</option>
                            <option value="Medan">Medan</option>
                            <option value="Bandung">Bandung</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Kota Tujuan *</label>
                        <select id="arrival_city" required>
                            <option value="">Pilih Kota</option>
                            <option value="Jeddah">Jeddah</option>
                            <option value="Madinah">Madinah</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Tanggal Berangkat *</label>
                        <input type="date" id="departure_date" required>
                    </div>
                    <div class="form-group">
                        <label>Waktu Berangkat</label>
                        <input type="time" id="departure_time">
                    </div>
                    <div class="form-group">
                        <label>Waktu Tiba</label>
                        <input type="time" id="arrival_time">
                    </div>
                    <div class="form-group">
                        <label>Nomor Penerbangan</label>
                        <input type="text" id="flight_number" placeholder="Contoh: GA123">
                    </div>
                </div>
                
                <h4 style="margin: 30px 0 20px; color: #F59E0B;">Penerbangan Pulang</h4>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label>Tanggal Pulang</label>
                        <input type="date" id="return_date">
                    </div>
                    <div class="form-group">
                        <label>Waktu Berangkat Pulang</label>
                        <input type="time" id="return_departure_time">
                    </div>
                    <div class="form-group">
                        <label>Waktu Tiba Pulang</label>
                        <input type="time" id="return_arrival_time">
                    </div>
                    <div class="form-group">
                        <label>Nomor Penerbangan Pulang</label>
                        <input type="text" id="return_flight_number" placeholder="Contoh: GA124">
                    </div>
                </div>
                
                <h4 style="margin: 30px 0 20px; color: #F59E0B;">Informasi Harga</h4>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label>Harga per Kursi *</label>
                        <input type="number" id="price_per_seat" required min="0" placeholder="0">
                    </div>
                    <div class="form-group">
                        <label>Tanggal Booking</label>
                        <input type="date" id="booking_date">
                    </div>
                    <div class="form-group">
                        <label>Tanggal Jatuh Tempo</label>
                        <input type="date" id="payment_due_date">
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Catatan</label>
                    <textarea id="notes" rows="3" placeholder="Catatan tambahan..."></textarea>
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 30px; justify-content: flex-end;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('pnrModal')">
                        <span class="material-icons">close</span>
                        Batal
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <span class="material-icons">save</span>
                        Simpan PNR
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Packages Without PNR Modal -->
    <div id="packagesWithoutPNRModal" class="modal">
        <div class="modal-content" style="
            max-width: 1000px;
            background: rgba(15, 23, 42, 0.85);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.18);
            box-shadow: 
                0 8px 32px 0 rgba(31, 38, 135, 0.37),
                inset 0 0 0 1px rgba(255, 255, 255, 0.1);
        ">
            <div class="modal-header" style="
                background: linear-gradient(135deg, rgba(239, 68, 68, 0.15), rgba(248, 113, 113, 0.15));
                margin: -30px -30px 20px -30px;
                padding: 24px 30px;
                border-radius: 24px 24px 0 0;
                border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            ">
                <h3>Paket yang Belum Memiliki PNR</h3>
                <button class="close-btn" onclick="closeModal('packagesWithoutPNRModal')">&times;</button>
            </div>
            
            <div style="padding: 10px;">
                <div id="packagesWithoutPNRList" class="cards-grid">
                    <!-- Package cards will be loaded here -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- PNR Detail Modal -->
    <div id="pnrDetailModal" class="modal">
        <div class="modal-content" style="
            max-width: 1100px;
            background: rgba(15, 23, 42, 0.85);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.18);
            box-shadow: 
                0 8px 32px 0 rgba(31, 38, 135, 0.37),
                inset 0 0 0 1px rgba(255, 255, 255, 0.1);
        ">
            <div class="modal-header" style="
                background: linear-gradient(135deg, rgba(245, 158, 11, 0.15), rgba(251, 191, 36, 0.15));
                margin: -30px -30px 20px -30px;
                padding: 24px 30px;
                border-radius: 24px 24px 0 0;
                border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            ">
                <h3 id="pnrDetailTitle">Detail PNR</h3>
                <button class="close-btn" onclick="closeModal('pnrDetailModal')">&times;</button>
            </div>
            
            <div id="pnrDetailContent" style="padding: 10px;">
                <!-- Content will be populated dynamically -->
            </div>
        </div>
    </div>
    
    <!-- Assign Package to PNR Modal -->
    <div id="assignPackageModal" class="modal">
        <div class="modal-content" style="
            max-width: 600px;
            background: rgba(15, 23, 42, 0.85);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.18);
            box-shadow: 
                0 8px 32px 0 rgba(31, 38, 135, 0.37),
                inset 0 0 0 1px rgba(255, 255, 255, 0.1);
        ">
            <div class="modal-header" style="
                background: linear-gradient(135deg, rgba(59, 130, 246, 0.15), rgba(96, 165, 250, 0.15));
                margin: -30px -30px 20px -30px;
                padding: 24px 30px;
                border-radius: 24px 24px 0 0;
                border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            ">
                <h3>Assign Paket ke PNR</h3>
                <button class="close-btn" onclick="closeModal('assignPackageModal')">&times;</button>
            </div>
            
            <form id="assignPackageForm" style="padding: 10px;">
                <input type="hidden" id="assign_pnr_id">
                
                <div class="form-group">
                    <label>PNR</label>
                    <input type="text" id="assign_pnr_info" readonly style="background: rgba(255, 255, 255, 0.05);">
                </div>
                
                <div class="form-group">
                    <label>Pilih Paket *</label>
                    <select id="assign_package_id" required>
                        <option value="">Pilih Paket</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Jumlah Kursi *</label>
                    <input type="number" id="assign_seats" required min="1">
                    <small style="color: rgba(255, 255, 255, 0.6);">Kursi tersedia: <span id="available_seats">0</span></small>
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 30px; justify-content: flex-end;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('assignPackageModal')">
                        <span class="material-icons">close</span>
                        Batal
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <span class="material-icons">check</span>
                        Assign
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Add Payment Modal -->
    <div id="flightPaymentModal" class="modal">
        <div class="modal-content" style="
            max-width: 700px;
            background: rgba(15, 23, 42, 0.85);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.18);
            box-shadow: 
                0 8px 32px 0 rgba(31, 38, 135, 0.37),
                inset 0 0 0 1px rgba(255, 255, 255, 0.1);
        ">
            <div class="modal-header" style="
                background: linear-gradient(135deg, rgba(16, 185, 129, 0.15), rgba(52, 211, 153, 0.15));
                margin: -30px -30px 20px -30px;
                padding: 24px 30px;
                border-radius: 24px 24px 0 0;
                border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            ">
                <h3>Tambah Pembayaran</h3>
                <button class="close-btn" onclick="closeModal('flightPaymentModal')">&times;</button>
            </div>
            
            <form id="flightPaymentForm" style="padding: 10px;">
                <input type="hidden" id="payment_pnr_id">
                
                <div class="form-group">
                    <label>PNR</label>
                    <input type="text" id="payment_pnr_info" readonly style="background: rgba(255, 255, 255, 0.05);">
                </div>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label>Tanggal Pembayaran *</label>
                        <input type="date" id="payment_date" required>
                    </div>
                    <div class="form-group">
                        <label>Jumlah *</label>
                        <input type="number" id="payment_amount" required min="0">
                    </div>
                    <div class="form-group">
                        <label>Metode Pembayaran *</label>
                        <select id="payment_method" required>
                            <option value="">Pilih Metode</option>
                            <option value="transfer">Transfer Bank</option>
                            <option value="cash">Cash</option>
                            <option value="credit_card">Kartu Kredit</option>
                            <option value="other">Lainnya</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Referensi Pembayaran</label>
                        <input type="text" id="payment_reference" placeholder="No. Invoice / Referensi">
                    </div>
                    <div class="form-group">
                        <label>Nama Bank</label>
                        <input type="text" id="bank_name" placeholder="Nama Bank (jika transfer)">
                    </div>
                    <div class="form-group">
                        <label>No. Rekening</label>
                        <input type="text" id="account_number" placeholder="Nomor Rekening">
                    </div>
                    <div class="form-group">
                        <label>Nama Pemilik Rekening</label>
                        <input type="text" id="account_name" placeholder="Atas Nama">
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Catatan</label>
                    <textarea id="payment_notes" rows="3" placeholder="Catatan pembayaran..."></textarea>
                </div>
                
                <div class="form-group">
                    <label>Bukti Pembayaran</label>
                    <input type="file" id="payment_proof" accept="image/*,.pdf" class="custom-file-input">
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 30px; justify-content: flex-end;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('flightPaymentModal')">
                        <span class="material-icons">close</span>
                        Batal
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <span class="material-icons">save</span>
                        Simpan Pembayaran
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // API Configuration
        function getApiBaseUrl() {
            return window.location.hostname === 'localhost' 
                ? 'http://localhost:5000'
                : 'http://103.181.143.223:5000';
        }
        
        function getAuthToken() {
            // For demo purposes, return a dummy token
            // In production, this should retrieve the actual auth token from localStorage/sessionStorage
            return 'demo-token';
        }
        
        // Sample Data
        let jamaahData = []; // Will be loaded from API

        /*
                nik: "1234567890123456",
                phone: "081234567890",
                email: "ahmad@email.com",
                package: "Umroh Ramadhan 2024",
                package_id: 1,
                group_id: 1,
                status: "verified",
                payment_status: "paid",
                document_status: "approved",
                visa_status: "approved",
                total_paid: 15000000,
                total_amount: 15000000,
                amount_paid: 15000000,
                birth_date: "15051985",
                birth_place: "Jakarta",
                gender: "male",
                address: "Jl. Merdeka No. 123, Jakarta",
                passport_image: "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjEyMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjMzM0MTU1Ii8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNCIgZmlsbD0iI2Y4ZmFmYyIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPkFobWFkIEZhdXppPC90ZXh0Pjx0ZXh0IHg9IjUwJSIgeT0iNzAlIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTAiIGZpbGw9IiNjYmQ1ZTEiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIuM2VtIj5QYXNwb3IgSW5kb25lc2lhPC90ZXh0Pjwvc3ZnPg==",
                passport_number: "A1234567",
                passport_name: "Ahmad Fauzi",
                passport_city: "Jakarta",
                passport_issue_date: "01012020",
                passport_expire_date: "01012030",
                provinsi: "DKI Jakarta",
                marital_status: "married",
                education: "s1",
                occupation: "Pegawai Swasta",
                emergency_contact_name: "Siti Fauzi",
                emergency_contact_phone: "081234567891",
                emergency_contact_relation: "Istri",
                mahram_name: "Sendiri",
                medical_conditions: "",
                medications: "",
                allergies: "",
                mobility_assistance: false,
                main_family_id: 1,
                family_role: "kepala_keluarga",
                room_preference: "quad",
                family_room_request: true,
                registration_number: "UMR202400001"
            },
            // Family 1 - Ahmad Fauzi's family (4 people - quad room)
            {
                id: 2,
                name: "Siti Fauzi",
                nik: "1234567890123457",
                phone: "081234567891",
                email: "siti.fauzi@email.com",
                package: "Umroh Ramadhan 2024",
                package_id: 1,
                group_id: 1,
                status: "verified",
                payment_status: "paid",
                document_status: "approved",
                visa_status: "approved",
                total_amount: 15000000,
                amount_paid: 15000000,
                birth_date: "10081987",
                birth_place: "Jakarta",
                gender: "female",
                address: "Jl. Merdeka No. 123, Jakarta",
                passport_number: "B2345678",
                passport_name: "Siti Fauzi",
                passport_city: "Jakarta",
                passport_issue_date: "15022020",
                passport_expire_date: "15022030",
                provinsi: "DKI Jakarta",
                marital_status: "married",
                education: "sma",
                occupation: "Ibu Rumah Tangga",
                emergency_contact_name: "Ahmad Fauzi",
                emergency_contact_phone: "081234567890",
                emergency_contact_relation: "Suami",
                mahram_name: "Ahmad Fauzi",
                main_family_id: 1,
                family_role: "istri",
                room_preference: "quad",
                family_room_request: true,
                registration_number: "UMR202400002"
            },
            {
                id: 3,
                name: "Fatimah Fauzi",
                nik: "1234567890123458",
                phone: "081234567892",
                email: "fatimah.fauzi@email.com",
                package: "Umroh Ramadhan 2024",
                package_id: 1,
                group_id: 1,
                status: "verified",
                payment_status: "paid",
                document_status: "approved",
                visa_status: "approved",
                total_amount: 13000000,
                amount_paid: 13000000,
                birth_date: "05122010",
                birth_place: "Jakarta",
                gender: "female",
                address: "Jl. Merdeka No. 123, Jakarta",
                passport_number: "C3456789",
                passport_name: "Fatimah Fauzi",
                passport_city: "Jakarta",
                passport_issue_date: "20032022",
                passport_expire_date: "20032032",
                provinsi: "DKI Jakarta",
                marital_status: "single",
                education: "smp",
                occupation: "Pelajar",
                emergency_contact_name: "Ahmad Fauzi",
                emergency_contact_phone: "081234567890",
                emergency_contact_relation: "Ayah",
                mahram_name: "Ahmad Fauzi",
                main_family_id: 1,
                family_role: "anak",
                room_preference: "quad",
                family_room_request: true,
                registration_number: "UMR202400003"
            },
            {
                id: 4,
                name: "Muhammad Fauzi",
                nik: "1234567890123459",
                phone: "081234567893",
                email: "muhammad.fauzi@email.com",
                package: "Umroh Ramadhan 2024",
                package_id: 1,
                group_id: 1,
                status: "verified",
                payment_status: "paid",
                document_status: "approved",
                visa_status: "approved",
                total_amount: 13000000,
                amount_paid: 13000000,
                birth_date: "15062012",
                birth_place: "Jakarta",
                gender: "male",
                address: "Jl. Merdeka No. 123, Jakarta",
                passport_number: "D4567890",
                passport_name: "Muhammad Fauzi",
                passport_city: "Jakarta",
                passport_issue_date: "10042022",
                passport_expire_date: "10042032",
                provinsi: "DKI Jakarta",
                marital_status: "single",
                education: "sd",
                occupation: "Pelajar",
                emergency_contact_name: "Ahmad Fauzi",
                emergency_contact_phone: "081234567890",
                emergency_contact_relation: "Ayah",
                mahram_name: "Ahmad Fauzi",
                main_family_id: 1,
                family_role: "anak",
                room_preference: "quad",
                family_room_request: true,
                registration_number: "UMR202400004"
            },
            // Family 2 - Budi's family (3 people - triple room)
            {
                id: 5,
                name: "Budi Santoso",
                nik: "1234567890123460",
                phone: "081234567894",
                email: "budi.santoso@email.com",
                package: "Umroh Ramadhan 2024",
                package_id: 1,
                group_id: 1,
                status: "verified",
                payment_status: "paid",
                document_status: "approved",
                visa_status: "approved",
                total_amount: 15000000,
                amount_paid: 15000000,
                birth_date: "20031982",
                birth_place: "Bandung",
                gender: "male",
                address: "Jl. Sudirman No. 456, Bandung",
                passport_number: "E5678901",
                passport_name: "Budi Santoso",
                passport_city: "Bandung",
                passport_issue_date: "05052021",
                passport_expire_date: "05052031",
                provinsi: "Jawa Barat",
                marital_status: "married",
                education: "s1",
                occupation: "Guru",
                emergency_contact_name: "Rina Santoso",
                emergency_contact_phone: "081234567895",
                emergency_contact_relation: "Istri",
                mahram_name: "Sendiri",
                main_family_id: 2,
                family_role: "kepala_keluarga",
                room_preference: "triple",
                family_room_request: true,
                registration_number: "UMR202400005"
            },
            {
                id: 6,
                name: "Rina Santoso",
                nik: "1234567890123461",
                phone: "081234567895",
                email: "rina.santoso@email.com",
                package: "Umroh Ramadhan 2024",
                package_id: 1,
                group_id: 1,
                status: "verified",
                payment_status: "paid",
                document_status: "approved",
                visa_status: "approved",
                total_amount: 15000000,
                amount_paid: 15000000,
                birth_date: "12111985",
                birth_place: "Bandung",
                gender: "female",
                address: "Jl. Sudirman No. 456, Bandung",
                passport_number: "F6789012",
                passport_name: "Rina Santoso",
                passport_city: "Bandung",
                passport_issue_date: "10062021",
                passport_expire_date: "10062031",
                provinsi: "Jawa Barat",
                marital_status: "married",
                education: "d3",
                occupation: "Perawat",
                emergency_contact_name: "Budi Santoso",
                emergency_contact_phone: "081234567894",
                emergency_contact_relation: "Suami",
                mahram_name: "Budi Santoso",
                main_family_id: 2,
                family_role: "istri",
                room_preference: "triple",
                family_room_request: true,
                registration_number: "UMR202400006"
            },
            {
                id: 7,
                name: "Aditya Santoso",
                nik: "1234567890123462",
                phone: "081234567896",
                email: "aditya.santoso@email.com",
                package: "Umroh Ramadhan 2024",
                package_id: 1,
                group_id: 1,
                status: "verified",
                payment_status: "paid",
                document_status: "approved",
                visa_status: "approved",
                total_amount: 13000000,
                amount_paid: 13000000,
                birth_date: "08092008",
                birth_place: "Bandung",
                gender: "male",
                address: "Jl. Sudirman No. 456, Bandung",
                passport_number: "G7890123",
                passport_name: "Aditya Santoso",
                passport_city: "Bandung",
                passport_issue_date: "15072021",
                passport_expire_date: "15072031",
                provinsi: "Jawa Barat",
                marital_status: "single",
                education: "sma",
                occupation: "Pelajar",
                emergency_contact_name: "Budi Santoso",
                emergency_contact_phone: "081234567894",
                emergency_contact_relation: "Ayah",
                mahram_name: "Budi Santoso",
                main_family_id: 2,
                family_role: "anak",
                room_preference: "triple",
                family_room_request: true,
                registration_number: "UMR202400007"
            },
            // Individual jamaah (double rooms)
            {
                id: 8,
                name: "Hasan Ibrahim",
                nik: "1234567890123463",
                phone: "081234567897",
                email: "hasan.ibrahim@email.com",
                package: "Umroh Ramadhan 2024",
                package_id: 1,
                group_id: 1,
                status: "verified",
                payment_status: "paid",
                document_status: "approved",
                visa_status: "approved",
                total_amount: 15000000,
                amount_paid: 15000000,
                birth_date: "25071975",
                birth_place: "Surabaya",
                gender: "male",
                address: "Jl. Pahlawan No. 789, Surabaya",
                passport_number: "H8901234",
                passport_name: "Hasan Ibrahim",
                passport_city: "Surabaya",
                passport_issue_date: "01012020",
                passport_expire_date: "01012030",
                provinsi: "Jawa Timur",
                marital_status: "widowed",
                education: "s1",
                occupation: "Wiraswasta",
                emergency_contact_name: "Ali Ibrahim",
                emergency_contact_phone: "081234567898",
                emergency_contact_relation: "Anak",
                mahram_name: "Sendiri",
                main_family_id: 3,
                family_role: "kepala_keluarga",
                room_preference: "double",
                family_room_request: false,
                registration_number: "UMR202400008"
            },
            {
                id: 9,
                name: "Abdullah Rahman",
                nik: "1234567890123464",
                phone: "081234567899",
                email: "abdullah.rahman@email.com",
                package: "Umroh Ramadhan 2024",
                package_id: 1,
                group_id: 1,
                status: "verified",
                payment_status: "partial",
                document_status: "approved",
                visa_status: "approved",
                total_amount: 15000000,
                amount_paid: 10000000,
                birth_date: "18041980",
                birth_place: "Medan",
                gender: "male",
                address: "Jl. Gatot Subroto No. 321, Medan",
                passport_number: "I9012345",
                passport_name: "Abdullah Rahman",
                passport_city: "Medan",
                passport_issue_date: "12122019",
                passport_expire_date: "12122029",
                provinsi: "Sumatera Utara",
                marital_status: "single",
                education: "s2",
                occupation: "Dosen",
                emergency_contact_name: "Fatimah Rahman",
                emergency_contact_phone: "081234567900",
                emergency_contact_relation: "Ibu",
                mahram_name: "Sendiri",
                main_family_id: 4,
                family_role: "kepala_keluarga",
                room_preference: "double",
                family_room_request: false,
                registration_number: "UMR202400009"
            },
            {
                id: 10,
                name: "Yusuf Hakim",
                nik: "1234567890123465",
                phone: "081234567901",
                email: "yusuf.hakim@email.com",
                package: "Umroh Ramadhan 2024",
                package_id: 1,
                group_id: 1,
                status: "verified",
                payment_status: "paid",
                document_status: "approved",
                visa_status: "approved",
                total_amount: 15000000,
                amount_paid: 15000000,
                birth_date: "03021990",
                birth_place: "Yogyakarta",
                gender: "male",
                address: "Jl. Malioboro No. 111, Yogyakarta",
                passport_number: "J0123456",
                passport_name: "Yusuf Hakim",
                passport_city: "Yogyakarta",
                passport_issue_date: "20032021",
                passport_expire_date: "20032031",
                provinsi: "DI Yogyakarta",
                marital_status: "married",
                education: "s1",
                occupation: "Pegawai Negeri",
                emergency_contact_name: "Zainab Hakim",
                emergency_contact_phone: "081234567902",
                emergency_contact_relation: "Istri",
                mahram_name: "Sendiri",
                main_family_id: 5,
                family_role: "kepala_keluarga",
                room_preference: "double",
                family_room_request: false,
                registration_number: "UMR202400010"
            }
            // Sample data removed - now using API
        */

        let packageData = [
            {
                id: 1,
                name: "Umroh Ramadhan 2024",
                code: "PKG001",
                price: 25000000,
                departure_date: "2024-03-15",
                duration: 14,
                quota: 45,
                booked: 10,
                makkah_hotel: "Hilton Makkah Convention",
                madinah_hotel: "Pullman Zamzam Madinah",
                makkah_nights: 7,
                madinah_nights: 7,
                airline: "Emirates",
                airline_code: "EK",
                description: "Paket umroh spesial bulan Ramadhan dengan fasilitas premium"
            },
            {
                id: 2,
                name: "Umroh Plus Turki",
                code: "PKG002",
                price: 35000000,
                departure_date: "2024-04-20",
                duration: 21,
                quota: 30,
                booked: 18,
                makkah_hotel: "Swissotel Makkah",
                madinah_hotel: "Anwar Al Madinah Movenpick",
                makkah_nights: 10,
                madinah_nights: 8,
                airline: "Turkish Airlines",
                airline_code: "TK",
                description: "Paket umroh dengan ekstensi wisata Istanbul, Turki"
            },
            {
                id: 3,
                name: "Umroh Keluarga",
                code: "PKG003",
                price: 22000000,
                departure_date: "2024-05-10",
                duration: 12,
                quota: 50,
                booked: 25,
                makkah_hotel: "Fairmont Makkah",
                madinah_hotel: "Dar Al Iman InterContinental",
                makkah_nights: 6,
                madinah_nights: 6,
                airline: "Saudi Airlines",
                airline_code: "SV",
                description: "Paket umroh khusus keluarga dengan fasilitas ramah anak"
            }
        ];

        let paymentData = [
            {
                id: 1,
                jamaah_id: 1,
                jamaah_name: "Ahmad Fauzi",
                package: "Umroh Ramadhan 2024",
                amount: 15000000,
                date: "2024-01-15",
                method: "Transfer Bank",
                bank: "BCA",
                reference: "TRF20240115001",
                status: "verified"
            },
            {
                id: 2,
                jamaah_id: 2,
                jamaah_name: "Siti Aisyah",
                package: "Umroh Plus Turki",
                amount: 20000000,
                date: "2024-01-20",
                method: "Transfer Bank",
                bank: "Mandiri",
                reference: "TRF20240120001",
                status: "pending"
            }
        ];

        let documentData = [
            {
                id: 1,
                jamaah_name: "Ahmad Fauzi",
                type: "Paspor",
                filename: "paspor_ahmad.pdf",
                upload_date: "2024-01-10",
                status: "verified"
            },
            {
                id: 2,
                jamaah_name: "Siti Aisyah",
                type: "KTP",
                filename: "ktp_siti.jpg",
                upload_date: "2024-01-12",
                status: "pending"
            }
        ];

        let groupData = [
            {
                id: 1,
                name: "Grup Ramadhan A",
                package: "Umroh Ramadhan 2024",
                departure_date: "2024-03-15",
                max_members: 45,
                current_members: 10,
                bus_number: "BUS001",
                meeting_time: "04:00",
                meeting_point: "Masjid Al-Ikhlas, Jakarta Pusat",
                tour_leader: "Ustadz Ahmad Fauzi",
                status: "active",
                sub_groups: [
                    {
                        id: 1,
                        name: "Sub Grup Hotel Hilton",
                        hotel_makkah: "Hilton Makkah Convention",
                        hotel_madinah: "Hilton Madinah",
                        members: 7,
                        max_members: 23
                    },
                    {
                        id: 2,
                        name: "Sub Grup Hotel Marriott", 
                        hotel_makkah: "Marriott Makkah",
                        hotel_madinah: "Marriott Madinah",
                        members: 3,
                        max_members: 22
                    }
                ]
            },
            {
                id: 2,
                name: "Grup Turki Premium",
                package: "Umroh Plus Turki",
                departure_date: "2024-04-20",
                max_members: 40,
                current_members: 25,
                bus_number: "BUS002",
                meeting_time: "03:30",
                meeting_point: "Masjid Istiqlal, Jakarta",
                tour_leader: "Ustadz Abdul Rahman",
                status: "planning",
                sub_groups: [
                    {
                        id: 3,
                        name: "Sub Grup Hotel Swissotel",
                        hotel_makkah: "Swissotel Makkah",
                        hotel_madinah: "Swissotel Al Madinah",
                        members: 15,
                        max_members: 20
                    },
                    {
                        id: 4,
                        name: "Sub Grup Hotel Hyatt",
                        hotel_makkah: "Hyatt Regency Makkah",
                        hotel_madinah: "Hyatt Regency Madinah",
                        members: 10,
                        max_members: 20
                    }
                ]
            },
            {
                id: 3,
                name: "Grup Keluarga Bahagia",
                package: "Umroh Keluarga",
                departure_date: "2024-02-10",
                max_members: 30,
                current_members: 30,
                bus_number: "BUS003",
                meeting_time: "05:00",
                meeting_point: "Terminal Kampung Rambutan",
                tour_leader: "Ustadz Muhammad Ismail",
                status: "departed",
                sub_groups: [
                    {
                        id: 5,
                        name: "Sub Grup Hotel Sheraton",
                        hotel_makkah: "Sheraton Makkah",
                        hotel_madinah: "Sheraton Madinah",
                        members: 30,
                        max_members: 30
                    }
                ]
            },
            {
                id: 4,
                name: "Grup Ekonomi Smart",
                package: "Umroh Ekonomi",
                departure_date: "2024-06-15",
                max_members: 50,
                current_members: 12,
                bus_number: "BUS004",
                meeting_time: "02:30",
                meeting_point: "Masjid Agung Sunda Kelapa",
                tour_leader: "Ustadz Yusuf Mansur",
                status: "planning",
                sub_groups: [
                    {
                        id: 6,
                        name: "Sub Grup Hotel Ibis",
                        hotel_makkah: "Ibis Styles Makkah",
                        hotel_madinah: "Ibis Styles Madinah",
                        members: 8,
                        max_members: 25
                    },
                    {
                        id: 7,
                        name: "Sub Grup Hotel Novotel",
                        hotel_makkah: "Novotel Makkah",
                        hotel_madinah: "Novotel Madinah",
                        members: 4,
                        max_members: 25
                    }
                ]
            },
            {
                id: 5,
                name: "Grup VIP Executive",
                package: "Umroh VIP",
                departure_date: "2024-05-25",
                max_members: 25,
                current_members: 25,
                bus_number: "BUS005",
                meeting_time: "06:00",
                meeting_point: "Hotel Grand Sahid Jaya",
                tour_leader: "Ustadz Hasan Abdullah",
                status: "completed",
                sub_groups: [
                    {
                        id: 8,
                        name: "Sub Grup Hotel Conrad",
                        hotel_makkah: "Conrad Makkah",
                        hotel_madinah: "Conrad Madinah",
                        members: 25,
                        max_members: 25
                    }
                ]
            },
            {
                id: 6,
                name: "Grup Haji Furoda",
                package: "Umroh Plus Haji",
                departure_date: "2024-07-12",
                max_members: 35,
                current_members: 18,
                bus_number: "BUS006",
                meeting_time: "04:30",
                meeting_point: "Masjid Al-Azhar, Kebayoran",
                tour_leader: "Ustadz Salim Bahreisy",
                status: "active",
                sub_groups: [
                    {
                        id: 9,
                        name: "Sub Grup Hotel Fairmont",
                        hotel_makkah: "Fairmont Makkah",
                        hotel_madinah: "Fairmont Madinah",
                        members: 10,
                        max_members: 18
                    },
                    {
                        id: 10,
                        name: "Sub Grup Hotel Intercontinental",
                        hotel_makkah: "InterContinental Makkah",
                        hotel_madinah: "InterContinental Madinah",
                        members: 8,
                        max_members: 17
                    }
                ]
            }
        ];

        // Room Management Data
        let roomData = [];
        let currentGroupRooms = [];
        let selectedAllocationStrategy = 'auto';

        // Debug function to fix layout issues
        function debugLayout() {
            console.log('Debugging layout...');
            
            // Check all pages
            const pages = document.querySelectorAll('.page');
            console.log('Total pages:', pages.length);
            
            let activeCount = 0;
            pages.forEach((page, index) => {
                if (page.classList.contains('active')) {
                    console.log('Active page:', page.id);
                    activeCount++;
                }
            });
            
            if (activeCount > 1) {
                console.warn('Multiple active pages detected! Resetting...');
                pages.forEach((page, index) => {
                    if (index === 0) {
                        page.classList.add('active');
                    } else {
                        page.classList.remove('active');
                    }
                    page.style.display = page.classList.contains('active') ? 'block' : 'none';
                });
            }
            
            // Check sidebar visibility
            const sidebar = document.querySelector('.sidebar');
            const sidebarRect = sidebar.getBoundingClientRect();
            console.log('Sidebar position:', sidebarRect);
            
            const mainContent = document.querySelector('.main-content');
            const mainRect = mainContent.getBoundingClientRect();
            console.log('Main content position:', mainRect);
            
            // Check for overlaps
            if (mainRect.left < sidebarRect.right) {
                console.warn('Content overlapping sidebar!');
            }
        }
        
        // Debug specific pages
        function debugPage(pageId) {
            const page = document.getElementById(pageId);
            if (!page) {
                console.error('Page not found:', pageId);
                return;
            }
            
            console.log(`Debugging ${pageId}:`);
            console.log('- Display:', window.getComputedStyle(page).display);
            console.log('- Visibility:', window.getComputedStyle(page).visibility);
            console.log('- Opacity:', window.getComputedStyle(page).opacity);
            console.log('- Z-index:', window.getComputedStyle(page).zIndex);
            console.log('- Position:', window.getComputedStyle(page).position);
            
            const cards = page.querySelectorAll('.glass-card, .card');
            console.log(`- Found ${cards.length} cards`);
            
            cards.forEach((card, index) => {
                console.log(`  Card ${index + 1}:`);
                console.log('  - Display:', window.getComputedStyle(card).display);
                console.log('  - Visibility:', window.getComputedStyle(card).visibility);
                console.log('  - Opacity:', window.getComputedStyle(card).opacity);
            });
        }
        
        // Run debug on load
        window.addEventListener('load', () => {
            setTimeout(debugLayout, 100);
        });

        // Navigation
        function showPage(pageId) {
            console.log('showPage called with:', pageId);
            
            // Prevent default if this is from an event
            if (window.event) {
                window.event.preventDefault();
                window.event.stopPropagation();
            }
            
            // Hide all pages
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
                page.style.display = 'none'; // Force hide
            });
            
            // Remove active class from all nav items
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Show selected page
            const selectedPage = document.getElementById(pageId);
            if (selectedPage) {
                selectedPage.classList.add('active');
                selectedPage.style.display = 'block'; // Force show
                selectedPage.style.opacity = '1'; // Force opacity
                selectedPage.style.visibility = 'visible'; // Force visibility
                
                // Ensure content is visible
                const cards = selectedPage.querySelectorAll('.glass-card, .card');
                cards.forEach(card => {
                    card.style.opacity = '1';
                    card.style.visibility = 'visible';
                });
            } else {
                console.error('Page not found:', pageId);
            }
            
            // Scroll to top of main content
            document.querySelector('.main-content').scrollTop = 0;
            
            // Add active class to the corresponding nav item
            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(item => {
                const dataPage = item.getAttribute('data-page');
                if (dataPage === pageId) {
                    item.classList.add('active');
                }
            });
            
            // Load page specific data
            loadPageData(pageId);
            
            // Force refresh for problem pages
            if (['flights', 'reports', 'excel'].includes(pageId)) {
                setTimeout(() => {
                    const page = document.getElementById(pageId);
                    if (page) {
                        // Force repaint
                        page.style.display = 'none';
                        page.offsetHeight; // Trigger reflow
                        page.style.display = 'block';
                        
                        // Log for debugging
                        console.log(`Force refreshed ${pageId} page`);
                    }
                }, 10);
            }
        }

        function loadPageData(pageId) {
            switch(pageId) {
                case 'dashboard':
                    loadDashboard();
                    break;
                case 'jamaah':
                    loadJamaahTable();
                    break;
                case 'packages':
                    loadPackageCards();
                    break;
                case 'payments':
                    loadPaymentTable();
                    break;
                case 'documents':
                    loadDocumentTable();
                    break;
                case 'groups':
                    loadGroupCards();
                    break;
                case 'hotel':
                    // Hotel data will be loaded when implemented
                    break;
                case 'inventory':
                    loadInventoryData();
                    break;
                case 'flights':
                    loadFlightsData();
                    break;
                case 'reports':
                    loadReportCharts();
                    break;
                case 'marketing':
                    // Marketing page - check WhatsApp status
                    console.log('Marketing page loaded');
                    checkWhatsAppStatus();
                    loadLeadsBotState();
                    break;
                default:
                    console.log('Page loaded:', pageId);
                    break;
            }
        }

        // Dashboard
        function loadDashboard() {
            // Update stats
            document.getElementById('totalJamaah').textContent = jamaahData.length.toLocaleString();
            document.getElementById('verifiedJamaah').textContent = jamaahData.filter(j => j.status === 'verified').length.toLocaleString();
            document.getElementById('activePackages').textContent = packageData.length;
            
            const totalRevenue = paymentData.reduce((sum, payment) => sum + payment.amount, 0);
            document.getElementById('totalRevenue').textContent = (totalRevenue / 1000000000).toFixed(1) + 'B';
            
            document.getElementById('totalDepartures').textContent = groupData.filter(g => g.status === 'departed').length;
            document.getElementById('pendingPayments').textContent = paymentData.filter(p => p.status === 'pending').length;

            // Load charts
            loadDashboardCharts();
        }

        function loadDashboardCharts() {
            // Jamaah registration chart
            const jamaahCtx = document.getElementById('jamaahChart').getContext('2d');
            new Chart(jamaahCtx, {
                type: 'line',
                data: {
                    labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                    datasets: [{
                        label: 'Registrasi Jamaah',
                        data: [120, 190, 300, 250, 180, 220],
                        borderColor: '#4facfe',
                        backgroundColor: 'rgba(79, 172, 254, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: { 
                                color: 'white',
                                font: { size: 12 }
                            }
                        }
                    },
                    scales: {
                        x: { 
                            ticks: { 
                                color: 'white',
                                font: { size: 11 }
                            }
                        },
                        y: { 
                            ticks: { 
                                color: 'white',
                                font: { size: 11 }
                            }
                        }
                    }
                }
            });

            // Revenue chart
            const revenueCtx = document.getElementById('revenueChart').getContext('2d');
            new Chart(revenueCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Umroh Ramadhan', 'Umroh Plus Turki', 'Umroh Keluarga'],
                    datasets: [{
                        data: [800, 540, 350],
                        backgroundColor: ['#4facfe', '#00f2fe', '#a8edea']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: { 
                                color: 'white',
                                font: { size: 11 }
                            }
                        }
                    }
                }
            });
        }

        // Jamaah Management
        async function loadJamaahTable() {
            const tbody = document.getElementById('jamaahTableBody');
            tbody.innerHTML = '<tr><td colspan="9" style="text-align: center;">Loading...</td></tr>';
            
            try {
                // Fetch data from backend API
                const apiUrl = getApiBaseUrl() + '/api/jamaah';
                console.log('Fetching jamaah data from:', apiUrl);
                const response = await fetch(apiUrl);
                console.log('Response status:', response.status);
                const result = await response.json();
                console.log('API Result:', result);
                
                if (!response.ok) {
                    throw new Error(result.error || 'Failed to load data');
                }
                
                // Update global jamaahData with API response
                jamaahData = result.data || [];
                console.log('Jamaah data loaded:', jamaahData.length, 'records');
                tbody.innerHTML = '';
                
                if (jamaahData.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="9" style="text-align: center;">Tidak ada data jamaah</td></tr>';
                    return;
                }
                
                jamaahData.forEach((jamaah, index) => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${index + 1}</td>
                        <td>${jamaah.name}</td>
                        <td>${jamaah.nik || jamaah.passport_number || '-'}</td>
                        <td>${jamaah.phone}</td>
                        <td>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <img src="${jamaah.passport_image || 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iMjQiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iIzY0NzQ4YiIvPjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iOCIgZmlsbD0iI2Y4ZmFmYyIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPk5vIEltYWdlPC90ZXh0Pjwvc3ZnPg=='}" 
                                 style="width: 40px; height: 24px; border-radius: 4px; object-fit: cover; cursor: pointer;" 
                                 onclick="viewPassportImage('${jamaah.passport_image}', '${jamaah.name}')"
                                 title="Klik untuk melihat paspor">
                            <span style="font-size: 12px; color: #cbd5e1;">${jamaah.passport_number || 'Belum ada'}</span>
                        </div>
                    </td>
                    <td>${jamaah.packages && jamaah.packages.length > 0 ? jamaah.packages.map(p => p.name).join(', ') : '-'}</td>
                    <td><span class="status-badge status-${jamaah.status}">${getStatusText(jamaah.status)}</span></td>
                    <td>Rp ${formatPrice(jamaah.total_paid || 0)}</td>
                    <td>
                        <div class="table-actions">
                            <button class="btn btn-primary btn-sm" onclick="editJamaah(${jamaah.id})">
                                <span class="material-icons">edit</span>
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="deleteJamaah(${jamaah.id})">
                                <span class="material-icons">delete</span>
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
            } catch (error) {
                console.error('Error loading jamaah data:', error);
                tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; color: #ef4444;">Error: ' + error.message + '</td></tr>';
                // Check if it's a network error
                if (error.message.includes('Failed to fetch')) {
                    showNotification('Tidak dapat terhubung ke server. Pastikan backend berjalan di port 5000.', 'error');
                } else {
                    showNotification('Gagal memuat data jamaah: ' + error.message, 'error');
                }
            }
        }

        function getStatusText(status) {
            const statusMap = {
                'verified': 'Terverifikasi',
                'pending': 'Pending',
                'active': 'Aktif',
                'cancelled': 'Dibatalkan',
                'completed': 'Selesai',
                'rejected': 'Ditolak'
            };
            return statusMap[status] || status;
        }

        function filterJamaah() {
            const search = document.getElementById('searchJamaah').value.toLowerCase();
            const packageFilter = document.getElementById('filterPackage').value;
            const statusFilter = document.getElementById('filterStatus').value;
            
            // In a real app, this would filter the data
            showNotification('Filter diterapkan!');
            loadJamaahTable();
        }

        async function editJamaah(id) {
            console.log('Editing jamaah with ID:', id);
            
            try {
                // Fetch fresh data from API
                const response = await fetch(getApiBaseUrl() + `/api/jamaah/${id}`);
                const jamaah = await response.json();
                
                if (!response.ok) {
                    throw new Error('Failed to fetch jamaah data');
                }
                
                console.log('Fetched jamaah data:', jamaah);
                
                // Store ID for update FIRST before opening modal
                const form = document.getElementById('jamaahForm');
                if (form) {
                    form.dataset.editId = id;
                }
                
                // First open the modal (but it won't reset because editId is set)
                openModal('jamaahModal');
                
                // Then wait a bit for modal to be fully visible
                await new Promise(resolve => setTimeout(resolve, 50));
                
                // Debug: check if elements exist
                console.log('Checking form elements:');
                console.log('jamaahName element:', document.getElementById('jamaahName'));
                console.log('jamaahNik element:', document.getElementById('jamaahNik'));
                
                // Populate form with jamaah data
                const nameField = document.getElementById('jamaahName');
                const nikField = document.getElementById('jamaahNik');
                
                if (nameField) {
                    nameField.value = jamaah.name || '';
                    console.log('Set name to:', jamaah.name);
                }
                if (nikField) {
                    nikField.value = jamaah.nik || '';
                    console.log('Set NIK to:', jamaah.nik);
                }
                // Format birth date from ISO to ddmmyyyy
                if (jamaah.birth_date) {
                    const birthDate = new Date(jamaah.birth_date);
                    const day = String(birthDate.getDate()).padStart(2, '0');
                    const month = String(birthDate.getMonth() + 1).padStart(2, '0');
                    const year = birthDate.getFullYear();
                    document.getElementById('jamaahBirthDate').value = day + month + year;
                }
                
                document.getElementById('jamaahBirthPlace').value = jamaah.birth_place || '';
                document.getElementById('jamaahGender').value = jamaah.gender || '';
                document.getElementById('jamaahPhone').value = jamaah.phone || '';
                document.getElementById('jamaahEmail').value = jamaah.email || '';
                
                // Get package ID from packages array
                if (jamaah.packages && jamaah.packages.length > 0) {
                    document.getElementById('jamaahPackage').value = jamaah.packages[0].id;
                }
                document.getElementById('jamaahAddress').value = jamaah.address || '';
                
                // Regional data
                document.getElementById('jamaahProvinsi').value = jamaah.province || '';
                document.getElementById('jamaahKabupaten').value = jamaah.city || '';
                document.getElementById('jamaahKecamatan').value = jamaah.kecamatan || '';
                document.getElementById('jamaahKelurahan').value = jamaah.kelurahan || '';
                
                // Personal data (may not exist in current DB)
                if (document.getElementById('jamaahMaritalStatus')) {
                    document.getElementById('jamaahMaritalStatus').value = jamaah.marital_status || '';
                }
                if (document.getElementById('jamaahEducation')) {
                    document.getElementById('jamaahEducation').value = jamaah.education || '';
                }
                if (document.getElementById('jamaahOccupation')) {
                    document.getElementById('jamaahOccupation').value = jamaah.occupation || '';
                }
                
                // Passport data
                if (document.getElementById('jamaahPassportName')) {
                    document.getElementById('jamaahPassportName').value = jamaah.passport_name || '';
                }
                document.getElementById('jamaahPassportNumber').value = jamaah.passport_number || '';
                if (document.getElementById('jamaahPassportCity')) {
                    document.getElementById('jamaahPassportCity').value = jamaah.passport_city || '';
                }
                if (document.getElementById('jamaahPassportIssueDate')) {
                    document.getElementById('jamaahPassportIssueDate').value = jamaah.passport_issue_date || '';
                }
                if (document.getElementById('jamaahPassportExpireDate')) {
                    document.getElementById('jamaahPassportExpireDate').value = jamaah.passport_expire_date || '';
                }
                
                // Check if passport name is same as KTP name
                if (jamaah.passport_name === jamaah.name && jamaah.passport_name) {
                    document.getElementById('sameAsKtpName').checked = true;
                    togglePassportName(document.getElementById('sameAsKtpName'));
                }
                
                // Family data
                document.getElementById('jamaahFamilyRole').value = jamaah.family_role || '';
                document.getElementById('jamaahRoomPreference').value = jamaah.room_preference || '';
                document.getElementById('jamaahFamilyRoomRequest').checked = jamaah.family_room_request || false;
                
                // Trigger family field toggle
                if (jamaah.family_role) {
                    toggleFamilyFields(document.getElementById('jamaahFamilyRole'));
                    if (jamaah.main_family_id && (jamaah.family_role === 'istri' || jamaah.family_role === 'anak')) {
                        setTimeout(() => {
                            document.getElementById('jamaahMainFamily').value = jamaah.main_family_id;
                        }, 100);
                    }
                }
                
                // Show passport preview if exists
                if (jamaah.passport_image) {
                    document.getElementById('passportPreview').style.display = 'block';
                    document.getElementById('passportImg').src = jamaah.passport_image;
                }
                
                // Change form title
                const modalTitle = document.querySelector('#jamaahModal h2');
                if (modalTitle) {
                    modalTitle.textContent = 'Edit Data Jamaah';
                }
                
                // Debug: check values after setting
                console.log('After setting values:');
                console.log('Name field value:', document.getElementById('jamaahName').value);
                console.log('NIK field value:', document.getElementById('jamaahNik').value);
                
            } catch (error) {
                console.error('Error fetching jamaah data:', error);
                showNotification('Gagal memuat data jamaah: ' + error.message, 'error');
            }
        }

        async function deleteJamaah(id) {
            if (confirm('Yakin ingin menghapus data jamaah ini?')) {
                try {
                    // In real API, we would soft delete by changing status to cancelled
                    const response = await fetch(getApiBaseUrl() + `/api/jamaah/${id}/status`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            status: 'cancelled',
                            notes: 'Dibatalkan melalui sistem'
                        })
                    });

                    const result = await response.json();

                    if (!response.ok) {
                        throw new Error(result.error || 'Failed to delete jamaah');
                    }

                    await loadJamaahTable();
                    showNotification('Data jamaah berhasil dihapus!');
                } catch (error) {
                    console.error('Error deleting jamaah:', error);
                    showNotification('Gagal menghapus data jamaah: ' + error.message, 'error');
                }
            }
        }

        async function saveJamaah(event) {
            event.preventDefault();
            
            // Check if editing
            const form = document.getElementById('jamaahForm');
            const editId = form.dataset.editId;
            const isEditing = !!editId;
            
            // Validate birth date first
            const birthDate = document.getElementById('jamaahBirthDate').value;
            if (!validateBirthDate(birthDate)) {
                showNotification('Format tanggal lahir tidak valid. Gunakan format ddmmyyyy (contoh: 15051985)', 'error');
                document.getElementById('jamaahBirthDate').focus();
                return;
            }
            
            // Validate passport dates if provided
            const passportIssueDate = document.getElementById('jamaahPassportIssueDate').value;
            const passportExpireDate = document.getElementById('jamaahPassportExpireDate').value;
            
            if (passportIssueDate && !validatePassportDate(passportIssueDate)) {
                showNotification('Format tanggal penerbitan paspor tidak valid. Gunakan format ddmmyyyy', 'error');
                document.getElementById('jamaahPassportIssueDate').focus();
                return;
            }
            
            if (passportExpireDate && !validatePassportDate(passportExpireDate)) {
                showNotification('Format tanggal kadaluarsa paspor tidak valid. Gunakan format ddmmyyyy', 'error');
                document.getElementById('jamaahPassportExpireDate').focus();
                return;
            }

            // Convert birth date to ISO format
            const birthDateFormatted = birthDate.substring(4) + '-' + birthDate.substring(2, 4) + '-' + birthDate.substring(0, 2);
            
            const formData = {
                name: document.getElementById('jamaahName').value,
                nik: document.getElementById('jamaahNik').value || undefined,
                birth_date: birthDateFormatted,
                birth_place: document.getElementById('jamaahBirthPlace').value || undefined,
                gender: document.getElementById('jamaahGender').value,
                phone: document.getElementById('jamaahPhone').value,
                email: document.getElementById('jamaahEmail').value || undefined,
                address: document.getElementById('jamaahAddress').value || undefined,
                province: document.getElementById('jamaahProvinsi').value || undefined,
                city: document.getElementById('jamaahKabupaten').value || undefined,
                passport_number: document.getElementById('jamaahPassportNumber').value || undefined,
                package_ids: document.getElementById('jamaahPackage').value ? [parseInt(document.getElementById('jamaahPackage').value)] : []
            };
            
            // Remove undefined values
            Object.keys(formData).forEach(key => {
                if (formData[key] === undefined || formData[key] === '') {
                    delete formData[key];
                }
            });
            
            // For new jamaah, package_ids is required
            if (!isEditing && (!formData.package_ids || formData.package_ids.length === 0)) {
                showNotification('Silakan pilih paket umroh', 'error');
                return;
            }
            
            // For edit, don't send package_ids (managed separately)
            if (isEditing) {
                delete formData.package_ids;
            }

            try {
                // Call API to save jamaah
                const apiUrl = isEditing 
                    ? getApiBaseUrl() + `/api/jamaah/${editId}`
                    : getApiBaseUrl() + '/api/jamaah';
                    
                const method = isEditing ? 'PUT' : 'POST';
                
                console.log(`${isEditing ? 'Updating' : 'Creating'} jamaah with data:`, formData);
                
                const response = await fetch(apiUrl, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });

                const result = await response.json();
                console.log('Save response:', response.status, result);

                if (!response.ok) {
                    // Show detailed validation error
                    if (result.details) {
                        throw new Error(result.error + ': ' + result.details);
                    }
                    throw new Error(result.error || 'Failed to save jamaah');
                }

                // Success
                closeModal('jamaahModal');
                await loadJamaahTable(); // Reload the table
                showNotification(isEditing ? 'Data jamaah berhasil diupdate!' : 'Data jamaah berhasil disimpan!');
                
                // Reset form and clear edit ID
                event.target.reset();
                delete form.dataset.editId;
                document.getElementById('passportPreview').style.display = 'none';
                
                // Reset modal title
                const modalTitle = document.querySelector('#jamaahModal h2');
                if (modalTitle) {
                    modalTitle.textContent = 'Tambah Jamaah Baru';
                }
            } catch (error) {
                console.error('Error saving jamaah:', error);
                showNotification('Gagal menyimpan data jamaah: ' + error.message, 'error');
            }
        }

        // Package Management
        async function loadPackageCards() {
            const container = document.getElementById('packageGrid');
            container.innerHTML = '<div style="grid-column: 1/-1; text-align: center; color: rgba(255,255,255,0.7);">Loading packages...</div>';
            
            try {
                // Fetch packages from API
                const apiUrl = getApiBaseUrl() + '/api/packages';
                console.log('Loading packages from:', apiUrl);
                
                const response = await fetch(apiUrl);
                console.log('Response status:', response.status, 'OK:', response.ok);
                
                const result = await response.json();
                console.log('API Result:', result);
                
                if (!response.ok) {
                    throw new Error('Failed to load packages');
                }
                
                // Extract data array from response
                const packages = result.data || result || [];
                console.log('Total packages:', packages.length);
                console.log('Packages:', packages);
                
                container.innerHTML = '';
                
                if (packages.length === 0) {
                    container.innerHTML = '<div style="grid-column: 1/-1; text-align: center; color: rgba(255,255,255,0.7);">No packages available</div>';
                    return;
                }
                
                // Filter only active packages for normal users
                const activePackages = packages.filter(p => p.status === 'active');
                console.log('Active packages:', activePackages.length);
                console.log('Active packages data:', activePackages);
                
                if (activePackages.length === 0) {
                    container.innerHTML = '<div style="grid-column: 1/-1; text-align: center; color: rgba(255,255,255,0.7);">Tidak ada paket aktif saat ini</div>';
                    return;
                }
                
                activePackages.forEach(package => {
                // Map database fields to frontend fields
                const packageName = package.name || package.nama_paket || 'Paket Umroh';
                const packageCode = package.code || package.kode_paket || '';
                const remainingSeats = package.available || package.sisa_seat || (package.quota - (package.booked || 0));
                const card = document.createElement('div');
                card.className = 'glass-card';
                card.style.cssText = 'padding: 25px; transition: all 0.3s ease; cursor: pointer;';
                card.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 20px;">
                        <div style="flex: 1;">
                            <h3 style="color: white; margin: 0 0 8px 0; font-size: 20px;">${packageName}</h3>
                            <span style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(16, 185, 129, 0.1)); color: #3b82f6; padding: 6px 16px; border-radius: 20px; font-size: 13px; font-weight: 600; display: inline-block;">${packageCode}</span>
                        </div>
                        ${package.brochure_image ? `
                        <div style="width: 80px; height: 80px; border-radius: 12px; overflow: hidden; margin-left: 15px; flex-shrink: 0;">
                            <img src="${package.brochure_image}" alt="${package.name}" style="width: 100%; height: 100%; object-fit: cover;">
                        </div>
                        ` : ''}
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; margin-bottom: 20px; padding: 20px; background: rgba(255, 255, 255, 0.05); border-radius: 12px; border: 1px solid rgba(255, 255, 255, 0.1);">
                        <div>
                            <p style="color: rgba(255, 255, 255, 0.6); font-size: 12px; margin: 0 0 4px 0;">Harga Paket</p>
                            <p style="color: #4facfe; font-weight: 700; font-size: 18px; margin: 0;">Rp ${formatPrice(package.price || 0)}</p>
                        </div>
                        <div>
                            <p style="color: rgba(255, 255, 255, 0.6); font-size: 12px; margin: 0 0 4px 0;">Keberangkatan</p>
                            <p style="color: white; font-weight: 600; margin: 0;">${formatDate(package.departure_date)}</p>
                        </div>
                        <div>
                            <p style="color: rgba(255, 255, 255, 0.6); font-size: 12px; margin: 0 0 4px 0;">Durasi</p>
                            <p style="color: white; font-weight: 600; margin: 0;">${calculateDuration(package.departure_date, package.return_date)} hari</p>
                        </div>
                        <div>
                            <p style="color: rgba(255, 255, 255, 0.6); font-size: 12px; margin: 0 0 4px 0;">Sisa Seat</p>
                            <p style="color: ${remainingSeats > 10 ? '#22c55e' : remainingSeats > 0 ? '#f59e0b' : '#ef4444'}; font-weight: 700; margin: 0;">${remainingSeats}/${package.quota}</p>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 20px; padding: 15px; background: rgba(255, 255, 255, 0.03); border-radius: 12px;">
                        <h4 style="color: white; font-size: 14px; margin: 0 0 12px 0; font-weight: 600;">Detail Hotel & Penerbangan</h4>
                        <div style="font-size: 13px; color: rgba(255, 255, 255, 0.8); line-height: 1.6;">
                            <p style="margin: 0 0 8px 0;">🏨 <strong>Makkah:</strong> ${package.makkah_hotel} (${package.makkah_nights} malam)</p>
                            <p style="margin: 0 0 8px 0;">🏨 <strong>Madinah:</strong> ${package.madinah_hotel} (${package.madinah_nights} malam)</p>
                            <p style="margin: 0 0 8px 0;">✈️ <strong>Maskapai:</strong> ${package.airline}</p>
                            
                            <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(255, 255, 255, 0.1);">
                                <p style="margin: 0 0 8px 0; color: #3b82f6;"><strong>🛫 Keberangkatan:</strong></p>
                                <p style="margin: 0 0 4px 0; padding-left: 20px;">
                                    ${package.departure_city || 'Jakarta'} 
                                    ${package.transit_city_departure ? `→ ${package.transit_city_departure} (Transit)` : ''} 
                                    → ${package.arrival_city || 'Madinah'}
                                </p>
                                ${package.departure_flight_number ? `<p style="margin: 0 0 8px 0; padding-left: 20px; font-size: 12px; color: rgba(255, 255, 255, 0.6);">Flight: ${package.departure_flight_number}</p>` : ''}
                                
                                <p style="margin: 0 0 8px 0; color: #10b981;"><strong>🛬 Kepulangan:</strong></p>
                                <p style="margin: 0 0 4px 0; padding-left: 20px;">
                                    ${package.return_departure_city || 'Jeddah'} 
                                    ${package.transit_city_return ? `→ ${package.transit_city_return} (Transit)` : ''} 
                                    → ${package.return_arrival_city || 'Jakarta'}
                                </p>
                                ${package.return_flight_number ? `<p style="margin: 0; padding-left: 20px; font-size: 12px; color: rgba(255, 255, 255, 0.6);">Flight: ${package.return_flight_number}</p>` : ''}
                            </div>
                        </div>
                    </div>
                    
                    ${package.description ? `
                    <div style="margin-bottom: 20px; padding: 15px; background: rgba(59, 130, 246, 0.05); border-radius: 12px; border-left: 3px solid #3b82f6;">
                        <p style="color: rgba(255, 255, 255, 0.9); font-size: 13px; line-height: 1.6; margin: 0;">${package.description}</p>
                    </div>
                    ` : ''}
                    
                    ${package.package_info ? `
                    <div style="margin-bottom: 20px;">
                        <h4 style="color: white; font-size: 14px; margin: 0 0 8px 0; font-weight: 600;">Informasi Paket</h4>
                        <div style="color: rgba(255, 255, 255, 0.8); font-size: 13px; line-height: 1.8; margin: 0; white-space: pre-wrap; word-wrap: break-word;">${package.package_info}</div>
                    </div>
                    ` : ''}
                    
                    <div class="btn-group" style="gap: 12px; padding-top: 15px; border-top: 1px solid rgba(255, 255, 255, 0.1);">
                        <button class="btn btn-primary btn-flex" onclick="editPackage(${package.id})" style="flex: 1; padding: 10px 20px;">
                            <span class="material-icons">edit</span>
                            Edit
                        </button>
                        <button class="btn btn-info btn-flex" onclick="viewPackageDetails(${package.id})" style="flex: 1; padding: 10px 20px;">
                            <span class="material-icons">visibility</span>
                            Detail
                        </button>
                        <button class="btn btn-danger btn-flex" onclick="deletePackage(${package.id})" style="flex: 1; padding: 10px 20px;">
                            <span class="material-icons">delete</span>
                            Hapus
                        </button>
                    </div>
                `;
                
                // Add hover effect
                card.addEventListener('mouseenter', function() {
                    this.style.transform = 'translateY(-5px)';
                    this.style.boxShadow = '0 20px 40px rgba(0, 0, 0, 0.3)';
                });
                card.addEventListener('mouseleave', function() {
                    this.style.transform = 'translateY(0)';
                    this.style.boxShadow = '';
                });
                container.appendChild(card);
            });
            } catch (error) {
                console.error('Error loading packages:', error);
                container.innerHTML = '<div style="grid-column: 1/-1; text-align: center; color: #ef4444;">Failed to load packages: ' + error.message + '</div>';
            }
        }

        async function editPackage(id) {
            try {
                console.log('Editing package ID:', id);
                const response = await fetch(getApiBaseUrl() + `/api/packages/${id}`);
                const result = await response.json();
                
                if (!response.ok) {
                    throw new Error(result.error || 'Failed to fetch package');
                }
                
                // Extract package data
                const package = result.data || result;
                console.log('Package data for edit:', package);
                
                // Store ID for update
                document.getElementById('packageForm').dataset.editId = id;
                
                // Update modal title
                const modalTitle = document.querySelector('#packageModal h3');
                if (modalTitle) {
                    modalTitle.textContent = 'Edit Paket Umroh';
                }
                
                // Populate form - using correct field names from database
                document.getElementById('packageName').value = package.name || package.nama_paket || '';
                document.getElementById('packageCode').value = package.code || package.kode_paket || '';
                document.getElementById('packagePrice').value = package.price || 0;
                document.getElementById('packageDeparture').value = package.departure_date ? package.departure_date.split('T')[0] : '';
                document.getElementById('packageReturn').value = package.return_date ? package.return_date.split('T')[0] : '';
                document.getElementById('packageQuota').value = package.quota || 0;
                document.getElementById('packageMakkahHotel').value = package.makkah_hotel || '';
                document.getElementById('packageMadinahHotel').value = package.madinah_hotel || package.hotel_madinah || '';
                document.getElementById('packageMakkahNights').value = package.makkah_nights || package.malam_makkah || 0;
                document.getElementById('packageMadinahNights').value = package.madinah_nights || package.malam_madinah || 0;
                document.getElementById('packageAirline').value = package.airline || package.maskapai || '';
                document.getElementById('packageDescription').value = package.description || package.deskripsi_singkat || '';
                document.getElementById('packageInfo').value = package.package_info || package.informasi_detail || '';
                
                // Populate flight details
                document.getElementById('packageDepartureCity').value = package.departure_city || 'Jakarta';
                document.getElementById('packageTransitDeparture').value = package.transit_city_departure || '';
                document.getElementById('packageArrivalCity').value = package.arrival_city || 'Madinah';
                document.getElementById('packageDepartureFlightNumber').value = package.departure_flight_number || '';
                document.getElementById('packageReturnDepartureCity').value = package.return_departure_city || 'Jeddah';
                document.getElementById('packageTransitReturn').value = package.transit_city_return || '';
                document.getElementById('packageReturnArrivalCity').value = package.return_arrival_city || 'Jakarta';
                document.getElementById('packageReturnFlightNumber').value = package.return_flight_number || '';
                document.getElementById('packageFlightInfo').value = package.flight_info || '';
                
                // Show brochure preview if exists
                if (package.brochure_image) {
                    document.getElementById('brochureImg').src = package.brochure_image;
                    document.getElementById('brochurePreview').style.display = 'block';
                } else {
                    document.getElementById('brochurePreview').style.display = 'none';
                }
                
                // Load multiple images if exists
                packageImagesData = [];
                const previewContainer = document.getElementById('multipleImagesPreview');
                previewContainer.innerHTML = '';
                
                if (package.package_images && Array.isArray(package.package_images)) {
                    packageImagesData = package.package_images;
                    package.package_images.forEach((img, index) => {
                        const imageContainer = document.createElement('div');
                        imageContainer.style.cssText = 'position: relative; border-radius: 8px; overflow: hidden; background: rgba(30, 41, 59, 0.6); border: 1px solid rgba(71, 85, 105, 0.4);';
                        imageContainer.innerHTML = `
                            <img src="${img.url}" style="width: 100%; height: 120px; object-fit: cover;">
                            <div style="position: absolute; top: 5px; right: 5px;">
                                <button type="button" onclick="removePackageImage(${index})" class="btn btn-danger btn-sm" style="padding: 5px 10px;">
                                    <span class="material-icons" style="font-size: 16px;">close</span>
                                </button>
                            </div>
                            <input type="text" placeholder="Caption..." value="${img.caption || ''}" onchange="updateImageCaption(${index}, this.value)" 
                                style="width: 100%; padding: 5px; background: rgba(15, 23, 42, 0.8); border: none; color: #f8fafc; font-size: 12px;">
                        `;
                        previewContainer.appendChild(imageContainer);
                    });
                }
                
                openModal('packageModal');
            } catch (error) {
                console.error('Error editing package:', error);
                showNotification('Gagal mengambil data paket: ' + error.message, 'error');
            }
        }

        async function deletePackage(id) {
            if (confirm('Yakin ingin menghapus paket ini?')) {
                try {
                    const response = await fetch(getApiBaseUrl() + `/api/packages/${id}`, {
                        method: 'DELETE'
                    });
                    
                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(error.error || 'Failed to delete package');
                    }
                    
                    await loadPackageCards();
                    showNotification('Paket berhasil dihapus!');
                } catch (error) {
                    console.error('Error deleting package:', error);
                    showNotification('Gagal menghapus paket: ' + error.message, 'error');
                }
            }
        }

        // Save form data to localStorage
        function savePackageFormData() {
            const formData = {
                packageName: document.getElementById('packageName').value,
                packageCode: document.getElementById('packageCode').value,
                packagePrice: document.getElementById('packagePrice').value,
                packageDeparture: document.getElementById('packageDeparture').value,
                packageReturn: document.getElementById('packageReturn').value,
                packageQuota: document.getElementById('packageQuota').value,
                packageMakkahHotel: document.getElementById('packageMakkahHotel').value,
                packageMadinahHotel: document.getElementById('packageMadinahHotel').value,
                packageMakkahNights: document.getElementById('packageMakkahNights').value,
                packageMadinahNights: document.getElementById('packageMadinahNights').value,
                packageAirline: document.getElementById('packageAirline').value,
                packageDepartureCity: document.getElementById('packageDepartureCity').value,
                packageTransitDeparture: document.getElementById('packageTransitDeparture').value,
                packageArrivalCity: document.getElementById('packageArrivalCity').value,
                packageDepartureFlightNumber: document.getElementById('packageDepartureFlightNumber').value,
                packageReturnDepartureCity: document.getElementById('packageReturnDepartureCity').value,
                packageTransitReturn: document.getElementById('packageTransitReturn').value,
                packageReturnArrivalCity: document.getElementById('packageReturnArrivalCity').value,
                packageReturnFlightNumber: document.getElementById('packageReturnFlightNumber').value,
                packageFlightInfo: document.getElementById('packageFlightInfo').value,
                packageDescription: document.getElementById('packageDescription').value,
                packageInfo: document.getElementById('packageInfo').value
            };
            localStorage.setItem('packageFormData', JSON.stringify(formData));
        }

        // Load form data from localStorage
        function loadPackageFormData() {
            const savedData = localStorage.getItem('packageFormData');
            if (savedData) {
                const formData = JSON.parse(savedData);
                Object.keys(formData).forEach(key => {
                    const element = document.getElementById(key);
                    if (element) {
                        element.value = formData[key];
                    }
                });
            }
        }

        // Clear form and localStorage
        function clearPackageForm() {
            // Clear all text inputs
            document.getElementById('packageName').value = '';
            document.getElementById('packageCode').value = '';
            document.getElementById('packagePrice').value = '';
            document.getElementById('packageDeparture').value = '';
            document.getElementById('packageReturn').value = '';
            document.getElementById('packageQuota').value = '';
            document.getElementById('packageMakkahHotel').value = '';
            document.getElementById('packageMadinahHotel').value = '';
            document.getElementById('packageMakkahNights').value = '';
            document.getElementById('packageMadinahNights').value = '';
            document.getElementById('packageAirline').value = '';
            
            // Clear flight details (reset to default values)
            document.getElementById('packageDepartureCity').value = 'Jakarta';
            document.getElementById('packageTransitDeparture').value = '';
            document.getElementById('packageArrivalCity').value = 'Madinah';
            document.getElementById('packageDepartureFlightNumber').value = '';
            document.getElementById('packageReturnDepartureCity').value = 'Jeddah';
            document.getElementById('packageTransitReturn').value = '';
            document.getElementById('packageReturnArrivalCity').value = 'Jakarta';
            document.getElementById('packageReturnFlightNumber').value = '';
            
            // Clear textareas
            document.getElementById('packageFlightInfo').value = '';
            document.getElementById('packageDescription').value = '';
            document.getElementById('packageInfo').value = '';
            
            // Clear file inputs
            document.getElementById('packageBrochure').value = '';
            document.getElementById('packageImages').value = '';
            
            // Clear image previews
            document.getElementById('brochurePreview').style.display = 'none';
            document.getElementById('multipleImagesPreview').innerHTML = '';
            
            // Reset file input labels
            document.getElementById('brochureLabel').classList.remove('file-selected');
            document.getElementById('brochureText').textContent = 'Pilih Gambar Brosur';
            document.getElementById('imagesLabel').classList.remove('file-selected');
            document.getElementById('imagesText').textContent = 'Pilih Beberapa Gambar';
            
            // Clear localStorage
            localStorage.removeItem('packageFormData');
            
            showNotification('Semua field telah dikosongkan', 'success');
        }

        // Handle brochure file change
        function handleBrochureChange(event) {
            const file = event.target.files[0];
            if (file) {
                document.getElementById('brochureLabel').classList.add('file-selected');
                document.getElementById('brochureText').textContent = file.name;
                previewBrochure(event);
            }
            savePackageFormData();
        }

        // Handle multiple images change
        function handleImagesChange(event) {
            const files = event.target.files;
            if (files.length > 0) {
                document.getElementById('imagesLabel').classList.add('file-selected');
                document.getElementById('imagesText').textContent = `${files.length} gambar dipilih`;
                previewMultipleImages(event);
            }
            savePackageFormData();
        }

        // Load saved cities from localStorage
        function loadSavedCities() {
            const savedCities = localStorage.getItem('customCities');
            if (savedCities) {
                return JSON.parse(savedCities);
            }
            return {
                departure: [],
                arrival: [],
                returnDeparture: [],
                returnArrival: []
            };
        }

        // Save custom cities to localStorage
        function saveCustomCities(cities) {
            localStorage.setItem('customCities', JSON.stringify(cities));
        }

        // Handle city select change
        function handleCitySelectChange(selectElement, type) {
            if (selectElement.value === 'add_new') {
                // Store reference to the select element
                document.getElementById('citySelectType').value = type;
                document.getElementById('citySelectElement').value = selectElement.id;
                
                // Reset to previous value temporarily
                const previousValue = selectElement.dataset.previousValue || 
                    (type === 'departure' || type === 'returnArrival' ? 'Jakarta' : 
                     type === 'returnDeparture' ? 'Jeddah' : 'Madinah');
                selectElement.value = previousValue;
                
                // Open modal
                openModal('addCityModal');
                document.getElementById('newCityName').focus();
            } else {
                // Store the current value for future reference
                selectElement.dataset.previousValue = selectElement.value;
                savePackageFormData();
            }
        }

        // Add new city to dropdown
        function addNewCity(event) {
            event.preventDefault();
            
            const cityName = document.getElementById('newCityName').value.trim();
            const type = document.getElementById('citySelectType').value;
            const selectId = document.getElementById('citySelectElement').value;
            const selectElement = document.getElementById(selectId);
            
            if (cityName && selectElement) {
                // Check if city already exists
                const existingOption = Array.from(selectElement.options).find(
                    option => option.value === cityName && option.value !== 'add_new'
                );
                
                if (existingOption) {
                    showNotification('Kota sudah ada dalam daftar', 'warning');
                    selectElement.value = cityName;
                } else {
                    // Add new option before the "add new" option
                    const newOption = document.createElement('option');
                    newOption.value = cityName;
                    newOption.textContent = cityName;
                    
                    const addNewOption = selectElement.querySelector('option[value="add_new"]');
                    selectElement.insertBefore(newOption, addNewOption);
                    
                    // Select the new option
                    selectElement.value = cityName;
                    selectElement.dataset.previousValue = cityName;
                    
                    // Save to localStorage
                    const customCities = loadSavedCities();
                    if (!customCities[type]) {
                        customCities[type] = [];
                    }
                    customCities[type].push(cityName);
                    saveCustomCities(customCities);
                    
                    showNotification(`Kota "${cityName}" berhasil ditambahkan`, 'success');
                }
                
                // Save form data
                savePackageFormData();
                
                // Close modal and reset form
                closeModal('addCityModal');
                document.getElementById('newCityName').value = '';
            }
        }

        // Load custom cities on page load
        function loadCustomCitiesIntoDropdowns() {
            const customCities = loadSavedCities();
            
            // Map of dropdown types to select IDs
            const dropdownMap = {
                departure: 'packageDepartureCity',
                arrival: 'packageArrivalCity',
                returnDeparture: 'packageReturnDepartureCity',
                returnArrival: 'packageReturnArrivalCity'
            };
            
            Object.entries(dropdownMap).forEach(([type, selectId]) => {
                const selectElement = document.getElementById(selectId);
                if (selectElement && customCities[type]) {
                    customCities[type].forEach(cityName => {
                        // Check if city doesn't already exist
                        const exists = Array.from(selectElement.options).some(
                            option => option.value === cityName
                        );
                        
                        if (!exists) {
                            const newOption = document.createElement('option');
                            newOption.value = cityName;
                            newOption.textContent = cityName;
                            
                            const addNewOption = selectElement.querySelector('option[value="add_new"]');
                            selectElement.insertBefore(newOption, addNewOption);
                        }
                    });
                }
            });
        }

        async function savePackage(event) {
            event.preventDefault();
            
            const form = document.getElementById('packageForm');
            const isEditing = form.dataset.editId;
            
            // Get brochure image if available
            let brochureImage = null;
            const brochureInput = document.getElementById('packageBrochure');
            if (brochureInput.files.length > 0) {
                const file = brochureInput.files[0];
                const reader = new FileReader();
                brochureImage = await new Promise((resolve) => {
                    reader.onload = (e) => resolve(e.target.result);
                    reader.readAsDataURL(file);
                });
            }
            
            const formData = {
                nama_paket: document.getElementById('packageName').value,
                kode_paket: document.getElementById('packageCode').value,
                price: parseInt(document.getElementById('packagePrice').value),
                tanggal_berangkat: document.getElementById('packageDeparture').value,
                tanggal_pulang: document.getElementById('packageReturn').value,
                kuota: parseInt(document.getElementById('packageQuota').value),
                hotel_makkah: document.getElementById('packageMakkahHotel').value,
                hotel_madinah: document.getElementById('packageMadinahHotel').value,
                malam_makkah: parseInt(document.getElementById('packageMakkahNights').value),
                malam_madinah: parseInt(document.getElementById('packageMadinahNights').value),
                maskapai: document.getElementById('packageAirline').value,
                deskripsi_singkat: document.getElementById('packageDescription').value,
                informasi_detail: document.getElementById('packageInfo').value,
                gambar_utama: brochureImage,
                gambar_tambahan: packageImagesData.map(img => typeof img === 'string' ? img : (img.url || '')), // Extract URLs from image objects
                // Flight details
                kota_keberangkatan: document.getElementById('packageDepartureCity').value,
                transit_berangkat: document.getElementById('packageTransitDeparture').value,
                kota_tiba: document.getElementById('packageArrivalCity').value,
                nomor_penerbangan_berangkat: document.getElementById('packageDepartureFlightNumber').value,
                kota_pulang_dari: document.getElementById('packageReturnDepartureCity').value,
                transit_pulang: document.getElementById('packageTransitReturn').value,
                kota_tiba_pulang: document.getElementById('packageReturnArrivalCity').value,
                nomor_penerbangan_pulang: document.getElementById('packageReturnFlightNumber').value,
                catatan_penerbangan: document.getElementById('packageFlightInfo').value
            };
            
            console.log('Package form data:', formData);
            
            try {
                const url = isEditing 
                    ? getApiBaseUrl() + `/api/packages/${isEditing}`
                    : getApiBaseUrl() + '/api/packages';
                
                console.log('Sending package to:', url);
                console.log('Method:', isEditing ? 'PUT' : 'POST');
                console.log('Request body:', JSON.stringify(formData));
                    
                const response = await fetch(url, {
                    method: isEditing ? 'PUT' : 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });
                
                console.log('Response status:', response.status);
                console.log('Response OK:', response.ok);
                
                const responseData = await response.json();
                console.log('Response data:', responseData);
                
                if (!response.ok) {
                    throw new Error(responseData.error || 'Failed to save package');
                }
                
                closeModal('packageModal');
                await loadPackageCards();
                showNotification(isEditing ? 'Paket berhasil diupdate!' : 'Paket berhasil disimpan!');
                
                // Reset form and clear edit ID
                event.target.reset();
                delete form.dataset.editId;
                packageImagesData = [];
                
                // Clear saved form data from localStorage
                localStorage.removeItem('packageFormData');
                document.getElementById('multipleImagesPreview').innerHTML = '';
            } catch (error) {
                console.error('Error saving package:', error);
                showNotification('Gagal menyimpan paket: ' + error.message, 'error');
            }
        }

        // Payment Management
        function loadPaymentTable() {
            const tbody = document.getElementById('paymentTableBody');
            tbody.innerHTML = '';
            
            paymentData.forEach(payment => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${formatDate(payment.date)}</td>
                    <td>${payment.jamaah_name}</td>
                    <td>${payment.package}</td>
                    <td>Rp ${formatPrice(payment.amount || 0)}</td>
                    <td>${payment.method}</td>
                    <td><span class="status-badge status-${payment.status}">${getStatusText(payment.status)}</span></td>
                    <td>
                        <div class="table-actions">
                        ${payment.status === 'pending' ? 
                            `<button class="btn btn-success btn-sm" onclick="verifyPayment(${payment.id})">
                                <span class="material-icons">check</span>
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="rejectPayment(${payment.id})">
                                <span class="material-icons">close</span>
                            </button>` :
                            `<button class="btn btn-primary btn-sm" onclick="viewPayment(${payment.id})">
                                <span class="material-icons">visibility</span>
                            </button>`
                        }
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function verifyPayment(id) {
            const payment = paymentData.find(p => p.id === id);
            if (payment && confirm('Verifikasi pembayaran ini?')) {
                payment.status = 'verified';
                loadPaymentTable();
                showNotification('Pembayaran berhasil diverifikasi!');
            }
        }

        function rejectPayment(id) {
            const payment = paymentData.find(p => p.id === id);
            if (payment && confirm('Tolak pembayaran ini?')) {
                payment.status = 'rejected';
                loadPaymentTable();
                showNotification('Pembayaran ditolak!', 'error');
            }
        }

        function savePayment(event) {
            event.preventDefault();
            
            const jamaahSelect = document.getElementById('paymentJamaah');
            const jamaahName = jamaahSelect.options[jamaahSelect.selectedIndex].text.split(' - ')[0];
            
            const newPayment = {
                id: Math.max(...paymentData.map(p => p.id)) + 1,
                jamaah_id: parseInt(document.getElementById('paymentJamaah').value),
                jamaah_name: jamaahName,
                package: "Umroh Ramadhan 2024", // Would be dynamically determined
                amount: parseInt(document.getElementById('paymentAmount').value),
                date: document.getElementById('paymentDate').value,
                method: document.getElementById('paymentMethod').value,
                bank: document.getElementById('paymentBank').value,
                reference: document.getElementById('paymentReference').value,
                status: 'pending'
            };
            
            paymentData.push(newPayment);
            closeModal('paymentModal');
            loadPaymentTable();
            showNotification('Pembayaran berhasil dicatat!');
            event.target.reset();
        }

        // Document Management
        function loadDocumentTable() {
            const tbody = document.getElementById('documentTableBody');
            tbody.innerHTML = '';
            
            documentData.forEach(doc => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${doc.jamaah_name}</td>
                    <td>${doc.type}</td>
                    <td><a href="#" style="color: #4facfe;">${doc.filename}</a></td>
                    <td>${formatDate(doc.upload_date)}</td>
                    <td><span class="status-badge status-${doc.status}">${getStatusText(doc.status)}</span></td>
                    <td>
                        <div class="table-actions">
                        ${doc.status === 'pending' ? 
                            `<button class="btn btn-success btn-sm" onclick="verifyDocument(${doc.id})">
                                <span class="material-icons">check</span>
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="rejectDocument(${doc.id})">
                                <span class="material-icons">close</span>
                            </button>` :
                            `<button class="btn btn-primary btn-sm" onclick="viewDocument(${doc.id})">
                                <span class="material-icons">visibility</span>
                            </button>`
                        }
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function handleFileUpload(event) {
            const files = event.target.files;
            if (files.length > 0) {
                showNotification(`${files.length} file berhasil diupload!`);
                // In real app, files would be uploaded to server
                for (let file of files) {
                    documentData.push({
                        id: Math.max(...documentData.map(d => d.id)) + 1,
                        jamaah_name: "Jamaah Baru",
                        type: "Dokumen",
                        filename: file.name,
                        upload_date: new Date().toISOString().split('T')[0],
                        status: 'pending'
                    });
                }
                loadDocumentTable();
            }
        }

        function handleDrop(event) {
            event.preventDefault();
            event.target.classList.remove('dragover');
            handleFileUpload(event);
        }

        function handleDragOver(event) {
            event.preventDefault();
            event.target.classList.add('dragover');
        }

        function handleDragLeave(event) {
            event.target.classList.remove('dragover');
        }

        function verifyDocument(id) {
            const doc = documentData.find(d => d.id === id);
            if (doc && confirm('Verifikasi dokumen ini?')) {
                doc.status = 'verified';
                loadDocumentTable();
                showNotification('Dokumen berhasil diverifikasi!');
            }
        }

        function rejectDocument(id) {
            const doc = documentData.find(d => d.id === id);
            if (doc && confirm('Tolak dokumen ini?')) {
                doc.status = 'rejected';
                loadDocumentTable();
                showNotification('Dokumen ditolak!', 'error');
            }
        }

        // Group Management
        function loadGroupCards() {
            const container = document.getElementById('groupGrid');
            container.innerHTML = '';
            
            groupData.forEach(group => {
                const card = document.createElement('div');
                card.className = 'group-card';
                
                // Calculate progress percentage
                const progressPercentage = (group.current_members / group.max_members) * 100;
                
                card.innerHTML = `
                    <!-- Group Header -->
                    <div class="group-header">
                        <div class="group-title">
                            <h3>${group.name}</h3>
                            <div class="group-package">${group.package}</div>
                        </div>
                        <div class="group-status-badge">
                            <span class="status-badge status-${group.status}">${getGroupStatusText(group.status)}</span>
                        </div>
                    </div>

                    <!-- Group Progress -->
                    <div class="group-progress">
                        <div class="group-progress-bar">
                            <div class="group-progress-fill" style="width: ${progressPercentage}%"></div>
                        </div>
                        <div class="group-progress-text">
                            ${group.current_members} dari ${group.max_members} anggota (${Math.round(progressPercentage)}%)
                        </div>
                    </div>

                    <!-- Group Information Grid -->
                    <div class="group-info-grid">
                        <div class="group-info-item">
                            <div class="group-info-label">Keberangkatan</div>
                            <div class="group-info-value">${formatDate(group.departure_date)}</div>
                        </div>
                        <div class="group-info-item">
                            <div class="group-info-label">Anggota</div>
                            <div class="group-info-value highlight">${group.current_members}/${group.max_members}</div>
                        </div>
                        <div class="group-info-item">
                            <div class="group-info-label">Bus</div>
                            <div class="group-info-value">${group.bus_number}</div>
                        </div>
                        <div class="group-info-item">
                            <div class="group-info-label">Kumpul</div>
                            <div class="group-info-value">${group.meeting_time}</div>
                        </div>
                    </div>

                    <!-- Group Logistics -->
                    <div class="group-logistics">
                        <div class="group-logistics-title">
                            <span class="material-icons" style="font-size: 16px;">location_on</span>
                            Detail Logistik
                        </div>
                        <div class="group-logistics-item">
                            <div class="group-logistics-icon">🚌</div>
                            <div>Bus: ${group.bus_number}</div>
                        </div>
                        <div class="group-logistics-item">
                            <div class="group-logistics-icon">⏰</div>
                            <div>Waktu Kumpul: ${group.meeting_time}</div>
                        </div>
                        <div class="group-logistics-item">
                            <div class="group-logistics-icon">📍</div>
                            <div>Lokasi: ${group.meeting_point}</div>
                        </div>
                        <div class="group-logistics-item">
                            <div class="group-logistics-icon">👤</div>
                            <div>Tour Leader: ${group.tour_leader || 'Ustadz Ahmad Fauzi'}</div>
                        </div>
                    </div>

                    <!-- Sub Groups Section -->
                    ${group.sub_groups && group.sub_groups.length > 0 ? `
                    <div class="group-sub-groups" style="margin: 12px 0; padding: 12px; background: rgba(30, 41, 59, 0.5); border-radius: 8px; border: 1px solid rgba(71, 85, 105, 0.3);">
                        <div class="group-logistics-title" style="margin-bottom: 8px; font-size: 12px;">
                            <span class="material-icons" style="font-size: 14px;">hotel</span>
                            Sub Groups (${group.sub_groups.length} Hotel)
                        </div>
                        <div class="sub-groups-list">
                            ${group.sub_groups.map(subGroup => `
                                <div class="sub-group-item" style="margin-bottom: 8px; padding: 8px; background: rgba(15, 23, 42, 0.6); border-radius: 6px; border-left: 2px solid #10b981;">
                                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 4px;">
                                        <div style="flex: 1; min-width: 0;">
                                            <div style="color: #f8fafc; font-weight: 500; font-size: 11px; line-height: 1.2; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${subGroup.name}</div>
                                            <div style="color: #cbd5e1; font-size: 9px; margin-top: 1px; line-height: 1.1;">
                                                🏨 ${subGroup.hotel_makkah.length > 15 ? subGroup.hotel_makkah.substring(0, 15) + '...' : subGroup.hotel_makkah}
                                            </div>
                                            <div style="color: #cbd5e1; font-size: 9px; line-height: 1.1;">
                                                🏨 ${subGroup.hotel_madinah.length > 15 ? subGroup.hotel_madinah.substring(0, 15) + '...' : subGroup.hotel_madinah}
                                            </div>
                                        </div>
                                        <div style="text-align: right; flex-shrink: 0; margin-left: 8px;">
                                            <div style="color: #10b981; font-weight: 600; font-size: 11px;">${subGroup.members}/${subGroup.max_members}</div>
                                            <div style="color: #64748b; font-size: 8px;">jamaah</div>
                                        </div>
                                    </div>
                                    <div style="margin-top: 6px;">
                                        <button class="btn btn-sm" style="background: rgba(16, 185, 129, 0.2); color: #10b981; border: 1px solid rgba(16, 185, 129, 0.3); font-size: 9px; padding: 3px 6px; width: 100%;" onclick="manageSubGroup(${group.id}, ${subGroup.id})">
                                            <span class="material-icons" style="font-size: 12px; margin-right: 2px;">manage_accounts</span>
                                            Kelola
                                        </button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        <div style="margin-top: 8px; text-align: center;">
                            <button class="btn btn-sm btn-primary" onclick="addSubGroup(${group.id})" style="font-size: 9px; padding: 4px 8px;">
                                <span class="material-icons" style="font-size: 12px; margin-right: 2px;">add_circle</span>
                                Tambah Sub Grup
                            </button>
                        </div>
                    </div>
                    ` : `
                    <div style="margin: 15px 0; text-align: center;">
                        <button class="btn btn-sm btn-primary" onclick="addSubGroup(${group.id})" style="font-size: 11px; padding: 6px 12px;">
                            <span class="material-icons" style="font-size: 14px;">add_circle</span>
                            Buat Sub Grup Hotel
                        </button>
                    </div>
                    `}

                    <!-- Group Actions -->
                    <div class="group-actions">
                        <button class="btn btn-primary btn-sm" onclick="manageGroupMembers(${group.id})" title="Kelola Anggota">
                            <span class="material-icons">people</span>
                            Anggota
                        </button>
                        <button class="btn btn-success btn-sm" onclick="generateRoomList(${group.id})" title="Generate Room List">
                            <span class="material-icons">auto_awesome</span>
                            Auto
                        </button>
                        <button class="btn btn-info btn-sm" onclick="openRoomManagement(${group.id})" title="Lihat Room List">
                            <span class="material-icons">hotel</span>
                            Kamar
                        </button>
                        <button class="btn btn-warning btn-sm" onclick="exportManifest(${group.id})" title="Export Manifest Grup">
                            <span class="material-icons">description</span>
                            Manifest
                        </button>
                        <button class="btn btn-warning btn-sm" onclick="editGroup(${group.id})" title="Edit Grup">
                            <span class="material-icons">edit</span>
                            Edit
                        </button>
                        <button class="btn btn-secondary btn-sm" onclick="viewGroupDetails(${group.id})" title="Lihat Detail">
                            <span class="material-icons">visibility</span>
                            Detail
                        </button>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function getGroupStatusText(status) {
            const statusMap = {
                'planning': 'Perencanaan',
                'active': 'Aktif',
                'departed': 'Berangkat',
                'completed': 'Selesai'
            };
            return statusMap[status] || status;
        }

        function saveGroup(event) {
            event.preventDefault();
            
            const packageSelect = document.getElementById('groupPackage');
            const packageName = packageSelect.options[packageSelect.selectedIndex].text;
            
            const newGroup = {
                id: Math.max(...groupData.map(g => g.id)) + 1,
                name: document.getElementById('groupName').value,
                package: packageName,
                departure_date: document.getElementById('groupDeparture').value,
                max_members: parseInt(document.getElementById('groupMaxMembers').value),
                current_members: 0,
                bus_number: document.getElementById('groupBusNumber').value,
                meeting_time: document.getElementById('groupMeetingTime').value,
                meeting_point: document.getElementById('groupMeetingPoint').value,
                tour_leader: document.getElementById('groupTourLeader').value || 'Belum ditentukan',
                status: 'planning'
            };
            
            groupData.push(newGroup);
            closeModal('groupModal');
            loadGroupCards();
            showNotification('Grup berhasil dibuat!');
            event.target.reset();
        }

        function manageGroupMembers(id) {
            showNotification('Fitur kelola anggota grup akan segera tersedia!');
        }

        function editGroup(id) {
            showNotification('Fitur edit grup akan segera tersedia!');
        }

        function viewGroupDetails(id) {
            const group = groupData.find(g => g.id === id);
            if (!group) return;
            
            // Create modal for group details
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.style.display = 'flex';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 700px;">
                    <div class="modal-header">
                        <h3>Detail Grup - ${group.name}</h3>
                        <button class="close-btn">&times;</button>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                        <div>
                            <h4 style="color: #4facfe; margin-bottom: 10px;">Informasi Grup</h4>
                            <p><strong>Nama:</strong> ${group.name}</p>
                            <p><strong>Paket:</strong> ${group.package}</p>
                            <p><strong>Status:</strong> <span class="status-badge status-${group.status}">${getGroupStatusText(group.status)}</span></p>
                            <p><strong>Anggota:</strong> ${group.current_members}/${group.max_members}</p>
                        </div>
                        <div>
                            <h4 style="color: #4facfe; margin-bottom: 10px;">Keberangkatan</h4>
                            <p><strong>Tanggal:</strong> ${formatDate(group.departure_date)}</p>
                            <p><strong>Bus:</strong> ${group.bus_number}</p>
                            <p><strong>Waktu Kumpul:</strong> ${group.meeting_time}</p>
                            <p><strong>Lokasi Kumpul:</strong> ${group.meeting_point}</p>
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px;">
                        <h4 style="color: #4facfe; margin-bottom: 15px;">Daftar Anggota Grup</h4>
                        <div style="background: rgba(30, 41, 59, 0.3); border-radius: 8px; padding: 15px;">
                            <p style="color: rgba(255, 255, 255, 0.7); text-align: center;">
                                ${group.current_members > 0 ? 
                                    `Grup ini memiliki ${group.current_members} anggota terdaftar.` : 
                                    'Belum ada anggota terdaftar dalam grup ini.'
                                }
                            </p>
                            <p style="color: rgba(255, 255, 255, 0.5); text-align: center; font-size: 12px; margin-top: 10px;">
                                Fitur detail anggota akan segera tersedia.
                            </p>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Add event listeners for close buttons
            const closeButtons = modal.querySelectorAll('.close-btn');
            closeButtons.forEach(btn => {
                btn.addEventListener('click', function() {
                    modal.remove();
                });
            });
            
            // Close on click outside
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

        // Sub-Group Management Functions
        function addSubGroup(groupId) {
            const group = groupData.find(g => g.id === groupId);
            if (!group) return;

            // Create modal for adding sub-group
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.style.display = 'flex';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 500px;">
                    <div class="modal-header">
                        <h3>Tambah Sub Grup - ${group.name}</h3>
                        <button class="close-btn">&times;</button>
                    </div>
                    
                    <form onsubmit="saveSubGroup(event, ${groupId})" style="padding: 20px;">
                        <div class="form-group">
                            <label for="subGroupName">Nama Sub Grup</label>
                            <input type="text" id="subGroupName" placeholder="Contoh: Sub Grup Hotel Hilton" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="subGroupHotelMakkah">Hotel Makkah</label>
                            <input type="text" id="subGroupHotelMakkah" placeholder="Nama hotel di Makkah" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="subGroupHotelMadinah">Hotel Madinah</label>
                            <input type="text" id="subGroupHotelMadinah" placeholder="Nama hotel di Madinah" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="subGroupMaxMembers">Maksimal Anggota</label>
                            <input type="number" id="subGroupMaxMembers" min="1" max="${group.max_members}" placeholder="Jumlah maksimal jamaah" required>
                        </div>
                        
                        <div class="form-actions">
                            <button type="button" class="btn btn-secondary close-btn">Batal</button>
                            <button type="submit" class="btn btn-primary">Simpan Sub Grup</button>
                        </div>
                    </form>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Add event listeners for close buttons
            const closeButtons = modal.querySelectorAll('.close-btn');
            closeButtons.forEach(btn => {
                btn.addEventListener('click', function() {
                    modal.remove();
                });
            });
            
            // Close on click outside
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

        function saveSubGroup(event, groupId) {
            event.preventDefault();
            
            const group = groupData.find(g => g.id === groupId);
            if (!group) return;
            
            // Initialize sub_groups array if it doesn't exist
            if (!group.sub_groups) {
                group.sub_groups = [];
            }
            
            const newSubGroup = {
                id: Date.now(), // Simple ID generation
                name: document.getElementById('subGroupName').value,
                hotel_makkah: document.getElementById('subGroupHotelMakkah').value,
                hotel_madinah: document.getElementById('subGroupHotelMadinah').value,
                members: 0,
                max_members: parseInt(document.getElementById('subGroupMaxMembers').value)
            };
            
            group.sub_groups.push(newSubGroup);
            
            // Close modal
            event.target.closest('.modal').remove();
            
            // Refresh group cards
            loadGroupCards();
            showNotification('Sub grup berhasil ditambahkan!');
        }

        function manageSubGroup(groupId, subGroupId) {
            const group = groupData.find(g => g.id === groupId);
            const subGroup = group?.sub_groups?.find(sg => sg.id === subGroupId);
            
            if (!group || !subGroup) return;

            // Create modal for managing sub-group
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.style.display = 'flex';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 700px;">
                    <div class="modal-header">
                        <h3>Kelola ${subGroup.name}</h3>
                        <button class="close-btn">&times;</button>
                    </div>
                    
                    <div style="padding: 20px;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                            <div style="background: rgba(30, 41, 59, 0.4); padding: 15px; border-radius: 12px;">
                                <h4 style="color: #3b82f6; margin-bottom: 10px;">Informasi Sub Grup</h4>
                                <p><strong>Nama:</strong> ${subGroup.name}</p>
                                <p><strong>Hotel Makkah:</strong> ${subGroup.hotel_makkah}</p>
                                <p><strong>Hotel Madinah:</strong> ${subGroup.hotel_madinah}</p>
                                <p><strong>Anggota:</strong> ${subGroup.members}/${subGroup.max_members}</p>
                            </div>
                            <div style="background: rgba(30, 41, 59, 0.4); padding: 15px; border-radius: 12px;">
                                <h4 style="color: #10b981; margin-bottom: 10px;">Statistik</h4>
                                <p><strong>Kapasitas:</strong> ${Math.round((subGroup.members / subGroup.max_members) * 100)}%</p>
                                <p><strong>Sisa Slot:</strong> ${subGroup.max_members - subGroup.members} orang</p>
                                <p><strong>Status:</strong> ${subGroup.members === subGroup.max_members ? 'Penuh' : 'Tersedia'}</p>
                            </div>
                        </div>
                        
                        <div style="background: rgba(30, 41, 59, 0.3); border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                            <h4 style="color: #4facfe; margin-bottom: 15px;">Daftar Anggota Sub Grup</h4>
                            <div style="color: rgba(255, 255, 255, 0.7); text-align: center; padding: 20px;">
                                ${subGroup.members > 0 ? 
                                    `Sub grup ini memiliki ${subGroup.members} anggota terdaftar.` : 
                                    'Belum ada anggota terdaftar dalam sub grup ini.'
                                }
                                <p style="color: rgba(255, 255, 255, 0.5); font-size: 12px; margin-top: 10px;">
                                    Fitur pengelolaan anggota sub grup akan segera tersedia.
                                </p>
                            </div>
                        </div>
                        
                        <div class="form-actions" style="display: flex; gap: 10px; justify-content: flex-end;">
                            <button class="btn btn-warning" onclick="editSubGroup(${groupId}, ${subGroupId})">
                                <span class="material-icons">edit</span>
                                Edit Sub Grup
                            </button>
                            <button class="btn btn-danger" onclick="deleteSubGroup(${groupId}, ${subGroupId})">
                                <span class="material-icons">delete</span>
                                Hapus Sub Grup
                            </button>
                            <button class="btn btn-secondary close-btn">Tutup</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Add event listeners for close buttons
            const closeButtons = modal.querySelectorAll('.close-btn');
            closeButtons.forEach(btn => {
                btn.addEventListener('click', function() {
                    modal.remove();
                });
            });
            
            // Close on click outside
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

        function editSubGroup(groupId, subGroupId) {
            const group = groupData.find(g => g.id === groupId);
            const subGroup = group?.sub_groups?.find(sg => sg.id === subGroupId);
            
            if (!group || !subGroup) return;

            // Close current modal
            document.querySelector('.modal').remove();

            // Create edit modal
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.style.display = 'flex';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 500px;">
                    <div class="modal-header">
                        <h3>Edit Sub Grup</h3>
                        <button class="close-btn">&times;</button>
                    </div>
                    
                    <form onsubmit="updateSubGroup(event, ${groupId}, ${subGroupId})" style="padding: 20px;">
                        <div class="form-group">
                            <label for="editSubGroupName">Nama Sub Grup</label>
                            <input type="text" id="editSubGroupName" value="${subGroup.name}" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="editSubGroupHotelMakkah">Hotel Makkah</label>
                            <input type="text" id="editSubGroupHotelMakkah" value="${subGroup.hotel_makkah}" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="editSubGroupHotelMadinah">Hotel Madinah</label>
                            <input type="text" id="editSubGroupHotelMadinah" value="${subGroup.hotel_madinah}" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="editSubGroupMaxMembers">Maksimal Anggota</label>
                            <input type="number" id="editSubGroupMaxMembers" min="${subGroup.members}" max="${group.max_members}" value="${subGroup.max_members}" required>
                            <small style="color: rgba(255, 255, 255, 0.6);">Minimal ${subGroup.members} (anggota saat ini)</small>
                        </div>
                        
                        <div class="form-actions">
                            <button type="button" class="btn btn-secondary close-btn">Batal</button>
                            <button type="submit" class="btn btn-primary">Update Sub Grup</button>
                        </div>
                    </form>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Add event listeners for close buttons
            const closeButtons = modal.querySelectorAll('.close-btn');
            closeButtons.forEach(btn => {
                btn.addEventListener('click', function() {
                    modal.remove();
                });
            });
            
            // Close on click outside
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

        function updateSubGroup(event, groupId, subGroupId) {
            event.preventDefault();
            
            const group = groupData.find(g => g.id === groupId);
            const subGroup = group?.sub_groups?.find(sg => sg.id === subGroupId);
            
            if (!group || !subGroup) return;
            
            // Update sub-group data
            subGroup.name = document.getElementById('editSubGroupName').value;
            subGroup.hotel_makkah = document.getElementById('editSubGroupHotelMakkah').value;
            subGroup.hotel_madinah = document.getElementById('editSubGroupHotelMadinah').value;
            subGroup.max_members = parseInt(document.getElementById('editSubGroupMaxMembers').value);
            
            // Close modal
            event.target.closest('.modal').remove();
            
            // Refresh group cards
            loadGroupCards();
            showNotification('Sub grup berhasil diupdate!');
        }

        function deleteSubGroup(groupId, subGroupId) {
            if (!confirm('Yakin ingin menghapus sub grup ini? Tindakan ini tidak dapat dibatalkan.')) return;
            
            const group = groupData.find(g => g.id === groupId);
            if (!group || !group.sub_groups) return;
            
            // Check if sub-group has members
            const subGroup = group.sub_groups.find(sg => sg.id === subGroupId);
            if (subGroup && subGroup.members > 0) {
                if (!confirm(`Sub grup ini memiliki ${subGroup.members} anggota. Yakin ingin menghapus?`)) {
                    return;
                }
            }
            
            // Remove sub-group
            group.sub_groups = group.sub_groups.filter(sg => sg.id !== subGroupId);
            
            // Close modal
            document.querySelector('.modal').remove();
            
            // Refresh group cards
            loadGroupCards();
            showNotification('Sub grup berhasil dihapus!');
        }

        // Generate Room List Function - The Main Feature
        function generateRoomList(groupId) {
            const group = groupData.find(g => g.id === groupId);
            if (!group) return;

            // Get all jamaah in this group
            const groupJamaah = jamaahData.filter(j => j.group_id === groupId);
            
            if (groupJamaah.length === 0) {
                showNotification('Tidak ada jamaah dalam grup ini', 'error');
                return;
            }

            // Process room allocation
            const roomAllocation = processRoomAllocation(groupJamaah, group);
            
            // Show result in modal
            showRoomListResult(group, roomAllocation);
        }

        function processRoomAllocation(jamaahList, group) {
            const allocation = {
                hotels: {},
                summary: {
                    total_jamaah: jamaahList.length,
                    total_families: 0,
                    total_rooms: 0,
                    room_types: { quad: 0, triple: 0, double: 0 }
                }
            };

            // Group jamaah by sub-group (hotel)
            const jamaahBySubGroup = {};
            
            jamaahList.forEach(jamaah => {
                // Determine which sub-group/hotel this jamaah belongs to
                let subGroupKey = 'default';
                
                if (group.sub_groups && group.sub_groups.length > 0) {
                    // For now, distribute evenly. In real implementation, 
                    // this would be based on user selection
                    const subGroupIndex = jamaah.id % group.sub_groups.length;
                    subGroupKey = group.sub_groups[subGroupIndex].name;
                }
                
                if (!jamaahBySubGroup[subGroupKey]) {
                    jamaahBySubGroup[subGroupKey] = [];
                }
                jamaahBySubGroup[subGroupKey].push(jamaah);
            });

            // Process each sub-group/hotel
            Object.keys(jamaahBySubGroup).forEach(hotelName => {
                const hotelJamaah = jamaahBySubGroup[hotelName];
                allocation.hotels[hotelName] = processHotelRoomAllocation(hotelJamaah);
            });

            // Calculate summary
            Object.values(allocation.hotels).forEach(hotel => {
                allocation.summary.total_families += hotel.families.length;
                allocation.summary.total_rooms += hotel.rooms.length;
                
                hotel.rooms.forEach(room => {
                    allocation.summary.room_types[room.type]++;
                });
            });

            return allocation;
        }

        function processHotelRoomAllocation(jamaahList) {
            const hotelAllocation = {
                families: [],
                rooms: [],
                unassigned: []
            };

            // Group by family
            const familyGroups = {};
            
            jamaahList.forEach(jamaah => {
                const familyId = jamaah.main_family_id;
                if (!familyGroups[familyId]) {
                    familyGroups[familyId] = [];
                }
                familyGroups[familyId].push(jamaah);
            });

            // Process each family
            Object.keys(familyGroups).forEach(familyId => {
                const family = familyGroups[familyId];
                const familyInfo = processFamilyRoomAssignment(family);
                hotelAllocation.families.push(familyInfo);
            });

            // Allocate rooms
            hotelAllocation.families.forEach(family => {
                const rooms = allocateRoomsForFamily(family);
                hotelAllocation.rooms.push(...rooms);
            });

            return hotelAllocation;
        }

        function processFamilyRoomAssignment(familyMembers) {
            const mainFamily = familyMembers.find(j => j.family_role === 'kepala_keluarga') || familyMembers[0];
            
            return {
                main_family_id: mainFamily.main_family_id,
                main_family_name: mainFamily.name,
                family_role: mainFamily.family_role,
                members: familyMembers,
                family_room_request: familyMembers.some(j => j.family_room_request),
                preferred_room_type: mainFamily.room_preference || 'double',
                member_count: familyMembers.length,
                male_count: familyMembers.filter(j => j.gender === 'L').length,
                female_count: familyMembers.filter(j => j.gender === 'P').length
            };
        }

        function allocateRoomsForFamily(family) {
            const rooms = [];
            
            if (family.family_room_request && family.member_count <= 4) {
                // Family wants to stay together in one room
                const roomType = getRoomTypeByCapacity(family.member_count);
                rooms.push({
                    type: roomType,
                    capacity: getRoomCapacity(roomType),
                    occupants: family.members,
                    main_family: family.main_family_name,
                    special_request: 'Family Room',
                    gender_mixed: family.male_count > 0 && family.female_count > 0
                });
            } else {
                // Separate by gender
                const maleMembers = family.members.filter(j => j.gender === 'L');
                const femaleMembers = family.members.filter(j => j.gender === 'P');
                
                if (maleMembers.length > 0) {
                    const maleRooms = allocateRoomsByGender(maleMembers, family, 'L');
                    rooms.push(...maleRooms);
                }
                
                if (femaleMembers.length > 0) {
                    const femaleRooms = allocateRoomsByGender(femaleMembers, family, 'P');
                    rooms.push(...femaleRooms);
                }
            }
            
            return rooms;
        }

        function allocateRoomsByGender(members, family, gender) {
            const rooms = [];
            const preferredRoomType = family.preferred_room_type;
            const capacity = getRoomCapacity(preferredRoomType);
            
            for (let i = 0; i < members.length; i += capacity) {
                const roomMembers = members.slice(i, i + capacity);
                const actualCapacity = roomMembers.length;
                const roomType = getRoomTypeByCapacity(actualCapacity);
                
                rooms.push({
                    type: roomType,
                    capacity: actualCapacity,
                    occupants: roomMembers,
                    main_family: family.main_family_name,
                    gender: gender === 'L' ? 'Laki-laki' : 'Perempuan',
                    special_request: null,
                    gender_mixed: false
                });
            }
            
            return rooms;
        }

        function getRoomCapacity(roomType) {
            const capacities = {
                'quad': 4,
                'triple': 3,
                'double': 2
            };
            return capacities[roomType] || 2;
        }

        function getRoomTypeByCapacity(memberCount) {
            if (memberCount >= 4) return 'quad';
            if (memberCount === 3) return 'triple';
            return 'double';
        }

        function showRoomListResult(group, allocation) {
            // Create modal for room list result
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.style.display = 'flex';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 1200px; width: 95%;">
                    <div class="modal-header">
                        <h3>📋 Room List Generated - ${group.name}</h3>
                        <button class="close-btn">&times;</button>
                    </div>
                    
                    <div style="padding: 20px;">
                        ${generateRoomListHTML(allocation, group)}
                    </div>
                    
                    <div style="display: flex; gap: 10px; justify-content: flex-end; margin: 20px; padding-top: 20px; border-top: 1px solid rgba(71, 85, 105, 0.3);">
                        <button class="btn btn-success" onclick="exportRoomListToExcel(${JSON.stringify(allocation).replace(/"/g, '&quot;')}, '${group.name}')">
                            <span class="material-icons">download</span>
                            Export to Excel
                        </button>
                        <button class="btn btn-primary" onclick="applyRoomList(${group.id}, ${JSON.stringify(allocation).replace(/"/g, '&quot;')})">
                            <span class="material-icons">check_circle</span>
                            Apply Room List
                        </button>
                        <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">
                            <span class="material-icons">close</span>
                            Tutup
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Add event listeners for close buttons
            const closeButtons = modal.querySelectorAll('.close-btn');
            closeButtons.forEach(btn => {
                btn.addEventListener('click', function() {
                    modal.remove();
                });
            });
            
            // Close on click outside
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

        function generateRoomListHTML(allocation, group) {
            let html = `
                <!-- Summary Section -->
                <div style="background: rgba(30, 41, 59, 0.4); padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                    <h4 style="color: #3b82f6; margin-bottom: 15px;">📊 Summary</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div>
                            <div style="color: rgba(255, 255, 255, 0.7); font-size: 12px;">Total Jamaah</div>
                            <div style="color: #f8fafc; font-size: 18px; font-weight: 600;">${allocation.summary.total_jamaah} orang</div>
                        </div>
                        <div>
                            <div style="color: rgba(255, 255, 255, 0.7); font-size: 12px;">Total Keluarga</div>
                            <div style="color: #f8fafc; font-size: 18px; font-weight: 600;">${allocation.summary.total_families} family</div>
                        </div>
                        <div>
                            <div style="color: rgba(255, 255, 255, 0.7); font-size: 12px;">Total Kamar</div>
                            <div style="color: #f8fafc; font-size: 18px; font-weight: 600;">${allocation.summary.total_rooms} kamar</div>
                        </div>
                        <div>
                            <div style="color: rgba(255, 255, 255, 0.7); font-size: 12px;">Room Types</div>
                            <div style="color: #f8fafc; font-size: 14px;">
                                Quad: ${allocation.summary.room_types.quad} | 
                                Triple: ${allocation.summary.room_types.triple} | 
                                Double: ${allocation.summary.room_types.double}
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Hotel sections
            Object.keys(allocation.hotels).forEach(hotelName => {
                const hotel = allocation.hotels[hotelName];
                html += generateHotelRoomListHTML(hotelName, hotel);
            });

            return html;
        }

        function generateHotelRoomListHTML(hotelName, hotel) {
            let html = `
                <div style="background: rgba(15, 23, 42, 0.6); padding: 20px; border-radius: 12px; margin-bottom: 20px; border-left: 4px solid #10b981;">
                    <h4 style="color: #10b981; margin-bottom: 15px; display: flex; align-items: center;">
                        <span class="material-icons" style="margin-right: 8px;">hotel</span>
                        ${hotelName}
                    </h4>
                    
                    <div style="display: grid; gap: 15px;">
            `;

            // Room cards
            hotel.rooms.forEach((room, index) => {
                const roomNumber = index + 1;
                html += `
                    <div style="background: rgba(30, 41, 59, 0.8); padding: 15px; border-radius: 8px; border: 1px solid rgba(71, 85, 105, 0.3);">
                        <div style="display: flex; justify-content: between; align-items: flex-start; margin-bottom: 10px;">
                            <div>
                                <div style="color: #f8fafc; font-weight: 600; font-size: 16px;">Room ${roomNumber} (${room.type.toUpperCase()})</div>
                                <div style="color: rgba(255, 255, 255, 0.7); font-size: 12px; margin-top: 2px;">
                                    Main Family: ${room.main_family} | ${room.gender || 'Mixed Gender'}
                                    ${room.special_request ? ` | ${room.special_request}` : ''}
                                    ${room.gender_mixed ? ' | ⚠️ Mixed Gender (Family Request)' : ''}
                                </div>
                            </div>
                            <div style="text-align: right;">
                                <div style="color: #10b981; font-weight: 600;">${room.occupants.length}/${room.capacity}</div>
                                <div style="color: rgba(255, 255, 255, 0.6); font-size: 10px;">orang</div>
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
                            ${room.occupants.map(occupant => `
                                <div style="background: rgba(71, 85, 105, 0.3); padding: 8px; border-radius: 6px;">
                                    <div style="color: #f8fafc; font-weight: 500; font-size: 13px;">${occupant.name}</div>
                                    <div style="color: rgba(255, 255, 255, 0.7); font-size: 11px;">
                                        ${occupant.gender === 'male' ? '👨' : '👩'} 
                                        <strong>${occupant.gender === 'male' ? 'L' : 'P'}</strong> | 
                                        <span style="background: rgba(59, 130, 246, 0.15); color: #60a5fa; padding: 1px 4px; border-radius: 3px; font-size: 9px; font-weight: 600;">
                                            ${(occupant.room_preference || 'quad').toUpperCase()}
                                        </span>
                                    </div>
                                    <div style="color: rgba(255, 255, 255, 0.5); font-size: 10px; margin-top: 2px;">
                                        ${occupant.family_role || 'Individual'} | Born: ${formatBirthDate(occupant.birth_date)}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            });

            html += `
                    </div>
                </div>
            `;

            return html;
        }

        // Room Management Functions
        function openRoomManagement(groupId) {
            const group = groupData.find(g => g.id === groupId);
            if (!group) return;
            
            // Set modal title with sub-group information
            let titleText = `Room List - ${group.name}`;
            if (group.sub_groups && group.sub_groups.length > 0) {
                titleText += ` (${group.sub_groups.length} Sub Grup Hotel)`;
            }
            document.getElementById('roomModalTitle').textContent = titleText;
            
            // Generate room data for this group
            generateRoomsForGroup(groupId);
            
            // Load room interface
            loadRoomManagement(groupId);
            
            // Open modal
            openModal('roomModal');
        }

        function generateRoomsForGroup(groupId) {
            const group = groupData.find(g => g.id === groupId);
            if (!group) return;
            
            // Get jamaah in this group (simulate from jamaahData)
            const groupJamaah = jamaahData.filter(j => j.id <= group.current_members).map((j, index) => ({
                ...j,
                id: index + 1,
                group_id: groupId,
                room_preference: ['double', 'triple', 'quad'][Math.floor(Math.random() * 3)],
                gender: index % 2 === 0 ? 'male' : 'female',
                family_group: index < 4 ? 'FAM001' : index < 8 ? 'FAM002' : null,
                room_number: null,
                bed_assignment: null
            }));
            
            // Store current group jamaah
            window.currentGroupJamaah = groupJamaah;
            
            // Generate initial room structure
            currentGroupRooms = [];
            
            // Calculate needed rooms based on preferences
            const maleJamaah = groupJamaah.filter(j => j.gender === 'male');
            const femaleJamaah = groupJamaah.filter(j => j.gender === 'female');
            
            let roomNumber = 1;
            
            // Generate rooms for males
            roomNumber = generateRoomsForGender(maleJamaah, 'male', roomNumber);
            
            // Generate rooms for females  
            generateRoomsForGender(femaleJamaah, 'female', roomNumber);
        }

        function generateRoomsForGender(jamaahList, gender, startRoomNumber) {
            let roomNumber = startRoomNumber;
            const preferences = {};
            
            // Count preferences
            jamaahList.forEach(j => {
                preferences[j.room_preference] = (preferences[j.room_preference] || 0) + 1;
            });
            
            // Generate quad rooms first
            const quadNeeded = Math.ceil(preferences.quad / 4) || 0;
            for (let i = 0; i < quadNeeded; i++) {
                currentGroupRooms.push(createRoom(roomNumber++, 'quad', gender));
            }
            
            // Generate triple rooms
            const tripleNeeded = Math.ceil(preferences.triple / 3) || 0;
            for (let i = 0; i < tripleNeeded; i++) {
                currentGroupRooms.push(createRoom(roomNumber++, 'triple', gender));
            }
            
            // Generate double rooms
            const doubleNeeded = Math.ceil(preferences.double / 2) || 0;
            for (let i = 0; i < doubleNeeded; i++) {
                currentGroupRooms.push(createRoom(roomNumber++, 'double', gender));
            }
            
            // Add extra rooms if needed
            const totalCapacity = (quadNeeded * 4) + (tripleNeeded * 3) + (doubleNeeded * 2);
            if (totalCapacity < jamaahList.length) {
                const extraNeeded = Math.ceil((jamaahList.length - totalCapacity) / 2);
                for (let i = 0; i < extraNeeded; i++) {
                    currentGroupRooms.push(createRoom(roomNumber++, 'double', gender));
                }
            }
            
            return roomNumber;
        }

        function createRoom(number, type, gender) {
            const capacity = {
                'single': 1,
                'double': 2, 
                'triple': 3,
                'quad': 4
            };
            
            return {
                id: `room_${number}`,
                number: `${number.toString().padStart(3, '0')}`,
                type: type,
                gender: gender,
                capacity: capacity[type],
                occupants: [],
                isEmpty: true
            };
        }

        function loadRoomManagement(groupId) {
            // Update statistics
            updateRoomStatistics();
            
            // Load unassigned jamaah
            loadUnassignedJamaah();
            
            // Load room grid
            loadRoomGrid();
        }

        function updateRoomStatistics() {
            const totalRooms = currentGroupRooms.length;
            const occupiedRooms = currentGroupRooms.filter(r => r.occupants.length > 0).length;
            const assignedJamaah = currentGroupRooms.reduce((sum, r) => sum + r.occupants.length, 0);
            const unassignedJamaah = window.currentGroupJamaah ? window.currentGroupJamaah.filter(j => !j.room_number).length : 0;
            
            document.getElementById('totalRooms').textContent = totalRooms;
            document.getElementById('occupiedRooms').textContent = occupiedRooms;
            document.getElementById('assignedJamaah').textContent = assignedJamaah;
            document.getElementById('unassignedJamaah').textContent = unassignedJamaah;
            document.getElementById('unassignedCount').textContent = unassignedJamaah;
        }

        function loadUnassignedJamaah() {
            const container = document.getElementById('unassignedList');
            container.innerHTML = '';
            
            if (!window.currentGroupJamaah) return;
            
            const unassigned = window.currentGroupJamaah.filter(j => !j.room_number);
            
            unassigned.forEach(jamaah => {
                const item = document.createElement('div');
                item.className = 'unassigned-item';
                item.innerHTML = `
                    <div>
                        <div style="font-weight: 500; color: #f8fafc; font-size: 13px;">${jamaah.name}</div>
                        <div style="font-size: 11px; color: rgba(255, 255, 255, 0.6);">
                            ${jamaah.gender === 'male' ? '👨' : '👩'} 
                            <strong>${jamaah.gender === 'male' ? 'L' : 'P'}</strong> | 
                            Beli: <span style="color: #60a5fa; font-weight: 600;">${(jamaah.room_preference || 'quad').toUpperCase()}</span>
                            ${jamaah.family_group ? ` | Family: ${jamaah.family_group}` : ''}
                        </div>
                    </div>
                    <div class="room-type ${jamaah.room_preference || 'quad'}">${(jamaah.room_preference || 'quad').toUpperCase()}</div>
                `;
                
                item.addEventListener('click', () => {
                    item.classList.toggle('selected');
                });
                
                container.appendChild(item);
            });
        }

        function loadRoomGrid() {
            const container = document.getElementById('roomGrid');
            container.innerHTML = '';
            
            currentGroupRooms.forEach(room => {
                const card = document.createElement('div');
                card.className = 'room-card';
                card.innerHTML = `
                    <div class="room-header">
                        <div class="room-number">Room ${room.number}</div>
                        <div class="room-type ${room.type}">${room.type}</div>
                    </div>
                    
                    <div class="room-occupants">
                        ${generateOccupantsHTML(room)}
                        ${generateEmptyBedsHTML(room)}
                    </div>
                    
                    <div class="room-actions">
                        <button class="btn btn-primary" onclick="assignToRoom('${room.id}')">
                            <span class="material-icons">person_add</span>
                            Assign
                        </button>
                        <button class="btn btn-warning" onclick="editRoom('${room.id}')">
                            <span class="material-icons">edit</span>
                            Edit
                        </button>
                        <button class="btn btn-danger" onclick="clearRoom('${room.id}')">
                            <span class="material-icons">clear</span>
                            Clear
                        </button>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function generateOccupantsHTML(room) {
            return room.occupants.map((occupant, index) => `
                <div class="occupant-item">
                    <div class="occupant-info">
                        <div class="occupant-name">${occupant.name}</div>
                        <div class="occupant-details">
                            ${occupant.gender === 'male' ? '👨' : '👩'} 
                            <strong>${occupant.gender === 'male' ? 'L' : 'P'}</strong> | 
                            <span style="background: rgba(59, 130, 246, 0.2); color: #3b82f6; padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: 500;">
                                ${(occupant.room_preference || 'quad').toUpperCase()}
                            </span> | 
                            ${occupant.phone}
                        </div>
                    </div>
                    <div class="bed-assignment">Bed ${index + 1}</div>
                </div>
            `).join('');
        }

        function generateEmptyBedsHTML(room) {
            const emptyBeds = room.capacity - room.occupants.length;
            let html = '';
            
            for (let i = 0; i < emptyBeds; i++) {
                html += `<div class="empty-bed">Empty Bed ${room.occupants.length + i + 1}</div>`;
            }
            
            return html;
        }

        function selectAllocationStrategy(strategy) {
            selectedAllocationStrategy = strategy;
            
            // Update UI
            document.querySelectorAll('.allocation-option').forEach(option => {
                option.classList.remove('active');
            });
            document.querySelector(`[data-strategy="${strategy}"]`).classList.add('active');
        }

        function autoAllocateRooms() {
            if (!window.currentGroupJamaah) return;
            
            // Clear existing assignments
            clearAllRooms();
            
            const unassigned = [...window.currentGroupJamaah];
            
            // Sort by strategy
            switch (selectedAllocationStrategy) {
                case 'family':
                    allocateByFamily(unassigned);
                    break;
                case 'preference':
                    allocateByPreference(unassigned);
                    break;
                case 'auto':
                default:
                    allocateSmartly(unassigned);
                    break;
            }
            
            // Refresh display
            loadRoomManagement();
            showNotification('Rooms allocated successfully!');
        }

        function allocateSmartly(jamaahList) {
            // First try to allocate by preference, then fallback to simple allocation
            allocateByPreference(jamaahList);
            
            // Check for any unassigned jamaah and allocate them to available rooms
            const unassigned = jamaahList.filter(j => !j.room_number);
            if (unassigned.length > 0) {
                console.log(`Found ${unassigned.length} unassigned jamaah, allocating to available rooms`);
                
                // Separate by gender
                const males = unassigned.filter(j => j.gender === 'male');
                const females = unassigned.filter(j => j.gender === 'female');
                
                // Allocate males
                allocateGenderGroupFallback(males, 'male');
                
                // Allocate females
                allocateGenderGroupFallback(females, 'female');
            }
        }

        function allocateGenderGroupFallback(jamaahList, gender) {
            // Find rooms with available capacity for this gender
            const availableRooms = currentGroupRooms.filter(r => 
                r.gender === gender && r.occupants.length < r.capacity
            ).sort((a, b) => {
                // Prioritize rooms that match jamaah preferences
                const aHasMatchingPreference = jamaahList.some(j => j.room_preference === a.type);
                const bHasMatchingPreference = jamaahList.some(j => j.room_preference === b.type);
                if (aHasMatchingPreference && !bHasMatchingPreference) return -1;
                if (!aHasMatchingPreference && bHasMatchingPreference) return 1;
                // Then by available space (fill partially occupied rooms first)
                return b.occupants.length - a.occupants.length;
            });
            
            let jamaahIndex = 0;
            
            // Fill rooms based on capacity
            availableRooms.forEach(room => {
                while (room.occupants.length < room.capacity && jamaahIndex < jamaahList.length) {
                    const jamaah = jamaahList[jamaahIndex];
                    room.occupants.push(jamaah);
                    jamaah.room_number = room.number;
                    jamaah.bed_assignment = `Bed ${room.occupants.length}`;
                    jamaahIndex++;
                }
            });
        }

        function allocateByFamily(jamaahList) {
            // Group by family first, then by gender
            const families = {};
            const singles = [];
            
            jamaahList.forEach(jamaah => {
                if (jamaah.family_group) {
                    if (!families[jamaah.family_group]) {
                        families[jamaah.family_group] = [];
                    }
                    families[jamaah.family_group].push(jamaah);
                } else {
                    singles.push(jamaah);
                }
            });
            
            // Allocate families first
            Object.values(families).forEach(family => {
                allocateGenderGroup(family.filter(j => j.gender === 'male'), 'male');
                allocateGenderGroup(family.filter(j => j.gender === 'female'), 'female');
            });
            
            // Then allocate singles
            allocateSmartly(singles);
        }

        function allocateByPreference(jamaahList) {
            // Group by gender and preference
            const groups = {
                'male': { 'quad': [], 'triple': [], 'double': [] },
                'female': { 'quad': [], 'triple': [], 'double': [] }
            };
            
            jamaahList.forEach(jamaah => {
                // Default to quad if no preference is set
                const preference = jamaah.room_preference || 'quad';
                if (groups[jamaah.gender] && groups[jamaah.gender][preference]) {
                    groups[jamaah.gender][preference].push(jamaah);
                }
            });
            
            // Allocate by preference
            ['male', 'female'].forEach(gender => {
                ['quad', 'triple', 'double'].forEach(preference => {
                    const preferenceGroup = groups[gender][preference];
                    const preferredRooms = currentGroupRooms.filter(r => r.gender === gender && r.type === preference);
                    
                    let jamaahIndex = 0;
                    preferredRooms.forEach(room => {
                        while (room.occupants.length < room.capacity && jamaahIndex < preferenceGroup.length) {
                            const jamaah = preferenceGroup[jamaahIndex];
                            room.occupants.push(jamaah);
                            jamaah.room_number = room.number;
                            jamaah.bed_assignment = `Bed ${room.occupants.length}`;
                            jamaahIndex++;
                        }
                    });
                });
            });
        }

        function clearAllRooms() {
            currentGroupRooms.forEach(room => {
                room.occupants.forEach(occupant => {
                    occupant.room_number = null;
                    occupant.bed_assignment = null;
                });
                room.occupants = [];
            });
            
            loadRoomManagement();
        }

        function clearRoom(roomId) {
            const room = currentGroupRooms.find(r => r.id === roomId);
            if (room) {
                room.occupants.forEach(occupant => {
                    occupant.room_number = null;
                    occupant.bed_assignment = null;
                });
                room.occupants = [];
                loadRoomManagement();
            }
        }

        function assignToRoom(roomId) {
            const selectedJamaah = document.querySelectorAll('.unassigned-item.selected');
            if (selectedJamaah.length === 0) {
                showNotification('Pilih jamaah yang akan ditempatkan', 'error');
                return;
            }
            
            const room = currentGroupRooms.find(r => r.id === roomId);
            if (!room) return;
            
            if (room.occupants.length >= room.capacity) {
                showNotification('Kamar sudah penuh', 'error');
                return;
            }
            
            // Process selected jamaah
            selectedJamaah.forEach(item => {
                if (room.occupants.length < room.capacity) {
                    const jamaahName = item.querySelector('.occupant-name, div[style*="font-weight: 500"]')?.textContent;
                    const jamaah = window.currentGroupJamaah.find(j => j.name === jamaahName);
                    
                    if (jamaah && !jamaah.room_number) {
                        room.occupants.push(jamaah);
                        jamaah.room_number = room.number;
                        jamaah.bed_assignment = `Bed ${room.occupants.length}`;
                    }
                }
            });
            
            loadRoomManagement();
            showNotification('Jamaah berhasil ditempatkan ke kamar');
        }

        function editRoom(roomId) {
            showNotification('Fitur edit room akan segera tersedia');
        }

        function saveRoomAssignments() {
            showNotification('Room assignments saved successfully!');
            closeModal('roomModal');
        }

        function exportRoomList() {
            // Create Excel-like data structure
            const data = [
                ['Room Number', 'Room Type', 'Gender', 'Occupant 1', 'Occupant 2', 'Occupant 3', 'Occupant 4']
            ];
            
            currentGroupRooms.forEach(room => {
                const row = [
                    room.number,
                    room.type.toUpperCase(),
                    room.gender.toUpperCase()
                ];
                
                // Add occupants
                for (let i = 0; i < 4; i++) {
                    row.push(room.occupants[i] ? room.occupants[i].name : '');
                }
                
                data.push(row);
            });
            
            // Create and download Excel file
            const ws = XLSX.utils.aoa_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Room List');
            XLSX.writeFile(wb, 'room_list.xlsx');
            
            showNotification('Room list exported successfully!');
        }

        // Reports
        function loadReportCharts() {
            // Trend chart
            const trendCtx = document.getElementById('trendChart').getContext('2d');
            new Chart(trendCtx, {
                type: 'line',
                data: {
                    labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                    datasets: [{
                        label: 'Registrasi',
                        data: [120, 190, 300, 250, 180, 220],
                        borderColor: '#4facfe',
                        backgroundColor: 'rgba(79, 172, 254, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { 
                            labels: { 
                                color: 'white',
                                font: { size: 12 }
                            } 
                        }
                    },
                    scales: {
                        x: { 
                            ticks: { 
                                color: 'white',
                                font: { size: 11 }
                            } 
                        },
                        y: { 
                            ticks: { 
                                color: 'white',
                                font: { size: 11 }
                            } 
                        }
                    }
                }
            });

            // Status chart
            const statusCtx = document.getElementById('statusChart').getContext('2d');
            new Chart(statusCtx, {
                type: 'pie',
                data: {
                    labels: ['Terverifikasi', 'Pending', 'Ditolak'],
                    datasets: [{
                        data: [1089, 158, 23],
                        backgroundColor: ['#22c55e', '#f59e0b', '#ef4444']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { 
                            labels: { 
                                color: 'white',
                                font: { size: 11 }
                            } 
                        }
                    }
                }
            });
        }

        function generateReport(type) {
            showNotification(`Generating laporan ${type}...`);
            
            // Simulate report generation
            setTimeout(() => {
                showNotification(`Laporan ${type} berhasil dibuat!`);
            }, 2000);
        }

        // Excel Functions
        function downloadTemplate(type) {
            let templateData = [];
            let filename = '';

            switch(type) {
                case 'jamaah':
                    templateData = [
                        ['Nama Lengkap', 'NIK', 'Tanggal Lahir', 'Tempat Lahir', 'Jenis Kelamin', 'No. Telepon', 'Email', 'Alamat', 'No. Paspor', 'Paket ID'],
                        ['Ahmad Fauzi', '1234567890123456', '1985-05-15', 'Jakarta', 'L', '081234567890', 'ahmad@email.com', 'Jl. Merdeka No. 123', 'A1234567', '1']
                    ];
                    filename = 'template_jamaah.xlsx';
                    break;
                case 'package':
                    templateData = [
                        ['Nama Paket', 'Harga', 'Tanggal Keberangkatan', 'Durasi', 'Kuota', 'Hotel Makkah', 'Hotel Madinah', 'Malam Makkah', 'Malam Madinah', 'Maskapai'],
                        ['Umroh Ramadhan 2024', '25000000', '2024-03-15', '14', '45', 'Hilton Makkah', 'Pullman Madinah', '7', '7', 'Emirates']
                    ];
                    filename = 'template_paket.xlsx';
                    break;
                case 'payment':
                    templateData = [
                        ['Jamaah ID', 'Jumlah', 'Tanggal', 'Metode', 'Bank', 'No. Referensi'],
                        ['1', '15000000', '2024-01-15', 'Transfer Bank', 'BCA', 'TRF20240115001']
                    ];
                    filename = 'template_pembayaran.xlsx';
                    break;
            }

            const ws = XLSX.utils.aoa_to_sheet(templateData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Template');
            XLSX.writeFile(wb, filename);
            
            showNotification(`Template ${type} berhasil didownload!`);
        }

        function handleExcelImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = e.target.result;
                    const workbook = XLSX.read(data, {type: 'binary'});
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, {header: 1});
                    
                    // Process imported data
                    const headers = jsonData[0];
                    const rows = jsonData.slice(1);
                    
                    let successCount = 0;
                    let errorCount = 0;
                    let errors = [];

                    rows.forEach((row, index) => {
                        try {
                            // Validate and process each row
                            if (row.length >= headers.length - 1) {
                                successCount++;
                            } else {
                                errorCount++;
                                errors.push(`Baris ${index + 2}: Data tidak lengkap`);
                            }
                        } catch (error) {
                            errorCount++;
                            errors.push(`Baris ${index + 2}: ${error.message}`);
                        }
                    });

                    // Show import results
                    const resultsDiv = document.getElementById('importResults');
                    const contentDiv = document.getElementById('importResultsContent');
                    
                    contentDiv.innerHTML = `
                        <div class="glass-card">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px;">
                                <div class="stat-card">
                                    <div class="stat-number" style="color: #22c55e;">${successCount}</div>
                                    <div class="stat-label">Berhasil</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-number" style="color: #ef4444;">${errorCount}</div>
                                    <div class="stat-label">Error</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-number">${rows.length}</div>
                                    <div class="stat-label">Total</div>
                                </div>
                            </div>
                            ${errors.length > 0 ? `
                                <div style="background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 8px; padding: 15px;">
                                    <h4 style="color: #ef4444; margin-bottom: 10px;">Error Details:</h4>
                                    <ul style="color: rgba(255, 255, 255, 0.8); margin-left: 20px;">
                                        ${errors.map(error => `<li>${error}</li>`).join('')}
                                    </ul>
                                </div>
                            ` : ''}
                        </div>
                    `;
                    
                    resultsDiv.style.display = 'block';
                    showNotification('Import Excel selesai!');
                    
                } catch (error) {
                    showNotification('Error membaca file Excel!', 'error');
                }
            };
            reader.readAsBinaryString(file);
        }

        function exportToExcel(type) {
            let data = [];
            let filename = '';

            switch(type) {
                case 'jamaah':
                    data = jamaahData.map(j => [
                        j.name, j.nik, j.phone, j.email, j.passport_number || 'Belum ada', j.package, 
                        getStatusText(j.status), j.total_paid
                    ]);
                    data.unshift(['Nama', 'NIK', 'Telepon', 'Email', 'No. Paspor', 'Paket', 'Status', 'Total Bayar']);
                    filename = 'data_jamaah.xlsx';
                    break;
                case 'package':
                    data = packageData.map(p => [
                        p.name, p.price, p.departure_date, p.duration, p.quota, p.booked,
                        p.makkah_hotel, p.madinah_hotel, p.airline
                    ]);
                    data.unshift(['Nama', 'Harga', 'Keberangkatan', 'Durasi', 'Kuota', 'Terdaftar', 'Hotel Makkah', 'Hotel Madinah', 'Maskapai']);
                    filename = 'data_paket.xlsx';
                    break;
                case 'payment':
                    data = paymentData.map(p => [
                        p.id, p.reference, p.jamaah_name, p.package, p.amount, p.date, p.method, p.bank, getStatusText(p.status)
                    ]);
                    data.unshift(['ID', 'No. Referensi', 'Jamaah', 'Paket', 'Jumlah', 'Tanggal', 'Metode', 'Bank', 'Status']);
                    filename = 'data_pembayaran.xlsx';
                    break;
                case 'manifest':
                    exportManifest();
                    return;
                case 'all':
                    // Create workbook with multiple sheets
                    const wb = XLSX.utils.book_new();
                    
                    // Jamaah sheet
                    const jamaahData2D = jamaahData.map(j => [j.name, j.nik, j.phone, j.email, j.passport_number || 'Belum ada', j.package, getStatusText(j.status), j.total_paid]);
                    jamaahData2D.unshift(['Nama', 'NIK', 'Telepon', 'Email', 'No. Paspor', 'Paket', 'Status', 'Total Bayar']);
                    const wsJamaah = XLSX.utils.aoa_to_sheet(jamaahData2D);
                    XLSX.utils.book_append_sheet(wb, wsJamaah, 'Jamaah');
                    
                    // Package sheet
                    const packageData2D = packageData.map(p => [p.code, p.name, p.price, p.departure_date, p.duration, p.quota, p.booked]);
                    packageData2D.unshift(['Kode', 'Nama', 'Harga', 'Keberangkatan', 'Durasi', 'Kuota', 'Terdaftar']);
                    const wsPackage = XLSX.utils.aoa_to_sheet(packageData2D);
                    XLSX.utils.book_append_sheet(wb, wsPackage, 'Paket');
                    
                    // Payment sheet
                    const paymentData2D = paymentData.map(p => [p.id, p.reference, p.jamaah_name, p.package, p.amount, p.date, p.method, p.bank, getStatusText(p.status)]);
                    paymentData2D.unshift(['ID', 'No. Referensi', 'Jamaah', 'Paket', 'Jumlah', 'Tanggal', 'Metode', 'Bank', 'Status']);
                    const wsPayment = XLSX.utils.aoa_to_sheet(paymentData2D);
                    XLSX.utils.book_append_sheet(wb, wsPayment, 'Pembayaran');
                    
                    XLSX.writeFile(wb, 'data_umroh_lengkap.xlsx');
                    showNotification('Semua data berhasil diekspor!');
                    return;
            }

            const ws = XLSX.utils.aoa_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Data');
            XLSX.writeFile(wb, filename);
            
            showNotification(`Data ${type} berhasil diekspor!`);
        }

        // Manifest Export Function
        function exportManifest(groupId = null) {
            // Get all jamaah for the specified group or all if no group specified
            let jamaahList = jamaahData;
            let groupInfo = null;
            
            if (groupId) {
                groupInfo = groupData.find(g => g.id === groupId);
                jamaahList = jamaahData.filter(j => j.group_id === groupId);
            }
            
            if (jamaahList.length === 0) {
                showNotification('Tidak ada data jamaah untuk diekspor!', 'error');
                return;
            }
            
            // Create manifest data structure
            const manifestData = [];
            
            // Get package and airline information
            let packageInfo = null;
            let airlineCode = '';
            let packageCode = '';
            
            if (groupInfo) {
                // Find package info from group
                packageInfo = packageData.find(p => p.name === groupInfo.package);
            } else if (jamaahList.length > 0) {
                // Get package info from first jamaah if no specific group
                packageInfo = packageData.find(p => p.name === jamaahList[0].package);
            }
            
            if (packageInfo) {
                // Extract airline code (first 2-3 characters of airline name or use airline field)
                airlineCode = packageInfo.airline_code || packageInfo.airline?.substring(0, 3).toUpperCase() || 'XXX';
                packageCode = packageInfo.code || `PKG${packageInfo.id.toString().padStart(3, '0')}`;
            }
            
            // Header Information with Airline and Package Codes
            manifestData.push(['MANIFEST JAMAAH UMROH']);
            manifestData.push(['']);
            manifestData.push(['KODE MASKAPAI:', airlineCode]);
            manifestData.push(['KODE PAKET:', packageCode]);
            manifestData.push(['']);
            
            if (groupInfo) {
                manifestData.push(['INFORMASI GRUP']);
                manifestData.push(['Nama Grup:', groupInfo.name]);
                manifestData.push(['Paket:', groupInfo.package]);
                manifestData.push(['Tanggal Keberangkatan:', formatDate(groupInfo.departure_date)]);
                manifestData.push(['Bus:', groupInfo.bus_number]);
                manifestData.push(['Waktu Kumpul:', groupInfo.meeting_time]);
                manifestData.push(['Tempat Kumpul:', groupInfo.meeting_point]);
                manifestData.push(['Total Jamaah:', jamaahList.length]);
                manifestData.push(['']);
            }
            
            manifestData.push(['DAFTAR JAMAAH']);
            manifestData.push(['']);
            
            // Table headers - Format sesuai manifest standar
            manifestData.push([
                'NO',
                'NAME PASSPORT',
                'SEX',
                'PLACE OF BIRTH',
                'DATE OF BIRTH',
                'AGE',
                'NO PASSPORT',
                'DATE OF ISSUED',
                'DATE OF EXPIRED',
                'PLACE OF ISSUED',
                'FIRST NAME'
            ]);
            
            // Jamaah data rows - Format sesuai manifest standar
            jamaahList.forEach((jamaah, index) => {
                const age = jamaah.birth_date ? calculateAge(jamaah.birth_date) : 0;
                
                // Format tanggal untuk passport issued dan expired
                const passportIssued = jamaah.passport_issue_date ? formatDateForManifest(jamaah.passport_issue_date) : '';
                const passportExpired = jamaah.passport_expire_date ? formatDateForManifest(jamaah.passport_expire_date) : '';
                const birthDate = jamaah.birth_date ? formatDateForManifest(jamaah.birth_date) : '';
                
                manifestData.push([
                    index + 1,                                          // NO
                    jamaah.passport_name || jamaah.name || '',         // NAME PASSPORT
                    jamaah.gender === 'male' ? 'M' : 'F',              // SEX
                    jamaah.birth_place || '',                          // PLACE OF BIRTH
                    birthDate,                                         // DATE OF BIRTH
                    age,                                               // AGE
                    jamaah.passport_number || '',                      // NO PASSPORT
                    passportIssued,                                    // DATE OF ISSUED
                    passportExpired,                                   // DATE OF EXPIRED
                    jamaah.passport_city || '',                        // PLACE OF ISSUED
                    jamaah.name ? jamaah.name.split(' ')[0] : ''       // FIRST NAME
                ]);
            });
            
            // Summary section
            manifestData.push(['']);
            manifestData.push(['RINGKASAN']);
            manifestData.push(['Total Jamaah:', jamaahList.length]);
            manifestData.push(['Laki-laki:', jamaahList.filter(j => j.gender === 'male').length]);
            manifestData.push(['Perempuan:', jamaahList.filter(j => j.gender === 'female').length]);
            manifestData.push(['Sudah Lunas:', jamaahList.filter(j => j.payment_status === 'paid').length]);
            manifestData.push(['Belum Lunas:', jamaahList.filter(j => j.payment_status !== 'paid').length]);
            manifestData.push(['Dokumen Lengkap:', jamaahList.filter(j => j.document_status === 'approved').length]);
            manifestData.push(['Visa Approved:', jamaahList.filter(j => j.visa_status === 'approved').length]);
            
            // Room allocation summary
            manifestData.push(['']);
            manifestData.push(['ALOKASI KAMAR']);
            const roomPreferences = jamaahList.reduce((acc, j) => {
                const pref = j.room_preference || 'quad';
                acc[pref] = (acc[pref] || 0) + 1;
                return acc;
            }, {});
            
            Object.entries(roomPreferences).forEach(([type, count]) => {
                manifestData.push([`Kamar ${type.charAt(0).toUpperCase() + type.slice(1)}:`, count]);
            });
            
            // Export to Excel
            const filename = groupInfo ? 
                `manifest-${groupInfo.name.replace(/\s+/g, '-')}-${new Date().toISOString().slice(0,10)}.xlsx` :
                `manifest-all-jamaah-${new Date().toISOString().slice(0,10)}.xlsx`;
                
            const ws = XLSX.utils.aoa_to_sheet(manifestData);
            
            // Set column widths for better formatting - Format manifest standar
            const wscols = [
                {wch: 5},   // NO
                {wch: 30},  // NAME PASSPORT
                {wch: 5},   // SEX
                {wch: 20},  // PLACE OF BIRTH
                {wch: 15},  // DATE OF BIRTH
                {wch: 5},   // AGE
                {wch: 15},  // NO PASSPORT
                {wch: 15},  // DATE OF ISSUED
                {wch: 15},  // DATE OF EXPIRED
                {wch: 20},  // PLACE OF ISSUED
                {wch: 20}   // FIRST NAME
            ];
            ws['!cols'] = wscols;
            
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Manifest');
            XLSX.writeFile(wb, filename);
            
            showNotification(`Manifest berhasil diekspor! (${jamaahList.length} jamaah)`, 'success');
        }
        
        function calculateAge(birthDate) {
            if (!birthDate) return 0;
            
            // Handle ddmmyyyy format
            let dateObj;
            if (birthDate.length === 8 && !birthDate.includes('-')) {
                const day = birthDate.substring(0, 2);
                const month = birthDate.substring(2, 4);
                const year = birthDate.substring(4, 8);
                dateObj = new Date(`${year}-${month}-${day}`);
            } else {
                dateObj = new Date(birthDate);
            }
            
            const today = new Date();
            let age = today.getFullYear() - dateObj.getFullYear();
            const monthDiff = today.getMonth() - dateObj.getMonth();
            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < dateObj.getDate())) {
                age--;
            }
            return age;
        }
        
        function formatDateForManifest(dateString) {
            if (!dateString) return '';
            
            let dateObj;
            // Handle ddmmyyyy format
            if (dateString.length === 8 && !dateString.includes('-')) {
                const day = dateString.substring(0, 2);
                const month = dateString.substring(2, 4);
                const year = dateString.substring(4, 8);
                dateObj = new Date(`${year}-${month}-${day}`);
            } else {
                dateObj = new Date(dateString);
            }
            
            if (isNaN(dateObj.getTime())) return dateString;
            
            // Format as DD-MM-YYYY for manifest
            const day = String(dateObj.getDate()).padStart(2, '0');
            const month = String(dateObj.getMonth() + 1).padStart(2, '0');
            const year = dateObj.getFullYear();
            
            return `${day}-${month}-${year}`;
        }

        // Modal Functions
        function openModal(modalId) {
            console.log('Opening modal:', modalId);
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.add('active');
                modal.style.display = 'flex'; // Force display
                document.body.style.overflow = 'hidden'; // Prevent background scrolling
                
                // Focus trap - focus on the modal
                modal.focus();
                
                // Reset form if opening modal - but NOT if we're editing
                if (modalId === 'jamaahModal' || modalId === 'packageModal') {
                    const form = modal.querySelector('form');
                    if (form && !form.dataset.editId) {
                        // Only reset if NOT in edit mode for jamaah
                        if (modalId === 'jamaahModal') {
                            form.reset();
                            document.getElementById('passportPreview').style.display = 'none';
                            // Reset modal title
                            const modalTitle = modal.querySelector('h3');
                            if (modalTitle) {
                                modalTitle.textContent = 'Tambah/Edit Jamaah';
                            }
                        } else if (modalId === 'packageModal') {
                            // Load custom cities first
                            loadCustomCitiesIntoDropdowns();
                            // Load saved data for package modal
                            loadPackageFormData();
                            // Reset modal title
                            const modalTitle = modal.querySelector('h3');
                            if (modalTitle) {
                                modalTitle.textContent = 'Tambah/Edit Paket Umroh';
                            }
                        }
                    }
                }
            } else {
                console.error('Modal not found:', modalId);
            }
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.remove('active');
                modal.style.display = 'none'; // Force hide
                document.body.style.overflow = 'auto'; // Restore background scrolling
                
                // Clean up WhatsApp intervals if closing QR modal
                if (modalId === 'whatsappQRModal') {
                    if (qrCheckInterval) {
                        clearInterval(qrCheckInterval);
                        qrCheckInterval = null;
                    }
                    if (statusCheckInterval) {
                        clearInterval(statusCheckInterval);
                        statusCheckInterval = null;
                    }
                }
                
                // Clear any form data if it's a form modal
                const form = modal.querySelector('form');
                if (form) {
                    form.reset();
                    // Clear form dataset
                    delete form.dataset.editId;
                    
                    // Also clear any preview images
                    const passportPreview = modal.querySelector('#passportPreview');
                    if (passportPreview) {
                        passportPreview.style.display = 'none';
                    }
                    
                    const brochurePreview = modal.querySelector('#brochurePreview');
                    if (brochurePreview) {
                        brochurePreview.style.display = 'none';
                    }
                    
                    // Reset modal titles
                    if (modalId === 'jamaahModal') {
                        const modalTitle = modal.querySelector('h3');
                        if (modalTitle) {
                            modalTitle.textContent = 'Tambah/Edit Jamaah';
                        }
                    } else if (modalId === 'packageModal') {
                        const modalTitle = modal.querySelector('h3');
                        if (modalTitle) {
                            modalTitle.textContent = 'Tambah/Edit Paket Umroh';
                        }
                    }
                }
                console.log('Modal closed:', modalId);
            }
        }

        // Function to close any active modal
        function closeActiveModal() {
            const activeModal = document.querySelector('.modal.active');
            if (activeModal) {
                closeModal(activeModal.id);
            }
        }

        // Utility Functions
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('id-ID', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }
        
        function calculateDuration(startDate, endDate) {
            const start = new Date(startDate);
            const end = new Date(endDate);
            const diffTime = Math.abs(end - start);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1; // +1 to include both start and end days
            return diffDays;
        }
        
        function formatPrice(price) {
            // Convert to number and remove decimals
            const numPrice = parseInt(price);
            // Convert to string and add thousand separators
            return numPrice.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
        }

        // Date utility functions for ddmmyyyy format
        function formatBirthDate(ddmmyyyy) {
            if (!ddmmyyyy || ddmmyyyy.length !== 8) return ddmmyyyy;
            
            const day = ddmmyyyy.substring(0, 2);
            const month = ddmmyyyy.substring(2, 4);
            const year = ddmmyyyy.substring(4, 8);
            
            const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'Mei', 'Jun', 
                              'Jul', 'Ags', 'Sep', 'Okt', 'Nov', 'Des'];
            const monthIndex = parseInt(month) - 1;
            const monthName = monthNames[monthIndex] || month;
            
            return `${day} ${monthName} ${year}`;
        }

        function validateBirthDate(ddmmyyyy) {
            if (!ddmmyyyy || ddmmyyyy.length !== 8) return false;
            
            const day = parseInt(ddmmyyyy.substring(0, 2));
            const month = parseInt(ddmmyyyy.substring(2, 4));
            const year = parseInt(ddmmyyyy.substring(4, 8));
            
            // Basic validation
            if (day < 1 || day > 31) return false;
            if (month < 1 || month > 12) return false;
            if (year < 1900 || year > new Date().getFullYear()) return false;
            
            // Check if date is valid
            const testDate = new Date(year, month - 1, day);
            return testDate.getFullYear() === year && 
                   testDate.getMonth() === month - 1 && 
                   testDate.getDate() === day;
        }

        function convertToISODate(ddmmyyyy) {
            if (!ddmmyyyy || ddmmyyyy.length !== 8) return '';
            
            const day = ddmmyyyy.substring(0, 2);
            const month = ddmmyyyy.substring(2, 4);
            const year = ddmmyyyy.substring(4, 8);
            
            return `${year}-${month}-${day}`;
        }

        // Passport form functions
        function togglePassportName(checkbox) {
            const passportNameInput = document.getElementById('jamaahPassportName');
            const ktpNameInput = document.getElementById('jamaahName');
            
            if (checkbox.checked) {
                passportNameInput.value = ktpNameInput.value;
                passportNameInput.readOnly = true;
                passportNameInput.style.backgroundColor = 'rgba(71, 85, 105, 0.3)';
            } else {
                passportNameInput.readOnly = false;
                passportNameInput.style.backgroundColor = '';
            }
        }

        function validatePassportDate(ddmmyyyy) {
            if (!ddmmyyyy || ddmmyyyy.length !== 8) return false;
            
            const day = parseInt(ddmmyyyy.substring(0, 2));
            const month = parseInt(ddmmyyyy.substring(2, 4));
            const year = parseInt(ddmmyyyy.substring(4, 8));
            
            // Basic validation
            if (day < 1 || day > 31) return false;
            if (month < 1 || month > 12) return false;
            if (year < 1900 || year > 2100) return false; // Allow future dates for passport expiry
            
            // Check if date is valid
            const testDate = new Date(year, month - 1, day);
            return testDate.getFullYear() === year && 
                   testDate.getMonth() === month - 1 && 
                   testDate.getDate() === day;
        }

        function formatDateInput(inputElement) {
            inputElement.addEventListener('input', function(e) {
                let value = e.target.value.replace(/\D/g, ''); // Remove non-digits
                
                if (value.length > 8) {
                    value = value.slice(0, 8);
                }
                
                e.target.value = value;
                
                // Real-time validation feedback
                if (value.length === 8) {
                    if (validatePassportDate(value)) {
                        e.target.style.borderColor = '#10b981';
                        e.target.style.backgroundColor = 'rgba(16, 185, 129, 0.1)';
                    } else {
                        e.target.style.borderColor = '#ef4444';
                        e.target.style.backgroundColor = 'rgba(239, 68, 68, 0.1)';
                    }
                } else {
                    e.target.style.borderColor = '';
                    e.target.style.backgroundColor = '';
                }
            });
            
            inputElement.addEventListener('blur', function(e) {
                const value = e.target.value;
                if (value.length === 8 && validatePassportDate(value)) {
                    const formatted = formatBirthDate(value);
                    e.target.title = `Tanggal: ${formatted}`;
                }
            });
        }

        // Family management functions
        function toggleFamilyFields(selectElement) {
            const mainFamilySection = document.getElementById('mainFamilySection');
            const value = selectElement.value;
            
            if (value === 'istri' || value === 'anak') {
                mainFamilySection.style.display = 'block';
                populateMainFamilyOptions();
            } else {
                mainFamilySection.style.display = 'none';
            }
        }

        function populateMainFamilyOptions() {
            const mainFamilySelect = document.getElementById('jamaahMainFamily');
            
            // Clear existing options except the first one
            mainFamilySelect.innerHTML = '<option value="">Pilih Kepala Keluarga</option>';
            
            // Find all kepala keluarga from jamaahData
            const kepalaKeluarga = jamaahData.filter(j => j.family_role === 'kepala_keluarga');
            
            kepalaKeluarga.forEach(kk => {
                const option = document.createElement('option');
                option.value = kk.main_family_id;
                option.textContent = `${kk.name} (Family ID: ${kk.main_family_id})`;
                mainFamilySelect.appendChild(option);
            });
            
            // Add option to create new family
            const newFamilyOption = document.createElement('option');
            newFamilyOption.value = 'new_family';
            newFamilyOption.textContent = '+ Buat Family Baru';
            mainFamilySelect.appendChild(newFamilyOption);
        }

        function generateNewFamilyId() {
            const existingFamilyIds = jamaahData
                .map(j => j.main_family_id)
                .filter(id => id !== undefined && id !== null);
            
            if (existingFamilyIds.length === 0) return 1;
            
            return Math.max(...existingFamilyIds) + 1;
        }

        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // Passport Functions
        function previewPassportImage(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('passportPreview').style.display = 'block';
                    document.getElementById('passportImg').src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        }
        
        function previewBrochure(event) {
            const file = event.target.files[0];
            if (file && file.type.startsWith('image/')) {
                const maxSize = 5 * 1024 * 1024; // 5MB
                if (file.size > maxSize) {
                    showNotification('File brosur terlalu besar. Maksimal 5MB.', 'error');
                    event.target.value = '';
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.getElementById('brochurePreview');
                    const img = document.getElementById('brochureImg');
                    img.src = e.target.result;
                    preview.style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        }
        
        // Global array to store multiple images data
        let packageImagesData = [];
        
        function previewMultipleImages(event) {
            const files = event.target.files;
            const previewContainer = document.getElementById('multipleImagesPreview');
            previewContainer.innerHTML = '';
            packageImagesData = [];
            
            if (files.length > 10) {
                showNotification('Maksimal 10 gambar yang dapat diupload', 'error');
                event.target.value = '';
                return;
            }
            
            const maxSize = 5 * 1024 * 1024; // 5MB per file
            let totalSize = 0;
            
            Array.from(files).forEach((file, index) => {
                if (file.type.startsWith('image/')) {
                    if (file.size > maxSize) {
                        showNotification(`File ${file.name} terlalu besar. Maksimal 5MB per gambar.`, 'error');
                        return;
                    }
                    
                    totalSize += file.size;
                    if (totalSize > 40 * 1024 * 1024) { // 40MB total
                        showNotification('Total ukuran gambar terlalu besar. Maksimal 40MB untuk semua gambar.', 'error');
                        return;
                    }
                    
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const imageData = {
                            url: e.target.result,
                            caption: file.name,
                            order: index + 1
                        };
                        packageImagesData.push(imageData);
                        
                        const imageContainer = document.createElement('div');
                        imageContainer.style.cssText = 'position: relative; border-radius: 8px; overflow: hidden; background: rgba(30, 41, 59, 0.6); border: 1px solid rgba(71, 85, 105, 0.4);';
                        imageContainer.innerHTML = `
                            <img src="${e.target.result}" style="width: 100%; height: 120px; object-fit: cover;">
                            <div style="position: absolute; top: 5px; right: 5px;">
                                <button type="button" onclick="removePackageImage(${index})" class="btn btn-danger btn-sm" style="padding: 5px 10px;">
                                    <span class="material-icons" style="font-size: 16px;">close</span>
                                </button>
                            </div>
                            <input type="text" placeholder="Caption..." onchange="updateImageCaption(${index}, this.value)" 
                                style="width: 100%; padding: 5px; background: rgba(15, 23, 42, 0.8); border: none; color: #f8fafc; font-size: 12px;">
                        `;
                        previewContainer.appendChild(imageContainer);
                    };
                    reader.readAsDataURL(file);
                }
            });
        }
        
        function removePackageImage(index) {
            packageImagesData.splice(index, 1);
            // Re-render preview
            const previewContainer = document.getElementById('multipleImagesPreview');
            const imageContainers = previewContainer.children;
            if (imageContainers[index]) {
                imageContainers[index].remove();
            }
            // Update order
            packageImagesData.forEach((img, i) => {
                img.order = i + 1;
            });
        }
        
        function updateImageCaption(index, caption) {
            if (packageImagesData[index]) {
                packageImagesData[index].caption = caption;
            }
        }
        
        function showImageModal(imageUrl, caption) {
            const modal = document.getElementById('imagePreviewModal');
            const img = document.getElementById('imagePreviewImg');
            const title = document.getElementById('imagePreviewTitle');
            
            img.src = imageUrl;
            img.alt = caption || 'Package Image';
            title.textContent = caption || 'Preview Gambar';
            
            openModal('imagePreviewModal');
        }
        
        // WhatsApp Integration Functions
        let waConnected = false;
        let waPhoneNumber = '';
        let qrCheckInterval = null;
        let statusCheckInterval = null;
        
        // Check WhatsApp status on page load
        async function checkWhatsAppStatus() {
            try {
                const response = await fetch(getApiBaseUrl() + '/api/whatsapp/status');
                const data = await response.json();
                
                if (data.connected) {
                    waConnected = true;
                    waPhoneNumber = formatPhoneNumber(data.phoneNumber);
                    updateWhatsAppStatus();
                }
            } catch (error) {
                console.error('Error checking WhatsApp status:', error);
            }
        }
        
        async function connectWhatsApp() {
            openModal('whatsappQRModal');
            
            try {
                // Start WhatsApp session
                const startResponse = await fetch(getApiBaseUrl() + '/api/whatsapp/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const startData = await startResponse.json();
                
                if (!startResponse.ok) {
                    if (startResponse.status === 503) {
                        showNotification(startData.error, 'error');
                        showNotification('Install WAHA: docker run -it --rm -p 3000:3000/tcp --name waha devlikeapro/waha', 'info');
                    } else {
                        showNotification('Gagal memulai WhatsApp: ' + (startData.error || 'Unknown error'), 'error');
                    }
                    closeModal('whatsappQRModal');
                    return;
                }
                
                if (startData.connected) {
                    showNotification('WhatsApp sudah terhubung!', 'info');
                    closeModal('whatsappQRModal');
                    checkWhatsAppStatus();
                    return;
                }
                
                if (startData.needsQR) {
                    showNotification('Session siap, silakan scan QR code', 'info');
                }
                
                // Start checking for QR code
                setTimeout(getQRCode, 2000);
                
                // Start checking connection status
                statusCheckInterval = setInterval(async () => {
                    const statusResponse = await fetch(getApiBaseUrl() + '/api/whatsapp/status');
                    const statusData = await statusResponse.json();
                    
                    if (statusData.connected) {
                        clearInterval(statusCheckInterval);
                        clearInterval(qrCheckInterval);
                        waConnected = true;
                        waPhoneNumber = formatPhoneNumber(statusData.phoneNumber);
                        updateWhatsAppStatus();
                        closeModal('whatsappQRModal');
                        showNotification('WhatsApp berhasil terhubung!', 'success');
                    }
                }, 3000);
                
            } catch (error) {
                console.error('Error connecting WhatsApp:', error);
                showNotification('Gagal memulai koneksi WhatsApp', 'error');
                closeModal('whatsappQRModal');
            }
        }
        
        async function getQRCode() {
            try {
                const response = await fetch(getApiBaseUrl() + '/api/whatsapp/qr');
                const data = await response.json();
                
                if (data.qr) {
                    displayQRCode(data.qr);
                    
                    // Refresh QR code every 30 seconds
                    qrCheckInterval = setInterval(async () => {
                        try {
                            const newResponse = await fetch(getApiBaseUrl() + '/api/whatsapp/qr');
                            const newData = await newResponse.json();
                            if (newData.qr) {
                                displayQRCode(newData.qr);
                            }
                        } catch (error) {
                            console.error('Error refreshing QR:', error);
                        }
                    }, 30000);
                } else {
                    // Retry after 2 seconds if QR not ready
                    setTimeout(getQRCode, 2000);
                }
            } catch (error) {
                console.error('Error getting QR code:', error);
                showNotification('Gagal mendapatkan QR code', 'error');
            }
        }
        
        function displayQRCode(qrData) {
            document.getElementById('qrCodeLoader').style.display = 'none';
            const canvas = document.getElementById('qrCodeCanvas');
            canvas.style.display = 'block';
            
            // Create QR code image
            const img = new Image();
            img.onload = function() {
                const ctx = canvas.getContext('2d');
                canvas.width = 300;
                canvas.height = 300;
                ctx.fillStyle = 'white';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                // Draw QR code centered
                const size = Math.min(canvas.width, canvas.height) - 20;
                const x = (canvas.width - size) / 2;
                const y = (canvas.height - size) / 2;
                ctx.drawImage(img, x, y, size, size);
            };
            img.src = qrData;
        }
        
        function formatPhoneNumber(phone) {
            if (!phone) return '';
            // Remove country code and format
            const cleaned = phone.replace(/^62/, '').replace('@c.us', '');
            return '+62 ' + cleaned.replace(/(\d{3})(\d{4})(\d{4})/, '$1-$2-$3');
        }
        
        async function disconnectWhatsApp() {
            if (confirm('Yakin ingin memutuskan koneksi WhatsApp?')) {
                try {
                    const response = await fetch(getApiBaseUrl() + '/api/whatsapp/stop', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    
                    if (response.ok) {
                        waConnected = false;
                        waPhoneNumber = '';
                        updateWhatsAppStatus();
                        showNotification('WhatsApp telah diputuskan', 'info');
                    } else {
                        showNotification('Gagal memutuskan koneksi WhatsApp', 'error');
                    }
                } catch (error) {
                    console.error('Error disconnecting WhatsApp:', error);
                    showNotification('Gagal memutuskan koneksi WhatsApp', 'error');
                }
            }
        }
        
        async function restartWhatsAppSession() {
            if (confirm('Restart WhatsApp session? Session lama akan dihapus.')) {
                try {
                    showNotification('Merestart session WhatsApp...', 'info');
                    
                    // Call restart endpoint
                    const response = await fetch(getApiBaseUrl() + '/api/whatsapp/restart', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    
                    if (response.ok) {
                        waConnected = false;
                        waPhoneNumber = '';
                        updateWhatsAppStatus();
                        showNotification('Session berhasil direstart. Silakan sambung ulang.', 'success');
                    } else {
                        showNotification('Gagal merestart session', 'error');
                    }
                } catch (error) {
                    console.error('Error restarting session:', error);
                    showNotification('Gagal merestart session', 'error');
                }
            }
        }
        
        // Leads Bot functionality
        let leadsBotEnabled = false;
        
        async function toggleLeadsBot(checkbox) {
            leadsBotEnabled = checkbox.checked;
            
            try {
                // Update backend autoreply status
                const response = await fetch(getApiBaseUrl() + '/api/whatsapp/autoreply', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ enabled: leadsBotEnabled })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    showNotification(
                        leadsBotEnabled ? 
                        'Leads Bot diaktifkan! Bot akan membalas pesan dengan kode paket.' : 
                        'Leads Bot dimatikan.',
                        'success'
                    );
                    
                    // Save state to localStorage
                    localStorage.setItem('leadsBotEnabled', leadsBotEnabled);
                } else {
                    // Revert checkbox if failed
                    checkbox.checked = !leadsBotEnabled;
                    leadsBotEnabled = !leadsBotEnabled;
                    showNotification('Gagal mengubah status Leads Bot', 'error');
                }
            } catch (error) {
                console.error('Error toggling leads bot:', error);
                // Revert checkbox if failed
                checkbox.checked = !leadsBotEnabled;
                leadsBotEnabled = !leadsBotEnabled;
                showNotification('Error: ' + error.message, 'error');
            }
        }
        
        // Load leads bot state on page load
        function loadLeadsBotState() {
            const savedState = localStorage.getItem('leadsBotEnabled');
            if (savedState !== null) {
                leadsBotEnabled = savedState === 'true';
                const toggle = document.getElementById('leadsBotToggle');
                if (toggle) {
                    toggle.checked = leadsBotEnabled;
                }
            }
        }
        
        // WhatsApp Chat Manager Functions
        let selectedChat = null;
        let chatMessages = {};
        
        async function openWhatsAppChat() {
            // Open WhatsApp Chat Manager in new tab
            window.open('whatsapp-chat.html', '_blank');
        }
        
        async function loadChatList() {
            try {
                const response = await fetch(getApiBaseUrl() + '/api/whatsapp/chats');
                if (response.ok) {
                    const chats = await response.json();
                    displayChatList(chats);
                } else {
                    // For now, show demo data
                    const demoChats = [
                        {
                            id: '6281234567890@c.us',
                            name: 'Ahmad Fauzi',
                            lastMessage: 'Assalamualaikum, ada paket umroh bulan depan?',
                            timestamp: new Date().toISOString(),
                            unread: 2
                        },
                        {
                            id: '6289876543210@c.us', 
                            name: 'Ibu Siti',
                            lastMessage: 'Terima kasih infonya',
                            timestamp: new Date(Date.now() - 3600000).toISOString(),
                            unread: 0
                        },
                        {
                            id: '6285555555555@c.us',
                            name: '+62 855-5555-5555',
                            lastMessage: '#2025_12H_TUR_TK_SEP16',
                            timestamp: new Date(Date.now() - 7200000).toISOString(),
                            unread: 1
                        }
                    ];
                    displayChatList(demoChats);
                }
            } catch (error) {
                console.error('Error loading chats:', error);
                // Show demo data on error
                const demoChats = [
                    {
                        id: '6281234567890@c.us',
                        name: 'Ahmad Fauzi',
                        lastMessage: 'Assalamualaikum, ada paket umroh bulan depan?',
                        timestamp: new Date().toISOString(),
                        unread: 2
                    }
                ];
                displayChatList(demoChats);
            }
        }
        
        function displayChatList(chats) {
            const chatList = document.getElementById('chatList');
            chatList.innerHTML = '';
            
            chats.forEach(chat => {
                const chatItem = document.createElement('div');
                chatItem.className = 'chat-item';
                chatItem.style.cssText = `
                    padding: 15px;
                    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
                    cursor: pointer;
                    transition: background 0.2s;
                `;
                
                chatItem.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <div style="width: 45px; height: 45px; background: #25D366; border-radius: 50%; 
                                    display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                            <span class="material-icons" style="color: white;">person</span>
                        </div>
                        <div style="flex: 1; min-width: 0;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                                <h4 style="margin: 0; font-size: 15px; font-weight: 500;">${chat.name}</h4>
                                <span style="font-size: 12px; color: rgba(255, 255, 255, 0.5);">
                                    ${formatMessageTime(chat.timestamp)}
                                </span>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <p style="margin: 0; font-size: 13px; color: rgba(255, 255, 255, 0.6); 
                                         overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                    ${chat.lastMessage}
                                </p>
                                ${chat.unread > 0 ? `
                                    <span style="background: #25D366; color: white; font-size: 11px; 
                                                padding: 2px 6px; border-radius: 10px; margin-left: 10px;">
                                        ${chat.unread}
                                    </span>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
                
                chatItem.onmouseover = () => {
                    chatItem.style.background = 'rgba(255, 255, 255, 0.05)';
                };
                
                chatItem.onmouseout = () => {
                    chatItem.style.background = selectedChat === chat.id ? 'rgba(37, 211, 102, 0.1)' : '';
                };
                
                chatItem.onclick = () => selectChat(chat);
                
                chatList.appendChild(chatItem);
            });
        }
        
        function selectChat(chat) {
            selectedChat = chat.id;
            
            // Update UI
            document.getElementById('chatEmptyState').style.display = 'none';
            document.getElementById('chatHeader').style.display = 'block';
            document.getElementById('messageInput').style.display = 'block';
            
            // Update header
            document.getElementById('chatContactName').textContent = chat.name;
            document.getElementById('chatContactNumber').textContent = chat.id.replace('@c.us', '');
            
            // Load messages
            loadChatMessages(chat.id);
            
            // Update selected state in list
            document.querySelectorAll('.chat-item').forEach((item, index) => {
                item.style.background = index === Array.from(item.parentNode.children).indexOf(item) && 
                                       item.querySelector('h4').textContent === chat.name ? 
                                       'rgba(37, 211, 102, 0.1)' : '';
            });
        }
        
        async function loadChatMessages(chatId) {
            try {
                const response = await fetch(getApiBaseUrl() + `/api/whatsapp/messages/${chatId}`);
                if (response.ok) {
                    const messages = await response.json();
                    displayMessages(messages);
                } else {
                    // Show demo messages
                    const demoMessages = [
                        {
                            id: '1',
                            from: chatId,
                            fromMe: false,
                            body: 'Assalamualaikum, ada paket umroh bulan depan?',
                            timestamp: new Date(Date.now() - 3600000).toISOString()
                        },
                        {
                            id: '2',
                            from: '6282255555000@c.us',
                            fromMe: true,
                            body: 'Waalaikumsalam. Ada pak, kami punya beberapa paket untuk bulan depan. Bapak berminat untuk keberangkatan tanggal berapa?',
                            timestamp: new Date(Date.now() - 3000000).toISOString()
                        },
                        {
                            id: '3',
                            from: chatId,
                            fromMe: false,
                            body: 'Sekitar pertengahan bulan. Ada yang 12 hari?',
                            timestamp: new Date(Date.now() - 2400000).toISOString()
                        }
                    ];
                    displayMessages(demoMessages);
                }
            } catch (error) {
                console.error('Error loading messages:', error);
            }
        }
        
        function displayMessages(messages) {
            const messagesList = document.getElementById('messagesList');
            messagesList.innerHTML = '';
            
            messages.forEach(message => {
                const messageDiv = document.createElement('div');
                messageDiv.style.cssText = `
                    display: flex;
                    ${message.fromMe ? 'justify-content: flex-end' : 'justify-content: flex-start'}
                `;
                
                const bubble = document.createElement('div');
                bubble.style.cssText = `
                    max-width: 70%;
                    padding: 10px 15px;
                    border-radius: 12px;
                    ${message.fromMe ? 
                        'background: #25D366; color: white; border-bottom-right-radius: 4px;' : 
                        'background: rgba(255, 255, 255, 0.1); color: white; border-bottom-left-radius: 4px;'}
                `;
                
                bubble.innerHTML = `
                    <p style="margin: 0 0 5px 0; font-size: 14px; line-height: 1.4;">${message.body}</p>
                    <span style="font-size: 11px; opacity: 0.7;">
                        ${formatMessageTime(message.timestamp)}
                    </span>
                `;
                
                messageDiv.appendChild(bubble);
                messagesList.appendChild(messageDiv);
            });
            
            // Scroll to bottom
            const messagesArea = document.getElementById('messagesArea');
            messagesArea.scrollTop = messagesArea.scrollHeight;
        }
        
        async function sendWhatsAppMessage(event) {
            event.preventDefault();
            
            const messageText = document.getElementById('messageText').value.trim();
            if (!messageText || !selectedChat) return;
            
            try {
                const response = await fetch(getApiBaseUrl() + '/api/whatsapp/send', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        to: selectedChat.replace('@c.us', ''),
                        message: messageText
                    })
                });
                
                if (response.ok) {
                    // Add message to UI immediately
                    const newMessage = {
                        id: Date.now().toString(),
                        from: '6282255555000@c.us',
                        fromMe: true,
                        body: messageText,
                        timestamp: new Date().toISOString()
                    };
                    
                    const messagesList = document.getElementById('messagesList');
                    const messageDiv = document.createElement('div');
                    messageDiv.style.cssText = 'display: flex; justify-content: flex-end';
                    
                    const bubble = document.createElement('div');
                    bubble.style.cssText = `
                        max-width: 70%;
                        padding: 10px 15px;
                        border-radius: 12px;
                        background: #25D366;
                        color: white;
                        border-bottom-right-radius: 4px;
                    `;
                    
                    bubble.innerHTML = `
                        <p style="margin: 0 0 5px 0; font-size: 14px; line-height: 1.4;">${messageText}</p>
                        <span style="font-size: 11px; opacity: 0.7;">
                            ${formatMessageTime(newMessage.timestamp)}
                        </span>
                    `;
                    
                    messageDiv.appendChild(bubble);
                    messagesList.appendChild(messageDiv);
                    
                    // Clear input and scroll to bottom
                    document.getElementById('messageText').value = '';
                    const messagesArea = document.getElementById('messagesArea');
                    messagesArea.scrollTop = messagesArea.scrollHeight;
                } else {
                    showNotification('Gagal mengirim pesan', 'error');
                }
            } catch (error) {
                console.error('Error sending message:', error);
                showNotification('Error: ' + error.message, 'error');
            }
        }
        
        function filterChats() {
            const searchValue = document.getElementById('chatSearch').value.toLowerCase();
            const chatItems = document.querySelectorAll('.chat-item');
            
            chatItems.forEach(item => {
                const name = item.querySelector('h4').textContent.toLowerCase();
                const message = item.querySelector('p').textContent.toLowerCase();
                
                if (name.includes(searchValue) || message.includes(searchValue)) {
                    item.style.display = 'block';
                } else {
                    item.style.display = 'none';
                }
            });
        }
        
        function formatMessageTime(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diff = now - date;
            
            if (diff < 60000) return 'Baru saja';
            if (diff < 3600000) return `${Math.floor(diff / 60000)} menit lalu`;
            if (diff < 86400000) return `${Math.floor(diff / 3600000)} jam lalu`;
            
            return date.toLocaleDateString('id-ID', { 
                day: 'numeric', 
                month: 'short',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
        
        // WhatsApp monitoring functions
        let waMonitoringInterval = null;
        
        async function refreshWhatsAppStatus() {
            try {
                const response = await fetch(getApiBaseUrl() + '/api/whatsapp/status');
                const data = await response.json();
                
                // Update monitoring dashboard
                const statusIndicator = document.getElementById('waStatusIndicator');
                const statusText = document.getElementById('waStatusText');
                const sessionStatus = document.getElementById('waSessionStatus');
                const phoneInfo = document.getElementById('waPhoneInfo');
                const nameInfo = document.getElementById('waNameInfo');
                const engineInfo = document.getElementById('waEngineInfo');
                const lastCheck = document.getElementById('waLastCheck');
                
                if (data.connected) {
                    statusIndicator.style.background = '#10B981';
                    statusText.textContent = 'Connected';
                    sessionStatus.textContent = 'WORKING';
                    phoneInfo.textContent = formatPhoneNumber(data.phoneNumber);
                    nameInfo.textContent = data.name || '-';
                    engineInfo.textContent = 'WEBJS';
                } else {
                    statusIndicator.style.background = '#EF4444';
                    statusText.textContent = 'Disconnected';
                    sessionStatus.textContent = data.status || 'FAILED';
                    phoneInfo.textContent = '-';
                    nameInfo.textContent = '-';
                    engineInfo.textContent = '-';
                }
                
                lastCheck.textContent = new Date().toLocaleTimeString('id-ID');
                
                // Update main status
                waConnected = data.connected;
                if (data.connected) {
                    waPhoneNumber = formatPhoneNumber(data.phoneNumber);
                }
                updateWhatsAppStatus();
                
            } catch (error) {
                console.error('Error refreshing WhatsApp status:', error);
            }
        }
        
        // Auto refresh monitoring
        function startWhatsAppMonitoring() {
            const autoRefresh = document.getElementById('waAutoRefresh');
            if (autoRefresh && autoRefresh.checked) {
                refreshWhatsAppStatus();
                waMonitoringInterval = setInterval(refreshWhatsAppStatus, 10000); // Every 10 seconds
            }
        }
        
        function stopWhatsAppMonitoring() {
            if (waMonitoringInterval) {
                clearInterval(waMonitoringInterval);
                waMonitoringInterval = null;
            }
        }
        
        // Auto refresh toggle handler
        document.addEventListener('DOMContentLoaded', function() {
            const autoRefreshToggle = document.getElementById('waAutoRefresh');
            if (autoRefreshToggle) {
                autoRefreshToggle.addEventListener('change', function() {
                    if (this.checked) {
                        startWhatsAppMonitoring();
                    } else {
                        stopWhatsAppMonitoring();
                    }
                });
            }
        });
        
        function updateWhatsAppStatus() {
            const statusDiv = document.getElementById('waConnectionStatus');
            const disconnectBtn = document.getElementById('waDisconnectBtn');
            const connectBtn = document.querySelector('button[onclick="connectWhatsApp()"]');
            
            if (waConnected) {
                statusDiv.style.display = 'block';
                document.getElementById('waConnectedNumber').textContent = waPhoneNumber;
                disconnectBtn.style.display = 'inline-flex';
                connectBtn.style.display = 'none';
            } else {
                statusDiv.style.display = 'none';
                disconnectBtn.style.display = 'none';
                connectBtn.style.display = 'inline-flex';
                
                // Reset QR modal
                document.getElementById('qrCodeLoader').style.display = 'block';
                document.getElementById('qrCodeCanvas').style.display = 'none';
                document.getElementById('waConnectionProgress').style.display = 'none';
                document.querySelector('#waConnectionProgress .progress-bar div').style.width = '0%';
            }
        }
        
        async function viewPackageDetails(id) {
            try {
                console.log('Viewing package details ID:', id);
                const response = await fetch(getApiBaseUrl() + `/api/packages/${id}`);
                const result = await response.json();
                
                if (!response.ok) {
                    throw new Error(result.error || 'Failed to fetch package details');
                }
                
                // Extract package data
                const package = result.data || result;
                console.log('Package details:', package);
                
                // Update modal title
                document.getElementById('packageDetailTitle').textContent = package.name || package.nama_paket || 'Package Details';
                
                // Build detail content
                const content = document.getElementById('packageDetailContent');
                content.innerHTML = `
                    <div style="display: grid; gap: 25px;">
                        
                        <!-- Gallery Images -->
                        ${(() => {
                            // Handle both array and JSON string formats
                            let images = package.package_images || package.gambar_tambahan || [];
                            if (typeof images === 'string') {
                                try {
                                    images = JSON.parse(images);
                                } catch (e) {
                                    images = [];
                                }
                            }
                            
                            // Include brochure image if exists
                            const allImages = [];
                            if (package.brochure_image || package.gambar_utama) {
                                allImages.push({
                                    url: package.brochure_image || package.gambar_utama,
                                    caption: 'Gambar Utama'
                                });
                            }
                            
                            // Add additional images
                            if (Array.isArray(images) && images.length > 0) {
                                images.forEach((img, index) => {
                                    if (typeof img === 'string') {
                                        allImages.push({
                                            url: img,
                                            caption: `Gambar ${index + 2}`
                                        });
                                    } else if (img && img.url) {
                                        allImages.push(img);
                                    }
                                });
                            }
                            
                            if (allImages.length > 0) {
                                return `
                                <div style="background: rgba(255, 255, 255, 0.05); padding: 20px; border-radius: 12px; border: 1px solid rgba(255, 255, 255, 0.1);">
                                    <h4 style="color: white; margin: 0 0 15px 0; font-size: 16px;">Galeri Gambar (${allImages.length})</h4>
                                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px;">
                                        ${allImages.map((img, index) => {
                                            const imageUrl = img.url || img;
                                            const safeCaption = (img.caption || `Gambar ${index + 1}`).replace(/'/g, "\\'");
                                            const safeUrl = imageUrl.replace(/'/g, "\\'");
                                            return `
                                            <div style="position: relative; border-radius: 8px; overflow: hidden; background: rgba(30, 41, 59, 0.6); border: 1px solid rgba(71, 85, 105, 0.4); cursor: pointer;"
                                                 onclick="showImageModal('${safeUrl}', '${safeCaption}')">
                                                <img src="${imageUrl}" alt="${img.caption || 'Gambar ' + (index + 1)}" 
                                                     style="width: 100%; height: 150px; object-fit: cover;">
                                                <div style="position: absolute; bottom: 0; left: 0; right: 0; background: linear-gradient(to top, rgba(0,0,0,0.8), transparent); padding: 10px;">
                                                    <p style="margin: 0; color: white; font-size: 12px; text-align: center;">${img.caption || `Gambar ${index + 1}`}</p>
                                                </div>
                                            </div>
                                        `;}).join('')}
                                    </div>
                                </div>
                                `;
                            }
                            return '';
                        })()}
                        
                        <!-- Basic Info -->
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                            <div style="background: rgba(255, 255, 255, 0.05); padding: 20px; border-radius: 12px; border: 1px solid rgba(255, 255, 255, 0.1);">
                                <h4 style="color: #3b82f6; margin: 0 0 15px 0; font-size: 16px;">Informasi Umum</h4>
                                <div style="display: grid; gap: 10px;">
                                    <div>
                                        <p style="margin: 0; color: rgba(255, 255, 255, 0.6); font-size: 12px;">Kode Paket</p>
                                        <p style="margin: 0; color: white; font-weight: 600;">${package.code || package.kode_paket || ''}</p>
                                    </div>
                                    <div>
                                        <p style="margin: 0; color: rgba(255, 255, 255, 0.6); font-size: 12px;">Harga</p>
                                        <p style="margin: 0; color: #4facfe; font-weight: 700; font-size: 20px;">Rp ${formatPrice(package.price || 0)}</p>
                                    </div>
                                    <div>
                                        <p style="margin: 0; color: rgba(255, 255, 255, 0.6); font-size: 12px;">Status</p>
                                        <p style="margin: 0; color: ${package.status === 'active' ? '#22c55e' : '#ef4444'}; font-weight: 600;">
                                            ${package.status === 'active' ? 'Aktif' : 'Tidak Aktif'}
                                        </p>
                                    </div>
                                </div>
                            </div>
                            
                            <div style="background: rgba(255, 255, 255, 0.05); padding: 20px; border-radius: 12px; border: 1px solid rgba(255, 255, 255, 0.1);">
                                <h4 style="color: #10b981; margin: 0 0 15px 0; font-size: 16px;">Jadwal & Durasi</h4>
                                <div style="display: grid; gap: 10px;">
                                    <div>
                                        <p style="margin: 0; color: rgba(255, 255, 255, 0.6); font-size: 12px;">Keberangkatan</p>
                                        <p style="margin: 0; color: white; font-weight: 600;">${formatDate(package.departure_date)}</p>
                                    </div>
                                    <div>
                                        <p style="margin: 0; color: rgba(255, 255, 255, 0.6); font-size: 12px;">Kepulangan</p>
                                        <p style="margin: 0; color: white; font-weight: 600;">${formatDate(package.return_date)}</p>
                                    </div>
                                    <div>
                                        <p style="margin: 0; color: rgba(255, 255, 255, 0.6); font-size: 12px;">Durasi</p>
                                        <p style="margin: 0; color: white; font-weight: 600;">${calculateDuration(package.departure_date, package.return_date)} hari</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div style="background: rgba(255, 255, 255, 0.05); padding: 20px; border-radius: 12px; border: 1px solid rgba(255, 255, 255, 0.1);">
                                <h4 style="color: #8b5cf6; margin: 0 0 15px 0; font-size: 16px;">Kuota & Booking</h4>
                                <div style="display: grid; gap: 10px;">
                                    <div>
                                        <p style="margin: 0; color: rgba(255, 255, 255, 0.6); font-size: 12px;">Total Kuota</p>
                                        <p style="margin: 0; color: white; font-weight: 600;">${package.quota} seats</p>
                                    </div>
                                    <div>
                                        <p style="margin: 0; color: rgba(255, 255, 255, 0.6); font-size: 12px;">Sudah Booking</p>
                                        <p style="margin: 0; color: #f59e0b; font-weight: 600;">${package.booked || 0} jamaah</p>
                                    </div>
                                    <div>
                                        <p style="margin: 0; color: rgba(255, 255, 255, 0.6); font-size: 12px;">Sisa Kuota</p>
                                        <p style="margin: 0; color: #22c55e; font-weight: 600;">${package.available || (package.quota - (package.booked || 0))} seats</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Hotel & Transportation -->
                        <div style="background: rgba(255, 255, 255, 0.05); padding: 25px; border-radius: 12px; border: 1px solid rgba(255, 255, 255, 0.1);">
                            <h4 style="color: #ec4899; margin: 0 0 20px 0; font-size: 16px;">Hotel & Transportasi</h4>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                                <div>
                                    <p style="margin: 0 0 5px 0; color: rgba(255, 255, 255, 0.8);">
                                        <strong>🏨 Hotel Makkah:</strong> ${package.makkah_hotel} (${package.makkah_nights} malam)
                                    </p>
                                </div>
                                <div>
                                    <p style="margin: 0 0 5px 0; color: rgba(255, 255, 255, 0.8);">
                                        <strong>🏨 Hotel Madinah:</strong> ${package.madinah_hotel} (${package.madinah_nights} malam)
                                    </p>
                                </div>
                                <div>
                                    <p style="margin: 0; color: rgba(255, 255, 255, 0.8);">
                                        <strong>✈️ Maskapai:</strong> ${package.airline}
                                    </p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Flight Details -->
                        <div style="background: rgba(255, 255, 255, 0.05); padding: 25px; border-radius: 12px; border: 1px solid rgba(255, 255, 255, 0.1);">
                            <h4 style="color: #3b82f6; margin: 0 0 20px 0; font-size: 16px;">Detail Penerbangan</h4>
                            
                            <!-- Departure Flight -->
                            <div style="margin-bottom: 20px; padding: 15px; background: rgba(59, 130, 246, 0.1); border-radius: 8px; border-left: 3px solid #3b82f6;">
                                <h5 style="color: white; margin: 0 0 12px 0; font-size: 14px;">✈️ Penerbangan Berangkat</h5>
                                <div style="display: grid; gap: 8px;">
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        <span style="color: rgba(255, 255, 255, 0.6); font-size: 13px; min-width: 120px;">Starting From:</span>
                                        <span style="color: white; font-weight: 600;">${package.departure_city || 'Jakarta'}</span>
                                    </div>
                                    ${package.transit_city_departure ? `
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        <span style="color: rgba(255, 255, 255, 0.6); font-size: 13px; min-width: 120px;">Transit:</span>
                                        <span style="color: white; font-weight: 600;">${package.transit_city_departure}</span>
                                    </div>
                                    ` : ''}
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        <span style="color: rgba(255, 255, 255, 0.6); font-size: 13px; min-width: 120px;">Landing:</span>
                                        <span style="color: white; font-weight: 600;">${package.arrival_city || 'Madinah'}</span>
                                    </div>
                                    ${package.departure_flight_number ? `
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        <span style="color: rgba(255, 255, 255, 0.6); font-size: 13px; min-width: 120px;">No. Penerbangan:</span>
                                        <span style="color: white; font-weight: 600;">${package.departure_flight_number}</span>
                                    </div>
                                    ` : ''}
                                </div>
                            </div>
                            
                            <!-- Return Flight -->
                            <div style="padding: 15px; background: rgba(16, 185, 129, 0.1); border-radius: 8px; border-left: 3px solid #10b981;">
                                <h5 style="color: white; margin: 0 0 12px 0; font-size: 14px;">✈️ Penerbangan Pulang</h5>
                                <div style="display: grid; gap: 8px;">
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        <span style="color: rgba(255, 255, 255, 0.6); font-size: 13px; min-width: 120px;">Starting From:</span>
                                        <span style="color: white; font-weight: 600;">${package.return_departure_city || 'Jeddah'}</span>
                                    </div>
                                    ${package.transit_city_return ? `
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        <span style="color: rgba(255, 255, 255, 0.6); font-size: 13px; min-width: 120px;">Transit:</span>
                                        <span style="color: white; font-weight: 600;">${package.transit_city_return}</span>
                                    </div>
                                    ` : ''}
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        <span style="color: rgba(255, 255, 255, 0.6); font-size: 13px; min-width: 120px;">Landing:</span>
                                        <span style="color: white; font-weight: 600;">${package.return_arrival_city || 'Jakarta'}</span>
                                    </div>
                                    ${package.return_flight_number ? `
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        <span style="color: rgba(255, 255, 255, 0.6); font-size: 13px; min-width: 120px;">No. Penerbangan:</span>
                                        <span style="color: white; font-weight: 600;">${package.return_flight_number}</span>
                                    </div>
                                    ` : ''}
                                </div>
                            </div>
                            
                            ${package.flight_info ? `
                            <div style="margin-top: 15px; padding: 15px; background: rgba(255, 255, 255, 0.05); border-radius: 8px;">
                                <p style="color: rgba(255, 255, 255, 0.8); font-size: 13px; line-height: 1.6; margin: 0;">
                                    <strong>Catatan:</strong> ${package.flight_info}
                                </p>
                            </div>
                            ` : ''}
                        </div>
                        
                        <!-- Description -->
                        ${package.description ? `
                        <div style="background: rgba(59, 130, 246, 0.05); padding: 20px; border-radius: 12px; border-left: 3px solid #3b82f6;">
                            <h4 style="color: white; margin: 0 0 10px 0; font-size: 16px;">Deskripsi</h4>
                            <p style="margin: 0; color: rgba(255, 255, 255, 0.9); line-height: 1.6;">${package.description}</p>
                        </div>
                        ` : ''}
                        
                        <!-- Package Info -->
                        ${package.package_info ? `
                        <div style="background: rgba(255, 255, 255, 0.03); padding: 25px; border-radius: 12px; border: 1px solid rgba(255, 255, 255, 0.1);">
                            <h4 style="color: white; margin: 0 0 15px 0; font-size: 16px;">Informasi Lengkap Paket</h4>
                            <div style="color: rgba(255, 255, 255, 0.85); line-height: 1.8; white-space: pre-wrap; font-size: 14px;">${package.package_info}</div>
                        </div>
                        ` : ''}
                        
                        <!-- Jamaah List -->
                        ${package.jamaah && package.jamaah.length > 0 ? `
                        <div style="background: rgba(255, 255, 255, 0.05); padding: 25px; border-radius: 12px; border: 1px solid rgba(255, 255, 255, 0.1);">
                            <h4 style="color: white; margin: 0 0 15px 0; font-size: 16px;">Jamaah Terdaftar (${package.jamaah.length})</h4>
                            <div style="max-height: 300px; overflow-y: auto;">
                                <table style="width: 100%; font-size: 13px;">
                                    <thead>
                                        <tr style="border-bottom: 1px solid rgba(255, 255, 255, 0.1);">
                                            <th style="text-align: left; padding: 8px; color: rgba(255, 255, 255, 0.7);">No</th>
                                            <th style="text-align: left; padding: 8px; color: rgba(255, 255, 255, 0.7);">Nama</th>
                                            <th style="text-align: left; padding: 8px; color: rgba(255, 255, 255, 0.7);">NIK</th>
                                            <th style="text-align: left; padding: 8px; color: rgba(255, 255, 255, 0.7);">Status</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${package.jamaah.map((j, idx) => `
                                            <tr style="border-bottom: 1px solid rgba(255, 255, 255, 0.05);">
                                                <td style="padding: 8px; color: rgba(255, 255, 255, 0.8);">${idx + 1}</td>
                                                <td style="padding: 8px; color: rgba(255, 255, 255, 0.9);">${j.name}</td>
                                                <td style="padding: 8px; color: rgba(255, 255, 255, 0.8);">${j.nik || '-'}</td>
                                                <td style="padding: 8px;">
                                                    <span class="status-badge status-${j.registration_status}">
                                                        ${j.registration_status === 'registered' ? 'Terdaftar' : 
                                                          j.registration_status === 'paid' ? 'Lunas' : 'Pending'}
                                                    </span>
                                                </td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        ` : ''}
                        
                        <!-- Meta Info -->
                        <div style="display: flex; justify-content: space-between; color: rgba(255, 255, 255, 0.5); font-size: 12px; padding-top: 20px; border-top: 1px solid rgba(255, 255, 255, 0.1);">
                            <span>Created: ${formatDate(package.created_at)}</span>
                            <span>Last Updated: ${formatDate(package.updated_at)}</span>
                        </div>
                    </div>
                `;
                
                openModal('packageDetailModal');
                
            } catch (error) {
                console.error('Error viewing package details:', error);
                showNotification('Gagal memuat detail paket: ' + error.message, 'error');
            }
        }

        function viewPassportImage(imageSrc, jamaahName) {
            if (!imageSrc) {
                showNotification('Belum ada foto paspor untuk jamaah ini', 'error');
                return;
            }
            
            // Create modal for passport view
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.style.display = 'flex';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 600px;">
                    <div class="modal-header">
                        <h3>Foto Paspor - ${jamaahName}</h3>
                        <button class="close-btn">&times;</button>
                    </div>
                    <div style="text-align: center;">
                        <img src="${imageSrc}" style="max-width: 100%; max-height: 400px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.3);">
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Add event listeners for close buttons
            const closeButtons = modal.querySelectorAll('.close-btn');
            closeButtons.forEach(btn => {
                btn.addEventListener('click', function() {
                    modal.remove();
                });
            });
            
            // Close on click outside
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }


        // Marketing Functions
        function openWhatsApp(phoneNumber) {
            const waNumber = phoneNumber.replace(/[^0-9]/g, '');
            const waLink = `https://wa.me/${waNumber}`;
            window.open(waLink, '_blank');
        }

        function filterByStage(stage) {
            // Reset all buttons
            document.querySelectorAll('[id^="filter"]').forEach(btn => {
                if (btn.id === 'filterAll') {
                    btn.style.background = stage === 'all' ? 'linear-gradient(135deg, #EC4899, #F472B6)' : '';
                    btn.style.border = stage === 'all' ? 'none' : '1px solid rgba(236, 72, 153, 0.5)';
                    btn.style.color = stage === 'all' ? 'white' : '#EC4899';
                } else if (btn.id === 'filterLeads') {
                    btn.style.background = stage === 'leads' ? 'linear-gradient(135deg, #3B82F6, #60A5FA)' : '';
                    btn.style.border = stage === 'leads' ? 'none' : '1px solid rgba(59, 130, 246, 0.5)';
                    btn.style.color = stage === 'leads' ? 'white' : '#3B82F6';
                } else if (btn.id === 'filterInterest') {
                    btn.style.background = stage === 'interest' ? 'linear-gradient(135deg, #F59E0B, #FCD34D)' : '';
                    btn.style.border = stage === 'interest' ? 'none' : '1px solid rgba(245, 158, 11, 0.5)';
                    btn.style.color = stage === 'interest' ? 'white' : '#F59E0B';
                } else if (btn.id === 'filterBooked') {
                    btn.style.background = stage === 'booked' ? 'linear-gradient(135deg, #10B981, #34D399)' : '';
                    btn.style.border = stage === 'booked' ? 'none' : '1px solid rgba(16, 185, 129, 0.5)';
                    btn.style.color = stage === 'booked' ? 'white' : '#10B981';
                }
            });

            // Filter table rows
            const rows = document.querySelectorAll('#marketingCustomerList tr');
            rows.forEach(row => {
                if (stage === 'all') {
                    row.style.display = '';
                } else {
                    const stageCell = row.querySelector('td:nth-child(3) .badge');
                    if (stageCell) {
                        const rowStage = stageCell.textContent.toLowerCase();
                        row.style.display = rowStage === stage ? '' : 'none';
                    }
                }
            });

            showNotification(`Showing ${stage === 'all' ? 'all' : stage} customers`);
        }

        function searchMarketingCustomers() {
            const searchTerm = document.getElementById('marketingSearch').value.toLowerCase();
            const rows = document.querySelectorAll('#marketingCustomerList tr');
            
            rows.forEach(row => {
                const name = row.querySelector('td:first-child')?.textContent.toLowerCase() || '';
                const phone = row.querySelector('td:nth-child(2)')?.textContent.toLowerCase() || '';
                
                if (name.includes(searchTerm) || phone.includes(searchTerm)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }

        function changeCustomerStage(customerId) {
            const stages = ['leads', 'interest', 'booked'];
            const stageLabels = {
                'leads': 'Leads',
                'interest': 'Interest',
                'booked': 'Booked'
            };

            // Create modal for stage change
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.style.display = 'flex';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 400px;">
                    <div class="modal-header">
                        <h3>Change Customer Stage</h3>
                        <button class="close-btn">&times;</button>
                    </div>
                    <div style="padding: 20px;">
                        <p style="margin-bottom: 20px;">Select new stage for this customer:</p>
                        <div style="display: flex; flex-direction: column; gap: 10px;">
                            ${stages.map(stage => `
                                <button class="btn btn-outline" style="width: 100%; padding: 15px; justify-content: flex-start; border-color: ${getStageColor(stage)}; color: ${getStageColor(stage)};" onclick="updateCustomerStage(${customerId}, '${stage}')">
                                    <span class="material-icons" style="margin-right: 10px;">${getStageIcon(stage)}</span>
                                    ${stageLabels[stage]}
                                </button>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Add event listeners
            modal.querySelector('.close-btn').addEventListener('click', () => modal.remove());
            modal.addEventListener('click', (e) => {
                if (e.target === modal) modal.remove();
            });
        }

        function getStageColor(stage) {
            switch(stage) {
                case 'leads': return '#3B82F6';
                case 'interest': return '#F59E0B';
                case 'booked': return '#10B981';
                default: return '#6B7280';
            }
        }

        function getStageIcon(stage) {
            switch(stage) {
                case 'leads': return 'person_add';
                case 'interest': return 'star';
                case 'booked': return 'check_circle';
                default: return 'circle';
            }
        }

        function updateCustomerStage(customerId, newStage) {
            // Close modal
            document.querySelector('.modal.active').remove();
            
            // Show success notification
            showNotification(`Customer stage updated to ${newStage}`);
            
            // In real app, this would update the backend
            // For demo, just refresh the display
            filterByStage('all');
        }

        function viewCustomerDetails(customerId) {
            // Sample customer data
            const customers = {
                1: {
                    name: 'Ahmad Hidayat',
                    phone: '+62 812-3456-7890',
                    stage: 'leads',
                    package: 'UMR2025',
                    value: 'Rp 35M',
                    firstContact: '2025-01-20',
                    conversations: [
                        { sender: 'customer', message: 'Assalamualaikum, saya mau tanya paket umroh', time: '2 jam yang lalu' },
                        { sender: 'agent', message: 'Waalaikumsalam, silakan. Ada yang bisa saya bantu?', time: '2 jam yang lalu' },
                        { sender: 'customer', message: 'Untuk bulan April ada?', time: '1 jam yang lalu' }
                    ]
                },
                2: { 
                    name: 'Siti Rahmawati',
                    phone: '+62 819-8765-4321',
                    stage: 'interest',
                    package: 'UMR2025P',
                    value: 'Rp 55M',
                    firstContact: '2025-01-18',
                    conversations: []
                },
                3: {
                    name: 'Muhammad Fadli',
                    phone: '+62 856-7890-1234',
                    stage: 'booked',
                    package: 'UMR2025',
                    value: 'Rp 35M',
                    firstContact: '2025-01-10',
                    conversations: []
                }
            };

            const customer = customers[customerId];
            if (!customer) return;

            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.style.display = 'flex';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 800px;">
                    <div class="modal-header">
                        <h3>Customer Details - ${customer.name}</h3>
                        <button class="close-btn">&times;</button>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; padding: 20px;">
                        <div>
                            <h4 style="color: #EC4899; margin-bottom: 15px;">Customer Information</h4>
                            <p><strong>Name:</strong> ${customer.name}</p>
                            <p><strong>Phone:</strong> ${customer.phone}</p>
                            <p><strong>Stage:</strong> <span class="badge" style="background: rgba(${getStageColorRgba(customer.stage)}, 0.2); color: ${getStageColor(customer.stage)}; border: 1px solid rgba(${getStageColorRgba(customer.stage)}, 0.3);">${customer.stage}</span></p>
                            <p><strong>Package:</strong> ${customer.package}</p>
                            <p><strong>Value:</strong> ${customer.value}</p>
                            <p><strong>First Contact:</strong> ${formatDate(customer.firstContact)}</p>
                        </div>
                        <div>
                            <h4 style="color: #EC4899; margin-bottom: 15px;">Actions</h4>
                            <button class="btn btn-success btn-sm" onclick="openWhatsApp('${customer.phone}')" style="width: 100%; margin-bottom: 10px;">
                                <span class="material-icons">chat</span>
                                Open WhatsApp
                            </button>
                            <button class="btn btn-primary btn-sm" onclick="changeCustomerStage(${customerId})" style="width: 100%; margin-bottom: 10px;">
                                <span class="material-icons">swap_horiz</span>
                                Change Stage
                            </button>
                            <button class="btn btn-warning btn-sm" style="width: 100%;">
                                <span class="material-icons">edit</span>
                                Edit Details
                            </button>
                        </div>
                    </div>
                    <div style="padding: 20px; border-top: 1px solid rgba(71, 85, 105, 0.3);">
                        <h4 style="color: #EC4899; margin-bottom: 15px;">Conversation History</h4>
                        <div style="max-height: 300px; overflow-y: auto; background: rgba(30, 41, 59, 0.3); border-radius: 8px; padding: 15px;">
                            ${customer.conversations.length > 0 ? customer.conversations.map(conv => `
                                <div style="margin-bottom: 15px; ${conv.sender === 'customer' ? 'text-align: left;' : 'text-align: right;'}">
                                    <div style="display: inline-block; max-width: 70%; padding: 10px 15px; border-radius: 15px; background: ${conv.sender === 'customer' ? 'rgba(59, 130, 246, 0.2)' : 'rgba(16, 185, 129, 0.2)'}; border: 1px solid ${conv.sender === 'customer' ? 'rgba(59, 130, 246, 0.3)' : 'rgba(16, 185, 129, 0.3)'};">
                                        <div style="font-size: 10px; color: rgba(255, 255, 255, 0.5); margin-bottom: 5px;">${conv.sender === 'customer' ? 'Customer' : 'Agent'} - ${conv.time}</div>
                                        <div>${conv.message}</div>
                                    </div>
                                </div>
                            `).join('') : '<p style="text-align: center; color: rgba(255, 255, 255, 0.5);">No conversation history yet</p>'}
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Add event listeners
            modal.querySelector('.close-btn').addEventListener('click', () => modal.remove());
            modal.addEventListener('click', (e) => {
                if (e.target === modal) modal.remove();
            });
        }

        function getStageColorRgba(stage) {
            switch(stage) {
                case 'leads': return '59, 130, 246';
                case 'interest': return '245, 158, 11';
                case 'booked': return '16, 185, 129';
                default: return '107, 114, 128';
            }
        }

        function showMarketingStageFilter() {
            showNotification('Advanced filter options coming soon!');
        }

        function refreshMarketingData() {
            showNotification('Data refreshed successfully!');
            // In real app, this would fetch fresh data from server
        }

        function addAutoReplyRule() {
            showNotification('Auto reply rule editor coming soon!');
        }

        function editAutoReply(ruleId) {
            showNotification('Edit auto reply feature coming soon!');
        }

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOMContentLoaded - Initializing app');
            
            // Close any open modals on load
            document.querySelectorAll('.modal').forEach(modal => {
                modal.style.display = 'none';
            });
            
            // Add event listeners for package form fields to save on change
            const packageFields = [
                'packageName', 'packageCode', 'packagePrice', 'packageDeparture',
                'packageReturn', 'packageQuota', 'packageMakkahHotel', 'packageMadinahHotel',
                'packageMakkahNights', 'packageMadinahNights', 'packageAirline',
                'packageDepartureCity', 'packageTransitDeparture', 'packageArrivalCity',
                'packageDepartureFlightNumber', 'packageReturnDepartureCity',
                'packageTransitReturn', 'packageReturnArrivalCity', 'packageReturnFlightNumber',
                'packageFlightInfo', 'packageDescription', 'packageInfo'
            ];
            
            packageFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.addEventListener('input', savePackageFormData);
                }
            });
            
            // Load custom cities into dropdowns
            loadCustomCitiesIntoDropdowns();
            
            // Setup navigation click handlers
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    // Get page ID from data-page attribute
                    const pageId = this.getAttribute('data-page');
                    const onclickAttr = this.getAttribute('onclick');
                    
                    if (pageId) {
                        console.log('Nav item clicked:', pageId);
                        showPage(pageId);
                    } else if (onclickAttr) {
                        // Handle external links
                        if (onclickAttr.includes('window.location.href')) {
                            eval(onclickAttr);
                        }
                    }
                });
            });
            
            loadDashboard();
            loadJamaahTable();
            
            // Add input formatting for birth date
            const birthDateInput = document.getElementById('jamaahBirthDate');
            if (birthDateInput) {
                formatDateInput(birthDateInput);
            }

            // Add input formatting for passport dates
            const passportIssueInput = document.getElementById('jamaahPassportIssueDate');
            const passportExpireInput = document.getElementById('jamaahPassportExpireDate');
            
            if (passportIssueInput) {
                formatDateInput(passportIssueInput);
            }
            
            if (passportExpireInput) {
                formatDateInput(passportExpireInput);
            }

            // Sync passport name with KTP name
            const ktpNameInput = document.getElementById('jamaahName');
            const sameAsKtpCheckbox = document.getElementById('sameAsKtpName');
            
            if (ktpNameInput && sameAsKtpCheckbox) {
                ktpNameInput.addEventListener('input', function() {
                    if (sameAsKtpCheckbox.checked) {
                        document.getElementById('jamaahPassportName').value = this.value;
                    }
                });
            }

            // Modal event listeners
            // 1. ESC key to close modals
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' || e.keyCode === 27) {
                    closeActiveModal();
                }
            });

            // 2. Click outside modal to close
            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', function(e) {
                    // Only close if clicked on the modal backdrop (not the modal content)
                    if (e.target === modal) {
                        closeModal(modal.id);
                    }
                });
            });

            // 3. Close button functionality for all modals
            document.querySelectorAll('.modal .close-btn').forEach(closeBtn => {
                closeBtn.addEventListener('click', function() {
                    const modal = this.closest('.modal');
                    if (modal) {
                        closeModal(modal.id);
                    }
                });
            });
        });
    </script>
    
    <!-- Add City Modal -->
    <div id="addCityModal" class="modal">
        <div class="modal-content" style="
            max-width: 400px;
            background: rgba(15, 23, 42, 0.85);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.18);
            box-shadow: 
                0 8px 32px 0 rgba(31, 38, 135, 0.37),
                inset 0 0 0 1px rgba(255, 255, 255, 0.1);
        ">
            <div class="modal-header" style="
                background: linear-gradient(135deg, rgba(59, 130, 246, 0.15), rgba(147, 51, 234, 0.15));
                margin: -30px -30px 20px -30px;
                padding: 24px 30px;
                border-radius: 24px 24px 0 0;
                border-bottom: 1px solid rgba(255, 255, 255, 0.1);
                display: flex;
                justify-content: space-between;
                align-items: center;
            ">
                <div>
                    <h3 style="
                        margin: 0;
                        font-size: 20px;
                        font-weight: 700;
                        background: linear-gradient(135deg, #3b82f6, #9333ea);
                        -webkit-background-clip: text;
                        -webkit-text-fill-color: transparent;
                    ">Tambah Kota Baru</h3>
                </div>
                <button class="close-btn" onclick="closeModal('addCityModal')" style="
                    background: rgba(255, 255, 255, 0.1);
                    border: 1px solid rgba(255, 255, 255, 0.2);
                    width: 36px;
                    height: 36px;
                    border-radius: 12px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    cursor: pointer;
                    transition: all 0.3s ease;
                " onmouseover="this.style.background='rgba(255, 255, 255, 0.2)'" onmouseout="this.style.background='rgba(255, 255, 255, 0.1)'">&times;</button>
            </div>
            
            <form onsubmit="addNewCity(event)">
                <input type="hidden" id="citySelectType">
                <input type="hidden" id="citySelectElement">
                
                <div class="form-group">
                    <label class="glass-label">Nama Kota</label>
                    <input type="text" id="newCityName" class="glass-input" placeholder="Masukkan nama kota" required>
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" class="btn btn-primary" style="
                        background: linear-gradient(135deg, #3b82f6, #2563eb);
                        border: 1px solid rgba(59, 130, 246, 0.3);
                        color: white;
                        padding: 12px 24px;
                        border-radius: 12px;
                        font-weight: 500;
                        display: flex;
                        align-items: center;
                        gap: 8px;
                        transition: all 0.3s ease;
                        box-shadow: 0 4px 15px rgba(59, 130, 246, 0.2);
                        flex: 1;
                        justify-content: center;
                    " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(59, 130, 246, 0.3)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(59, 130, 246, 0.2)'">
                        <span class="material-icons">add</span>
                        Tambah
                    </button>
                    <button type="button" class="btn btn-danger" onclick="closeModal('addCityModal')" style="
                        background: rgba(239, 68, 68, 0.2);
                        border: 1px solid rgba(239, 68, 68, 0.3);
                        color: #ef4444;
                        padding: 12px 24px;
                        border-radius: 12px;
                        font-weight: 500;
                        display: flex;
                        align-items: center;
                        gap: 8px;
                        transition: all 0.3s ease;
                        flex: 1;
                        justify-content: center;
                    " onmouseover="this.style.background='rgba(239, 68, 68, 0.3)'" onmouseout="this.style.background='rgba(239, 68, 68, 0.2)'">
                        <span class="material-icons">cancel</span>
                        Batal
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal for Special Requests -->
    <div id="specialRequestsModal" class="modal">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 90%; max-width: 500px;">
            <div class="glass-card" style="max-height: 80vh; overflow-y: auto; padding: 24px; position: relative;">
                <button onclick="closeModal('specialRequestsModal')" style="position: absolute; top: 16px; right: 16px; background: transparent; border: none; color: #fff; font-size: 24px; cursor: pointer;">
                    <span class="material-icons">close</span>
                </button>
                <h3 style="margin-bottom: 20px; background: linear-gradient(135deg, #F59E0B, #FCD34D); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">Special Requests</h3>
                <div id="requestsList">
                    <!-- Content will be populated by JavaScript -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- WhatsApp Chat Manager Modal -->
    <div id="whatsappChatModal" class="modal">
        <div class="modal-content" style="max-width: 1200px; height: 90vh; display: flex; flex-direction: column;">
            <div class="modal-header">
                <h3>WhatsApp Chat Manager</h3>
                <button class="close-btn" onclick="closeModal('whatsappChatModal')">&times;</button>
            </div>
            
            <div style="display: flex; flex: 1; overflow: hidden;">
                <!-- Chat List Sidebar -->
                <div style="width: 350px; background: rgba(30, 41, 59, 0.8); border-right: 1px solid rgba(255, 255, 255, 0.1); overflow-y: auto;">
                    <!-- Search Box -->
                    <div style="padding: 15px; border-bottom: 1px solid rgba(255, 255, 255, 0.1);">
                        <input type="text" id="chatSearch" placeholder="Cari chat..." 
                               style="width: 100%; padding: 10px 15px; background: rgba(255, 255, 255, 0.05); 
                                      border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 8px; 
                                      color: white;" onkeyup="filterChats()">
                    </div>
                    
                    <!-- Chat List -->
                    <div id="chatList">
                        <!-- Chat items will be populated here -->
                    </div>
                </div>
                
                <!-- Chat Content Area -->
                <div style="flex: 1; display: flex; flex-direction: column; background: rgba(15, 23, 42, 0.8);">
                    <!-- Chat Header -->
                    <div id="chatHeader" style="padding: 15px 20px; border-bottom: 1px solid rgba(255, 255, 255, 0.1); display: none;">
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <div style="width: 45px; height: 45px; background: #25D366; border-radius: 50%; 
                                        display: flex; align-items: center; justify-content: center;">
                                <span class="material-icons" style="color: white;">person</span>
                            </div>
                            <div>
                                <h4 id="chatContactName" style="margin: 0; font-size: 16px;"></h4>
                                <p id="chatContactNumber" style="margin: 0; font-size: 13px; color: rgba(255, 255, 255, 0.6);"></p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Messages Area -->
                    <div id="messagesArea" style="flex: 1; overflow-y: auto; padding: 20px;">
                        <div id="messagesList" style="display: flex; flex-direction: column; gap: 10px;">
                            <!-- Messages will be populated here -->
                        </div>
                    </div>
                    
                    <!-- Message Input -->
                    <div id="messageInput" style="padding: 15px; border-top: 1px solid rgba(255, 255, 255, 0.1); display: none;">
                        <form onsubmit="sendWhatsAppMessage(event)" style="display: flex; gap: 10px;">
                            <input type="text" id="messageText" placeholder="Ketik pesan..." 
                                   style="flex: 1; padding: 12px 15px; background: rgba(255, 255, 255, 0.05); 
                                          border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 8px; 
                                          color: white;">
                            <button type="submit" class="btn btn-primary" style="background: #25D366;">
                                <span class="material-icons">send</span>
                            </button>
                        </form>
                    </div>
                    
                    <!-- Empty State -->
                    <div id="chatEmptyState" style="flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 40px;">
                        <span class="material-icons" style="font-size: 80px; color: rgba(255, 255, 255, 0.2); margin-bottom: 20px;">chat</span>
                        <h3 style="color: rgba(255, 255, 255, 0.5); margin-bottom: 10px;">Pilih chat untuk memulai</h3>
                        <p style="color: rgba(255, 255, 255, 0.3);">Pilih kontak dari daftar di sebelah kiri untuk melihat percakapan</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- PNR Edit Modal -->
    <div id="pnrEditModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3 id="pnrEditTitle">Edit Data PNR Paket</h3>
                <button class="close-btn" onclick="closeModal('pnrEditModal')">&times;</button>
            </div>
            
            <form id="pnrEditForm" onsubmit="savePNRData(event)">
                <input type="hidden" id="pnr_package_id">
                
                <div class="form-group">
                    <label>Nama Paket</label>
                    <input type="text" id="pnr_package_name" readonly style="background: rgba(255, 255, 255, 0.05); cursor: not-allowed;">
                </div>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label>Nomor PNR *</label>
                        <input type="text" id="pnr_number" placeholder="Contoh: GA897JKT" required>
                    </div>
                    
                    <div class="form-group">
                        <label>Vendor/Supplier Tiket *</label>
                        <input type="text" id="pnr_vendor" placeholder="Nama vendor penjual tiket" required>
                    </div>
                </div>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label>Tanggal Pelunasan * (DD/MM/YYYY)</label>
                        <input type="text" id="pnr_payment_date" placeholder="DD/MM/YYYY" pattern="\d{2}/\d{2}/\d{4}" maxlength="10" required style="background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.2); color: white; padding: 10px; border-radius: 8px;">
                    </div>
                    
                    <div class="form-group">
                        <label>Batas Insert Name * (DD/MM/YYYY)</label>
                        <input type="text" id="pnr_insert_date" placeholder="DD/MM/YYYY" pattern="\d{2}/\d{2}/\d{4}" maxlength="10" required style="background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.2); color: white; padding: 10px; border-radius: 8px;">
                    </div>
                </div>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label>Status Pembayaran</label>
                        <select id="pnr_payment_status" style="background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.2); color: white; padding: 10px; border-radius: 8px; width: 100%;">
                            <option value="" style="color: #333;">Pilih Status</option>
                            <option value="pending" style="color: #333;">Pending</option>
                            <option value="partial" style="color: #333;">DP/Partial</option>
                            <option value="paid" style="color: #333;">Lunas</option>
                            <option value="cancelled" style="color: #333;">Dibatalkan</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Nomor Tiket</label>
                        <input type="text" id="pnr_ticket_number" placeholder="Nomor tiket/booking">
                    </div>
                </div>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label>Total Harga Tiket</label>
                        <input type="number" id="pnr_ticket_price" placeholder="Total harga tiket" min="0">
                    </div>
                    
                    <div class="form-group">
                        <label>Jumlah Dibayar</label>
                        <input type="number" id="pnr_paid_amount" placeholder="Jumlah yang sudah dibayar" min="0">
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Catatan</label>
                    <textarea id="pnr_notes" rows="3" placeholder="Catatan tambahan..." style="background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.2); color: white; padding: 10px; border-radius: 8px; width: 100%; resize: vertical;"></textarea>
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 30px; justify-content: flex-end;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('pnrEditModal')">
                        <span class="material-icons">close</span>
                        Batal
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <span class="material-icons">save</span>
                        Simpan
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <script>
        // Special Requests Data
        const specialRequests = {
            'GA-897': [
                { type: 'wheelchair', name: 'Hj. Fatimah (65th)', notes: 'Kursi roda dari check-in hingga boarding' },
                { type: 'wheelchair', name: 'H. Ahmad (70th)', notes: 'Bantuan kursi roda untuk transit' },
                { type: 'special_seat', name: 'Ibu Siti', notes: 'Seat dekat toilet (kondisi hamil)' },
                { type: 'special_meal', name: 'Bpk. Yusuf', notes: 'Diabetic meal' },
                { type: 'medical', name: 'Hj. Aisyah', notes: 'Membawa oxygen concentrator' }
            ],
            'SV-815': [],
            'QR-955': []
        };
        
        function showSpecialRequests(flightCode) {
            openModal('specialRequestsModal');
            const requestsList = document.getElementById('requestsList');
            const requests = specialRequests[flightCode] || [];
            
            requestsList.innerHTML = '';
            
            if (requests.length === 0) {
                requestsList.innerHTML = '<p style="text-align: center; color: rgba(255, 255, 255, 0.6);">No special requests for this flight</p>';
            } else {
                requests.forEach(request => {
                    const requestItem = `
                        <div style="background: rgba(255, 255, 255, 0.05); padding: 16px; border-radius: 8px; margin-bottom: 12px; border-left: 3px solid #F59E0B;">
                            <div style="display: flex; align-items: start; gap: 12px;">
                                <span class="material-icons" style="color: #F59E0B; font-size: 24px;">
                                    ${request.type === 'wheelchair' ? 'accessible' : 
                                      request.type === 'special_seat' ? 'event_seat' :
                                      request.type === 'special_meal' ? 'restaurant' : 'medical_services'}
                                </span>
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; margin-bottom: 4px; font-size: 14px;">${request.name}</div>
                                    <div style="font-size: 13px; color: rgba(255, 255, 255, 0.7);">${request.notes}</div>
                                </div>
                            </div>
                        </div>
                    `;
                    requestsList.innerHTML += requestItem;
                });
            }
        }
        
        function showFlightDetails(flightCode) {
            // Implement flight details modal
            alert('Flight details for ' + flightCode + ' - To be implemented');
        }
        
        // Removed duplicate closeModal function - using the main one above
        
        // Close modal when clicking outside
        document.getElementById('specialRequestsModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal('specialRequestsModal');
            }
        });

        // Inventory Functions
        function loadInventoryData() {
            // Load inventory stats and initial data
            console.log('Loading inventory data...');
        }

        function switchInventoryTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('#inventory .tab-content').forEach(tab => {
                tab.style.display = 'none';
            });
            
            // Remove active class from all buttons
            document.querySelectorAll('#inventory .tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById('inventory' + tabName.charAt(0).toUpperCase() + tabName.slice(1) + 'Tab').style.display = 'block';
            
            // Add active class to clicked button
            event.target.classList.add('active');
        }

        function openInventoryModal() {
            alert('Add new inventory item - Modal to be implemented');
        }

        function openTransactionModal() {
            alert('Record new transaction - Modal to be implemented');
        }

        function openSlayerColorModal() {
            alert('Add new slayer color - Modal to be implemented');
        }

        function openEarphoneMappingModal() {
            alert('Map earphone to group - Modal to be implemented');
        }

        function recordTransaction(itemId) {
            alert('Record transaction for item ID: ' + itemId + ' - Modal to be implemented');
        }

        // Helper function for currency formatting
        function formatCurrency(amount) {
            return new Intl.NumberFormat('id-ID', {
                style: 'currency',
                currency: 'IDR',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(amount);
        }
        
        // Flight Management Functions
        function loadFlightsData() {
            console.log('Loading flights data...');
            loadSimpleFlightPackages();
        }
        
        // Load packages for flight management
        async function loadSimpleFlightPackages() {
            const container = document.getElementById('flight-package-list');
            if (!container) return;
            
            try {
                const response = await fetch(`${getApiBaseUrl()}/api/packages`);
                if (response.ok) {
                    const result = await response.json();
                    const packages = result.data || [];
                    
                    if (packages.length === 0) {
                        container.innerHTML = `
                            <div style="text-align: center; padding: 60px; color: rgba(255, 255, 255, 0.6);">
                                <span class="material-icons" style="font-size: 72px; display: block; margin-bottom: 20px; opacity: 0.3;">flight_takeoff</span>
                                <p>Belum ada paket yang terdaftar</p>
                            </div>
                        `;
                        return;
                    }
                    
                    // Render simple package list
                    container.innerHTML = packages.map(pkg => {
                        // Calculate H- (days to departure)
                        let daysToGo = '';
                        let daysColor = '#3B82F6';
                        let daysBackground = 'rgba(59, 130, 246, 0.1)';
                        const departureDate = pkg.departure_date || pkg.tanggal_berangkat;
                        
                        if (departureDate) {
                            const today = new Date();
                            today.setHours(0, 0, 0, 0);
                            const departure = new Date(departureDate);
                            departure.setHours(0, 0, 0, 0);
                            const diffTime = departure - today;
                            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                            
                            if (diffDays < 0) {
                                daysToGo = `H+${Math.abs(diffDays)}`;
                                daysColor = '#6B7280';
                                daysBackground = 'rgba(107, 114, 128, 0.1)';
                            } else if (diffDays === 0) {
                                daysToGo = 'H-0 (Hari Ini)';
                                daysColor = '#EF4444';
                                daysBackground = 'rgba(239, 68, 68, 0.1)';
                            } else if (diffDays <= 7) {
                                daysToGo = `H-${diffDays}`;
                                daysColor = '#EF4444';
                                daysBackground = 'rgba(239, 68, 68, 0.1)';
                            } else if (diffDays <= 30) {
                                daysToGo = `H-${diffDays}`;
                                daysColor = '#F59E0B';
                                daysBackground = 'rgba(245, 158, 11, 0.1)';
                            } else {
                                daysToGo = `H-${diffDays}`;
                                daysColor = '#10B981';
                                daysBackground = 'rgba(16, 185, 129, 0.1)';
                            }
                        }
                        
                        return `
                        <div class="glass-card" style="padding: 20px; margin-bottom: 15px; position: relative;">
                            ${daysToGo ? `
                                <div style="position: absolute; top: 20px; right: 20px; background: ${daysBackground}; border: 1px solid ${daysColor}; padding: 6px 14px; border-radius: 20px;">
                                    <span style="color: ${daysColor}; font-weight: 600; font-size: 13px;">
                                        <span class="material-icons" style="font-size: 14px; vertical-align: middle; margin-right: 3px;">schedule</span>
                                        ${daysToGo}
                                    </span>
                                </div>
                            ` : ''}
                            <div style="display: grid; grid-template-columns: 1fr auto; gap: 20px; align-items: center;">
                                <div>
                                    <h4 style="margin: 0 0 10px 0; color: #F59E0B;">${pkg.name || pkg.nama_paket || 'Paket Umroh'}</h4>
                                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                                        <div>
                                            <p style="margin: 0; font-size: 12px; color: rgba(255, 255, 255, 0.6);">Kode Paket</p>
                                            <p style="margin: 0; font-weight: 600;">${pkg.code || pkg.kode_paket || '-'}</p>
                                        </div>
                                        <div>
                                            <p style="margin: 0; font-size: 12px; color: rgba(255, 255, 255, 0.6);">Maskapai</p>
                                            <p style="margin: 0; font-weight: 600;">${pkg.airline || pkg.maskapai || 'Belum ditentukan'}</p>
                                        </div>
                                        <div>
                                            <p style="margin: 0; font-size: 12px; color: rgba(255, 255, 255, 0.6);">Keberangkatan</p>
                                            <p style="margin: 0; font-weight: 600;">${formatDate(departureDate)}</p>
                                        </div>
                                        <div>
                                            <p style="margin: 0; font-size: 12px; color: rgba(255, 255, 255, 0.6);">Nomor PNR</p>
                                            <p style="margin: 0; font-weight: 600; color: ${pkg.pnr_code ? '#10B981' : '#EF4444'};">
                                                ${pkg.pnr_code || 'Belum ada PNR'}
                                            </p>
                                        </div>
                                    </div>
                                </div>
                                <div style="margin-right: 80px;">
                                    <button class="btn btn-primary" onclick="editPackagePNR(${pkg.id})">
                                        <span class="material-icons">edit</span>
                                        Edit PNR
                                    </button>
                                </div>
                            </div>
                        </div>
                    `}).join('');
                } else {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 60px; color: rgba(255, 255, 255, 0.6);">
                            <span class="material-icons" style="font-size: 72px; display: block; margin-bottom: 20px; opacity: 0.3;">error</span>
                            <p>Gagal memuat data paket</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading packages:', error);
                container.innerHTML = `
                    <div style="text-align: center; padding: 60px; color: rgba(255, 255, 255, 0.6);">
                        <span class="material-icons" style="font-size: 72px; display: block; margin-bottom: 20px; opacity: 0.3;">error</span>
                        <p>Terjadi kesalahan saat memuat data</p>
                    </div>
                `;
            }
        }
        
        // Refresh flight packages
        function refreshFlightPackages() {
            loadSimpleFlightPackages();
        }
        
        // Date format helpers
        function formatDateToDDMMYYYY(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            return `${day}/${month}/${year}`;
        }
        
        function parseDDMMYYYYToISO(dateString) {
            if (!dateString) return null;
            const parts = dateString.split('/');
            if (parts.length !== 3) return null;
            const day = parts[0];
            const month = parts[1];
            const year = parts[2];
            return `${year}-${month}-${day}`;
        }
        
        // Auto-format date input as user types
        function setupDateInput(inputId) {
            const input = document.getElementById(inputId);
            if (!input) return;
            
            input.addEventListener('input', function(e) {
                let value = e.target.value.replace(/\D/g, ''); // Remove non-digits
                let formattedValue = '';
                
                if (value.length >= 2) {
                    formattedValue = value.substring(0, 2);
                    if (value.length > 2) {
                        formattedValue += '/' + value.substring(2, 4);
                        if (value.length > 4) {
                            formattedValue += '/' + value.substring(4, 8);
                        }
                    }
                } else {
                    formattedValue = value;
                }
                
                e.target.value = formattedValue;
            });
            
            // Add calendar icon button
            const wrapper = input.parentElement;
            const calendarBtn = document.createElement('button');
            calendarBtn.type = 'button';
            calendarBtn.style.cssText = 'position: absolute; right: 10px; top: 35px; background: transparent; border: none; color: #F59E0B; cursor: pointer; padding: 5px;';
            calendarBtn.innerHTML = '<span class="material-icons">calendar_today</span>';
            calendarBtn.onclick = function() {
                // Create a hidden date input for calendar picker
                const hiddenInput = document.createElement('input');
                hiddenInput.type = 'date';
                hiddenInput.style.cssText = 'position: absolute; opacity: 0; pointer-events: none;';
                hiddenInput.value = parseDDMMYYYYToISO(input.value) || '';
                
                hiddenInput.addEventListener('change', function() {
                    input.value = formatDateToDDMMYYYY(this.value);
                    this.remove();
                });
                
                wrapper.appendChild(hiddenInput);
                hiddenInput.showPicker();
            };
            
            wrapper.style.position = 'relative';
            wrapper.appendChild(calendarBtn);
        }
        
        // Edit package PNR
        async function editPackagePNR(packageId) {
            try {
                // Fetch package data
                const response = await fetch(`${getApiBaseUrl()}/api/packages/${packageId}`);
                if (response.ok) {
                    const result = await response.json();
                    const packageData = result.data || result;
                    
                    // Populate modal fields
                    document.getElementById('pnr_package_id').value = packageId;
                    document.getElementById('pnr_package_name').value = packageData.name || packageData.nama_paket || '';
                    document.getElementById('pnr_number').value = packageData.pnr_code || '';
                    document.getElementById('pnr_vendor').value = packageData.ticket_vendor || '';
                    document.getElementById('pnr_ticket_number').value = packageData.ticket_number || '';
                    document.getElementById('pnr_payment_status').value = packageData.flight_payment_status || '';
                    document.getElementById('pnr_notes').value = packageData.flight_notes || '';
                    
                    // Set dates if available - format to DD/MM/YYYY
                    if (packageData.payment_due_date) {
                        document.getElementById('pnr_payment_date').value = formatDateToDDMMYYYY(packageData.payment_due_date);
                    }
                    if (packageData.insert_name_deadline) {
                        document.getElementById('pnr_insert_date').value = formatDateToDDMMYYYY(packageData.insert_name_deadline);
                    }
                    if (packageData.insert_name_deadline) {
                        document.getElementById('pnr_insert_date').value = packageData.insert_name_deadline.split('T')[0];
                    }
                    
                    // Set price fields if available
                    document.getElementById('pnr_ticket_price').value = packageData.ticket_total_price || '';
                    document.getElementById('pnr_paid_amount').value = packageData.ticket_paid_amount || '';
                    
                    // Show modal
                    openModal('pnrEditModal');
                    
                    // Setup date inputs with formatting after modal is shown
                    setTimeout(() => {
                        setupDateInput('pnr_payment_date');
                        setupDateInput('pnr_insert_date');
                    }, 100);
                } else {
                    showNotification('Gagal memuat data paket', 'error');
                }
            } catch (error) {
                console.error('Error loading package data:', error);
                showNotification('Terjadi kesalahan saat memuat data', 'error');
            }
        }
        
        // Save PNR data
        async function savePNRData(event) {
            event.preventDefault();
            
            const packageId = document.getElementById('pnr_package_id').value;
            
            // Convert DD/MM/YYYY dates to ISO format for backend
            const paymentDateInput = document.getElementById('pnr_payment_date').value;
            const insertDateInput = document.getElementById('pnr_insert_date').value;
            
            const data = {
                pnr_code: document.getElementById('pnr_number').value,
                ticket_vendor: document.getElementById('pnr_vendor').value,
                ticket_number: document.getElementById('pnr_ticket_number').value,
                flight_payment_status: document.getElementById('pnr_payment_status').value,
                flight_notes: document.getElementById('pnr_notes').value,
                payment_due_date: paymentDateInput ? parseDDMMYYYYToISO(paymentDateInput) : null,
                insert_name_deadline: insertDateInput ? parseDDMMYYYYToISO(insertDateInput) : null,
                ticket_total_price: document.getElementById('pnr_ticket_price').value || null,
                ticket_paid_amount: document.getElementById('pnr_paid_amount').value || null
            };
            
            try {
                const response = await fetch(`${getApiBaseUrl()}/api/packages/${packageId}/flight-info`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${getAuthToken()}`
                    },
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    showNotification('Data PNR berhasil disimpan', 'success');
                    closeModal('pnrEditModal');
                    // Reload the flight packages list
                    loadSimpleFlightPackages();
                } else {
                    const error = await response.json();
                    showNotification(error.message || 'Gagal menyimpan data PNR', 'error');
                }
            } catch (error) {
                console.error('Error saving PNR data:', error);
                showNotification('Terjadi kesalahan saat menyimpan data', 'error');
            }
        }
    </script>
</body>
</html>