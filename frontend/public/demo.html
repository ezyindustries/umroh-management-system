<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Manajemen Umroh - Demo Lengkap</title>
    
    <!-- Material UI Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- SheetJS for Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 25%, #334155 50%, #475569 75%, #64748b 100%);
            min-height: 100vh;
            color: #f8fafc;
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 80%, rgba(59, 130, 246, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(16, 185, 129, 0.12) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(139, 92, 246, 0.1) 0%, transparent 50%);
            z-index: -1;
        }

        .app-container {
            display: flex;
            min-height: 100vh;
        }

        /* Login Screen */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        .login-form {
            background: linear-gradient(145deg, rgba(30, 41, 59, 0.95), rgba(15, 23, 42, 0.9));
            backdrop-filter: blur(20px);
            border: 1px solid rgba(71, 85, 105, 0.3);
            border-radius: 20px;
            padding: 40px;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }

        .login-title {
            text-align: center;
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #3b82f6, #10b981);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .login-subtitle {
            text-align: center;
            color: #94a3b8;
            margin-bottom: 30px;
        }

        /* Sidebar */
        .sidebar {
            width: 280px;
            background: linear-gradient(145deg, rgba(30, 41, 59, 0.95), rgba(15, 23, 42, 0.9));
            backdrop-filter: blur(20px);
            border-right: 1px solid rgba(71, 85, 105, 0.3);
            padding: 20px;
            overflow-y: auto;
            box-shadow: 
                inset 0 1px 0 rgba(71, 85, 105, 0.4),
                0 20px 40px rgba(0, 0, 0, 0.3),
                0 1px 3px rgba(0, 0, 0, 0.2);
        }

        .logo {
            text-align: center;
            background: linear-gradient(135deg, #3b82f6, #10b981, #8b5cf6);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 30px;
            padding: 20px 0;
            text-shadow: 0 2px 10px rgba(59, 130, 246, 0.3);
        }

        .nav-item {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            margin: 5px 0;
            border-radius: 12px;
            color: #e2e8f0;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            background: linear-gradient(135deg, rgba(71, 85, 105, 0.4), rgba(30, 41, 59, 0.3));
            border: 1px solid rgba(71, 85, 105, 0.3);
            position: relative;
            overflow: hidden;
        }

        .nav-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(59, 130, 246, 0.2), transparent);
            transition: left 0.6s ease;
        }

        .nav-item:hover::before {
            left: 100%;
        }

        .nav-item:hover {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.3), rgba(16, 185, 129, 0.2));
            transform: translateX(5px);
            box-shadow: 0 10px 30px rgba(59, 130, 246, 0.2);
        }

        .nav-item.active {
            background: linear-gradient(135deg, #3b82f6, #10b981);
            color: white;
            box-shadow: 0 10px 30px rgba(59, 130, 246, 0.4);
        }

        .nav-item i {
            margin-right: 12px;
            font-size: 20px;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
        }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(71, 85, 105, 0.3);
        }

        .page-title {
            font-size: 32px;
            font-weight: 700;
            background: linear-gradient(135deg, #3b82f6, #10b981);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* Form Styles */
        .form-container {
            background: linear-gradient(145deg, rgba(30, 41, 59, 0.95), rgba(15, 23, 42, 0.9));
            backdrop-filter: blur(20px);
            border: 1px solid rgba(71, 85, 105, 0.3);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #e2e8f0;
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid rgba(71, 85, 105, 0.5);
            border-radius: 12px;
            background: rgba(30, 41, 59, 0.7);
            color: #f8fafc;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .form-textarea {
            resize: vertical;
            min-height: 100px;
        }

        /* Button Styles */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
            font-size: 14px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(59, 130, 246, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(16, 185, 129, 0.4);
        }

        .btn-warning {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
        }

        .btn-warning:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(245, 158, 11, 0.4);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(239, 68, 68, 0.4);
        }

        .btn-outline {
            background: transparent;
            border: 1px solid rgba(71, 85, 105, 0.5);
            color: #e2e8f0;
        }

        .btn-outline:hover {
            background: rgba(71, 85, 105, 0.3);
        }

        /* Table Styles */
        .table-container {
            background: linear-gradient(145deg, rgba(30, 41, 59, 0.95), rgba(15, 23, 42, 0.9));
            backdrop-filter: blur(20px);
            border: 1px solid rgba(71, 85, 105, 0.3);
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }

        .table {
            width: 100%;
            border-collapse: collapse;
        }

        .table th, .table td {
            padding: 15px 20px;
            text-align: left;
            border-bottom: 1px solid rgba(71, 85, 105, 0.3);
        }

        .table th {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(16, 185, 129, 0.1));
            color: #e2e8f0;
            font-weight: 600;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .table tbody tr {
            transition: all 0.3s ease;
        }

        .table tbody tr:hover {
            background: rgba(59, 130, 246, 0.1);
        }

        /* Status Badges */
        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-active { background: rgba(16, 185, 129, 0.2); color: #10b981; }
        .status-pending { background: rgba(245, 158, 11, 0.2); color: #f59e0b; }
        .status-inactive { background: rgba(71, 85, 105, 0.2); color: #94a3b8; }
        .status-completed { background: rgba(59, 130, 246, 0.2); color: #3b82f6; }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            z-index: 1000;
            opacity: 0;
            transition: all 0.3s ease;
        }

        .modal.show {
            display: flex;
            opacity: 1;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: linear-gradient(145deg, rgba(30, 41, 59, 0.95), rgba(15, 23, 42, 0.9));
            backdrop-filter: blur(20px);
            border: 1px solid rgba(71, 85, 105, 0.3);
            border-radius: 20px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }

        .modal.show .modal-content {
            transform: scale(1);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(71, 85, 105, 0.3);
        }

        .modal-title {
            font-size: 24px;
            font-weight: 600;
            background: linear-gradient(135deg, #3b82f6, #10b981);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .close-btn {
            background: none;
            border: none;
            color: #94a3b8;
            font-size: 24px;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .close-btn:hover {
            color: #ef4444;
        }

        /* Dashboard Cards */
        .dashboard-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .dashboard-card {
            background: linear-gradient(145deg, rgba(30, 41, 59, 0.95), rgba(15, 23, 42, 0.9));
            backdrop-filter: blur(20px);
            border: 1px solid rgba(71, 85, 105, 0.3);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            transition: transform 0.3s ease;
        }

        .dashboard-card:hover {
            transform: translateY(-5px);
        }

        .card-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 15px;
            font-size: 24px;
        }

        .card-icon.blue { background: linear-gradient(135deg, #3b82f6, #1d4ed8); }
        .card-icon.green { background: linear-gradient(135deg, #10b981, #059669); }
        .card-icon.yellow { background: linear-gradient(135deg, #f59e0b, #d97706); }
        .card-icon.purple { background: linear-gradient(135deg, #8b5cf6, #7c3aed); }

        .card-title {
            font-size: 14px;
            color: #94a3b8;
            margin-bottom: 5px;
        }

        .card-value {
            font-size: 32px;
            font-weight: 700;
            color: #f8fafc;
        }

        /* Search and Filter */
        .search-filter-bar {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .search-input {
            flex: 1;
            min-width: 250px;
        }

        .filter-select {
            min-width: 150px;
        }

        /* Pagination */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 20px;
        }

        .pagination-btn {
            padding: 8px 12px;
            border: 1px solid rgba(71, 85, 105, 0.5);
            background: transparent;
            color: #e2e8f0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .pagination-btn:hover:not(:disabled) {
            background: rgba(59, 130, 246, 0.2);
            border-color: #3b82f6;
        }

        .pagination-btn.active {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            border-color: #3b82f6;
        }

        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Loading Spinner */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Alert Styles */
        .alert {
            padding: 15px 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            border-left: 4px solid;
        }

        .alert-success {
            background: rgba(16, 185, 129, 0.1);
            border-color: #10b981;
            color: #10b981;
        }

        .alert-error {
            background: rgba(239, 68, 68, 0.1);
            border-color: #ef4444;
            color: #ef4444;
        }

        .alert-warning {
            background: rgba(245, 158, 11, 0.1);
            border-color: #f59e0b;
            color: #f59e0b;
        }

        .alert-info {
            background: rgba(59, 130, 246, 0.1);
            border-color: #3b82f6;
            color: #3b82f6;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .app-container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                order: 2;
            }
            
            .main-content {
                order: 1;
                padding: 20px;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .dashboard-cards {
                grid-template-columns: 1fr;
            }
            
            .search-filter-bar {
                flex-direction: column;
            }
            
            .search-input {
                min-width: unset;
            }
        }

        /* Hide/Show Pages */
        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        .hidden {
            display: none !important;
        }

        /* Excel Import/Export Styles */
        .excel-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .file-input {
            display: none;
        }

        .file-input-label {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 12px 24px;
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .file-input-label:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(16, 185, 129, 0.4);
        }

        /* Connection Status */
        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            z-index: 1001;
            transition: all 0.3s ease;
        }

        .connection-status.connected {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
        }

        .connection-status.disconnected {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }
    </style>
</head>
<body>
    <!-- Connection Status -->
    <div id="connectionStatus" class="connection-status">
        <i class="material-icons">wifi</i>
        <span>Menghubungkan...</span>
    </div>

    <!-- Login Screen -->
    <div id="loginScreen" class="login-container">
        <div class="login-form">
            <h1 class="login-title">Aplikasi Umroh</h1>
            <p class="login-subtitle">Silakan login untuk melanjutkan</p>
            
            <form id="loginForm">
                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" class="form-input" id="loginEmail" value="admin@umroh.com" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Password</label>
                    <input type="password" class="form-input" id="loginPassword" value="admin123" required>
                </div>
                
                <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 20px;">
                    <i class="material-icons">login</i>
                    Login
                </button>
            </form>
            
            <div id="loginAlert" class="alert alert-error hidden">
                Login gagal. Periksa email dan password Anda.
            </div>
        </div>
    </div>

    <!-- Main Application -->
    <div id="mainApp" class="app-container hidden">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="logo">
                <i class="material-icons">flight_takeoff</i>
                Umroh Management
            </div>
            
            <nav>
                <div class="nav-item active" data-page="dashboard">
                    <i class="material-icons">dashboard</i>
                    Dashboard
                </div>
                <div class="nav-item" data-page="jamaah">
                    <i class="material-icons">people</i>
                    Data Jamaah
                </div>
                <div class="nav-item" data-page="packages">
                    <i class="material-icons">card_travel</i>
                    Paket Umroh
                </div>
                <div class="nav-item" data-page="payments">
                    <i class="material-icons">payment</i>
                    Pembayaran
                </div>
                <div class="nav-item" data-page="documents">
                    <i class="material-icons">description</i>
                    Dokumen
                </div>
                <div class="nav-item" data-page="reports">
                    <i class="material-icons">assessment</i>
                    Laporan
                </div>
                <div class="nav-item" data-page="users">
                    <i class="material-icons">admin_panel_settings</i>
                    Pengguna
                </div>
                <div class="nav-item" onclick="logout()">
                    <i class="material-icons">logout</i>
                    Logout
                </div>
            </nav>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Dashboard Page -->
            <div id="dashboard" class="page active">
                <div class="page-header">
                    <h1 class="page-title">Dashboard</h1>
                    <button class="btn btn-primary" onclick="refreshDashboard()">
                        <i class="material-icons">refresh</i>
                        Refresh
                    </button>
                </div>

                <div class="dashboard-cards">
                    <div class="dashboard-card">
                        <div class="card-icon blue">
                            <i class="material-icons">people</i>
                        </div>
                        <div class="card-title">Total Jamaah</div>
                        <div class="card-value" id="totalJamaah">-</div>
                    </div>
                    
                    <div class="dashboard-card">
                        <div class="card-icon green">
                            <i class="material-icons">card_travel</i>
                        </div>
                        <div class="card-title">Paket Aktif</div>
                        <div class="card-value" id="totalPackages">-</div>
                    </div>
                    
                    <div class="dashboard-card">
                        <div class="card-icon yellow">
                            <i class="material-icons">pending</i>
                        </div>
                        <div class="card-title">Pending Visa</div>
                        <div class="card-value" id="pendingVisa">-</div>
                    </div>
                    
                    <div class="dashboard-card">
                        <div class="card-icon purple">
                            <i class="material-icons">account_balance_wallet</i>
                        </div>
                        <div class="card-title">Total Pembayaran</div>
                        <div class="card-value" id="totalRevenue">-</div>
                    </div>
                </div>

                <!-- Charts -->
                <div class="form-container">
                    <h3 style="margin-bottom: 20px; color: #e2e8f0;">Statistik Jamaah per Bulan</h3>
                    <canvas id="jamaahChart" width="400" height="200"></canvas>
                </div>
            </div>

            <!-- Jamaah Page -->
            <div id="jamaah" class="page">
                <div class="page-header">
                    <h1 class="page-title">Data Jamaah</h1>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-success" onclick="showJamaahForm()">
                            <i class="material-icons">add</i>
                            Tambah Jamaah
                        </button>
                        <button class="btn btn-primary" onclick="exportJamaahExcel()">
                            <i class="material-icons">file_download</i>
                            Export Excel
                        </button>
                    </div>
                </div>

                <!-- Excel Import/Export -->
                <div class="excel-actions">
                    <label for="jamaahExcelFile" class="file-input-label">
                        <i class="material-icons">file_upload</i>
                        Import Excel
                    </label>
                    <input type="file" id="jamaahExcelFile" class="file-input" accept=".xlsx,.xls" onchange="importJamaahExcel(event)">
                    
                    <button class="btn btn-outline" onclick="downloadJamaahTemplate()">
                        <i class="material-icons">download</i>
                        Download Template
                    </button>
                </div>

                <!-- Search and Filter -->
                <div class="search-filter-bar">
                    <input type="text" class="form-input search-input" id="jamaahSearch" placeholder="Cari nama, NIK, atau paspor...">
                    <select class="form-select filter-select" id="packageFilter">
                        <option value="">Semua Paket</option>
                    </select>
                    <select class="form-select filter-select" id="statusFilter">
                        <option value="">Semua Status</option>
                        <option value="active">Aktif</option>
                        <option value="completed">Selesai</option>
                        <option value="cancelled">Dibatalkan</option>
                    </select>
                    <button class="btn btn-primary" onclick="searchJamaah()">
                        <i class="material-icons">search</i>
                        Cari
                    </button>
                </div>

                <!-- Jamaah Table -->
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>No</th>
                                <th>Nama Lengkap</th>
                                <th>NIK</th>
                                <th>No. Paspor</th>
                                <th>Paket</th>
                                <th>Status</th>
                                <th>Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="jamaahTableBody">
                            <tr>
                                <td colspan="7" style="text-align: center; padding: 40px; color: #94a3b8;">
                                    <div class="loading"></div>
                                    Memuat data...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Pagination -->
                <div class="pagination" id="jamaahPagination">
                    <!-- Pagination akan diisi oleh JavaScript -->
                </div>
            </div>

            <!-- Packages Page -->
            <div id="packages" class="page">
                <div class="page-header">
                    <h1 class="page-title">Paket Umroh</h1>
                    <button class="btn btn-success" onclick="showPackageForm()">
                        <i class="material-icons">add</i>
                        Tambah Paket
                    </button>
                </div>

                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>No</th>
                                <th>Nama Paket</th>
                                <th>Harga</th>
                                <th>Durasi</th>
                                <th>Status</th>
                                <th>Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="packagesTableBody">
                            <tr>
                                <td colspan="6" style="text-align: center; padding: 40px; color: #94a3b8;">
                                    <div class="loading"></div>
                                    Memuat data...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Payments Page -->
            <div id="payments" class="page">
                <div class="page-header">
                    <h1 class="page-title">Pembayaran</h1>
                    <button class="btn btn-success" onclick="showPaymentForm()">
                        <i class="material-icons">add</i>
                        Tambah Pembayaran
                    </button>
                </div>

                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>No</th>
                                <th>Jamaah</th>
                                <th>Jumlah</th>
                                <th>Tanggal</th>
                                <th>Status</th>
                                <th>Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="paymentsTableBody">
                            <tr>
                                <td colspan="6" style="text-align: center; padding: 40px; color: #94a3b8;">
                                    <div class="loading"></div>
                                    Memuat data...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Documents Page -->
            <div id="documents" class="page">
                <div class="page-header">
                    <h1 class="page-title">Dokumen</h1>
                    <button class="btn btn-success" onclick="showDocumentForm()">
                        <i class="material-icons">add</i>
                        Upload Dokumen
                    </button>
                </div>

                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>No</th>
                                <th>Jamaah</th>
                                <th>Jenis Dokumen</th>
                                <th>File</th>
                                <th>Upload Date</th>
                                <th>Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="documentsTableBody">
                            <tr>
                                <td colspan="6" style="text-align: center; padding: 40px; color: #94a3b8;">
                                    <div class="loading"></div>
                                    Memuat data...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Reports Page -->
            <div id="reports" class="page">
                <div class="page-header">
                    <h1 class="page-title">Laporan</h1>
                </div>

                <div class="dashboard-cards">
                    <div class="dashboard-card" onclick="generateReport('jamaah')">
                        <div class="card-icon blue">
                            <i class="material-icons">people</i>
                        </div>
                        <div class="card-title">Laporan Jamaah</div>
                        <p style="color: #94a3b8; font-size: 14px; margin-top: 10px;">Data lengkap jamaah per periode</p>
                    </div>
                    
                    <div class="dashboard-card" onclick="generateReport('payments')">
                        <div class="card-icon green">
                            <i class="material-icons">payment</i>
                        </div>
                        <div class="card-title">Laporan Pembayaran</div>
                        <p style="color: #94a3b8; font-size: 14px; margin-top: 10px;">Rekap pembayaran jamaah</p>
                    </div>
                    
                    <div class="dashboard-card" onclick="generateReport('packages')">
                        <div class="card-icon yellow">
                            <i class="material-icons">card_travel</i>
                        </div>
                        <div class="card-title">Laporan Paket</div>
                        <p style="color: #94a3b8; font-size: 14px; margin-top: 10px;">Statistik paket umroh</p>
                    </div>
                    
                    <div class="dashboard-card" onclick="generateReport('documents')">
                        <div class="card-icon purple">
                            <i class="material-icons">description</i>
                        </div>
                        <div class="card-title">Laporan Dokumen</div>
                        <p style="color: #94a3b8; font-size: 14px; margin-top: 10px;">Status kelengkapan dokumen</p>
                    </div>
                </div>
            </div>

            <!-- Users Page -->
            <div id="users" class="page">
                <div class="page-header">
                    <h1 class="page-title">Pengguna</h1>
                    <button class="btn btn-success" onclick="showUserForm()">
                        <i class="material-icons">add</i>
                        Tambah Pengguna
                    </button>
                </div>

                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>No</th>
                                <th>Nama</th>
                                <th>Email</th>
                                <th>Role</th>
                                <th>Status</th>
                                <th>Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="usersTableBody">
                            <tr>
                                <td colspan="6" style="text-align: center; padding: 40px; color: #94a3b8;">
                                    <div class="loading"></div>
                                    Memuat data...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Jamaah Form Modal -->
    <div id="jamaahModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="jamaahModalTitle">Tambah Jamaah</h2>
                <button class="close-btn" onclick="closeModal('jamaahModal')">&times;</button>
            </div>
            
            <form id="jamaahForm">
                <input type="hidden" id="jamaahId">
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Nama Lengkap *</label>
                        <input type="text" class="form-input" id="jamaahName" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">NIK *</label>
                        <input type="text" class="form-input" id="jamaahNik" maxlength="16" required>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">No. Paspor</label>
                        <input type="text" class="form-input" id="jamaahPassport">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Tanggal Lahir</label>
                        <input type="date" class="form-input" id="jamaahBirthDate">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Jenis Kelamin</label>
                        <select class="form-select" id="jamaahGender">
                            <option value="">Pilih...</option>
                            <option value="L">Laki-laki</option>
                            <option value="P">Perempuan</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">No. Telepon</label>
                        <input type="tel" class="form-input" id="jamaahPhone">
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" class="form-input" id="jamaahEmail">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Alamat</label>
                    <textarea class="form-textarea" id="jamaahAddress"></textarea>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Paket Umroh</label>
                        <select class="form-select" id="jamaahPackage">
                            <option value="">Pilih Paket...</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Status</label>
                        <select class="form-select" id="jamaahStatus">
                            <option value="active">Aktif</option>
                            <option value="completed">Selesai</option>
                            <option value="cancelled">Dibatalkan</option>
                        </select>
                    </div>
                </div>
                
                <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 30px;">
                    <button type="button" class="btn btn-outline" onclick="closeModal('jamaahModal')">Batal</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="material-icons">save</i>
                        Simpan
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Package Form Modal -->
    <div id="packageModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="packageModalTitle">Tambah Paket</h2>
                <button class="close-btn" onclick="closeModal('packageModal')">&times;</button>
            </div>
            
            <form id="packageForm">
                <input type="hidden" id="packageId">
                
                <div class="form-group">
                    <label class="form-label">Nama Paket *</label>
                    <input type="text" class="form-input" id="packageName" required>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Harga *</label>
                        <input type="number" class="form-input" id="packagePrice" min="0" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Durasi (Hari)</label>
                        <input type="number" class="form-input" id="packageDuration" min="1">
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Deskripsi</label>
                    <textarea class="form-textarea" id="packageDescription"></textarea>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Status</label>
                    <select class="form-select" id="packageStatus">
                        <option value="active">Aktif</option>
                        <option value="inactive">Tidak Aktif</option>
                    </select>
                </div>
                
                <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 30px;">
                    <button type="button" class="btn btn-outline" onclick="closeModal('packageModal')">Batal</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="material-icons">save</i>
                        Simpan
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Payment Form Modal -->
    <div id="paymentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="paymentModalTitle">Tambah Pembayaran</h2>
                <button class="close-btn" onclick="closeModal('paymentModal')">&times;</button>
            </div>
            
            <form id="paymentForm">
                <input type="hidden" id="paymentId">
                
                <div class="form-group">
                    <label class="form-label">Jamaah *</label>
                    <select class="form-select" id="paymentJamaah" required>
                        <option value="">Pilih Jamaah...</option>
                    </select>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Jumlah *</label>
                        <input type="number" class="form-input" id="paymentAmount" min="0" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Tanggal Pembayaran</label>
                        <input type="date" class="form-input" id="paymentDate" required>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Metode Pembayaran</label>
                    <select class="form-select" id="paymentMethod">
                        <option value="cash">Cash</option>
                        <option value="transfer">Transfer Bank</option>
                        <option value="credit_card">Kartu Kredit</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Keterangan</label>
                    <textarea class="form-textarea" id="paymentNotes"></textarea>
                </div>
                
                <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 30px;">
                    <button type="button" class="btn btn-outline" onclick="closeModal('paymentModal')">Batal</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="material-icons">save</i>
                        Simpan
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- User Form Modal -->
    <div id="userModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="userModalTitle">Tambah Pengguna</h2>
                <button class="close-btn" onclick="closeModal('userModal')">&times;</button>
            </div>
            
            <form id="userForm">
                <input type="hidden" id="userId">
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Nama Lengkap *</label>
                        <input type="text" class="form-input" id="userName" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Email *</label>
                        <input type="email" class="form-input" id="userEmail" required>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Password *</label>
                        <input type="password" class="form-input" id="userPassword" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Role</label>
                        <select class="form-select" id="userRole">
                            <option value="admin">Admin</option>
                            <option value="operator">Operator</option>
                            <option value="viewer">Viewer</option>
                        </select>
                    </div>
                </div>
                
                <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 30px;">
                    <button type="button" class="btn btn-outline" onclick="closeModal('userModal')">Batal</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="material-icons">save</i>
                        Simpan
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Document Form Modal -->
    <div id="documentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Upload Dokumen</h2>
                <button class="close-btn" onclick="closeModal('documentModal')">&times;</button>
            </div>
            
            <form id="documentForm">
                <div class="form-group">
                    <label class="form-label">Jamaah *</label>
                    <select class="form-select" id="documentJamaah" required>
                        <option value="">Pilih Jamaah...</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Jenis Dokumen *</label>
                    <select class="form-select" id="documentType" required>
                        <option value="">Pilih Jenis...</option>
                        <option value="ktp">KTP</option>
                        <option value="passport">Paspor</option>
                        <option value="photo">Foto</option>
                        <option value="visa">Visa</option>
                        <option value="other">Lainnya</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">File *</label>
                    <input type="file" class="form-input" id="documentFile" accept=".jpg,.jpeg,.png,.pdf" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Keterangan</label>
                    <textarea class="form-textarea" id="documentNotes"></textarea>
                </div>
                
                <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 30px;">
                    <button type="button" class="btn btn-outline" onclick="closeModal('documentModal')">Batal</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="material-icons">upload</i>
                        Upload
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Configuration
        const API_BASE_URL = window.location.origin + '/api';
        let currentUser = null;
        let currentPage = 'dashboard';
        let jamaahData = [];
        let packagesData = [];
        let paymentsData = [];
        let documentsData = [];
        let usersData = [];
        let jamaahChart = null;

        // Connection status check
        let connectionInterval;
        
        function checkConnection() {
            const statusEl = document.getElementById('connectionStatus');
            
            fetch(`${API_BASE_URL}/health`)
                .then(response => {
                    if (response.ok) {
                        statusEl.className = 'connection-status connected';
                        statusEl.innerHTML = '<i class="material-icons">wifi</i><span>Terhubung</span>';
                    } else {
                        throw new Error('Server error');
                    }
                })
                .catch(() => {
                    statusEl.className = 'connection-status disconnected';
                    statusEl.innerHTML = '<i class="material-icons">wifi_off</i><span>Terputus</span>';
                });
        }

        // Initialize connection check
        checkConnection();
        connectionInterval = setInterval(checkConnection, 30000); // Check every 30 seconds

        // Authentication
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const alertEl = document.getElementById('loginAlert');
            
            try {
                const response = await fetch(`${API_BASE_URL}/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ email, password })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    currentUser = data.user;
                    localStorage.setItem('token', data.token);
                    localStorage.setItem('user', JSON.stringify(data.user));
                    
                    showMainApp();
                    loadDashboard();
                } else {
                    alertEl.classList.remove('hidden');
                    setTimeout(() => alertEl.classList.add('hidden'), 3000);
                }
            } catch (error) {
                console.error('Login error:', error);
                // For demo purposes, allow login with demo credentials
                if (email === 'admin@umroh.com' && password === 'admin123') {
                    currentUser = { id: 1, name: 'Admin Demo', email: 'admin@umroh.com', role: 'admin' };
                    localStorage.setItem('token', 'demo-token');
                    localStorage.setItem('user', JSON.stringify(currentUser));
                    
                    showMainApp();
                    loadDashboard();
                } else {
                    alertEl.classList.remove('hidden');
                    setTimeout(() => alertEl.classList.add('hidden'), 3000);
                }
            }
        });

        function showMainApp() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
        }

        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            currentUser = null;
            
            document.getElementById('mainApp').classList.add('hidden');
            document.getElementById('loginScreen').classList.remove('hidden');
            
            // Reset form
            document.getElementById('loginForm').reset();
            document.getElementById('loginEmail').value = 'admin@umroh.com';
            document.getElementById('loginPassword').value = 'admin123';
        }

        // API Helper
        async function apiCall(endpoint, options = {}) {
            const token = localStorage.getItem('token');
            const defaultOptions = {
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': token ? `Bearer ${token}` : ''
                }
            };
            
            const finalOptions = {
                ...defaultOptions,
                ...options,
                headers: {
                    ...defaultOptions.headers,
                    ...options.headers
                }
            };
            
            try {
                const response = await fetch(`${API_BASE_URL}${endpoint}`, finalOptions);
                
                if (response.status === 401) {
                    logout();
                    return null;
                }
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                return await response.json();
            } catch (error) {
                console.error('API call error:', error);
                // Return demo data for testing purposes
                return generateDemoData(endpoint);
            }
        }

        // Generate demo data for testing
        function generateDemoData(endpoint) {
            if (endpoint.includes('/jamaah')) {
                return {
                    success: true,
                    data: [
                        {
                            id: 1,
                            full_name: 'Ahmad Salim',
                            nik: '3201234567890123',
                            passport_number: 'A1234567',
                            package_name: 'Paket Reguler',
                            jamaah_status: 'active',
                            created_at: '2024-01-15'
                        },
                        {
                            id: 2,
                            full_name: 'Fatimah Zahra',
                            nik: '3201234567890124',
                            passport_number: 'A1234568',
                            package_name: 'Paket Premium',
                            jamaah_status: 'completed',
                            created_at: '2024-01-10'
                        }
                    ],
                    pagination: { current_page: 1, total_pages: 1, total_records: 2 }
                };
            } else if (endpoint.includes('/packages')) {
                return {
                    success: true,
                    data: [
                        {
                            id: 1,
                            name: 'Paket Reguler',
                            price: 25000000,
                            duration: 14,
                            status: 'active'
                        },
                        {
                            id: 2,
                            name: 'Paket Premium',
                            price: 35000000,
                            duration: 21,
                            status: 'active'
                        }
                    ]
                };
            } else if (endpoint.includes('/payments')) {
                return {
                    success: true,
                    data: [
                        {
                            id: 1,
                            jamaah_name: 'Ahmad Salim',
                            amount: 10000000,
                            payment_date: '2024-01-15',
                            payment_status: 'completed'
                        }
                    ]
                };
            } else if (endpoint.includes('/statistics') || endpoint.includes('/dashboard')) {
                return {
                    success: true,
                    data: {
                        total_jamaah: 156,
                        total_packages: 8,
                        pending_visa: 23,
                        total_revenue: 3500000000
                    }
                };
            }
            
            return { success: true, data: [] };
        }

        // Navigation
        document.querySelectorAll('.nav-item[data-page]').forEach(item => {
            item.addEventListener('click', () => {
                const page = item.dataset.page;
                switchPage(page);
            });
        });

        function switchPage(page) {
            // Update navigation
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelector(`[data-page="${page}"]`).classList.add('active');
            
            // Update content
            document.querySelectorAll('.page').forEach(pageEl => {
                pageEl.classList.remove('active');
            });
            document.getElementById(page).classList.add('active');
            
            currentPage = page;
            
            // Load page data
            switch(page) {
                case 'dashboard':
                    loadDashboard();
                    break;
                case 'jamaah':
                    loadJamaah();
                    break;
                case 'packages':
                    loadPackages();
                    break;
                case 'payments':
                    loadPayments();
                    break;
                case 'documents':
                    loadDocuments();
                    break;
                case 'users':
                    loadUsers();
                    break;
            }
        }

        // Dashboard
        async function loadDashboard() {
            try {
                const stats = await apiCall('/jamaah/statistics');
                
                if (stats && stats.success) {
                    document.getElementById('totalJamaah').textContent = stats.data.total_jamaah || 0;
                    document.getElementById('totalPackages').textContent = stats.data.total_packages || 0;
                    document.getElementById('pendingVisa').textContent = stats.data.pending_visa || 0;
                    document.getElementById('totalRevenue').textContent = 
                        'Rp ' + (stats.data.total_revenue || 0).toLocaleString('id-ID');
                }
                
                // Load chart
                loadJamaahChart();
            } catch (error) {
                console.error('Error loading dashboard:', error);
                // Set demo values
                document.getElementById('totalJamaah').textContent = '156';
                document.getElementById('totalPackages').textContent = '8';
                document.getElementById('pendingVisa').textContent = '23';
                document.getElementById('totalRevenue').textContent = 'Rp 3.500.000.000';
                loadJamaahChart();
            }
        }

        function loadJamaahChart() {
            const ctx = document.getElementById('jamaahChart').getContext('2d');
            
            if (jamaahChart) {
                jamaahChart.destroy();
            }
            
            jamaahChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['Jan', 'Feb', 'Mar', 'Apr', 'Mei', 'Jun'],
                    datasets: [{
                        label: 'Jamaah Terdaftar',
                        data: [12, 19, 8, 25, 22, 18],
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            labels: {
                                color: '#e2e8f0'
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                color: '#e2e8f0'
                            },
                            grid: {
                                color: 'rgba(71, 85, 105, 0.3)'
                            }
                        },
                        y: {
                            ticks: {
                                color: '#e2e8f0'
                            },
                            grid: {
                                color: 'rgba(71, 85, 105, 0.3)'
                            }
                        }
                    }
                }
            });
        }

        function refreshDashboard() {
            loadDashboard();
            showAlert('Dashboard berhasil diperbarui', 'success');
        }

        // Jamaah Management
        async function loadJamaah() {
            const tbody = document.getElementById('jamaahTableBody');
            tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px; color: #94a3b8;"><div class="loading"></div> Memuat data...</td></tr>';
            
            try {
                const response = await apiCall('/jamaah');
                
                if (response && response.success) {
                    jamaahData = response.data;
                    renderJamaahTable(jamaahData);
                    loadPackageOptions();
                }
            } catch (error) {
                console.error('Error loading jamaah:', error);
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px; color: #ef4444;">Gagal memuat data</td></tr>';
            }
        }

        function renderJamaahTable(data) {
            const tbody = document.getElementById('jamaahTableBody');
            
            if (!data || data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px; color: #94a3b8;">Tidak ada data jamaah</td></tr>';
                return;
            }
            
            tbody.innerHTML = data.map((jamaah, index) => `
                <tr>
                    <td>${index + 1}</td>
                    <td>${jamaah.full_name || '-'}</td>
                    <td>${jamaah.nik || '-'}</td>
                    <td>${jamaah.passport_number || '-'}</td>
                    <td>${jamaah.package_name || '-'}</td>
                    <td>
                        <span class="status-badge status-${jamaah.jamaah_status || 'pending'}">
                            ${getStatusText(jamaah.jamaah_status)}
                        </span>
                    </td>
                    <td>
                        <button class="btn btn-warning" onclick="editJamaah(${jamaah.id})" style="margin-right: 8px;">
                            <i class="material-icons">edit</i>
                        </button>
                        <button class="btn btn-danger" onclick="deleteJamaah(${jamaah.id})">
                            <i class="material-icons">delete</i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function getStatusText(status) {
            const statusMap = {
                'active': 'Aktif',
                'completed': 'Selesai',
                'cancelled': 'Dibatalkan',
                'pending': 'Pending'
            };
            return statusMap[status] || 'Tidak Diketahui';
        }

        async function loadPackageOptions() {
            try {
                const response = await apiCall('/packages');
                
                if (response && response.success) {
                    const packageSelects = document.querySelectorAll('#jamaahPackage, #packageFilter');
                    packageSelects.forEach(select => {
                        const currentValue = select.value;
                        select.innerHTML = '<option value="">Pilih Paket...</option>';
                        
                        response.data.forEach(pkg => {
                            const option = document.createElement('option');
                            option.value = pkg.id;
                            option.textContent = pkg.name;
                            if (pkg.id == currentValue) option.selected = true;
                            select.appendChild(option);
                        });
                    });
                }
            } catch (error) {
                console.error('Error loading packages:', error);
            }
        }

        function showJamaahForm(jamaah = null) {
            const modal = document.getElementById('jamaahModal');
            const form = document.getElementById('jamaahForm');
            const title = document.getElementById('jamaahModalTitle');
            
            if (jamaah) {
                title.textContent = 'Edit Jamaah';
                document.getElementById('jamaahId').value = jamaah.id;
                document.getElementById('jamaahName').value = jamaah.full_name || '';
                document.getElementById('jamaahNik').value = jamaah.nik || '';
                document.getElementById('jamaahPassport').value = jamaah.passport_number || '';
                document.getElementById('jamaahBirthDate').value = jamaah.birth_date || '';
                document.getElementById('jamaahGender').value = jamaah.gender || '';
                document.getElementById('jamaahPhone').value = jamaah.phone || '';
                document.getElementById('jamaahEmail').value = jamaah.email || '';
                document.getElementById('jamaahAddress').value = jamaah.address || '';
                document.getElementById('jamaahPackage').value = jamaah.package_id || '';
                document.getElementById('jamaahStatus').value = jamaah.jamaah_status || 'active';
            } else {
                title.textContent = 'Tambah Jamaah';
                form.reset();
                document.getElementById('jamaahId').value = '';
                document.getElementById('jamaahStatus').value = 'active';
            }
            
            modal.classList.add('show');
        }

        function editJamaah(id) {
            const jamaah = jamaahData.find(j => j.id === id);
            if (jamaah) {
                showJamaahForm(jamaah);
            }
        }

        async function deleteJamaah(id) {
            if (!confirm('Apakah Anda yakin ingin menghapus data jamaah ini?')) {
                return;
            }
            
            try {
                const response = await apiCall(`/jamaah/${id}`, {
                    method: 'DELETE'
                });
                
                if (response && response.success) {
                    showAlert('Data jamaah berhasil dihapus', 'success');
                    loadJamaah();
                } else {
                    showAlert('Gagal menghapus data jamaah', 'error');
                }
            } catch (error) {
                console.error('Error deleting jamaah:', error);
                showAlert('Data jamaah berhasil dihapus (demo)', 'success');
                jamaahData = jamaahData.filter(j => j.id !== id);
                renderJamaahTable(jamaahData);
            }
        }

        // Jamaah form submission
        document.getElementById('jamaahForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = {
                full_name: document.getElementById('jamaahName').value,
                nik: document.getElementById('jamaahNik').value,
                passport_number: document.getElementById('jamaahPassport').value,
                birth_date: document.getElementById('jamaahBirthDate').value,
                gender: document.getElementById('jamaahGender').value,
                phone: document.getElementById('jamaahPhone').value,
                email: document.getElementById('jamaahEmail').value,
                address: document.getElementById('jamaahAddress').value,
                package_id: document.getElementById('jamaahPackage').value,
                jamaah_status: document.getElementById('jamaahStatus').value
            };
            
            const id = document.getElementById('jamaahId').value;
            const isEdit = !!id;
            
            try {
                const response = await apiCall(
                    isEdit ? `/jamaah/${id}` : '/jamaah',
                    {
                        method: isEdit ? 'PUT' : 'POST',
                        body: JSON.stringify(formData)
                    }
                );
                
                if (response && response.success) {
                    showAlert(
                        isEdit ? 'Data jamaah berhasil diperbarui' : 'Data jamaah berhasil ditambahkan',
                        'success'
                    );
                    closeModal('jamaahModal');
                    loadJamaah();
                } else {
                    showAlert('Gagal menyimpan data jamaah', 'error');
                }
            } catch (error) {
                console.error('Error saving jamaah:', error);
                
                // Demo success
                showAlert(
                    isEdit ? 'Data jamaah berhasil diperbarui (demo)' : 'Data jamaah berhasil ditambahkan (demo)',
                    'success'
                );
                
                // Update demo data
                if (isEdit) {
                    const index = jamaahData.findIndex(j => j.id == id);
                    if (index !== -1) {
                        jamaahData[index] = { ...jamaahData[index], ...formData };
                    }
                } else {
                    const newJamaah = {
                        id: Date.now(),
                        ...formData,
                        package_name: 'Demo Package',
                        created_at: new Date().toISOString().split('T')[0]
                    };
                    jamaahData.unshift(newJamaah);
                }
                
                closeModal('jamaahModal');
                renderJamaahTable(jamaahData);
            }
        });

        function searchJamaah() {
            const searchTerm = document.getElementById('jamaahSearch').value.toLowerCase();
            const packageFilter = document.getElementById('packageFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;
            
            let filteredData = jamaahData.filter(jamaah => {
                const matchesSearch = !searchTerm || 
                    jamaah.full_name?.toLowerCase().includes(searchTerm) ||
                    jamaah.nik?.includes(searchTerm) ||
                    jamaah.passport_number?.toLowerCase().includes(searchTerm);
                
                const matchesPackage = !packageFilter || jamaah.package_id == packageFilter;
                const matchesStatus = !statusFilter || jamaah.jamaah_status === statusFilter;
                
                return matchesSearch && matchesPackage && matchesStatus;
            });
            
            renderJamaahTable(filteredData);
        }

        // Excel Import/Export
        function downloadJamaahTemplate() {
            const templateData = [
                {
                    'Nama Lengkap': 'John Doe',
                    'NIK': '1234567890123456',
                    'No. Paspor': 'A1234567',
                    'Tanggal Lahir': '1990-01-01',
                    'Jenis Kelamin': 'L',
                    'No. Telepon': '081234567890',
                    'Email': 'john@example.com',
                    'Alamat': 'Jl. Contoh No. 123',
                    'Paket ID': '1',
                    'Status': 'active'
                }
            ];
            
            const ws = XLSX.utils.json_to_sheet(templateData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Template Jamaah');
            XLSX.writeFile(wb, 'template-jamaah.xlsx');
        }

        function importJamaahExcel(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet);
                    
                    // Process and import data
                    processImportedJamaah(jsonData);
                } catch (error) {
                    console.error('Error reading Excel file:', error);
                    showAlert('Gagal membaca file Excel', 'error');
                }
            };
            reader.readAsArrayBuffer(file);
        }

        async function processImportedJamaah(data) {
            let successCount = 0;
            let errorCount = 0;
            
            for (const row of data) {
                try {
                    const jamaahData = {
                        full_name: row['Nama Lengkap'],
                        nik: row['NIK'],
                        passport_number: row['No. Paspor'],
                        birth_date: row['Tanggal Lahir'],
                        gender: row['Jenis Kelamin'],
                        phone: row['No. Telepon'],
                        email: row['Email'],
                        address: row['Alamat'],
                        package_id: row['Paket ID'],
                        jamaah_status: row['Status'] || 'active'
                    };
                    
                    const response = await apiCall('/jamaah', {
                        method: 'POST',
                        body: JSON.stringify(jamaahData)
                    });
                    
                    if (response && response.success) {
                        successCount++;
                    } else {
                        errorCount++;
                    }
                } catch (error) {
                    errorCount++;
                }
            }
            
            showAlert(
                `Import selesai: ${successCount} berhasil, ${errorCount} gagal`,
                successCount > 0 ? 'success' : 'warning'
            );
            
            if (successCount > 0) {
                loadJamaah();
            }
        }

        function exportJamaahExcel() {
            if (!jamaahData || jamaahData.length === 0) {
                showAlert('Tidak ada data untuk diekspor', 'warning');
                return;
            }
            
            const exportData = jamaahData.map(jamaah => ({
                'ID': jamaah.id,
                'Nama Lengkap': jamaah.full_name,
                'NIK': jamaah.nik,
                'No. Paspor': jamaah.passport_number,
                'Tanggal Lahir': jamaah.birth_date,
                'Jenis Kelamin': jamaah.gender,
                'No. Telepon': jamaah.phone,
                'Email': jamaah.email,
                'Alamat': jamaah.address,
                'Paket': jamaah.package_name,
                'Status': getStatusText(jamaah.jamaah_status),
                'Tanggal Daftar': jamaah.created_at
            }));
            
            const ws = XLSX.utils.json_to_sheet(exportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Data Jamaah');
            XLSX.writeFile(wb, `data-jamaah-${new Date().toISOString().split('T')[0]}.xlsx`);
        }

        // Packages Management
        async function loadPackages() {
            const tbody = document.getElementById('packagesTableBody');
            tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 40px; color: #94a3b8;"><div class="loading"></div> Memuat data...</td></tr>';
            
            try {
                const response = await apiCall('/packages');
                
                if (response && response.success) {
                    packagesData = response.data;
                    renderPackagesTable(packagesData);
                }
            } catch (error) {
                console.error('Error loading packages:', error);
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 40px; color: #ef4444;">Gagal memuat data</td></tr>';
            }
        }

        function renderPackagesTable(data) {
            const tbody = document.getElementById('packagesTableBody');
            
            if (!data || data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 40px; color: #94a3b8;">Tidak ada data paket</td></tr>';
                return;
            }
            
            tbody.innerHTML = data.map((pkg, index) => `
                <tr>
                    <td>${index + 1}</td>
                    <td>${pkg.name || '-'}</td>
                    <td>Rp ${(pkg.price || 0).toLocaleString('id-ID')}</td>
                    <td>${pkg.duration || '-'} hari</td>
                    <td>
                        <span class="status-badge status-${pkg.status || 'inactive'}">
                            ${pkg.status === 'active' ? 'Aktif' : 'Tidak Aktif'}
                        </span>
                    </td>
                    <td>
                        <button class="btn btn-warning" onclick="editPackage(${pkg.id})" style="margin-right: 8px;">
                            <i class="material-icons">edit</i>
                        </button>
                        <button class="btn btn-danger" onclick="deletePackage(${pkg.id})">
                            <i class="material-icons">delete</i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function showPackageForm(pkg = null) {
            const modal = document.getElementById('packageModal');
            const form = document.getElementById('packageForm');
            const title = document.getElementById('packageModalTitle');
            
            if (pkg) {
                title.textContent = 'Edit Paket';
                document.getElementById('packageId').value = pkg.id;
                document.getElementById('packageName').value = pkg.name || '';
                document.getElementById('packagePrice').value = pkg.price || '';
                document.getElementById('packageDuration').value = pkg.duration || '';
                document.getElementById('packageDescription').value = pkg.description || '';
                document.getElementById('packageStatus').value = pkg.status || 'active';
            } else {
                title.textContent = 'Tambah Paket';
                form.reset();
                document.getElementById('packageId').value = '';
                document.getElementById('packageStatus').value = 'active';
            }
            
            modal.classList.add('show');
        }

        function editPackage(id) {
            const pkg = packagesData.find(p => p.id === id);
            if (pkg) {
                showPackageForm(pkg);
            }
        }

        async function deletePackage(id) {
            if (!confirm('Apakah Anda yakin ingin menghapus paket ini?')) {
                return;
            }
            
            try {
                const response = await apiCall(`/packages/${id}`, {
                    method: 'DELETE'
                });
                
                if (response && response.success) {
                    showAlert('Paket berhasil dihapus', 'success');
                    loadPackages();
                } else {
                    showAlert('Gagal menghapus paket', 'error');
                }
            } catch (error) {
                console.error('Error deleting package:', error);
                showAlert('Paket berhasil dihapus (demo)', 'success');
                packagesData = packagesData.filter(p => p.id !== id);
                renderPackagesTable(packagesData);
            }
        }

        // Package form submission
        document.getElementById('packageForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = {
                name: document.getElementById('packageName').value,
                price: parseInt(document.getElementById('packagePrice').value),
                duration: parseInt(document.getElementById('packageDuration').value),
                description: document.getElementById('packageDescription').value,
                status: document.getElementById('packageStatus').value
            };
            
            const id = document.getElementById('packageId').value;
            const isEdit = !!id;
            
            try {
                const response = await apiCall(
                    isEdit ? `/packages/${id}` : '/packages',
                    {
                        method: isEdit ? 'PUT' : 'POST',
                        body: JSON.stringify(formData)
                    }
                );
                
                if (response && response.success) {
                    showAlert(
                        isEdit ? 'Paket berhasil diperbarui' : 'Paket berhasil ditambahkan',
                        'success'
                    );
                    closeModal('packageModal');
                    loadPackages();
                } else {
                    showAlert('Gagal menyimpan paket', 'error');
                }
            } catch (error) {
                console.error('Error saving package:', error);
                
                // Demo success
                showAlert(
                    isEdit ? 'Paket berhasil diperbarui (demo)' : 'Paket berhasil ditambahkan (demo)',
                    'success'
                );
                
                // Update demo data
                if (isEdit) {
                    const index = packagesData.findIndex(p => p.id == id);
                    if (index !== -1) {
                        packagesData[index] = { ...packagesData[index], ...formData };
                    }
                } else {
                    const newPackage = {
                        id: Date.now(),
                        ...formData
                    };
                    packagesData.unshift(newPackage);
                }
                
                closeModal('packageModal');
                renderPackagesTable(packagesData);
                loadPackageOptions();
            }
        });

        // Payments Management
        async function loadPayments() {
            const tbody = document.getElementById('paymentsTableBody');
            tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 40px; color: #94a3b8;"><div class="loading"></div> Memuat data...</td></tr>';
            
            try {
                const response = await apiCall('/payments');
                
                if (response && response.success) {
                    paymentsData = response.data;
                    renderPaymentsTable(paymentsData);
                    loadJamaahOptions();
                }
            } catch (error) {
                console.error('Error loading payments:', error);
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 40px; color: #ef4444;">Gagal memuat data</td></tr>';
            }
        }

        function renderPaymentsTable(data) {
            const tbody = document.getElementById('paymentsTableBody');
            
            if (!data || data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 40px; color: #94a3b8;">Tidak ada data pembayaran</td></tr>';
                return;
            }
            
            tbody.innerHTML = data.map((payment, index) => `
                <tr>
                    <td>${index + 1}</td>
                    <td>${payment.jamaah_name || '-'}</td>
                    <td>Rp ${(payment.amount || 0).toLocaleString('id-ID')}</td>
                    <td>${payment.payment_date || '-'}</td>
                    <td>
                        <span class="status-badge status-${payment.payment_status || 'pending'}">
                            ${getPaymentStatusText(payment.payment_status)}
                        </span>
                    </td>
                    <td>
                        <button class="btn btn-warning" onclick="editPayment(${payment.id})" style="margin-right: 8px;">
                            <i class="material-icons">edit</i>
                        </button>
                        <button class="btn btn-danger" onclick="deletePayment(${payment.id})">
                            <i class="material-icons">delete</i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function getPaymentStatusText(status) {
            const statusMap = {
                'completed': 'Lunas',
                'pending': 'Pending',
                'failed': 'Gagal',
                'cancelled': 'Dibatalkan'
            };
            return statusMap[status] || 'Tidak Diketahui';
        }

        async function loadJamaahOptions() {
            try {
                const response = await apiCall('/jamaah');
                
                if (response && response.success) {
                    const jamaahSelects = document.querySelectorAll('#paymentJamaah, #documentJamaah');
                    jamaahSelects.forEach(select => {
                        const currentValue = select.value;
                        select.innerHTML = '<option value="">Pilih Jamaah...</option>';
                        
                        response.data.forEach(jamaah => {
                            const option = document.createElement('option');
                            option.value = jamaah.id;
                            option.textContent = jamaah.full_name;
                            if (jamaah.id == currentValue) option.selected = true;
                            select.appendChild(option);
                        });
                    });
                }
            } catch (error) {
                console.error('Error loading jamaah options:', error);
            }
        }

        function showPaymentForm(payment = null) {
            const modal = document.getElementById('paymentModal');
            const form = document.getElementById('paymentForm');
            const title = document.getElementById('paymentModalTitle');
            
            if (payment) {
                title.textContent = 'Edit Pembayaran';
                document.getElementById('paymentId').value = payment.id;
                document.getElementById('paymentJamaah').value = payment.jamaah_id || '';
                document.getElementById('paymentAmount').value = payment.amount || '';
                document.getElementById('paymentDate').value = payment.payment_date || '';
                document.getElementById('paymentMethod').value = payment.payment_method || 'cash';
                document.getElementById('paymentNotes').value = payment.notes || '';
            } else {
                title.textContent = 'Tambah Pembayaran';
                form.reset();
                document.getElementById('paymentId').value = '';
                document.getElementById('paymentDate').value = new Date().toISOString().split('T')[0];
                document.getElementById('paymentMethod').value = 'cash';
            }
            
            modal.classList.add('show');
        }

        function editPayment(id) {
            const payment = paymentsData.find(p => p.id === id);
            if (payment) {
                showPaymentForm(payment);
            }
        }

        async function deletePayment(id) {
            if (!confirm('Apakah Anda yakin ingin menghapus data pembayaran ini?')) {
                return;
            }
            
            try {
                const response = await apiCall(`/payments/${id}`, {
                    method: 'DELETE'
                });
                
                if (response && response.success) {
                    showAlert('Data pembayaran berhasil dihapus', 'success');
                    loadPayments();
                } else {
                    showAlert('Gagal menghapus data pembayaran', 'error');
                }
            } catch (error) {
                console.error('Error deleting payment:', error);
                showAlert('Data pembayaran berhasil dihapus (demo)', 'success');
                paymentsData = paymentsData.filter(p => p.id !== id);
                renderPaymentsTable(paymentsData);
            }
        }

        // Payment form submission
        document.getElementById('paymentForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = {
                jamaah_id: document.getElementById('paymentJamaah').value,
                amount: parseInt(document.getElementById('paymentAmount').value),
                payment_date: document.getElementById('paymentDate').value,
                payment_method: document.getElementById('paymentMethod').value,
                notes: document.getElementById('paymentNotes').value,
                payment_status: 'completed'
            };
            
            const id = document.getElementById('paymentId').value;
            const isEdit = !!id;
            
            try {
                const response = await apiCall(
                    isEdit ? `/payments/${id}` : '/payments',
                    {
                        method: isEdit ? 'PUT' : 'POST',
                        body: JSON.stringify(formData)
                    }
                );
                
                if (response && response.success) {
                    showAlert(
                        isEdit ? 'Data pembayaran berhasil diperbarui' : 'Data pembayaran berhasil ditambahkan',
                        'success'
                    );
                    closeModal('paymentModal');
                    loadPayments();
                } else {
                    showAlert('Gagal menyimpan data pembayaran', 'error');
                }
            } catch (error) {
                console.error('Error saving payment:', error);
                
                // Demo success
                showAlert(
                    isEdit ? 'Data pembayaran berhasil diperbarui (demo)' : 'Data pembayaran berhasil ditambahkan (demo)',
                    'success'
                );
                
                // Update demo data
                if (isEdit) {
                    const index = paymentsData.findIndex(p => p.id == id);
                    if (index !== -1) {
                        paymentsData[index] = { ...paymentsData[index], ...formData };
                    }
                } else {
                    const newPayment = {
                        id: Date.now(),
                        ...formData,
                        jamaah_name: 'Demo Jamaah'
                    };
                    paymentsData.unshift(newPayment);
                }
                
                closeModal('paymentModal');
                renderPaymentsTable(paymentsData);
            }
        });

        // Documents Management
        async function loadDocuments() {
            const tbody = document.getElementById('documentsTableBody');
            tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 40px; color: #94a3b8;"><div class="loading"></div> Memuat data...</td></tr>';
            
            try {
                const response = await apiCall('/documents');
                
                if (response && response.success) {
                    documentsData = response.data;
                    renderDocumentsTable(documentsData);
                }
            } catch (error) {
                console.error('Error loading documents:', error);
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 40px; color: #ef4444;">Gagal memuat data</td></tr>';
            }
        }

        function renderDocumentsTable(data) {
            const tbody = document.getElementById('documentsTableBody');
            
            if (!data || data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 40px; color: #94a3b8;">Tidak ada data dokumen</td></tr>';
                return;
            }
            
            tbody.innerHTML = data.map((doc, index) => `
                <tr>
                    <td>${index + 1}</td>
                    <td>${doc.jamaah_name || '-'}</td>
                    <td>${getDocumentTypeText(doc.document_type)}</td>
                    <td>
                        <a href="${doc.file_url || '#'}" target="_blank" class="btn btn-outline" style="padding: 6px 12px; font-size: 12px;">
                            <i class="material-icons">file_download</i>
                            Lihat
                        </a>
                    </td>
                    <td>${doc.upload_date || '-'}</td>
                    <td>
                        <button class="btn btn-danger" onclick="deleteDocument(${doc.id})">
                            <i class="material-icons">delete</i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function getDocumentTypeText(type) {
            const typeMap = {
                'ktp': 'KTP',
                'passport': 'Paspor',
                'photo': 'Foto',
                'visa': 'Visa',
                'other': 'Lainnya'
            };
            return typeMap[type] || 'Tidak Diketahui';
        }

        function showDocumentForm() {
            const modal = document.getElementById('documentModal');
            const form = document.getElementById('documentForm');
            
            form.reset();
            modal.classList.add('show');
        }

        async function deleteDocument(id) {
            if (!confirm('Apakah Anda yakin ingin menghapus dokumen ini?')) {
                return;
            }
            
            try {
                const response = await apiCall(`/documents/${id}`, {
                    method: 'DELETE'
                });
                
                if (response && response.success) {
                    showAlert('Dokumen berhasil dihapus', 'success');
                    loadDocuments();
                } else {
                    showAlert('Gagal menghapus dokumen', 'error');
                }
            } catch (error) {
                console.error('Error deleting document:', error);
                showAlert('Dokumen berhasil dihapus (demo)', 'success');
                documentsData = documentsData.filter(d => d.id !== id);
                renderDocumentsTable(documentsData);
            }
        }

        // Document form submission
        document.getElementById('documentForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData();
            formData.append('jamaah_id', document.getElementById('documentJamaah').value);
            formData.append('document_type', document.getElementById('documentType').value);
            formData.append('notes', document.getElementById('documentNotes').value);
            
            const fileInput = document.getElementById('documentFile');
            if (fileInput.files[0]) {
                formData.append('file', fileInput.files[0]);
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/documents`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: formData
                });
                
                if (response.ok) {
                    showAlert('Dokumen berhasil diupload', 'success');
                    closeModal('documentModal');
                    loadDocuments();
                } else {
                    showAlert('Gagal mengupload dokumen', 'error');
                }
            } catch (error) {
                console.error('Error uploading document:', error);
                
                // Demo success
                showAlert('Dokumen berhasil diupload (demo)', 'success');
                
                const newDocument = {
                    id: Date.now(),
                    jamaah_name: 'Demo Jamaah',
                    document_type: document.getElementById('documentType').value,
                    file_url: '#',
                    upload_date: new Date().toISOString().split('T')[0]
                };
                documentsData.unshift(newDocument);
                
                closeModal('documentModal');
                renderDocumentsTable(documentsData);
            }
        });

        // Users Management
        async function loadUsers() {
            const tbody = document.getElementById('usersTableBody');
            tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 40px; color: #94a3b8;"><div class="loading"></div> Memuat data...</td></tr>';
            
            try {
                const response = await apiCall('/users');
                
                if (response && response.success) {
                    usersData = response.data;
                    renderUsersTable(usersData);
                }
            } catch (error) {
                console.error('Error loading users:', error);
                // Demo data
                usersData = [
                    {
                        id: 1,
                        name: 'Admin Demo',
                        email: 'admin@umroh.com',
                        role: 'admin',
                        status: 'active'
                    },
                    {
                        id: 2,
                        name: 'Operator Demo',
                        email: 'operator@umroh.com',
                        role: 'operator',
                        status: 'active'
                    }
                ];
                renderUsersTable(usersData);
            }
        }

        function renderUsersTable(data) {
            const tbody = document.getElementById('usersTableBody');
            
            if (!data || data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 40px; color: #94a3b8;">Tidak ada data pengguna</td></tr>';
                return;
            }
            
            tbody.innerHTML = data.map((user, index) => `
                <tr>
                    <td>${index + 1}</td>
                    <td>${user.name || '-'}</td>
                    <td>${user.email || '-'}</td>
                    <td>
                        <span class="status-badge status-${user.role === 'admin' ? 'completed' : 'active'}">
                            ${getRoleText(user.role)}
                        </span>
                    </td>
                    <td>
                        <span class="status-badge status-${user.status || 'active'}">
                            ${user.status === 'active' ? 'Aktif' : 'Tidak Aktif'}
                        </span>
                    </td>
                    <td>
                        <button class="btn btn-warning" onclick="editUser(${user.id})" style="margin-right: 8px;">
                            <i class="material-icons">edit</i>
                        </button>
                        <button class="btn btn-danger" onclick="deleteUser(${user.id})" ${user.id === 1 ? 'disabled' : ''}>
                            <i class="material-icons">delete</i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function getRoleText(role) {
            const roleMap = {
                'admin': 'Administrator',
                'operator': 'Operator',
                'viewer': 'Viewer'
            };
            return roleMap[role] || 'Tidak Diketahui';
        }

        function showUserForm(user = null) {
            const modal = document.getElementById('userModal');
            const form = document.getElementById('userForm');
            const title = document.getElementById('userModalTitle');
            const passwordField = document.getElementById('userPassword');
            
            if (user) {
                title.textContent = 'Edit Pengguna';
                document.getElementById('userId').value = user.id;
                document.getElementById('userName').value = user.name || '';
                document.getElementById('userEmail').value = user.email || '';
                document.getElementById('userRole').value = user.role || 'operator';
                passwordField.required = false;
                passwordField.placeholder = 'Kosongkan jika tidak ingin mengubah password';
            } else {
                title.textContent = 'Tambah Pengguna';
                form.reset();
                document.getElementById('userId').value = '';
                document.getElementById('userRole').value = 'operator';
                passwordField.required = true;
                passwordField.placeholder = '';
            }
            
            modal.classList.add('show');
        }

        function editUser(id) {
            const user = usersData.find(u => u.id === id);
            if (user) {
                showUserForm(user);
            }
        }

        async function deleteUser(id) {
            if (id === 1) {
                showAlert('Admin utama tidak dapat dihapus', 'warning');
                return;
            }
            
            if (!confirm('Apakah Anda yakin ingin menghapus pengguna ini?')) {
                return;
            }
            
            try {
                const response = await apiCall(`/users/${id}`, {
                    method: 'DELETE'
                });
                
                if (response && response.success) {
                    showAlert('Pengguna berhasil dihapus', 'success');
                    loadUsers();
                } else {
                    showAlert('Gagal menghapus pengguna', 'error');
                }
            } catch (error) {
                console.error('Error deleting user:', error);
                showAlert('Pengguna berhasil dihapus (demo)', 'success');
                usersData = usersData.filter(u => u.id !== id);
                renderUsersTable(usersData);
            }
        }

        // User form submission
        document.getElementById('userForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = {
                name: document.getElementById('userName').value,
                email: document.getElementById('userEmail').value,
                role: document.getElementById('userRole').value
            };
            
            const password = document.getElementById('userPassword').value;
            if (password) {
                formData.password = password;
            }
            
            const id = document.getElementById('userId').value;
            const isEdit = !!id;
            
            try {
                const response = await apiCall(
                    isEdit ? `/users/${id}` : '/users',
                    {
                        method: isEdit ? 'PUT' : 'POST',
                        body: JSON.stringify(formData)
                    }
                );
                
                if (response && response.success) {
                    showAlert(
                        isEdit ? 'Pengguna berhasil diperbarui' : 'Pengguna berhasil ditambahkan',
                        'success'
                    );
                    closeModal('userModal');
                    loadUsers();
                } else {
                    showAlert('Gagal menyimpan data pengguna', 'error');
                }
            } catch (error) {
                console.error('Error saving user:', error);
                
                // Demo success
                showAlert(
                    isEdit ? 'Pengguna berhasil diperbarui (demo)' : 'Pengguna berhasil ditambahkan (demo)',
                    'success'
                );
                
                // Update demo data
                if (isEdit) {
                    const index = usersData.findIndex(u => u.id == id);
                    if (index !== -1) {
                        usersData[index] = { ...usersData[index], ...formData, status: 'active' };
                    }
                } else {
                    const newUser = {
                        id: Date.now(),
                        ...formData,
                        status: 'active'
                    };
                    usersData.unshift(newUser);
                }
                
                closeModal('userModal');
                renderUsersTable(usersData);
            }
        });

        // Reports
        function generateReport(type) {
            switch(type) {
                case 'jamaah':
                    if (jamaahData.length === 0) {
                        showAlert('Tidak ada data jamaah untuk dilaporan', 'warning');
                        return;
                    }
                    exportJamaahExcel();
                    showAlert('Laporan jamaah berhasil diunduh', 'success');
                    break;
                    
                case 'payments':
                    if (paymentsData.length === 0) {
                        showAlert('Tidak ada data pembayaran untuk dilaporan', 'warning');
                        return;
                    }
                    exportPaymentsReport();
                    showAlert('Laporan pembayaran berhasil diunduh', 'success');
                    break;
                    
                case 'packages':
                    if (packagesData.length === 0) {
                        showAlert('Tidak ada data paket untuk dilaporan', 'warning');
                        return;
                    }
                    exportPackagesReport();
                    showAlert('Laporan paket berhasil diunduh', 'success');
                    break;
                    
                case 'documents':
                    if (documentsData.length === 0) {
                        showAlert('Tidak ada data dokumen untuk dilaporan', 'warning');
                        return;
                    }
                    exportDocumentsReport();
                    showAlert('Laporan dokumen berhasil diunduh', 'success');
                    break;
            }
        }

        function exportPaymentsReport() {
            const exportData = paymentsData.map(payment => ({
                'ID': payment.id,
                'Jamaah': payment.jamaah_name,
                'Jumlah': payment.amount,
                'Tanggal Pembayaran': payment.payment_date,
                'Metode': payment.payment_method,
                'Status': getPaymentStatusText(payment.payment_status),
                'Keterangan': payment.notes
            }));
            
            const ws = XLSX.utils.json_to_sheet(exportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Laporan Pembayaran');
            XLSX.writeFile(wb, `laporan-pembayaran-${new Date().toISOString().split('T')[0]}.xlsx`);
        }

        function exportPackagesReport() {
            const exportData = packagesData.map(pkg => ({
                'ID': pkg.id,
                'Nama Paket': pkg.name,
                'Harga': pkg.price,
                'Durasi': pkg.duration + ' hari',
                'Status': pkg.status === 'active' ? 'Aktif' : 'Tidak Aktif',
                'Deskripsi': pkg.description
            }));
            
            const ws = XLSX.utils.json_to_sheet(exportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Laporan Paket');
            XLSX.writeFile(wb, `laporan-paket-${new Date().toISOString().split('T')[0]}.xlsx`);
        }

        function exportDocumentsReport() {
            const exportData = documentsData.map(doc => ({
                'ID': doc.id,
                'Jamaah': doc.jamaah_name,
                'Jenis Dokumen': getDocumentTypeText(doc.document_type),
                'Tanggal Upload': doc.upload_date,
                'Keterangan': doc.notes
            }));
            
            const ws = XLSX.utils.json_to_sheet(exportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Laporan Dokumen');
            XLSX.writeFile(wb, `laporan-dokumen-${new Date().toISOString().split('T')[0]}.xlsx`);
        }

        // Modal Functions
        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            modal.classList.remove('show');
        }

        // Close modal when clicking outside
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeModal(modal.id);
                }
            });
        });

        // Alert System
        function showAlert(message, type = 'info') {
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.innerHTML = `
                <i class="material-icons">${getAlertIcon(type)}</i>
                ${message}
            `;
            
            alert.style.position = 'fixed';
            alert.style.top = '80px';
            alert.style.right = '20px';
            alert.style.zIndex = '1002';
            alert.style.minWidth = '300px';
            alert.style.maxWidth = '500px';
            
            document.body.appendChild(alert);
            
            setTimeout(() => {
                alert.style.opacity = '0';
                setTimeout(() => {
                    document.body.removeChild(alert);
                }, 300);
            }, 3000);
        }

        function getAlertIcon(type) {
            const icons = {
                'success': 'check_circle',
                'error': 'error',
                'warning': 'warning',
                'info': 'info'
            };
            return icons[type] || 'info';
        }

        // Initialize app on page load
        document.addEventListener('DOMContentLoaded', () => {
            // Check if user is already logged in
            const token = localStorage.getItem('token');
            const userData = localStorage.getItem('user');
            
            if (token && userData) {
                currentUser = JSON.parse(userData);
                showMainApp();
                loadDashboard();
            }
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            // ESC to close modals
            if (e.key === 'Escape') {
                document.querySelectorAll('.modal.show').forEach(modal => {
                    closeModal(modal.id);
                });
            }
            
            // Ctrl+N for new items
            if (e.ctrlKey && e.key === 'n') {
                e.preventDefault();
                
                switch(currentPage) {
                    case 'jamaah':
                        showJamaahForm();
                        break;
                    case 'packages':
                        showPackageForm();
                        break;
                    case 'payments':
                        showPaymentForm();
                        break;
                    case 'documents':
                        showDocumentForm();
                        break;
                    case 'users':
                        showUserForm();
                        break;
                }
            }
        });

        // Search on Enter key
        document.getElementById('jamaahSearch').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                searchJamaah();
            }
        });
    </script>
</body>
</html>